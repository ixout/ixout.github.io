<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="glibc各个版本检查机制发生的变化">
<meta property="og:type" content="article">
<meta property="og:title" content="ptmalloc2安全检查">
<meta property="og:url" content="https://ixout.github.io/posts/25293/index.html">
<meta property="og:site_name" content="ixout&#39;s blog">
<meta property="og:description" content="glibc各个版本检查机制发生的变化">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-07-29T07:40:32.000Z">
<meta property="article:modified_time" content="2024-05-20T12:10:57.730Z">
<meta property="article:author" content="ixout">
<meta property="article:tag" content="安全检查">
<meta property="article:tag" content="glibc">
<meta property="article:tag" content="堆">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.png">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
        
      
    
    <!-- title -->
    <title>ptmalloc2安全检查</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ixout's blog" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/posts/61238/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/posts/19785/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ixout.github.io/posts/25293/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ixout.github.io/posts/25293/&text=ptmalloc2安全检查"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ixout.github.io/posts/25293/&title=ptmalloc2安全检查"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ixout.github.io/posts/25293/&is_video=false&description=ptmalloc2安全检查"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ptmalloc2安全检查&body=Check out this article: https://ixout.github.io/posts/25293/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ixout.github.io/posts/25293/&title=ptmalloc2安全检查"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ixout.github.io/posts/25293/&title=ptmalloc2安全检查"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ixout.github.io/posts/25293/&title=ptmalloc2安全检查"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ixout.github.io/posts/25293/&title=ptmalloc2安全检查"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ixout.github.io/posts/25293/&name=ptmalloc2安全检查&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ixout.github.io/posts/25293/&t=ptmalloc2安全检查"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-23"><span class="toc-number">1.</span> <span class="toc-text">glibc2.23</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc"><span class="toc-number">1.1.</span> <span class="toc-text">malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#libc-malloc"><span class="toc-number">1.1.1.</span> <span class="toc-text">__libc_malloc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#int-malloc"><span class="toc-number">1.1.2.</span> <span class="toc-text">__int_malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mglobal-1"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">mglobal-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mfastbin-1"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">mfastbin-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#msmallbin-1"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">msmallbin-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#munsortedbin-1"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">munsortedbin-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#munsorted-2"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">munsorted-2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mlargebin-1"><span class="toc-number">1.1.2.6.</span> <span class="toc-text">mlargebin-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mbinmap-1"><span class="toc-number">1.1.2.7.</span> <span class="toc-text">mbinmap-1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#free"><span class="toc-number">1.2.</span> <span class="toc-text">free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#int-free"><span class="toc-number">1.2.1.</span> <span class="toc-text">__int_free</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-1"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">fglobal-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-2"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">fglobal-2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ffastbin-1"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">ffastbin-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ffastbin-2"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">ffastbin-2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ffastbin-3"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">ffastbin-3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-2-1"><span class="toc-number">1.2.1.6.</span> <span class="toc-text">fglobal-2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-3"><span class="toc-number">1.2.1.7.</span> <span class="toc-text">fglobal-3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-4"><span class="toc-number">1.2.1.8.</span> <span class="toc-text">fglobal-4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-5"><span class="toc-number">1.2.1.9.</span> <span class="toc-text">fglobal-5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-6"><span class="toc-number">1.2.1.10.</span> <span class="toc-text">fglobal-6</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%B1%9E"><span class="toc-number">1.3.</span> <span class="toc-text">附属</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#unlink"><span class="toc-number">1.3.1.</span> <span class="toc-text">unlink</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#unlink-1"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">unlink-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unlink-2"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">unlink-2</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-27"><span class="toc-number">2.</span> <span class="toc-text">glibc2.27</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%B1%9E-1"><span class="toc-number">2.1.</span> <span class="toc-text">附属</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#unlink-1"><span class="toc-number">2.1.1.</span> <span class="toc-text">unlink</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#unlink-3"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">+unlink-3</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#malloc-consolidate"><span class="toc-number">2.1.2.</span> <span class="toc-text">malloc_consolidate</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#maco-1"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">+maco-1</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache"><span class="toc-number">2.1.3.</span> <span class="toc-text">tcache</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tcput-1"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">+tcput-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tcget-1"><span class="toc-number">2.1.3.2.</span> <span class="toc-text">+tcget-1</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-29"><span class="toc-number">3.</span> <span class="toc-text">glibc2.29</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-1"><span class="toc-number">3.1.</span> <span class="toc-text">malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#munsortedbin-1-1"><span class="toc-number">3.1.1.</span> <span class="toc-text">@munsortedbin-1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#munsortedbin-2"><span class="toc-number">3.1.2.</span> <span class="toc-text">+munsortedbin-2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#usetop-1"><span class="toc-number">3.1.3.</span> <span class="toc-text">+usetop-1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#free-1"><span class="toc-number">3.2.</span> <span class="toc-text">free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ftcache-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">+ftcache-1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fglobal-7"><span class="toc-number">3.2.2.</span> <span class="toc-text">+fglobal-7</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%B1%9E-2"><span class="toc-number">3.3.</span> <span class="toc-text">附属</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#maco-2"><span class="toc-number">3.3.1.</span> <span class="toc-text">+maco-2</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-31"><span class="toc-number">4.</span> <span class="toc-text">glibc2.31</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-2"><span class="toc-number">4.1.</span> <span class="toc-text">malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#munsortedbin-3"><span class="toc-number">4.1.1.</span> <span class="toc-text">+munsortedbin-3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#munsortedbin-4"><span class="toc-number">4.1.2.</span> <span class="toc-text">+munsortedbin-4</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%B1%9E-3"><span class="toc-number">4.2.</span> <span class="toc-text">附属</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tcput-1-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">-tcput-1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcget-1-1"><span class="toc-number">4.2.2.</span> <span class="toc-text">-tcget-1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-32"><span class="toc-number">5.</span> <span class="toc-text">glibc2.32</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-3"><span class="toc-number">5.1.</span> <span class="toc-text">malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mfastbin-2"><span class="toc-number">5.1.1.</span> <span class="toc-text">+mfastbin-2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mfastbin-3"><span class="toc-number">5.1.2.</span> <span class="toc-text">+mfastbin-3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mfastbin-4"><span class="toc-number">5.1.3.</span> <span class="toc-text">+mfastbin-4</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#free-2"><span class="toc-number">5.2.</span> <span class="toc-text">free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ftcache-1-1"><span class="toc-number">5.2.1.</span> <span class="toc-text">@ftcache-1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%B1%9E-4"><span class="toc-number">5.3.</span> <span class="toc-text">附属</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#maco-3"><span class="toc-number">5.3.1.</span> <span class="toc-text">+maco-3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcget-2"><span class="toc-number">5.3.2.</span> <span class="toc-text">+tcget-2</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-33"><span class="toc-number">6.</span> <span class="toc-text">glibc2.33</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#free-3"><span class="toc-number">6.1.</span> <span class="toc-text">free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ftcache-1-2"><span class="toc-number">6.1.1.</span> <span class="toc-text">@ftcache-1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-34"><span class="toc-number">7.</span> <span class="toc-text">glibc2.34</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-35"><span class="toc-number">8.</span> <span class="toc-text">glibc2.35</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-37"><span class="toc-number">9.</span> <span class="toc-text">glibc2.37</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-38"><span class="toc-number">10.</span> <span class="toc-text">glibc2.38</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-4"><span class="toc-number">10.1.</span> <span class="toc-text">malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#munsortedbin-2-1"><span class="toc-number">10.1.1.</span> <span class="toc-text">-munsortedbin-2</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        ptmalloc2安全检查
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">ixout</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-07-29T07:40:32.000Z" class="dt-published" itemprop="datePublished">2023-07-29</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/pwn/">pwn</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/glibc/" rel="tag">glibc</a>, <a class="p-category" href="/tags/%E5%A0%86/" rel="tag">堆</a>, <a class="p-category" href="/tags/%E5%AE%89%E5%85%A8%E6%A3%80%E6%9F%A5/" rel="tag">安全检查</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <span class='p black'>在不同的glibc下</span>
<p>分为两篇,一篇记录安全检测,一篇记录操作变化</p>
<p><strong>需要注意,一个大版本下的libc还有许多小版本,版本不同libc也会存在差异,有些明明可能是后面版本的检查,可能被反向移植到旧版</strong></p>
<p>这里以<a target="_blank" rel="noopener" href="http://mirrors.nju.edu.cn/gnu/libc/">libc下载</a>网站下载的为准</p>
<p><strong>有些检查可能是在介绍的两个版本之间更新的,这里以只考虑比较经典的几个版本</strong></p>
<h1 id="glibc2-23"><a href="#glibc2-23" class="headerlink" title="glibc2.23"></a>glibc2.23</h1><p><strong>现在看来,2.23已经是一个比较老的版本了,比它更早的版本暂时不做关注,2.23是一个十分经典的版本,以它为基础先概览各类检查</strong></p>
<h2 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h2><h3 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">        ar_ptr == arena_for_chunk (mem2chunk (victim)));</span><br></pre></td></tr></table></figure>
<p>返回victim前的最后一个检查,需要满足以下三个条件中的至少一个:</p>
<ol>
<li>victim==NULL</li>
<li>chunk的mmap分配标志位为1</li>
<li>chunk的non_main_arena标志为0</li>
</ol>
<h3 id="int-malloc"><a href="#int-malloc" class="headerlink" title="__int_malloc"></a>__int_malloc</h3><h4 id="mglobal-1"><a href="#mglobal-1" class="headerlink" title="mglobal-1"></a>mglobal-1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> checked_request2size(req, sz)                             \</span></span><br><span class="line"><span class="meta">  <span class="keyword">if</span> (REQUEST_OUT_OF_RANGE (req)) &#123;					      \</span></span><br><span class="line"><span class="meta">      __set_errno (ENOMEM);						      \</span></span><br><span class="line"><span class="meta">      return 0;								      \</span></span><br><span class="line"><span class="meta">    &#125;									      \</span></span><br><span class="line"><span class="meta">  (sz) = request2size (req);</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                 \</span></span><br><span class="line"><span class="meta">  ((unsigned long) (req) &gt;=						      \</span></span><br><span class="line"><span class="meta">   (unsigned long) (INTERNAL_SIZE_T) (-2 * MINSIZE))</span></span><br></pre></td></tr></table></figure>
<p>_int_malloc初始会在checked_request2size (bytes, nb)中判断申请大小是否合规</p>
<p>如果在无符号比较中申请大小大于等于-2* MINSIZE,则会报错</p>
<blockquote>
<p>另外提一下,虽然在代码中是先判断申请大小是否越界,再将其转为实际申请chunk大小,但在大多数实际情况下,二者的顺序是倒过来的,即先转化再判断</p>
</blockquote>
<h4 id="mfastbin-1"><a href="#mfastbin-1" class="headerlink" title="mfastbin-1"></a>mfastbin-1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    errstr = <span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>;</span><br><span class="line">  errout:</span><br><span class="line">    malloc_printerr (check_action, errstr, chunk2mem (victim), av);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>取出fastbin中的chunk时,通过该chunk计算出的fastbin索引是否与该chunk所在的链的索引相同,即大小是否对应</p>
<h4 id="msmallbin-1"><a href="#msmallbin-1" class="headerlink" title="msmallbin-1"></a>msmallbin-1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">             bck = victim-&gt;bk;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">               &#123;</span><br><span class="line">                 errstr = <span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;</span><br><span class="line">                 <span class="keyword">goto</span> errout;</span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure>
<p>取出smallbin中的chunk时,判断链表的完整性</p>
<h4 id="munsortedbin-1"><a href="#munsortedbin-1" class="headerlink" title="munsortedbin-1"></a>munsortedbin-1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">    || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;malloc(): memory corruption&quot;</span>,</span><br><span class="line">                   chunk2mem (victim), av);</span><br></pre></td></tr></table></figure>
<p>unsorted循环遍历时,检查从unsortedbin中取出的chunk的size是否合规</p>
<h4 id="munsorted-2"><a href="#munsorted-2" class="headerlink" title="munsorted-2"></a>munsorted-2</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>将unsortedbin中取出的chunk放入不为空的largebin中时,largebin链中的最后一个chunk的NON_MAIN_ARENA标志位应该为0</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>将unsortedbin中取出的chunk放入不为空的largebin中时,chunk的size大于等于最小的size</p>
<p>会对每一个位于nextsize链上大于它的chunk调用检查</p>
<h4 id="mlargebin-1"><a href="#mlargebin-1" class="headerlink" title="mlargebin-1"></a>mlargebin-1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	  bck = unsorted_chunks (av);</span><br><span class="line">               fwd = bck-&gt;fd;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">                 &#123;</span><br><span class="line">                   errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;</span><br><span class="line">                   <span class="keyword">goto</span> errout;</span><br><span class="line">                 &#125;</span><br></pre></td></tr></table></figure>
<p>largebin中取出chunk需要切割时,会检查unsorted头部的完整性</p>
<h4 id="mbinmap-1"><a href="#mbinmap-1" class="headerlink" title="mbinmap-1"></a>mbinmap-1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">               bck = unsorted_chunks (av);</span><br><span class="line">               fwd = bck-&gt;fd;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">                 &#123;</span><br><span class="line">                   errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>;</span><br><span class="line">                   <span class="keyword">goto</span> errout;</span><br><span class="line">                 &#125;</span><br></pre></td></tr></table></figure>
<p>与<strong>largebin-1</strong>相同,位于binmap分配中</p>
<h2 id="free"><a href="#free" class="headerlink" title="free"></a>free</h2><h3 id="int-free"><a href="#int-free" class="headerlink" title="__int_free"></a>__int_free</h3><h4 id="fglobal-1"><a href="#fglobal-1" class="headerlink" title="fglobal-1"></a>fglobal-1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect ((<span class="type">uintptr_t</span>) p &gt; (<span class="type">uintptr_t</span>) -size, <span class="number">0</span>)</span><br><span class="line">    || __builtin_expect (misaligned_chunk (p), <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    errstr = <span class="string">&quot;free(): invalid pointer&quot;</span>;</span><br><span class="line">  errout:</span><br><span class="line">    <span class="keyword">if</span> (!have_lock &amp;&amp; locked)</span><br><span class="line">      (<span class="type">void</span>) mutex_unlock (&amp;av-&gt;mutex);</span><br><span class="line">    malloc_printerr (check_action, errstr, chunk2mem (p), av);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>通过无符号数比较p是否大于-size,判断p是否正常</li>
<li>判断p是否对齐</li>
</ol>
<h4 id="fglobal-2"><a href="#fglobal-2" class="headerlink" title="fglobal-2"></a>fglobal-2</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))</span><br><span class="line">  &#123;</span><br><span class="line">    errstr = <span class="string">&quot;free(): invalid size&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> errout;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>size是否小于MINSIZE或者size不对齐</p>
<h4 id="ffastbin-1"><a href="#ffastbin-1" class="headerlink" title="ffastbin-1"></a>ffastbin-1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">|| __builtin_expect (chunksize (chunk_at_offset (p, size))</span><br><span class="line">		     &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p>判断p的下一个chunk的size是否正常</p>
<h4 id="ffastbin-2"><a href="#ffastbin-2" class="headerlink" title="ffastbin-2"></a>ffastbin-2</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (old == p, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    errstr = <span class="string">&quot;double free or corruption (fasttop)&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> errout;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>如果p等于该fastbin链上的第一个chunk,那么判定为double free</p>
<h4 id="ffastbin-3"><a href="#ffastbin-3" class="headerlink" title="ffastbin-3"></a>ffastbin-3</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> (have_lock &amp;&amp; old != <span class="literal">NULL</span> &amp;&amp; __builtin_expect (old_idx != idx, <span class="number">0</span>))</span><br><span class="line">     &#123;</span><br><span class="line">errstr = <span class="string">&quot;invalid fastbin entry (free)&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>比较少见的一个检查</p>
<h4 id="fglobal-2-1"><a href="#fglobal-2-1" class="headerlink" title="fglobal-2"></a>fglobal-2</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> (__glibc_unlikely (p == av-&gt;top))</span><br><span class="line">     &#123;</span><br><span class="line">errstr = <span class="string">&quot;double free or corruption (top)&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>如果p为top_chunk,判定为double free</p>
<h4 id="fglobal-3"><a href="#fglobal-3" class="headerlink" title="fglobal-3"></a>fglobal-3</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> (__builtin_expect (contiguous (av)</span><br><span class="line">		  &amp;&amp; (<span class="type">char</span> *) nextchunk</span><br><span class="line">		  &gt;= ((<span class="type">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="number">0</span>))</span><br><span class="line">     &#123;</span><br><span class="line">errstr = <span class="string">&quot;double free or corruption (out)&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>判断p的nextchunk是否超越了堆的边界</p>
<h4 id="fglobal-4"><a href="#fglobal-4" class="headerlink" title="fglobal-4"></a>fglobal-4</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk)))</span><br><span class="line">     &#123;</span><br><span class="line">errstr = <span class="string">&quot;double free or corruption (!prev)&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>判断p的nextchunk的prev_inuse位是否为1,不为1则报错</p>
<h4 id="fglobal-5"><a href="#fglobal-5" class="headerlink" title="fglobal-5"></a>fglobal-5</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   nextsize = chunksize(nextchunk);</span><br><span class="line">   <span class="keyword">if</span> (__builtin_expect (nextchunk-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">|| __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">     &#123;</span><br><span class="line">errstr = <span class="string">&quot;free(): invalid next size (normal)&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>判断p的nextchunk的size是否正常</p>
<h4 id="fglobal-6"><a href="#fglobal-6" class="headerlink" title="fglobal-6"></a>fglobal-6</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">     <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">&#123;</span><br><span class="line">  errstr = <span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>;</span><br><span class="line">  <span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>放入unsortedbin时,判断unsorted的头部完整性</p>
<h2 id="附属"><a href="#附属" class="headerlink" title="附属"></a>附属</h2><h3 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h3><h4 id="unlink-1"><a href="#unlink-1" class="headerlink" title="unlink-1"></a><strong>unlink-1</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))		      \</span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);</span><br></pre></td></tr></table></figure>
<p>验证完整性,操作chunk的上一个的下一个和下一个的上一个是否都等于该chunk</p>
<h4 id="unlink-2"><a href="#unlink-2" class="headerlink" title="unlink-2"></a>unlink-2</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)	      \</span><br><span class="line">|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    \</span><br><span class="line">     malloc_printerr (check_action,				      \</span><br><span class="line">	       <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span><br><span class="line">	       P, AV);	</span><br></pre></td></tr></table></figure>
<p>和unlink-1类似,不过检查的是largebin的nextsize链完整性</p>
<h1 id="glibc2-27"><a href="#glibc2-27" class="headerlink" title="glibc2.27"></a>glibc2.27</h1><h2 id="附属-1"><a href="#附属-1" class="headerlink" title="附属"></a>附属</h2><h3 id="unlink-1"><a href="#unlink-1" class="headerlink" title="unlink"></a>unlink</h3><h4 id="unlink-3"><a href="#unlink-3" class="headerlink" title="+unlink-3"></a><strong>+unlink-3</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      \</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);			 </span><br></pre></td></tr></table></figure>
<p>检查通过该chunk的size找到的nextchunk的prev_size是否等于该chunk的size,</p>
<p>unlink不会检查通过prev_size找到的chunk的size是否等于那个prev_size</p>
<h3 id="malloc-consolidate"><a href="#malloc-consolidate" class="headerlink" title="malloc_consolidate"></a>malloc_consolidate</h3><h4 id="maco-1"><a href="#maco-1" class="headerlink" title="+maco-1"></a>+maco-1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index (chunksize (p));</span><br><span class="line">  <span class="keyword">if</span> ((&amp;fastbin (av, idx)) != fb)</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断由p的size计算得出的fastbin索引是否与当前fastbin链匹配</p>
<h3 id="tcache"><a href="#tcache" class="headerlink" title="tcache"></a>tcache</h3><h4 id="tcput-1"><a href="#tcput-1" class="headerlink" title="+tcput-1"></a>+tcput-1</h4><p><code>assert (tc_idx &lt; TCACHE_MAX_BINS);</code></p>
<p>判断tc_idx是否越界</p>
<h4 id="tcget-1"><a href="#tcget-1" class="headerlink" title="+tcget-1"></a>+tcget-1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>判断tc_idx是否越界以及该tcache链是否为空</p>
<h1 id="glibc2-29"><a href="#glibc2-29" class="headerlink" title="glibc2.29"></a>glibc2.29</h1><h2 id="malloc-1"><a href="#malloc-1" class="headerlink" title="malloc"></a>malloc</h2><h3 id="munsortedbin-1-1"><a href="#munsortedbin-1-1" class="headerlink" title="@munsortedbin-1"></a>@munsortedbin-1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (size &lt;= <span class="number">2</span> * SIZE_SZ)</span><br><span class="line">    || __glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): invalid size (unsorted)&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; <span class="number">2</span> * SIZE_SZ)</span><br><span class="line">    || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): invalid next size (unsorted)&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim)</span><br><span class="line">    || __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): unsorted double linked list corrupted&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (prev_inuse (next)))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): invalid next-&gt;prev_inuse (unsorted)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>除了之前就存在的对victim的size检查外,新增:</p>
<ol>
<li>对nextchunk(victim的物理相邻chunk)的size的检查</li>
<li>判断该chunk的size是否等于nextchunk的prev_size</li>
<li>判断链表尾部的完整性</li>
<li>对victim的nextchunk的prev_inuse位检查,是否合理</li>
</ol>
<h3 id="munsortedbin-2"><a href="#munsortedbin-2" class="headerlink" title="+munsortedbin-2"></a>+munsortedbin-2</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">          malloc_printerr (<span class="string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>移除unsorted中chunk时检查链表尾是否完整</p>
<h3 id="usetop-1"><a href="#usetop-1" class="headerlink" title="+usetop-1"></a>+usetop-1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): corrupted top size&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>检查topchunk的size是否合规</p>
<h2 id="free-1"><a href="#free-1" class="headerlink" title="free"></a>free</h2><h3 id="ftcache-1"><a href="#ftcache-1" class="headerlink" title="+ftcache-1"></a>+ftcache-1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">  &#123;</span><br><span class="line">    tcache_entry *tmp;</span><br><span class="line">    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">	 tmp;</span><br><span class="line">	 tmp = tmp-&gt;next)</span><br><span class="line">      <span class="keyword">if</span> (tmp == e)</span><br><span class="line">	malloc_printerr (<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">    <span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">       few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>free时,如果一个chunk的key字段等于tcache,那么就会遍历该tcache链中的所有chunk来判断是否存在double free</p>
<p><strong>可以通过破坏key绕过</strong></p>
<h3 id="fglobal-7"><a href="#fglobal-7" class="headerlink" title="+fglobal-7"></a>+fglobal-7</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">  prevsize = prev_size (p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">  unlink_chunk (av, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前向低地址合并都是不检查即将unlink的chunk的size是否等于找到这个chunk的prev_size</p>
<p>现在新增了这个检查,使得unlink的利用受到多一点的限制</p>
<p>向高地址合并则没有变化</p>
<p>且<strong>宏unlink</strong>现在由<strong>函数unlink_chunk</strong>实现</p>
<p>但内部具体代码并无明显变化</p>
<h2 id="附属-2"><a href="#附属-2" class="headerlink" title="附属"></a>附属</h2><h3 id="maco-2"><a href="#maco-2" class="headerlink" title="+maco-2"></a>+maco-2</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">  prevsize = prev_size (p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size in fastbins&quot;</span>);</span><br><span class="line">  unlink_chunk (av, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与fglobal-7相同,只不过由malloc_consolidate触发</p>
<h1 id="glibc2-31"><a href="#glibc2-31" class="headerlink" title="glibc2.31"></a>glibc2.31</h1><h2 id="malloc-2"><a href="#malloc-2" class="headerlink" title="malloc"></a>malloc</h2><h3 id="munsortedbin-3"><a href="#munsortedbin-3" class="headerlink" title="+munsortedbin-3"></a>+munsortedbin-3</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>当unsortedbin中的chunk放入largebin时,如果要放入的size不小于largebin链中最小的chunk,且size异于largebin链上的所有chunk,则会在插入nextsize链时检测nextsize链完整性</p>
<h3 id="munsortedbin-4"><a href="#munsortedbin-4" class="headerlink" title="+munsortedbin-4"></a>+munsortedbin-4</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>当unsortedbin中的chunk放入largebin时,如果要放入的size不小于largebin链中最小的chunk,就会触发fd/bk链的完整性检查</p>
<p><strong>这两个检查实际上应该是2.30增加的</strong></p>
<h2 id="附属-3"><a href="#附属-3" class="headerlink" title="附属"></a>附属</h2><h3 id="tcput-1-1"><a href="#tcput-1-1" class="headerlink" title="-tcput-1"></a>-tcput-1</h3><p>tcache_put中去除</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br></pre></td></tr></table></figure>
<h3 id="tcget-1-1"><a href="#tcget-1-1" class="headerlink" title="-tcget-1"></a>-tcget-1</h3><p>tcache_get中去除</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>当然这并不意味着tcache-&gt;entries[tc_idx]== 0是可行的,因为这样的话__libc_malloc根本不会进入tcache_get</p>
<h1 id="glibc2-32"><a href="#glibc2-32" class="headerlink" title="glibc2.32"></a>glibc2.32</h1><h2 id="malloc-3"><a href="#malloc-3" class="headerlink" title="malloc"></a>malloc</h2><h3 id="mfastbin-2"><a href="#mfastbin-2" class="headerlink" title="+mfastbin-2"></a>+mfastbin-2</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (misaligned_chunk (victim)))</span><br><span class="line">   malloc_printerr (<span class="string">&quot;malloc(): unaligned fastbin chunk detected 2&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>fastbin取出chunk时,新增chunk对齐检查</p>
<h3 id="mfastbin-3"><a href="#mfastbin-3" class="headerlink" title="+mfastbin-3"></a>+mfastbin-3</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (pp != <span class="literal">NULL</span> &amp;&amp; misaligned_chunk (pp)))       \</span><br><span class="line">	malloc_printerr (<span class="string">&quot;malloc(): unaligned fastbin chunk detected&quot;</span>); \</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在REMOVE_FB宏中,新增对齐检测</p>
<h3 id="mfastbin-4"><a href="#mfastbin-4" class="headerlink" title="+mfastbin-4"></a>+mfastbin-4</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (misaligned_chunk (tc_victim)))</span><br><span class="line">	malloc_printerr (<span class="string">&quot;malloc(): unaligned fastbin chunk detected 3&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>fastbin填充tcachebin新增对齐检测,会检查每一个chunk是否对齐</p>
<h2 id="free-2"><a href="#free-2" class="headerlink" title="free"></a>free</h2><h3 id="ftcache-1-1"><a href="#ftcache-1-1" class="headerlink" title="@ftcache-1"></a>@ftcache-1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">  &#123;</span><br><span class="line">    tcache_entry *tmp;</span><br><span class="line">    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">	 tmp;</span><br><span class="line">	 tmp = REVEAL_PTR (tmp-&gt;next))</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (tmp)))</span><br><span class="line">	  malloc_printerr (<span class="string">&quot;free(): unaligned chunk detected in tcache 2&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (tmp == e)</span><br><span class="line">	  malloc_printerr (<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">	<span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">	   few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>判断doublefree时,会检查tcache链上的所有chunk是否对齐</p>
<h2 id="附属-4"><a href="#附属-4" class="headerlink" title="附属"></a>附属</h2><h3 id="maco-3"><a href="#maco-3" class="headerlink" title="+maco-3"></a>+maco-3</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (misaligned_chunk (p)))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc_consolidate(): &quot;</span></span><br><span class="line">     <span class="string">&quot;unaligned fastbin chunk detected&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>每一个fastbin取出时会检查对齐</p>
<h3 id="tcget-2"><a href="#tcget-2" class="headerlink" title="+tcget-2"></a>+tcget-2</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>tcache_get取出chunk时会有对齐检查</p>
<h1 id="glibc2-33"><a href="#glibc2-33" class="headerlink" title="glibc2.33"></a>glibc2.33</h1><h2 id="free-3"><a href="#free-3" class="headerlink" title="free"></a>free</h2><h3 id="ftcache-1-2"><a href="#ftcache-1-2" class="headerlink" title="@ftcache-1"></a>@ftcache-1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cnt &gt;= mp_.tcache_count)</span><br><span class="line">		  malloc_printerr (<span class="string">&quot;free(): too many chunks detected in tcache&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>判断doublefree时,会检查tcache链上的chunk数目是否超过限制</p>
<p>之前虽然也会与mp_.tcache_count比较,但只是作为一些分支的条件,并不会检查错误</p>
<p>除此之外tcache_counts几乎没有其他检查了</p>
<h1 id="glibc2-34"><a href="#glibc2-34" class="headerlink" title="glibc2.34"></a>glibc2.34</h1><p>无显著变化</p>
<h1 id="glibc2-35"><a href="#glibc2-35" class="headerlink" title="glibc2.35"></a>glibc2.35</h1><p>无显著变化</p>
<h1 id="glibc2-37"><a href="#glibc2-37" class="headerlink" title="glibc2.37"></a>glibc2.37</h1><p>无显著变化</p>
<h1 id="glibc2-38"><a href="#glibc2-38" class="headerlink" title="glibc2.38"></a>glibc2.38</h1><h2 id="malloc-4"><a href="#malloc-4" class="headerlink" title="malloc"></a>malloc</h2><h3 id="munsortedbin-2-1"><a href="#munsortedbin-2-1" class="headerlink" title="-munsortedbin-2"></a>-munsortedbin-2</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>移除该检查,因为其实前面已经做过一次检查了,这个检查有些重复</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-23"><span class="toc-number">1.</span> <span class="toc-text">glibc2.23</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc"><span class="toc-number">1.1.</span> <span class="toc-text">malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#libc-malloc"><span class="toc-number">1.1.1.</span> <span class="toc-text">__libc_malloc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#int-malloc"><span class="toc-number">1.1.2.</span> <span class="toc-text">__int_malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mglobal-1"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">mglobal-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mfastbin-1"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">mfastbin-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#msmallbin-1"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">msmallbin-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#munsortedbin-1"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">munsortedbin-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#munsorted-2"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">munsorted-2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mlargebin-1"><span class="toc-number">1.1.2.6.</span> <span class="toc-text">mlargebin-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mbinmap-1"><span class="toc-number">1.1.2.7.</span> <span class="toc-text">mbinmap-1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#free"><span class="toc-number">1.2.</span> <span class="toc-text">free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#int-free"><span class="toc-number">1.2.1.</span> <span class="toc-text">__int_free</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-1"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">fglobal-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-2"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">fglobal-2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ffastbin-1"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">ffastbin-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ffastbin-2"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">ffastbin-2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ffastbin-3"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">ffastbin-3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-2-1"><span class="toc-number">1.2.1.6.</span> <span class="toc-text">fglobal-2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-3"><span class="toc-number">1.2.1.7.</span> <span class="toc-text">fglobal-3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-4"><span class="toc-number">1.2.1.8.</span> <span class="toc-text">fglobal-4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-5"><span class="toc-number">1.2.1.9.</span> <span class="toc-text">fglobal-5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fglobal-6"><span class="toc-number">1.2.1.10.</span> <span class="toc-text">fglobal-6</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%B1%9E"><span class="toc-number">1.3.</span> <span class="toc-text">附属</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#unlink"><span class="toc-number">1.3.1.</span> <span class="toc-text">unlink</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#unlink-1"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">unlink-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unlink-2"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">unlink-2</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-27"><span class="toc-number">2.</span> <span class="toc-text">glibc2.27</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%B1%9E-1"><span class="toc-number">2.1.</span> <span class="toc-text">附属</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#unlink-1"><span class="toc-number">2.1.1.</span> <span class="toc-text">unlink</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#unlink-3"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">+unlink-3</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#malloc-consolidate"><span class="toc-number">2.1.2.</span> <span class="toc-text">malloc_consolidate</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#maco-1"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">+maco-1</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache"><span class="toc-number">2.1.3.</span> <span class="toc-text">tcache</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tcput-1"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">+tcput-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tcget-1"><span class="toc-number">2.1.3.2.</span> <span class="toc-text">+tcget-1</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-29"><span class="toc-number">3.</span> <span class="toc-text">glibc2.29</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-1"><span class="toc-number">3.1.</span> <span class="toc-text">malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#munsortedbin-1-1"><span class="toc-number">3.1.1.</span> <span class="toc-text">@munsortedbin-1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#munsortedbin-2"><span class="toc-number">3.1.2.</span> <span class="toc-text">+munsortedbin-2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#usetop-1"><span class="toc-number">3.1.3.</span> <span class="toc-text">+usetop-1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#free-1"><span class="toc-number">3.2.</span> <span class="toc-text">free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ftcache-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">+ftcache-1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fglobal-7"><span class="toc-number">3.2.2.</span> <span class="toc-text">+fglobal-7</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%B1%9E-2"><span class="toc-number">3.3.</span> <span class="toc-text">附属</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#maco-2"><span class="toc-number">3.3.1.</span> <span class="toc-text">+maco-2</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-31"><span class="toc-number">4.</span> <span class="toc-text">glibc2.31</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-2"><span class="toc-number">4.1.</span> <span class="toc-text">malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#munsortedbin-3"><span class="toc-number">4.1.1.</span> <span class="toc-text">+munsortedbin-3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#munsortedbin-4"><span class="toc-number">4.1.2.</span> <span class="toc-text">+munsortedbin-4</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%B1%9E-3"><span class="toc-number">4.2.</span> <span class="toc-text">附属</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tcput-1-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">-tcput-1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcget-1-1"><span class="toc-number">4.2.2.</span> <span class="toc-text">-tcget-1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-32"><span class="toc-number">5.</span> <span class="toc-text">glibc2.32</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-3"><span class="toc-number">5.1.</span> <span class="toc-text">malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mfastbin-2"><span class="toc-number">5.1.1.</span> <span class="toc-text">+mfastbin-2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mfastbin-3"><span class="toc-number">5.1.2.</span> <span class="toc-text">+mfastbin-3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mfastbin-4"><span class="toc-number">5.1.3.</span> <span class="toc-text">+mfastbin-4</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#free-2"><span class="toc-number">5.2.</span> <span class="toc-text">free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ftcache-1-1"><span class="toc-number">5.2.1.</span> <span class="toc-text">@ftcache-1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%B1%9E-4"><span class="toc-number">5.3.</span> <span class="toc-text">附属</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#maco-3"><span class="toc-number">5.3.1.</span> <span class="toc-text">+maco-3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcget-2"><span class="toc-number">5.3.2.</span> <span class="toc-text">+tcget-2</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-33"><span class="toc-number">6.</span> <span class="toc-text">glibc2.33</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#free-3"><span class="toc-number">6.1.</span> <span class="toc-text">free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ftcache-1-2"><span class="toc-number">6.1.1.</span> <span class="toc-text">@ftcache-1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-34"><span class="toc-number">7.</span> <span class="toc-text">glibc2.34</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-35"><span class="toc-number">8.</span> <span class="toc-text">glibc2.35</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-37"><span class="toc-number">9.</span> <span class="toc-text">glibc2.37</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc2-38"><span class="toc-number">10.</span> <span class="toc-text">glibc2.38</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-4"><span class="toc-number">10.1.</span> <span class="toc-text">malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#munsortedbin-2-1"><span class="toc-number">10.1.1.</span> <span class="toc-text">-munsortedbin-2</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ixout.github.io/posts/25293/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ixout.github.io/posts/25293/&text=ptmalloc2安全检查"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ixout.github.io/posts/25293/&title=ptmalloc2安全检查"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ixout.github.io/posts/25293/&is_video=false&description=ptmalloc2安全检查"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ptmalloc2安全检查&body=Check out this article: https://ixout.github.io/posts/25293/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ixout.github.io/posts/25293/&title=ptmalloc2安全检查"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ixout.github.io/posts/25293/&title=ptmalloc2安全检查"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ixout.github.io/posts/25293/&title=ptmalloc2安全检查"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ixout.github.io/posts/25293/&title=ptmalloc2安全检查"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ixout.github.io/posts/25293/&name=ptmalloc2安全检查&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ixout.github.io/posts/25293/&t=ptmalloc2安全检查"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    ixout
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
