<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="elf dynamic link">
<meta property="og:type" content="article">
<meta property="og:title" content="elf动态链接">
<meta property="og:url" content="https://ixout.github.io/posts/19785/index.html">
<meta property="og:site_name" content="ixout&#39;s blog">
<meta property="og:description" content="elf dynamic link">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-07-23T02:22:35.000Z">
<meta property="article:modified_time" content="2025-04-06T11:42:36.217Z">
<meta property="article:author" content="ixout">
<meta property="article:tag" content="基础">
<meta property="article:tag" content="elf">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.png">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
        
      
    
    <!-- title -->
    <title>elf动态链接</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ixout's blog" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/posts/25293/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/posts/15815/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ixout.github.io/posts/19785/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ixout.github.io/posts/19785/&text=elf动态链接"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ixout.github.io/posts/19785/&title=elf动态链接"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ixout.github.io/posts/19785/&is_video=false&description=elf动态链接"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=elf动态链接&body=Check out this article: https://ixout.github.io/posts/19785/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ixout.github.io/posts/19785/&title=elf动态链接"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ixout.github.io/posts/19785/&title=elf动态链接"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ixout.github.io/posts/19785/&title=elf动态链接"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ixout.github.io/posts/19785/&title=elf动态链接"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ixout.github.io/posts/19785/&name=elf动态链接&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ixout.github.io/posts/19785/&t=elf动态链接"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">相关结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#plt-amp-amp-plt-got-amp-amp-plt-sec"><span class="toc-number">1.1.</span> <span class="toc-text">.plt&amp;&amp;.plt.got&amp;&amp;.plt.sec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#got-amp-amp-got-plt"><span class="toc-number">1.2.</span> <span class="toc-text">.got &amp;&amp; .got.plt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#imapct-of-RELRO"><span class="toc-number">1.3.</span> <span class="toc-text">imapct of RELRO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FULL-RELRO"><span class="toc-number">1.3.1.</span> <span class="toc-text">FULL RELRO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Partial-RELRO"><span class="toc-number">1.3.2.</span> <span class="toc-text">Partial RELRO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#No-RELRO"><span class="toc-number">1.3.3.</span> <span class="toc-text">No RELRO</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dynamic"><span class="toc-number">1.4.</span> <span class="toc-text">.dynamic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dynstr"><span class="toc-number">1.5.</span> <span class="toc-text">.dynstr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dynsym"><span class="toc-number">1.6.</span> <span class="toc-text">.dynsym</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rel-plt"><span class="toc-number">1.7.</span> <span class="toc-text">.rel.plt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#link-map"><span class="toc-number">1.8.</span> <span class="toc-text">link_map</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E8%BF%87%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">链接过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dl-runtime-resolve-link-map-reloc-arg"><span class="toc-number">2.1.</span> <span class="toc-text">_dl_runtime_resolve(link_map,reloc_arg)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dl-fixup"><span class="toc-number">2.2.</span> <span class="toc-text">_dl_fixup</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        elf动态链接
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">ixout</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-07-23T02:22:35.000Z" class="dt-published" itemprop="datePublished">2023-07-23</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/pwn/">pwn</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/elf/" rel="tag">elf</a>, <a class="p-category" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="相关结构"><a href="#相关结构" class="headerlink" title="相关结构"></a>相关结构</h1><h2 id="plt-amp-amp-plt-got-amp-amp-plt-sec"><a href="#plt-amp-amp-plt-got-amp-amp-plt-sec" class="headerlink" title=".plt&amp;&amp;.plt.got&amp;&amp;.plt.sec"></a>.plt&amp;&amp;.plt.got&amp;&amp;.plt.sec</h2><p><strong>所在segment:代码段</strong></p>
<p><strong>plt表说是表但其实其中的代码都是用来运行的</strong></p>
<p>PLT : 程序链接表（PLT，Procedure Link Table）</p>
<p>调用链接器来解析某个外部函数的地址, 并填充到GOT表中, 然后跳转到该函数; 或者直接在GOT中查找并跳转到对应外部函数(如果非首次调用).</p>
<p>PLT表可能四种情况:</p>
<ol>
<li><code>只有.plt</code></li>
<li><code>`.plt和.plt.got</code></li>
<li><code>.plt和.plt,sec</code></li>
<li><code>.plt和.plt,sec和.plt.got</code></li>
</ol>
<hr>
<p>在延迟绑定环境下,每一个函数对应的PLT表项有三个字段</p>
<ol>
<li>code:跳转到对应的got表项中的地址</li>
<li>code:压栈,该参数是对应函数在.rel.plt上的偏移,是写定的</li>
<li>code:<strong>跳转到公共项plt[0]</strong></li>
</ol>
<p><strong>公共项plt[0]处的代码push GOT[1]然后jmp GOT[2]</strong></p>
<p>在使用了intel cet技术后,在code1和code2字段前会各加一个endbr64指令</p>
<p>且只要存在<code>.plt.sec</code>节,那么code1一般都位于其中</p>
<p>code2和code3以及公共项都位于<code>.plt</code>节</p>
<h2 id="got-amp-amp-got-plt"><a href="#got-amp-amp-got-plt" class="headerlink" title=".got &amp;&amp; .got.plt"></a>.got &amp;&amp; .got.plt</h2><p><strong>所在segment:数据段</strong></p>
<p>got表就真的只是表了,只存储内容非运行代码</p>
<p>GOT : 全局偏移表（GOT, Global Offset Table）</p>
<p>包括了<code>.got</code>和<code>.got.plt</code>.</p>
<p><strong>有时<code>.got</code>和<code>.got.plt</code>同时存在,有时只有<code>.got</code>,与relro模式相关</strong></p>
<p><code>.got</code>主要用于放置全局变量地址以及不需要延迟绑定的函数地址</p>
<p>got表相当于plt的GOT全局偏移表, 其内容有两种情况:</p>
<ol>
<li>如果在之前查找过该符号, 内容为外部函数的具体地址. </li>
<li>如果没查找过, 则内容为对应函数PLT表第二个表项的地址.</li>
</ol>
<p>在x86架构下, 除了每个函数占用一个GOT表项外，GOT表项还保留了 3个公共表项,  保存在前三个位置, 分别是:</p>
<ul>
<li>got[0]: 本ELF动态段(.dynamic段)的装载地址,初始不为空,就位于elf中</li>
<li>got<a target="_blank" rel="noopener" href="http://www.cs.stevens.edu/~jschauma/810/elf.html">1</a>: 本ELF的<code>link_map</code>数据结构描述符地址,初始为空,程序开始前初始化</li>
<li>got<a target="_blank" rel="noopener" href="http://www.cs.dartmouth.edu/~sergey/cs108/dyn-linking-with-gdb.txt">2</a>: <code>_dl_runtime_resolve</code>函数的地址,初始为空,程序开始前初始化</li>
</ul>
<p>如果<code>.got</code>和<code>.got.plt</code>同时存在,这三个表项位于<code>.got.plt</code>,否则位于<code>.got</code></p>
<p><code>FULL RELRO</code>下,got[1]和got[2]不初始化</p>
<p><code>Partial RELRO</code>和<code>No RELRO</code>则在程序正式开始前由<code>_dl_start_user</code>完成初始化,</p>
<p>其中, <code>link_map</code>数据结构的定义如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="comment">/* Shared library&#x27;s load address. */</span></span><br><span class="line">ElfW(Addr) l_addr;</span><br><span class="line"><span class="comment">/* Pointer to library&#x27;s name in the string table. */</span>                                    <span class="type">char</span> *l_name;</span><br><span class="line"><span class="comment">/*         Dynamic section of the shared object.</span></span><br><span class="line"><span class="comment">           Includes dynamic linking info etc.</span></span><br><span class="line"><span class="comment">           Not interesting to us.</span></span><br><span class="line"><span class="comment">           */</span>                      </span><br><span class="line">ElfW(Dyn) *l_ld;      </span><br><span class="line"><span class="comment">/* Pointer to previous and next link_map node. */</span>                    </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>, *<span class="title">l_prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="imapct-of-RELRO"><a href="#imapct-of-RELRO" class="headerlink" title="imapct of RELRO"></a>imapct of RELRO</h2><p>这篇文章讲的动态链接延迟绑定</p>
<p>是指在RELRO保护为<code>Partial RELRO和No RELRO</code>的情况下部分函数进行的延迟绑定</p>
<hr>
<p>当RELRO保护为<code>FULL RELRO</code>的情况下<br>函数的动态链接会在程序进入main之前(start函数中)便完成,所有函数第一次调用时GOT表皆已指向真实函数地址</p>
<p><code>Parital RELRO和No RELRO</code>下<strong>部分</strong>函数也是这样</p>
<p>栈回溯如下</p>
<figure class="highlight plaintext"><figcaption><span>backtrace</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">►  f 0   0x7ffff7fdd80d _dl_relocate_object+3613</span><br><span class="line">   f 1   0x7ffff7fdd80d _dl_relocate_object+3613</span><br><span class="line">   f 2   0x7ffff7fd353a dl_main+8026</span><br><span class="line">   f 3   0x7ffff7febc4b _dl_sysdep_start+1355</span><br><span class="line">   f 4   0x7ffff7fd104c _dl_start+604</span><br><span class="line">   f 5   0x7ffff7fd104c _dl_start+604</span><br><span class="line">   f 6   0x7ffff7fd0108 _dl_start_user</span><br><span class="line">   f 7              0x1</span><br></pre></td></tr></table></figure>
<h3 id="FULL-RELRO"><a href="#FULL-RELRO" class="headerlink" title="FULL RELRO"></a>FULL RELRO</h3><p>FULL RELRO情况下,一般只会有一个<code>.got</code>节(.got.plt并入其中)</p>
<p>程序正式进行之前,所有函数的动态链接完成后</p>
<p><strong>会使用mprotect将<code>.got</code>表所在页的写权限禁止</strong></p>
<h3 id="Partial-RELRO"><a href="#Partial-RELRO" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h3><p><code>Parital RELRO</code>情况下,会有<code>.got</code>节和<code>.got.plt</code>节</p>
<p>将函数分为两个部分</p>
<p><code>.got</code>中的函数,在main函数之前完成动态链接,<strong>并由mprotect禁止<code>.got</code>所在页写权限</strong></p>
<p><code>.got.plt</code>中的函数,则是按照正常的延迟绑定流程进行,并且一直拥有写权限</p>
<h3 id="No-RELRO"><a href="#No-RELRO" class="headerlink" title="No RELRO"></a>No RELRO</h3><p><code>No RELRO</code>和Parital一样会有<code>.got</code>节和<code>.got.plt</code>节</p>
<p>函数同样分为两个部分</p>
<p><code>.got</code>中的函数,同样在main函数之前完成动态链接</p>
<p><code>.got.plt</code>中的函数,同样按照正常的延迟绑定流程进行</p>
<p>不同的是,<code>No RELRO</code>不禁止GOT表的任何写权限</p>
<h2 id="dynamic"><a href="#dynamic" class="headerlink" title=".dynamic"></a>.dynamic</h2><p>包含了很多动态链接所需的关键信息，在动态链接中我们主要关注DT_STRTAB, DT_SYMTAB, DT_JMPREL这三项，这三个东西分别包含了指向<code>.dynstr</code>, <code>.dynsym</code>, <code>.rel.plt</code>这3个section的指针</p>
<p>结构体成员的定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Elf64_Dyn struc ; (<span class="keyword">sizeof</span>=<span class="number">0x10</span>, align=<span class="number">0x8</span>, copyof_3)</span><br><span class="line"><span class="number">00000000</span>                                        </span><br><span class="line"><span class="number">00000000</span>                                  </span><br><span class="line"><span class="number">00000000</span> d_tag dq ?				<span class="comment">//在link_map成员l_info中的下标</span></span><br><span class="line"><span class="number">00000008</span> d_un dq ?</span><br><span class="line"><span class="number">00000010</span> Elf64_Dyn ends</span><br></pre></td></tr></table></figure>
<p>其中的d_un是个联合体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    Elf64_Xword d_val;</span><br><span class="line">    Elf64_Addr d_ptr;</span><br><span class="line">&#125; d_un;</span><br></pre></td></tr></table></figure>
<hr>
<p>除了上述提及的三个成员,.dynamic中还存在不少符号信息(init,fini等等),其中还有一个可能要用到的是DT_DEBUG成员,它指向<strong>_r_debug全局结构体</strong>,在其中能够找到<strong>link_map</strong>地址(一般是其第二个成员)</p>
<h2 id="dynstr"><a href="#dynstr" class="headerlink" title=".dynstr"></a>.dynstr</h2><p>一个字符串表,包含着动态链接所需要的符号,表项是字符串以0结尾,当要引用某个字符串时,用的时相对这个secticon头的偏移</p>
<h2 id="dynsym"><a href="#dynsym" class="headerlink" title=".dynsym"></a>.dynsym</h2><p>这个节是一个符号表（结构体数组），里面记录了各种符号的信息，每个表项是一个结构体每个结构体对应一个符号。</p>
<p>64位和32位中改结构体有些差异,以64位为例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Elf64_Sym struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, align=<span class="number">0x8</span>, mappedto_1)</span><br><span class="line"><span class="number">00000000</span>                                      </span><br><span class="line"><span class="number">00000000</span>                                      </span><br><span class="line"><span class="number">00000000</span> st_name dd ?                 <span class="comment">//函数名字符串在.dynstr中的偏移           </span></span><br><span class="line"><span class="number">00000004</span> st_info db ?                <span class="comment">//对导入函数而言,为固定的0x12</span></span><br><span class="line"><span class="number">00000005</span> st_other db ?               <span class="comment">//对导入函数而言,剩下的都为0</span></span><br><span class="line"><span class="number">00000006</span> st_shndx dw ?                </span><br><span class="line"><span class="number">00000008</span> st_value dq ?                          </span><br><span class="line"><span class="number">00000010</span> st_size dq ?</span><br><span class="line"><span class="number">00000018</span> Elf64_Sym ends</span><br></pre></td></tr></table></figure>
<h2 id="rel-plt"><a href="#rel-plt" class="headerlink" title=".rel.plt"></a>.rel.plt</h2><p>它是重定位表,也是一个结构体数组，每个项对应一个导入函数。</p>
<p>64位和32位中改结构体有些差异,以64位为例,结构体定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Elf64_Rela struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, align=<span class="number">0x8</span>, copyof_2)</span><br><span class="line"><span class="number">00000000</span>                                </span><br><span class="line"><span class="number">00000000</span>                                         </span><br><span class="line"><span class="number">00000000</span> r_offset dq ?      <span class="comment">//存储导入函数的got表地址</span></span><br><span class="line"><span class="number">00000008</span> r_info dq ?		<span class="comment">//对导入函数而言,该值等于[函数序号&lt;&lt;32]+7  32位下&lt;&lt;8</span></span><br><span class="line"><span class="number">00000010</span> r_addend dq ?		<span class="comment">//对导入函数而言为0</span></span><br><span class="line"><span class="number">00000018</span> Elf64_Rela ends</span><br></pre></td></tr></table></figure>
<h2 id="link-map"><a href="#link-map" class="headerlink" title="link_map"></a>link_map</h2><p>对整个elf生命周期都非常重要的一个结构体,结构体非常大,声明有几百行</p>
<p>详见glibc/include/link.h</p>
<p>简单看一下常用的几个成员</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> &#123;</span></span><br><span class="line">    Elf64_Addr l_addr;</span><br><span class="line">    <span class="type">char</span> *l_name;</span><br><span class="line">    Elf64_Dyn *l_ld;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_real</span>;</span></span><br><span class="line">    Lmid_t l_ns;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">libname_list</span> *<span class="title">l_libname</span>;</span></span><br><span class="line">    Elf64_Dyn *l_info[<span class="number">77</span>];</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个普通的程序启动后,会有四个link_map结构</p>
<p>通过l_next和l_prev链接,以l_next为正序的话,四个link_map分别对应</p>
<p><code>running elf -&gt; vdso -&gt; libc -&gt; ld</code></p>
<p>link_map用到较多的是l_info,其是一个指针线性表,程序开始时便会用<code>.dynmaic</code>段的表项地址去初始化它,在resolve时会利用这这些指针去访问<code>.dynamic</code>段中的各个表项</p>
<h1 id="链接过程"><a href="#链接过程" class="headerlink" title="链接过程"></a>链接过程</h1><p> 整个过程可以概述为</p>
<h2 id="dl-runtime-resolve-link-map-reloc-arg"><a href="#dl-runtime-resolve-link-map-reloc-arg" class="headerlink" title="_dl_runtime_resolve(link_map,reloc_arg)"></a>_dl_runtime_resolve(link_map,reloc_arg)</h2><ol>
<li>用<code>link_map</code>访问<code>.dynamic</code>，取出<code>.dynstr</code>, <code>.dynsym</code>, <code>.rel.plt</code>的指针,初始化时就将<code>.dynamic</code>中的各表项地址用于初始化<code>link_map</code></li>
<li><code>.rel.plt + 第二个参数</code>求出当前函数的重定位表项<code>Elf_Rel</code>的指针，记作<code>rel</code></li>
<li><code>rel-&gt;r_info &gt;&gt; 固定数</code>作为<code>.dynsym</code>的下标，求出当前函数的符号表项<code>Elf_Sym</code>的指针，记作<code>sym</code></li>
<li><code>.dynstr + sym-&gt;st_name</code>得出符号名字符串指针</li>
<li>在动态链接库查找这个函数的地址，并且把地址赋值给<code>*rel-&gt;r_offset</code>，即GOT表</li>
<li>调用这个函数</li>
</ol>
<hr>
<p>_dl_runtime_resolve直接由汇编写成,见<code>glibc/sysdeps/x86_64/dl-trampoline.h</code></p>
<p>不过代码有点难读直接放实际运行时dump下来的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Dump of assembler code for function _dl_runtime_resolve_xsavec:</span><br><span class="line">   0x00007ffff7fe7bc0 &lt;+0&gt;:	endbr64 </span><br><span class="line">   0x00007ffff7fe7bc4 &lt;+4&gt;:	push   rbx</span><br><span class="line">   0x00007ffff7fe7bc5 &lt;+5&gt;:	mov    rbx,rsp</span><br><span class="line">   0x00007ffff7fe7bc8 &lt;+8&gt;:	and    rsp,0xffffffffffffffc0</span><br><span class="line">   0x00007ffff7fe7bcc &lt;+12&gt;:	sub    rsp,QWORD PTR [rip+0x14b35]        # 0x7ffff7ffc708 &lt;_rtld_global_ro+232&gt;</span><br><span class="line">   0x00007ffff7fe7bd3 &lt;+19&gt;:	mov    QWORD PTR [rsp],rax</span><br><span class="line">   0x00007ffff7fe7bd7 &lt;+23&gt;:	mov    QWORD PTR [rsp+0x8],rcx</span><br><span class="line">   0x00007ffff7fe7bdc &lt;+28&gt;:	mov    QWORD PTR [rsp+0x10],rdx</span><br><span class="line">   0x00007ffff7fe7be1 &lt;+33&gt;:	mov    QWORD PTR [rsp+0x18],rsi</span><br><span class="line">   0x00007ffff7fe7be6 &lt;+38&gt;:	mov    QWORD PTR [rsp+0x20],rdi</span><br><span class="line">   0x00007ffff7fe7beb &lt;+43&gt;:	mov    QWORD PTR [rsp+0x28],r8</span><br><span class="line">   0x00007ffff7fe7bf0 &lt;+48&gt;:	mov    QWORD PTR [rsp+0x30],r9</span><br><span class="line">   0x00007ffff7fe7bf5 &lt;+53&gt;:	mov    eax,0xee</span><br><span class="line">   0x00007ffff7fe7bfa &lt;+58&gt;:	xor    edx,edx</span><br><span class="line">   0x00007ffff7fe7bfc &lt;+60&gt;:	mov    QWORD PTR [rsp+0x250],rdx</span><br><span class="line">   0x00007ffff7fe7c04 &lt;+68&gt;:	mov    QWORD PTR [rsp+0x258],rdx</span><br><span class="line">   0x00007ffff7fe7c0c &lt;+76&gt;:	mov    QWORD PTR [rsp+0x260],rdx</span><br><span class="line">   0x00007ffff7fe7c14 &lt;+84&gt;:	mov    QWORD PTR [rsp+0x268],rdx</span><br><span class="line">   0x00007ffff7fe7c1c &lt;+92&gt;:	mov    QWORD PTR [rsp+0x270],rdx</span><br><span class="line">   0x00007ffff7fe7c24 &lt;+100&gt;:	mov    QWORD PTR [rsp+0x278],rdx</span><br><span class="line">   0x00007ffff7fe7c2c &lt;+108&gt;:	xsavec [rsp+0x40]</span><br><span class="line">   0x00007ffff7fe7c31 &lt;+113&gt;:	mov    rsi,QWORD PTR [rbx+0x10]</span><br><span class="line">   0x00007ffff7fe7c35 &lt;+117&gt;:	mov    rdi,QWORD PTR [rbx+0x8]</span><br><span class="line">   0x00007ffff7fe7c39 &lt;+121&gt;:	call   0x7ffff7fe00c0 &lt;_dl_fixup&gt;</span><br><span class="line">   0x00007ffff7fe7c3e &lt;+126&gt;:	mov    r11,rax</span><br><span class="line">   0x00007ffff7fe7c41 &lt;+129&gt;:	mov    eax,0xee</span><br><span class="line">   0x00007ffff7fe7c46 &lt;+134&gt;:	xor    edx,edx</span><br><span class="line">   0x00007ffff7fe7c48 &lt;+136&gt;:	xrstor [rsp+0x40]</span><br><span class="line">   0x00007ffff7fe7c4d &lt;+141&gt;:	mov    r9,QWORD PTR [rsp+0x30]</span><br><span class="line">   0x00007ffff7fe7c52 &lt;+146&gt;:	mov    r8,QWORD PTR [rsp+0x28]</span><br><span class="line">   0x00007ffff7fe7c57 &lt;+151&gt;:	mov    rdi,QWORD PTR [rsp+0x20]</span><br><span class="line">   0x00007ffff7fe7c5c &lt;+156&gt;:	mov    rsi,QWORD PTR [rsp+0x18]</span><br><span class="line">   0x00007ffff7fe7c61 &lt;+161&gt;:	mov    rdx,QWORD PTR [rsp+0x10]</span><br><span class="line">   0x00007ffff7fe7c66 &lt;+166&gt;:	mov    rcx,QWORD PTR [rsp+0x8]</span><br><span class="line">   0x00007ffff7fe7c6b &lt;+171&gt;:	mov    rax,QWORD PTR [rsp]</span><br><span class="line">   0x00007ffff7fe7c6f &lt;+175&gt;:	mov    rsp,rbx</span><br><span class="line">   0x00007ffff7fe7c72 &lt;+178&gt;:	mov    rbx,QWORD PTR [rsp]</span><br><span class="line">   0x00007ffff7fe7c76 &lt;+182&gt;:	add    rsp,0x18</span><br><span class="line">   0x00007ffff7fe7c7a &lt;+186&gt;:	bnd jmp r11</span><br></pre></td></tr></table></figure>
<h2 id="dl-fixup"><a href="#dl-fixup" class="headerlink" title="_dl_fixup"></a>_dl_fixup</h2><p>_dl_runtime_resolve的主体其实是调用_dl_fixup</p>
<p>当然_dl_fixup也调用了不少函数,暂时不深入,重点关注_dl_fixup</p>
<p><strong>_dl_fixup</strong>是在glibc/elf/dl-runtime.c实现的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">DL_FIXUP_VALUE_TYPE</span><br><span class="line">attribute_hidden __attribute ((noinline)) DL_ARCH_FIXUP_ATTRIBUTE</span><br><span class="line">_dl_fixup (</span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> ELF_MACHINE_RUNTIME_FIXUP_ARGS</span></span><br><span class="line">	   ELF_MACHINE_RUNTIME_FIXUP_ARGS,</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">	   <span class="keyword">struct</span> link_map *l, ElfW(Word) reloc_arg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Sym)</span> *<span class="type">const</span> symtab</span><br><span class="line">    = (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *strtab = (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[DT_STRTAB]);</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">uintptr_t</span> pltgot = (<span class="type">uintptr_t</span>) D_PTR (l, l_info[DT_PLTGOT]);</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> PLTREL *<span class="type">const</span> reloc</span><br><span class="line">    = (<span class="type">const</span> <span class="type">void</span> *) (D_PTR (l, l_info[DT_JMPREL])</span><br><span class="line">		      + reloc_offset (pltgot, reloc_arg));</span><br><span class="line">  <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Sym)</span> *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">  <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Sym)</span> *refsym = sym;</span><br><span class="line">  <span class="type">void</span> *<span class="type">const</span> rel_addr = (<span class="type">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);</span><br><span class="line">  <span class="type">lookup_t</span> result;</span><br><span class="line">  DL_FIXUP_VALUE_TYPE value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Sanity check that we&#x27;re really looking at a PLT relocation.  */</span></span><br><span class="line">  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not</span></span><br><span class="line"><span class="comment">      used don&#x27;t look in the global scope.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Half)</span> *vernum =</span><br><span class="line">	    (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">	  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">	  version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">	  <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">	    version = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We need to keep the scope around so do some locking.  This is</span></span><br><span class="line"><span class="comment">	 not necessary for objects which cannot be unloaded or when</span></span><br><span class="line"><span class="comment">	 we are not using any threads (yet).  */</span></span><br><span class="line">      <span class="type">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;</span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">	&#123;</span><br><span class="line">	  THREAD_GSCOPE_SET_FLAG ();</span><br><span class="line">	  flags |= DL_LOOKUP_GSCOPE_LOCK;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_ENABLE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,</span><br><span class="line">				    version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We are done with the global scope.  */</span></span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">	THREAD_GSCOPE_RESET_FLAG ();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_FINALIZE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Currently result contains the base load address (or link map)</span></span><br><span class="line"><span class="comment">	 of the object that defines sym.  Now add in the symbol</span></span><br><span class="line"><span class="comment">	 offset.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (result,</span><br><span class="line">				   SYMBOL_ADDRESS (result, sym, <span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We already found the symbol.  The module (and therefore its load</span></span><br><span class="line"><span class="comment">	 address) is also known.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (l, SYMBOL_ADDRESS (l, sym, <span class="literal">true</span>));</span><br><span class="line">      result = l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* And now perhaps the relocation addend.  */</span></span><br><span class="line">  value = elf_machine_plt_value (l, reloc, value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sym != <span class="literal">NULL</span></span><br><span class="line">      &amp;&amp; __builtin_expect (ELFW(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, <span class="number">0</span>))</span><br><span class="line">    value = elf_ifunc_invoke (DL_FIXUP_VALUE_ADDR (value));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="comment">/* Auditing checkpoint: we have a new binding.  Provide the auditing</span></span><br><span class="line"><span class="comment">     libraries the possibility to change the value and tell us whether further</span></span><br><span class="line"><span class="comment">     auditing is wanted.</span></span><br><span class="line"><span class="comment">     The l_reloc_result is only allocated if there is an audit module which</span></span><br><span class="line"><span class="comment">     provides a la_symbind.  */</span></span><br><span class="line">  <span class="keyword">if</span> (l-&gt;l_reloc_result != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* This is the address in the array where we store the result of previous</span></span><br><span class="line"><span class="comment">	 relocations.  */</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">reloc_result</span> *<span class="title">reloc_result</span></span></span><br><span class="line"><span class="class">	=</span> &amp;l-&gt;l_reloc_result[reloc_index (pltgot, reloc_arg, <span class="keyword">sizeof</span> (PLTREL))];</span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> init = atomic_load_acquire (&amp;reloc_result-&gt;init);</span><br><span class="line">      <span class="keyword">if</span> (init == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  _dl_audit_symbind (l, reloc_result, reloc, sym, &amp;value, result, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Store the result for later runs.  */</span></span><br><span class="line">	  <span class="keyword">if</span> (__glibc_likely (! GLRO(dl_bind_not)))</span><br><span class="line">	    &#123;</span><br><span class="line">	      reloc_result-&gt;addr = value;</span><br><span class="line">	      <span class="comment">/* Guarantee all previous writes complete before init is</span></span><br><span class="line"><span class="comment">		 updated.  See CONCURRENCY NOTES below.  */</span></span><br><span class="line">	      atomic_store_release (&amp;reloc_result-&gt;init, <span class="number">1</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	value = reloc_result-&gt;addr;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Finally, fix up the plt itself.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (GLRO(dl_bind_not)))</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> elf_machine_fixup_plt (l, result, refsym, sym, reloc, rel_addr, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">相关结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#plt-amp-amp-plt-got-amp-amp-plt-sec"><span class="toc-number">1.1.</span> <span class="toc-text">.plt&amp;&amp;.plt.got&amp;&amp;.plt.sec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#got-amp-amp-got-plt"><span class="toc-number">1.2.</span> <span class="toc-text">.got &amp;&amp; .got.plt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#imapct-of-RELRO"><span class="toc-number">1.3.</span> <span class="toc-text">imapct of RELRO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FULL-RELRO"><span class="toc-number">1.3.1.</span> <span class="toc-text">FULL RELRO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Partial-RELRO"><span class="toc-number">1.3.2.</span> <span class="toc-text">Partial RELRO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#No-RELRO"><span class="toc-number">1.3.3.</span> <span class="toc-text">No RELRO</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dynamic"><span class="toc-number">1.4.</span> <span class="toc-text">.dynamic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dynstr"><span class="toc-number">1.5.</span> <span class="toc-text">.dynstr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dynsym"><span class="toc-number">1.6.</span> <span class="toc-text">.dynsym</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rel-plt"><span class="toc-number">1.7.</span> <span class="toc-text">.rel.plt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#link-map"><span class="toc-number">1.8.</span> <span class="toc-text">link_map</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E8%BF%87%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">链接过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dl-runtime-resolve-link-map-reloc-arg"><span class="toc-number">2.1.</span> <span class="toc-text">_dl_runtime_resolve(link_map,reloc_arg)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dl-fixup"><span class="toc-number">2.2.</span> <span class="toc-text">_dl_fixup</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ixout.github.io/posts/19785/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ixout.github.io/posts/19785/&text=elf动态链接"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ixout.github.io/posts/19785/&title=elf动态链接"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ixout.github.io/posts/19785/&is_video=false&description=elf动态链接"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=elf动态链接&body=Check out this article: https://ixout.github.io/posts/19785/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ixout.github.io/posts/19785/&title=elf动态链接"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ixout.github.io/posts/19785/&title=elf动态链接"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ixout.github.io/posts/19785/&title=elf动态链接"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ixout.github.io/posts/19785/&title=elf动态链接"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ixout.github.io/posts/19785/&name=elf动态链接&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ixout.github.io/posts/19785/&t=elf动态链接"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>
        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    ixout
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
